

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>webapp.webapp &mdash; Skyline 2.0.0 documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/skyline.styles.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home" alt="Documentation Home"> Skyline
          

          
          </a>

          
            
            
              <div class="version">
                2.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../requirements.html">Requirements</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting-started.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../running-in-python-virtualenv.html">Running Skyline in a Python virtualenv</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../upgrading/index.html">Upgrading</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../getting-data-into-skyline.html">Getting data into Skyline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../alert-testing.html">Alert testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../alerts.html">Alerts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../slack.html">slack</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../monotonic-metrics.html">Strictly increasing monotonicity</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../horizon.html">Horizon</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../analyzer.html">Analyzer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../analyzer-optimizations.html">Analyzer Optimizations</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../algorithms/index.html">Algorithms</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../mirage.html">Mirage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../boundary.html">Boundary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../crucible.html">Crucible</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../panorama.html">Panorama</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../webapp.html">Webapp</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ionosphere.html">Ionosphere</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ionosphere_echo.html">Ionosphere echo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tsfresh.html">tsfresh</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../luminosity.html">Luminosity</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../flux.html">Flux</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../upload-data-to-flux.html">upload_data to Flux - EXPERIMENTAL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../vista.html">Vista</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../redis-integration.html">Redis integration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../rebrow.html"><span class="red">re</span><span class="brow">brow</span></a></li>
<li class="toctree-l1"><a class="reference internal" href="../../running-multiple-skylines.html">Running multiple Skyline instances</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../skyline-and-friends.html">Skyline and friends</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../logging.html">Logging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tuning-tips.html">Tuning tips</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../monitoring-skyline.html">Monitoring Skyline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../deprecated-docs/index.html">Deprecated docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../releases.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../whats-new.html">Whatâ€™s new</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../development/index.html">Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../roadmap.html">Roadmap</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../skyline.html">skyline package</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Skyline</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>webapp.webapp</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for webapp.webapp</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">division</span>
<span class="kn">import</span> <span class="nn">redis</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">simplejson</span> <span class="k">as</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">from</span> <span class="nn">msgpack</span> <span class="kn">import</span> <span class="n">Unpacker</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">wraps</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">render_template</span><span class="p">,</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">Response</span><span class="p">,</span> <span class="n">abort</span><span class="p">,</span> <span class="n">flash</span><span class="p">,</span>
    <span class="n">send_file</span><span class="p">,</span> <span class="n">jsonify</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">daemon</span> <span class="kn">import</span> <span class="n">runner</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">isdir</span>
<span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">path</span>
<span class="kn">import</span> <span class="nn">string</span>
<span class="kn">from</span> <span class="nn">os</span> <span class="kn">import</span> <span class="n">remove</span> <span class="k">as</span> <span class="n">os_remove</span>
<span class="kn">from</span> <span class="nn">time</span> <span class="kn">import</span> <span class="n">sleep</span>

<span class="c1"># @added 20160703 - Feature #1464: Webapp Redis browser</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="c1"># @modified 20180918 - Feature #2602: Graphs in search_features_profiles</span>
<span class="c1"># from datetime import datetime, timedelta</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">timedelta</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">base64</span>

<span class="c1"># flask things for rebrow</span>
<span class="c1"># @modified 20180918 - Feature #2602: Graphs in search_features_profiles</span>
<span class="c1"># from flask import session, g, url_for, flash, Markup, json</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">url_for</span><span class="p">,</span> <span class="n">Markup</span>

<span class="c1"># For secret_key</span>
<span class="kn">import</span> <span class="nn">uuid</span>

<span class="c1"># @added 20170122 - Feature #1872: Ionosphere - features profile page by id only</span>
<span class="c1"># Determine the features profile dir path for a fp_id</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="c1"># from pytz import timezone</span>
<span class="kn">import</span> <span class="nn">pytz</span>

<span class="c1"># @added 20180520 - Feature #2378: Add redis auth to Skyline and rebrow</span>
<span class="c1"># Added auth to rebrow as per https://github.com/marians/rebrow/pull/20 by</span>
<span class="c1"># elky84</span>
<span class="kn">from</span> <span class="nn">six.moves.urllib.parse</span> <span class="kn">import</span> <span class="n">quote</span>

<span class="c1"># @modified 20180918 - Feature #2602: Graphs in search_features_profiles</span>
<span class="c1"># from features_profile import feature_name_id, calculate_features_profile</span>
<span class="kn">from</span> <span class="nn">features_profile</span> <span class="kn">import</span> <span class="n">calculate_features_profile</span>

<span class="kn">from</span> <span class="nn">tsfresh_feature_names</span> <span class="kn">import</span> <span class="n">TSFRESH_VERSION</span>

<span class="c1"># @modified 20180526 - Feature #2378: Add redis auth to Skyline and rebrow</span>
<span class="c1"># Use PyJWT instead of pycryptodome</span>
<span class="c1"># from Crypto.Cipher import AES</span>
<span class="c1"># import base64</span>
<span class="c1"># @added 20180526 - Feature #2378: Add redis auth to Skyline and rebrow</span>
<span class="kn">import</span> <span class="nn">jwt</span>
<span class="c1"># @added 20180527 - Feature #2378: Add redis auth to Skyline and rebrow</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">from</span> <span class="nn">sys</span> <span class="kn">import</span> <span class="n">version_info</span>
<span class="kn">from</span> <span class="nn">ast</span> <span class="kn">import</span> <span class="n">literal_eval</span>

<span class="c1"># @added 20180721 - Feature #2464: luminosity_remote_data</span>
<span class="c1"># Use a gzipped response as the response as raw preprocessed time series</span>
<span class="c1"># added cStringIO, gzip and functools to implement Gzip for particular views</span>
<span class="c1"># http://flask.pocoo.org/snippets/122/</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">after_this_request</span>
<span class="c1"># from cStringIO import StringIO as IO</span>
<span class="kn">import</span> <span class="nn">gzip</span>
<span class="kn">import</span> <span class="nn">functools</span>

<span class="kn">from</span> <span class="nn">logging.handlers</span> <span class="kn">import</span> <span class="n">TimedRotatingFileHandler</span><span class="p">,</span> <span class="n">MemoryHandler</span>

<span class="kn">import</span> <span class="nn">os.path</span>
<span class="c1"># @added 20190116 - Cross-Site Scripting Security Vulnerability #85</span>
<span class="c1">#                   Bug #2816: Cross-Site Scripting Security Vulnerability</span>
<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">escape</span> <span class="k">as</span> <span class="n">flask_escape</span>

<span class="k">if</span> <span class="kc">True</span><span class="p">:</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)),</span> <span class="n">os</span><span class="o">.</span><span class="n">pardir</span><span class="p">))</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">))</span>
    <span class="kn">import</span> <span class="nn">settings</span>
    <span class="kn">from</span> <span class="nn">validate_settings</span> <span class="kn">import</span> <span class="n">validate_settings_variables</span>
    <span class="kn">import</span> <span class="nn">skyline_version</span>
    <span class="kn">from</span> <span class="nn">skyline_functions</span> <span class="kn">import</span> <span class="p">(</span>
        <span class="n">get_graphite_metric</span><span class="p">,</span>
        <span class="c1"># @added 20170604 - Feature #2034: analyse_derivatives</span>
        <span class="n">in_list</span><span class="p">,</span>
        <span class="c1"># @added 20180804 - Feature #2488: Allow user to specifically set metric as a derivative metric in training_data</span>
        <span class="n">set_metric_as_derivative</span><span class="p">,</span>
        <span class="c1"># @added 20190510 - Feature #2990: Add metrics id to relevant web pages</span>
        <span class="c1"># get_memcache_metric_object,</span>
        <span class="c1"># @added 20190920 - Feature #3230: users DB table</span>
        <span class="c1">#                   Ideas #2476: Label and relate anomalies</span>
        <span class="c1">#                   Feature #2516: Add label to features profile</span>
        <span class="n">get_user_details</span><span class="p">,</span>
        <span class="c1"># @added 20191030 - Bug #3266: py3 Redis binary objects not strings</span>
        <span class="c1">#                   Branch #3262: py3</span>
        <span class="c1"># Added a single functions to deal with Redis connection and the</span>
        <span class="c1"># charset=&#39;utf-8&#39;, decode_responses=True arguments required in py3</span>
        <span class="n">get_redis_conn</span><span class="p">,</span> <span class="n">get_redis_conn_decoded</span><span class="p">)</span>

    <span class="kn">from</span> <span class="nn">backend</span> <span class="kn">import</span> <span class="p">(</span>
        <span class="n">panorama_request</span><span class="p">,</span> <span class="n">get_list</span><span class="p">,</span>
        <span class="c1"># @added 20180720 - Feature #2464: luminosity_remote_data</span>
        <span class="n">luminosity_remote_data</span><span class="p">)</span>
    <span class="kn">from</span> <span class="nn">ionosphere_backend</span> <span class="kn">import</span> <span class="p">(</span>
        <span class="n">ionosphere_data</span><span class="p">,</span> <span class="n">ionosphere_metric_data</span><span class="p">,</span>
        <span class="c1"># @modified 20170114 - Feature #1854: Ionosphere learn</span>
        <span class="c1"># Decoupled create_features_profile from ionosphere_backend</span>
        <span class="c1"># ionosphere_get_metrics_dir, create_features_profile,</span>
        <span class="n">ionosphere_get_metrics_dir</span><span class="p">,</span>
        <span class="n">features_profile_details</span><span class="p">,</span>
        <span class="c1"># @added 20170118 - Feature #1862: Ionosphere features profiles search page</span>
        <span class="n">ionosphere_search</span><span class="p">,</span>
        <span class="c1"># @added 20170305 - Feature #1960: ionosphere_layers</span>
        <span class="n">create_ionosphere_layers</span><span class="p">,</span> <span class="n">feature_profile_layers_detail</span><span class="p">,</span>
        <span class="n">feature_profile_layer_alogrithms</span><span class="p">,</span>
        <span class="c1"># @added 20170308 - Feature #1960: ionosphere_layers</span>
        <span class="c1"># To present the operator with the existing layers and algorithms for the metric</span>
        <span class="n">metric_layers_alogrithms</span><span class="p">,</span>
        <span class="c1"># @added 20170327 - Feature #2004: Ionosphere layers - edit_layers</span>
        <span class="c1">#                   Task #2002: Review and correct incorrectly defined layers</span>
        <span class="n">edit_ionosphere_layers</span><span class="p">,</span>
        <span class="c1"># @added 20170402 - Feature #2000: Ionosphere - validated</span>
        <span class="n">validate_fp</span><span class="p">,</span>
        <span class="c1"># @added 20170617 - Feature #2054: ionosphere.save.training_data</span>
        <span class="n">save_training_data_dir</span><span class="p">,</span>
        <span class="c1"># added 20170908 - Feature #2056: ionosphere - disabled_features_profiles</span>
        <span class="n">features_profile_family_tree</span><span class="p">,</span> <span class="n">disable_features_profile_family_tree</span><span class="p">,</span>
        <span class="c1"># @added 20170916 - Feature #1996: Ionosphere - matches page</span>
        <span class="n">get_fp_matches</span><span class="p">,</span>
        <span class="c1"># @added 20170917 - Feature #1996: Ionosphere - matches page</span>
        <span class="n">get_matched_id_resources</span><span class="p">,</span>
        <span class="c1"># @added 20180812 - Feature #2430: Ionosphere validate learnt features profiles page</span>
        <span class="n">get_features_profiles_to_validate</span><span class="p">,</span>
        <span class="c1"># @added 20180815 - Feature #2430: Ionosphere validate learnt features profiles page</span>
        <span class="n">get_metrics_with_features_profiles_to_validate</span><span class="p">,</span>
        <span class="c1"># @added 20181205 - Bug #2746: webapp time out - Graphs in search_features_profiles</span>
        <span class="c1">#                   Feature #2602: Graphs in search_features_profiles</span>
        <span class="n">ionosphere_show_graphs</span><span class="p">,</span>
        <span class="c1"># @added 20190502 - Branch #2646: slack</span>
        <span class="n">webapp_update_slack_thread</span><span class="p">,</span>
        <span class="c1"># @added 20190601 - Feature #3084: Ionosphere - validated matches</span>
        <span class="n">validate_ionosphere_match</span><span class="p">,</span>
        <span class="c1"># @added 20200226: Ideas #2476: Label and relate anomalies</span>
        <span class="c1">#                  Feature #2516: Add label to features profile</span>
        <span class="n">label_anomalies</span>
    <span class="p">)</span>

    <span class="c1"># from utilites import alerts_matcher</span>

    <span class="c1"># @added 20170114 - Feature #1854: Ionosphere learn</span>
    <span class="c1"># Decoupled the create_features_profile from ionosphere_backend and moved to</span>
    <span class="c1"># ionosphere_functions so it can be used by ionosphere/learn</span>
    <span class="kn">from</span> <span class="nn">ionosphere_functions</span> <span class="kn">import</span> <span class="p">(</span>
        <span class="n">create_features_profile</span><span class="p">,</span> <span class="n">get_ionosphere_learn_details</span><span class="p">,</span>
        <span class="c1"># @added 20180414 - Branch #2270: luminosity</span>
        <span class="n">get_correlations</span><span class="p">,</span>
        <span class="c1"># @added 20200113 - Feature #3390: luminosity related anomalies</span>
        <span class="c1">#                   Branch #2270: luminosity</span>
        <span class="n">get_related</span><span class="p">)</span>

    <span class="c1"># @added 20200420 - Feature #3500: webapp - crucible_process_metrics</span>
    <span class="c1">#                   Feature #1448: Crucible web UI</span>
    <span class="c1">#                   Branch #868: crucible</span>
    <span class="kn">from</span> <span class="nn">crucible_backend</span> <span class="kn">import</span> <span class="p">(</span>
        <span class="n">submit_crucible_job</span><span class="p">,</span> <span class="n">get_crucible_jobs</span><span class="p">,</span> <span class="n">get_crucible_job</span><span class="p">,</span>
        <span class="n">send_crucible_job_metric_to_panorama</span><span class="p">)</span>

<span class="c1"># @added 20200516 - Feature #3538: webapp - upload_data endoint</span>
<span class="n">file_uploads_enabled</span> <span class="o">=</span> <span class="kc">False</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">flux_process_uploads</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLUX_PROCESS_UPLOADS</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">flux_process_uploads</span> <span class="o">=</span> <span class="kc">False</span>
<span class="k">if</span> <span class="n">flux_process_uploads</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">file_uploads_enabled</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">WEBAPP_ACCEPT_DATA_UPLOADS</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">file_uploads_enabled</span> <span class="o">=</span> <span class="kc">False</span>
<span class="k">if</span> <span class="n">file_uploads_enabled</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">werkzeug.utils</span> <span class="kn">import</span> <span class="n">secure_filename</span>
    <span class="kn">from</span> <span class="nn">skyline_functions</span> <span class="kn">import</span> <span class="n">mkdir_p</span><span class="p">,</span> <span class="n">write_data_to_file</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">DATA_UPLOADS_PATH</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">DATA_UPLOADS_PATH</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">DATA_UPLOADS_PATH</span> <span class="o">=</span> <span class="s1">&#39;/tmp/skyline/data_uploads&#39;</span>
    <span class="n">ALLOWED_EXTENSIONS</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;json&#39;</span><span class="p">,</span> <span class="s1">&#39;csv&#39;</span><span class="p">,</span> <span class="s1">&#39;xlsx&#39;</span><span class="p">,</span> <span class="s1">&#39;xls&#39;</span><span class="p">,</span> <span class="s1">&#39;zip&#39;</span><span class="p">,</span> <span class="s1">&#39;gz&#39;</span><span class="p">}</span>
    <span class="n">ALLOWED_FORMATS</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;csv&#39;</span><span class="p">,</span> <span class="s1">&#39;xlsx&#39;</span><span class="p">,</span> <span class="s1">&#39;xls&#39;</span><span class="p">}</span>
    <span class="c1"># @modified 20200520 - Bug #3552: flux.uploaded_data_worker - tar.gz</span>
    <span class="c1"># tar.gz needs more work</span>
    <span class="c1"># ALLOWED_ARCHIVES = {&#39;none&#39;, &#39;zip&#39;, &#39;gz&#39;, &#39;tar_gz&#39;}</span>
    <span class="n">ALLOWED_ARCHIVES</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> <span class="s1">&#39;zip&#39;</span><span class="p">,</span> <span class="s1">&#39;gz&#39;</span><span class="p">}</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">flux_upload_keys</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLUX_UPLOADS_KEYS</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">flux_upload_keys</span> <span class="o">=</span> <span class="p">{}</span>


<span class="n">skyline_version</span> <span class="o">=</span> <span class="n">skyline_version</span><span class="o">.</span><span class="n">__absolute_version__</span>

<span class="n">skyline_app</span> <span class="o">=</span> <span class="s1">&#39;webapp&#39;</span>
<span class="n">skyline_app_logger</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">Log&#39;</span> <span class="o">%</span> <span class="n">skyline_app</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="n">skyline_app_logger</span><span class="p">)</span>
<span class="n">skyline_app_logfile</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">.log&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">LOG_PATH</span><span class="p">,</span> <span class="n">skyline_app</span><span class="p">)</span>
<span class="n">skyline_app_loglock</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.lock&#39;</span> <span class="o">%</span> <span class="n">skyline_app_logfile</span>
<span class="n">skyline_app_logwait</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.wait&#39;</span> <span class="o">%</span> <span class="n">skyline_app_logfile</span>
<span class="n">logfile</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">.log&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">LOG_PATH</span><span class="p">,</span> <span class="n">skyline_app</span><span class="p">)</span>

<span class="c1"># werkzeug access log for Python errors</span>
<span class="n">access_logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s1">&#39;werkzeug&#39;</span><span class="p">)</span>

<span class="n">python_version</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">version_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="c1"># @added 20180721 - Feature #2464: luminosity_remote_data</span>
<span class="c1"># Use a gzipped response as the response as raw preprocessed time series</span>
<span class="c1"># added cStringIO to implement Gzip for particular views</span>
<span class="c1"># http://flask.pocoo.org/snippets/122/</span>
<span class="k">if</span> <span class="n">python_version</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">StringIO</span> <span class="kn">import</span> <span class="n">StringIO</span> <span class="k">as</span> <span class="n">IO</span>
<span class="k">if</span> <span class="n">python_version</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">io</span> <span class="k">as</span> <span class="nn">IO</span>

<span class="c1"># @modified 20180519 - Feature #2378: Add redis auth to Skyline and rebrow</span>
<span class="c1"># @modified 20191030 - Bug #3266: py3 Redis binary objects not strings</span>
<span class="c1">#                      Branch #3262: py3</span>
<span class="c1"># Use get_redis_conn and get_redis_conn_decoded</span>
<span class="c1"># if settings.REDIS_PASSWORD:</span>
    <span class="c1"># @modified 20190130 - Bug #3266: py3 Redis binary objects not strings</span>
    <span class="c1">#                      Branch #3262: py3</span>
    <span class="c1"># REDIS_CONN = redis.StrictRedis(password=settings.REDIS_PASSWORD, unix_socket_path=settings.REDIS_SOCKET_PATH)</span>
    <span class="c1"># REDIS_CONN = redis.StrictRedis(password=settings.REDIS_PASSWORD, unix_socket_path=settings.REDIS_SOCKET_PATH, charset=&#39;utf-8&#39;, decode_responses=True)</span>
    <span class="c1"># @added 20191015 - Bug #3266: py3 Redis binary objects not strings</span>
    <span class="c1">#                   Branch #3262: py3</span>
    <span class="c1"># REDIS_CONN_UNDECODE = redis.StrictRedis(password=settings.REDIS_PASSWORD, unix_socket_path=settings.REDIS_SOCKET_PATH)</span>
<span class="c1"># else:</span>
    <span class="c1"># REDIS_CONN = redis.StrictRedis(unix_socket_path=settings.REDIS_SOCKET_PATH)</span>
    <span class="c1"># REDIS_CONN = redis.StrictRedis(unix_socket_path=settings.REDIS_SOCKET_PATH, charset=&#39;utf-8&#39;, decode_responses=True)</span>
    <span class="c1"># @added 20191015 - Bug #3266: py3 Redis binary objects not strings</span>
    <span class="c1">#                   Branch #3262: py3</span>
    <span class="c1"># REDIS_CONN_UNDECODE = redis.StrictRedis(unix_socket_path=settings.REDIS_SOCKET_PATH)</span>

<span class="c1"># @added 20191030 - Bug #3266: py3 Redis binary objects not strings</span>
<span class="c1">#                   Branch #3262: py3</span>
<span class="c1"># Added a single functions to deal with Redis connection and the</span>
<span class="c1"># charset=&#39;utf-8&#39;, decode_responses=True arguments required in py3</span>
<span class="n">REDIS_CONN_UNDECODE</span> <span class="o">=</span> <span class="n">get_redis_conn</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">)</span>
<span class="n">REDIS_CONN</span> <span class="o">=</span> <span class="n">get_redis_conn_decoded</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">)</span>

<span class="n">ENABLE_WEBAPP_DEBUG</span> <span class="o">=</span> <span class="kc">False</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="c1"># @modified 20190502 - Branch #2646: slack</span>
<span class="c1"># Reduce logging, removed gunicorn</span>
<span class="c1"># gunicorn_error_logger = logging.getLogger(&#39;gunicorn.error&#39;)</span>
<span class="c1"># logger.handlers.extend(gunicorn_error_logger.handlers)</span>
<span class="c1"># logger.setLevel(logging.DEBUG)</span>

<span class="c1"># app.secret_key = str(uuid.uuid5(uuid.NAMESPACE_DNS, settings.GRAPHITE_HOST))</span>
<span class="n">secret_key</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid5</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">NAMESPACE_DNS</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">GRAPHITE_HOST</span><span class="p">))</span>
<span class="n">app</span><span class="o">.</span><span class="n">secret_key</span> <span class="o">=</span> <span class="n">secret_key</span>

<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;PROPAGATE_EXCEPTIONS&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

<span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
    <span class="n">SESSION_COOKIE_NAME</span><span class="o">=</span><span class="s1">&#39;skyline&#39;</span><span class="p">,</span>
    <span class="n">SESSION_COOKIE_SECURE</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">SECRET_KEY</span><span class="o">=</span><span class="n">secret_key</span>
<span class="p">)</span>

<span class="k">if</span> <span class="n">file_uploads_enabled</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;MAX_CONTENT_LENGTH&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">16</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span>
    <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;DATA_UPLOADS_PATH&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">DATA_UPLOADS_PATH</span>

<span class="n">graph_url_string</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">GRAPH_URL</span><span class="p">)</span>
<span class="n">PANORAMA_GRAPH_URL</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;\/render.*&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">graph_url_string</span><span class="p">)</span>

<span class="c1"># @added 20160727 - Bug #1524: Panorama dygraph not aligning correctly</span>
<span class="c1"># Defaults for momentjs to work if the setttings.py was not updated</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">WEBAPP_USER_TIMEZONE</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">WEBAPP_USER_TIMEZONE</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">WEBAPP_USER_TIMEZONE</span> <span class="o">=</span> <span class="kc">True</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">WEBAPP_FIXED_TIMEZONE</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">WEBAPP_FIXED_TIMEZONE</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">WEBAPP_FIXED_TIMEZONE</span> <span class="o">=</span> <span class="s1">&#39;Etc/GMT+0&#39;</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">WEBAPP_JAVASCRIPT_DEBUG</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">WEBAPP_JAVASCRIPT_DEBUG</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">WEBAPP_JAVASCRIPT_DEBUG</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1"># @added 20190520 - Branch #3002: docker</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">GRAPHITE_RENDER_URI</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">GRAPHITE_RENDER_URI</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">GRAPHITE_RENDER_URI</span> <span class="o">=</span> <span class="s1">&#39;render&#39;</span>

<span class="c1"># @added 20200731 - Feature #3654: IONOSPHERE_GRAPHITE_NOW_GRAPHS_OVERRIDE</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">IONOSPHERE_GRAPHITE_NOW_GRAPHS_OVERRIDE</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_GRAPHITE_NOW_GRAPHS_OVERRIDE</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">IONOSPHERE_GRAPHITE_NOW_GRAPHS_OVERRIDE</span> <span class="o">=</span> <span class="kc">False</span>


<div class="viewcode-block" id="limit_remote_addr"><a class="viewcode-back" href="../../skyline.webapp.html#webapp.webapp.limit_remote_addr">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">before_request</span>
<span class="c1"># def setup_logging():</span>
<span class="c1">#    if not app.debug:</span>
<span class="c1">#        stream_handler = logging.StreamHandler()</span>
<span class="c1">#        stream_handler.setLevel(logging.DEBUG)</span>
<span class="c1">#        app.logger.addHandler(stream_handler)</span>
<span class="c1">#        import logging</span>
<span class="c1">#        from logging.handlers import TimedRotatingFileHandler, MemoryHandler</span>
<span class="c1">#        file_handler = MemoryHandler(app_logfile, mode=&#39;a&#39;)</span>
<span class="c1">#        file_handler.setLevel(logging.DEBUG)</span>
<span class="c1">#        app.logger.addHandler(file_handler)</span>
<span class="c1">#</span>
<span class="c1">#        formatter = logging.Formatter(&quot;%(asctime)s :: %(process)s :: %(message)s&quot;, datefmt=&quot;%Y-%m-%d %H:%M:%S&quot;)</span>
<span class="c1">#        handler = logging.handlers.TimedRotatingFileHandler(</span>
<span class="c1">#            app_logfile,</span>
<span class="c1">#            when=&quot;midnight&quot;,</span>
<span class="c1">#            interval=1,</span>
<span class="c1">#            backupCount=5)</span>
<span class="c1">#        handler.setLevel(logging.DEBUG)</span>
<span class="c1">#</span>
<span class="c1">#        memory_handler = logging.handlers.MemoryHandler(100,</span>
<span class="c1">#                                                        flushLevel=logging.DEBUG,</span>
<span class="c1">#                                                        target=handler)</span>
<span class="c1">#        handler.setFormatter(formatter)</span>
<span class="c1">#        app.logger.addHandler(memory_handler)</span>
<span class="c1">#        app.logger.addHandler(handler)</span>
<span class="k">def</span> <span class="nf">limit_remote_addr</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This function is called to check if the requesting IP address is in the</span>
<span class="sd">    settings.WEBAPP_ALLOWED_IPS array, if not 403.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ip_allowed</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">for</span> <span class="n">web_allowed_ip</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">WEBAPP_ALLOWED_IPS</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">remote_addr</span> <span class="o">==</span> <span class="n">web_allowed_ip</span><span class="p">:</span>
            <span class="n">ip_allowed</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">settings</span><span class="o">.</span><span class="n">WEBAPP_IP_RESTRICTED</span><span class="p">:</span>
        <span class="n">ip_allowed</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">ip_allowed</span><span class="p">:</span>
        <span class="n">abort</span><span class="p">(</span><span class="mi">403</span><span class="p">)</span>  <span class="c1"># Forbidden</span></div>


<span class="c1"># @added 20200514 - Feature #3538: webapp - upload_data endoint</span>
<div class="viewcode-block" id="allowed_file"><a class="viewcode-back" href="../../skyline.webapp.html#webapp.webapp.allowed_file">[docs]</a><span class="k">def</span> <span class="nf">allowed_file</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="k">return</span> <span class="s1">&#39;.&#39;</span> <span class="ow">in</span> <span class="n">filename</span> <span class="ow">and</span> \
           <span class="n">filename</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">ALLOWED_EXTENSIONS</span></div>


<div class="viewcode-block" id="check_auth"><a class="viewcode-back" href="../../skyline.webapp.html#webapp.webapp.check_auth">[docs]</a><span class="k">def</span> <span class="nf">check_auth</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">password</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function is called to check if a username /</span>
<span class="sd">    password combination is valid.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">WEBAPP_AUTH_ENABLED</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">username</span> <span class="o">==</span> <span class="n">settings</span><span class="o">.</span><span class="n">WEBAPP_AUTH_USER</span> <span class="ow">and</span> <span class="n">password</span> <span class="o">==</span> <span class="n">settings</span><span class="o">.</span><span class="n">WEBAPP_AUTH_USER_PASSWORD</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="authenticate"><a class="viewcode-back" href="../../skyline.webapp.html#webapp.webapp.authenticate">[docs]</a><span class="k">def</span> <span class="nf">authenticate</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;Sends a 401 response that enables basic auth&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">Response</span><span class="p">(</span>
        <span class="s1">&#39;Forbidden&#39;</span><span class="p">,</span> <span class="mi">401</span><span class="p">,</span>
        <span class="p">{</span><span class="s1">&#39;WWW-Authenticate&#39;</span><span class="p">:</span> <span class="s1">&#39;Basic realm=&quot;Login Required&quot;&#39;</span><span class="p">})</span></div>


<div class="viewcode-block" id="requires_auth"><a class="viewcode-back" href="../../skyline.webapp.html#webapp.webapp.requires_auth">[docs]</a><span class="k">def</span> <span class="nf">requires_auth</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="nd">@wraps</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">decorated</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">WEBAPP_AUTH_ENABLED</span><span class="p">:</span>
            <span class="n">auth</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">authorization</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">auth</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">check_auth</span><span class="p">(</span><span class="n">auth</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">auth</span><span class="o">.</span><span class="n">password</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">authenticate</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="n">decorated</span></div>


<span class="c1"># @added 20180721 - Feature #2464: luminosity_remote_data</span>
<span class="c1"># Use a gzipped response as the response as raw preprocessed time series with</span>
<span class="c1"># an implementation of Gzip for particular views</span>
<span class="c1"># http://flask.pocoo.org/snippets/122/</span>
<div class="viewcode-block" id="gzipped"><a class="viewcode-back" href="../../skyline.webapp.html#webapp.webapp.gzipped">[docs]</a><span class="k">def</span> <span class="nf">gzipped</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
    <span class="nd">@functools</span><span class="o">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">view_func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nd">@after_this_request</span>
        <span class="k">def</span> <span class="nf">zipper</span><span class="p">(</span><span class="n">response</span><span class="p">):</span>
            <span class="n">accept_encoding</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;Accept-Encoding&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="s1">&#39;gzip&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">accept_encoding</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="k">return</span> <span class="n">response</span>

            <span class="n">response</span><span class="o">.</span><span class="n">direct_passthrough</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">&lt;</span> <span class="mi">200</span> <span class="ow">or</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">&gt;=</span> <span class="mi">300</span> <span class="ow">or</span> <span class="s1">&#39;Content-Encoding&#39;</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">response</span>
            <span class="n">gzip_buffer</span> <span class="o">=</span> <span class="n">IO</span><span class="p">()</span>
            <span class="n">gzip_file</span> <span class="o">=</span> <span class="n">gzip</span><span class="o">.</span><span class="n">GzipFile</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;wb&#39;</span><span class="p">,</span>
                                      <span class="n">fileobj</span><span class="o">=</span><span class="n">gzip_buffer</span><span class="p">)</span>
            <span class="n">gzip_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            <span class="n">gzip_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

            <span class="n">response</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">gzip_buffer</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span>
            <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Content-Encoding&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;gzip&#39;</span>
            <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Vary&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Accept-Encoding&#39;</span>
            <span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="p">[</span><span class="s1">&#39;Content-Length&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">response</span>

        <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">view_func</span></div>


<div class="viewcode-block" id="internal_error"><a class="viewcode-back" href="../../skyline.webapp.html#webapp.webapp.internal_error">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">errorhandler</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">traceback_format_exc</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Show traceback in the browser when running a flask app on a production</span>
<span class="sd">    server.</span>
<span class="sd">    By default, flask does not show any useful information when running on a</span>
<span class="sd">    production server.</span>
<span class="sd">    By adding this view, we output the Python traceback to the error 500 page</span>
<span class="sd">    and log.</span>

<span class="sd">    As per:</span>
<span class="sd">    Show flask traceback when running on production server</span>
<span class="sd">    https://gist.github.com/probonopd/8616a8ff05c8a75e4601 - Python traceback</span>
<span class="sd">    rendered nicely by Jinja2</span>

<span class="sd">    This can be tested by hitting SKYLINE_URL/a_500</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fail_msg</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
    <span class="n">trace</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">traceback_format_exc</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: returning 500 as there was an error, why else would 500 be returned...&#39;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: sending the user that caused the error to happen, this useful information&#39;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: but they or I may have already emailed it to you, you should check your inbox&#39;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">traceback_format_exc</span><span class="p">))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: which is accompanied with the message&#39;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: request url :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="p">))</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: request referrer :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">referrer</span><span class="p">))</span>
    <span class="c1"># resp = &#39;&lt;pre&gt;%s&lt;/pre&gt;&lt;pre&gt;%s&lt;/pre&gt;&#39; % (str(message), str(traceback_format_exc))</span>
<span class="c1">#    return(resp), 500</span>
    <span class="n">server_name</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">SERVER_METRICS_NAME</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span>
        <span class="s1">&#39;traceback.html&#39;</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="n">skyline_version</span><span class="p">,</span>
        <span class="n">message</span><span class="o">=</span><span class="n">fail_msg</span><span class="p">,</span> <span class="n">traceback</span><span class="o">=</span><span class="n">trace</span><span class="p">,</span> <span class="n">bad_machine</span><span class="o">=</span><span class="n">server_name</span><span class="p">),</span> <span class="mi">500</span></div>


<div class="viewcode-block" id="index"><a class="viewcode-back" href="../../skyline.webapp.html#webapp.webapp.index">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
<span class="nd">@requires_auth</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>

    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">if</span> <span class="s1">&#39;uh_oh&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span>
                <span class="s1">&#39;uh_oh.html&#39;</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="n">skyline_version</span><span class="p">,</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Testing uh_oh&quot;</span><span class="p">),</span> <span class="mi">200</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">error_string</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to render uh_oh.html: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">error_string</span><span class="p">))</span>
            <span class="k">return</span> <span class="s1">&#39;Uh oh ... a Skyline 500 :(&#39;</span><span class="p">,</span> <span class="mi">500</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span>
            <span class="s1">&#39;now.html&#39;</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="n">skyline_version</span><span class="p">,</span>
            <span class="n">duration</span><span class="o">=</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)),</span> <span class="mi">200</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">error_string</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to render index.html: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">error_string</span><span class="p">))</span>
        <span class="k">return</span> <span class="s1">&#39;Uh oh ... a Skyline 500 :(&#39;</span><span class="p">,</span> <span class="mi">500</span></div>


<div class="viewcode-block" id="a_500"><a class="viewcode-back" href="../../skyline.webapp.html#webapp.webapp.a_500">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/a_500&quot;</span><span class="p">)</span>
<span class="nd">@requires_auth</span>
<span class="k">def</span> <span class="nf">a_500</span><span class="p">():</span>

    <span class="k">if</span> <span class="s1">&#39;message&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;message&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: message - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">message</span><span class="p">))</span>
        <span class="n">test_500_string</span> <span class="o">=</span> <span class="n">message</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: testing /a_500 route and app.errorhandler(500) internal_error function&#39;</span><span class="p">)</span>
        <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Testing app.errorhandler(500) internal_error function, if you are seeing this it works - OK&#39;</span>
        <span class="n">test_500_string</span> <span class="o">=</span> <span class="s1">&#39;This is a test to generate a ValueError and a HTTP response of 500 and display the traceback&#39;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">test_errorhandler_500_internal_error</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">test_500_string</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s1">&#39;debug :: test_errorhandler_500_internal_error tests OK with </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">test_errorhandler_500_internal_error</span><span class="p">)))</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: test OK&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

    <span class="n">error_msg</span> <span class="o">=</span> <span class="s1">&#39;failed test of /a_500 route and app.errorhandler(500) internal_error function&#39;</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">error_msg</span><span class="p">)</span>
    <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="n">error_msg</span><span class="p">})</span>
    <span class="k">return</span> <span class="n">resp</span><span class="p">,</span> <span class="mi">501</span></div>


<div class="viewcode-block" id="now"><a class="viewcode-back" href="../../skyline.webapp.html#webapp.webapp.now">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/now&quot;</span><span class="p">)</span>
<span class="nd">@requires_auth</span>
<span class="k">def</span> <span class="nf">now</span><span class="p">():</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span>
            <span class="s1">&#39;now.html&#39;</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="n">skyline_version</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)),</span> <span class="mi">200</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">error_string</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to render now.html: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">error_string</span><span class="p">))</span>
        <span class="k">return</span> <span class="s1">&#39;Uh oh ... a Skyline 500 :(&#39;</span><span class="p">,</span> <span class="mi">500</span></div>


<div class="viewcode-block" id="then"><a class="viewcode-back" href="../../skyline.webapp.html#webapp.webapp.then">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/then&quot;</span><span class="p">)</span>
<span class="nd">@requires_auth</span>
<span class="k">def</span> <span class="nf">then</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;then.html&#39;</span><span class="p">),</span> <span class="mi">200</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">error_string</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to render then.html: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">error_string</span><span class="p">))</span>
        <span class="k">return</span> <span class="s1">&#39;Uh oh ... a Skyline 500 :(&#39;</span><span class="p">,</span> <span class="mi">500</span></div>


<div class="viewcode-block" id="anomalies"><a class="viewcode-back" href="../../skyline.webapp.html#webapp.webapp.anomalies">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/anomalies.json&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">anomalies</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">anomalies_json</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> <span class="s1">&#39;..&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">ANOMALY_DUMP</span><span class="p">))</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">anomalies_json</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json_data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to get anomalies.json: &#39;</span> <span class="o">+</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
        <span class="k">return</span> <span class="s1">&#39;Uh oh ... a Skyline 500 :(&#39;</span><span class="p">,</span> <span class="mi">500</span>
    <span class="k">return</span> <span class="n">json_data</span><span class="p">,</span> <span class="mi">200</span></div>


<div class="viewcode-block" id="panorama_anomalies"><a class="viewcode-back" href="../../skyline.webapp.html#webapp.webapp.panorama_anomalies">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/panorama.json&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">panorama_anomalies</span><span class="p">():</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">anomalies_json</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> <span class="s1">&#39;..&#39;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">ANOMALY_DUMP</span><span class="p">))</span>
        <span class="c1"># @modified 20191014 - Task #3270: Deprecate string.replace for py3</span>
        <span class="c1"># panorama_json = string.replace(str(anomalies_json), &#39;anomalies.json&#39;, &#39;panorama.json&#39;)</span>
        <span class="n">panorama_json</span> <span class="o">=</span> <span class="n">anomalies_json</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;anomalies.json&#39;</span><span class="p">,</span> <span class="s1">&#39;panorama.json&#39;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;opening - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">panorama_json</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">panorama_json</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">json_data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to get panorama.json: &#39;</span> <span class="o">+</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
        <span class="k">return</span> <span class="s1">&#39;Uh oh ... a Skyline 500 :(&#39;</span><span class="p">,</span> <span class="mi">500</span>
    <span class="k">return</span> <span class="n">json_data</span><span class="p">,</span> <span class="mi">200</span></div>


<div class="viewcode-block" id="app_settings"><a class="viewcode-back" href="../../skyline.webapp.html#webapp.webapp.app_settings">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/app_settings&quot;</span><span class="p">)</span>
<span class="nd">@requires_auth</span>
<span class="k">def</span> <span class="nf">app_settings</span><span class="p">():</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">app_settings</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;GRAPH_URL&#39;</span><span class="p">:</span> <span class="n">settings</span><span class="o">.</span><span class="n">GRAPH_URL</span><span class="p">,</span>
                        <span class="s1">&#39;OCULUS_HOST&#39;</span><span class="p">:</span> <span class="n">settings</span><span class="o">.</span><span class="n">OCULUS_HOST</span><span class="p">,</span>
                        <span class="s1">&#39;FULL_NAMESPACE&#39;</span><span class="p">:</span> <span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span><span class="p">,</span>
                        <span class="s1">&#39;SKYLINE_VERSION&#39;</span><span class="p">:</span> <span class="n">skyline_version</span><span class="p">,</span>
                        <span class="s1">&#39;PANORAMA_ENABLED&#39;</span><span class="p">:</span> <span class="n">settings</span><span class="o">.</span><span class="n">PANORAMA_ENABLED</span><span class="p">,</span>
                        <span class="s1">&#39;PANORAMA_DATABASE&#39;</span><span class="p">:</span> <span class="n">settings</span><span class="o">.</span><span class="n">PANORAMA_DATABASE</span><span class="p">,</span>
                        <span class="s1">&#39;PANORAMA_DBHOST&#39;</span><span class="p">:</span> <span class="n">settings</span><span class="o">.</span><span class="n">PANORAMA_DBHOST</span><span class="p">,</span>
                        <span class="s1">&#39;PANORAMA_DBPORT&#39;</span><span class="p">:</span> <span class="n">settings</span><span class="o">.</span><span class="n">PANORAMA_DBPORT</span><span class="p">,</span>
                        <span class="s1">&#39;PANORAMA_DBUSER&#39;</span><span class="p">:</span> <span class="n">settings</span><span class="o">.</span><span class="n">PANORAMA_DBUSER</span><span class="p">,</span>
                        <span class="s1">&#39;PANORAMA_DBUSERPASS&#39;</span><span class="p">:</span> <span class="s1">&#39;redacted&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;PANORAMA_GRAPH_URL&#39;</span><span class="p">:</span> <span class="n">PANORAMA_GRAPH_URL</span><span class="p">,</span>
                        <span class="s1">&#39;WEBAPP_USER_TIMEZONE&#39;</span><span class="p">:</span> <span class="n">settings</span><span class="o">.</span><span class="n">WEBAPP_USER_TIMEZONE</span><span class="p">,</span>
                        <span class="s1">&#39;WEBAPP_FIXED_TIMEZONE&#39;</span><span class="p">:</span> <span class="n">settings</span><span class="o">.</span><span class="n">WEBAPP_FIXED_TIMEZONE</span><span class="p">,</span>
                        <span class="s1">&#39;WEBAPP_JAVASCRIPT_DEBUG&#39;</span><span class="p">:</span> <span class="n">settings</span><span class="o">.</span><span class="n">WEBAPP_JAVASCRIPT_DEBUG</span>
                        <span class="p">}</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;error: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s1">&#39;app_settings&#39;</span><span class="p">:</span> <span class="n">error</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">resp</span><span class="p">,</span> <span class="mi">500</span>

    <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">app_settings</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">resp</span><span class="p">,</span> <span class="mi">200</span></div>


<div class="viewcode-block" id="version"><a class="viewcode-back" href="../../skyline.webapp.html#webapp.webapp.version">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/version&quot;</span><span class="p">)</span>
<span class="nd">@requires_auth</span>
<span class="k">def</span> <span class="nf">version</span><span class="p">():</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">version_settings</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;SKYLINE_VERSION&#39;</span><span class="p">:</span> <span class="n">skyline_version</span><span class="p">}</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">version_settings</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">resp</span><span class="p">,</span> <span class="mi">200</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;Not Found&quot;</span><span class="p">,</span> <span class="mi">404</span></div>


<div class="viewcode-block" id="api"><a class="viewcode-back" href="../../skyline.webapp.html#webapp.webapp.api">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/api&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="c1"># @modified 20180720 - Feature #2464: luminosity_remote_data</span>
<span class="c1"># Rnamed def from data to api for the purpose of trying to add some</span>
<span class="c1"># documentation relating to the API endpoints and their required parameters,</span>
<span class="c1"># the results or error and status codes they return and the context in which</span>
<span class="c1"># they are used.</span>
<span class="c1"># def data():</span>
<span class="k">def</span> <span class="nf">api</span><span class="p">():</span>

    <span class="c1"># @added 20200611 - Feature #3578: Test alerts</span>
    <span class="k">if</span> <span class="s1">&#39;test_alert&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?test_alert request&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;skyline_app&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">test_skyline_app</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;skyline_app&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">test_skyline_app</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: /api?test_alert request no skyline_app parameter sent&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;Bad Request&#39;</span><span class="p">,</span> <span class="mi">400</span>
        <span class="k">if</span> <span class="s1">&#39;metric&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">metric</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;metric&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">metric</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: /api?test_alert request no metric parameter sent&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;Bad Request&#39;</span><span class="p">,</span> <span class="mi">400</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?test_alert request with skyline_app - </span><span class="si">%s</span><span class="s1"> and metric - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">test_skyline_app</span><span class="p">,</span> <span class="n">metric</span><span class="p">))</span>
        <span class="n">test_alert_redis_key</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.test_alerts&#39;</span> <span class="o">%</span> <span class="n">test_skyline_app</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="n">test_alert_redis_key</span><span class="p">,</span> <span class="n">metric</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: could not add </span><span class="si">%s</span><span class="s1"> to </span><span class="si">%s</span><span class="s1"> Redis set&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">test_skyline_app</span><span class="p">,</span> <span class="n">metric</span><span class="p">))</span>
            <span class="k">return</span> <span class="s1">&#39;Internal Server Error&#39;</span><span class="p">,</span> <span class="mi">500</span>
        <span class="n">test_alert_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;skyline_app&#39;</span><span class="p">:</span> <span class="n">test_skyline_app</span><span class="p">,</span>
            <span class="s1">&#39;metric&#39;</span><span class="p">:</span> <span class="n">metric</span>
        <span class="p">}</span>
        <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;test_alert&quot;</span><span class="p">:</span> <span class="n">test_alert_dict</span><span class="p">}}</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?test_alert request returning data - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">data_dict</span><span class="p">)))</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">200</span>

    <span class="c1"># @added 20200517 - Feature #3538: webapp - upload_data endpoint</span>
    <span class="c1">#                   Feature #3550: flux.uploaded_data_worker</span>
    <span class="k">if</span> <span class="s1">&#39;upload_status&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?upload_status request&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">file_uploads_enabled</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;Not Found&#39;</span><span class="p">,</span> <span class="mi">404</span>
        <span class="k">if</span> <span class="s1">&#39;upload_id_key&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">upload_id_key</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;upload_id_key&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">upload_id_key</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: /api?upload_status request&#39;</span><span class="p">)</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;no upload_id_key was passed&#39;</span><span class="p">})</span>
            <span class="k">return</span> <span class="n">resp</span><span class="p">,</span> <span class="mi">400</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?upload_status request for upload_id_key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">upload_id_key</span><span class="p">)</span>
        <span class="n">upload_status_redis_key</span> <span class="o">=</span> <span class="s1">&#39;flux.upload_status.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">upload_id_key</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">upload_status</span> <span class="o">=</span> <span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">upload_status_redis_key</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">upload_status</span><span class="p">:</span>
                <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                    <span class="p">{</span><span class="s1">&#39;not found&#39;</span><span class="p">:</span> <span class="s1">&#39;there is not status for &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">upload_id_key</span><span class="p">)})</span>
                <span class="k">return</span> <span class="n">flask_escape</span><span class="p">(</span><span class="n">resp</span><span class="p">),</span> <span class="mi">404</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: could not get the </span><span class="si">%s</span><span class="s1"> from Redis&#39;</span> <span class="o">%</span> <span class="n">upload_status_redis_key</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: /api?upload_status request&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;Internal Server Error&#39;</span><span class="p">,</span> <span class="mi">500</span>
        <span class="n">upload_status_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">upload_status</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">upload_status_dict</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">upload_status</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: could not literal_eval the </span><span class="si">%s</span><span class="s1"> data from Redis&#39;</span> <span class="o">%</span> <span class="n">upload_status_redis_key</span><span class="p">)</span>
                <span class="k">return</span> <span class="s1">&#39;Internal Server Error&#39;</span><span class="p">,</span> <span class="mi">500</span>
        <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;upload&quot;</span><span class="p">:</span> <span class="n">upload_status_dict</span><span class="p">}}</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?upload_status request for upload_id_key - </span><span class="si">%s</span><span class="s1">, returning data&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="n">upload_id_key</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">200</span>

    <span class="c1"># @added 20200410 - Feature #3474: webapp api - training_data</span>
    <span class="c1">#                   Feature #3472: ionosphere.training_data Redis set</span>
    <span class="k">if</span> <span class="s1">&#39;training_data&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="n">metric_filter</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">timestamp_filter</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s1">&#39;metric&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">metric_filter</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;metric&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;timestamp&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">timestamp_filter</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;timestamp&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">training_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">training_data_raw</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="s1">&#39;ionosphere.training_data&#39;</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">training_data_str</span> <span class="ow">in</span> <span class="n">training_data_raw</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">training_data_item</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">training_data_str</span><span class="p">)</span>
                <span class="n">training_metric</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">training_data_item</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">training_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">training_data_item</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="c1"># @added 20200425 - Feature #3508: ionosphere.untrainable_metrics</span>
                <span class="c1"># Added resolution_seconds</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">training_resolution_seconds</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">training_data_item</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">training_resolution_seconds</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">training_resolution_seconds</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">alert</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">ALERTS</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">training_resolution_seconds</span><span class="p">:</span>
                            <span class="k">break</span>
                        <span class="n">alert_match_pattern</span> <span class="o">=</span> <span class="n">alert</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">metric_pattern</span> <span class="o">=</span> <span class="n">training_metric</span>
                        <span class="n">pattern_match</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">alert_match_pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">alert_match_pattern</span><span class="p">)</span>
                            <span class="n">pattern_match</span> <span class="o">=</span> <span class="n">alert_match_pattern</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">metric_pattern</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">pattern_match</span><span class="p">:</span>
                                <span class="n">pattern_match</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">pattern_match</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">pattern_match</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">alert</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">training_metric</span><span class="p">:</span>
                                <span class="n">pattern_match</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">pattern_match</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">training_resolution_seconds</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">alert</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3600</span><span class="p">)</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">training_resolution_seconds</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">training_resolution_seconds</span><span class="p">:</span>
                    <span class="n">training_resolution_seconds</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FULL_DURATION</span>

                <span class="n">add_to_response</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">metric_filter</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">metric_filter</span> <span class="o">!=</span> <span class="n">training_metric</span><span class="p">:</span>
                        <span class="n">add_to_response</span> <span class="o">=</span> <span class="kc">False</span>

                    <span class="c1"># @added 20200417 - Feature #3474: webapp api - training_data</span>
                    <span class="c1"># Allow to match namespaces too</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">add_to_response</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">metric_filter</span> <span class="ow">in</span> <span class="n">training_metric</span><span class="p">:</span>
                            <span class="n">add_to_response</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">add_to_response</span><span class="p">:</span>
                        <span class="n">metric_filter_namespace_elements</span> <span class="o">=</span> <span class="n">metric_filter</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
                        <span class="n">training_metric_namespace_elements</span> <span class="o">=</span> <span class="n">training_metric</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
                        <span class="n">elements_matched</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">metric_filter_namespace_elements</span><span class="p">)</span> <span class="o">&amp;</span> <span class="nb">set</span><span class="p">(</span><span class="n">training_metric_namespace_elements</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">elements_matched</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">metric_filter_namespace_elements</span><span class="p">):</span>
                            <span class="n">add_to_response</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="k">if</span> <span class="n">timestamp_filter</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">timestamp_filter</span><span class="p">)</span> <span class="o">!=</span> <span class="n">training_timestamp</span><span class="p">:</span>
                        <span class="n">add_to_response</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="c1"># @added 20200425 - Feature #3508: ionosphere.untrainable_metrics</span>
                <span class="c1"># Remove ionosphere.untrainable_metrics from the training data</span>
                <span class="c1"># when entries exist at the same resolution</span>
                <span class="n">ionosphere_untrainable_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">ionosphere_untrainable_metrics_redis_set</span> <span class="o">=</span> <span class="s1">&#39;ionosphere.untrainable_metrics&#39;</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">ionosphere_untrainable_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="n">ionosphere_untrainable_metrics_redis_set</span><span class="p">))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: could not get the ionosphere.untrainable_metrics set from Redis&#39;</span><span class="p">)</span>
                    <span class="n">ionosphere_untrainable_metrics</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">add_to_response</span> <span class="ow">and</span> <span class="n">ionosphere_untrainable_metrics</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">ionosphere_untrainable_metric_str</span> <span class="ow">in</span> <span class="n">ionosphere_untrainable_metrics</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">ionosphere_untrainable_metric</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">ionosphere_untrainable_metric_str</span><span class="p">)</span>
                            <span class="n">ium_metric_name</span> <span class="o">=</span> <span class="n">ionosphere_untrainable_metric</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="k">if</span> <span class="n">ium_metric_name</span> <span class="o">==</span> <span class="n">training_metric</span><span class="p">:</span>
                                <span class="n">ium_resolution</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ionosphere_untrainable_metric</span><span class="p">[</span><span class="mi">5</span><span class="p">])</span>
                                <span class="k">if</span> <span class="n">ium_resolution</span> <span class="o">==</span> <span class="n">training_resolution_seconds</span><span class="p">:</span>
                                    <span class="n">add_to_response</span> <span class="o">=</span> <span class="kc">False</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;removed training data from response as identified as untrainable as has negative value/s - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">ionosphere_untrainable_metric</span><span class="p">))</span>
                                    <span class="k">break</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to determine if metric is in ionosphere.untrainable_metrics Redis set&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">add_to_response</span><span class="p">:</span>
                    <span class="n">training_data</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">training_metric</span><span class="p">,</span> <span class="n">training_timestamp</span><span class="p">])</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s1">&#39;error :: failed to iterate literal_eval of training_data_raw&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="s1">&#39;Internal Server Error&#39;</span><span class="p">,</span> <span class="mi">500</span>
        <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;metrics&quot;</span><span class="p">:</span> <span class="n">training_data</span><span class="p">}}</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">200</span>

    <span class="c1"># @added 20200129 - Feature #3422: webapp api - alerting_metrics and non_alerting_metrics</span>
    <span class="k">if</span> <span class="s1">&#39;non_alerting_metrics&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="n">non_alerting_metrics</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">non_alerting_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="s1">&#39;aet.analyzer.non_smtp_alerter_metrics&#39;</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: Webapp could not get the aet.analyzer.smtp_alerter_metrics list from Redis&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;Internal Server Error&#39;</span><span class="p">,</span> <span class="mi">500</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?non_alerting_metrics responding with </span><span class="si">%s</span><span class="s1"> metrics&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">non_alerting_metrics</span><span class="p">)))</span>
        <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;metrics&quot;</span><span class="p">:</span> <span class="n">non_alerting_metrics</span><span class="p">}}</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">200</span>
    <span class="k">if</span> <span class="s1">&#39;alerting_metrics&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="n">alerting_metrics</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">alerting_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="s1">&#39;aet.analyzer.smtp_alerter_metrics&#39;</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: Webapp could not get the aet.analyzer.smtp_alerter_metrics list from Redis&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;Internal Server Error&#39;</span><span class="p">,</span> <span class="mi">500</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/api?non_alerting_metrics responding with </span><span class="si">%s</span><span class="s1"> metrics&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">alerting_metrics</span><span class="p">)))</span>
        <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;metrics&quot;</span><span class="p">:</span> <span class="n">alerting_metrics</span><span class="p">}}</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">200</span>

    <span class="c1"># @added 20200117 - Feature #3400: Identify air gaps in the metric data</span>
    <span class="k">if</span> <span class="s1">&#39;airgapped_metrics&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="n">airgapped_metrics</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">airgapped_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="s1">&#39;analyzer.airgapped_metrics&#39;</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: Webapp could not get the analyzer.airgapped_metrics list from Redis&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;Internal Server Error&#39;</span><span class="p">,</span> <span class="mi">500</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;airgapped_metrics responding with </span><span class="si">%s</span><span class="s1"> metrics&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">airgapped_metrics</span><span class="p">)))</span>
        <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;metrics&quot;</span><span class="p">:</span> <span class="n">airgapped_metrics</span><span class="p">}}</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">200</span>
    <span class="c1"># @added 20200205 - Feature #3400: Identify air gaps in the metric data</span>
    <span class="c1"># /api?airgap_filled&amp;metric=&lt;metric&gt;&amp;resoluion=&lt;resolution&gt;&amp;start=&lt;start-unix-timestamp&gt;&amp;end=&lt;end-unix-timestamp&gt;&amp;attempt&lt;attempts&gt;</span>
    <span class="k">if</span> <span class="s1">&#39;airgap_filled&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="n">metric</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">resolution</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">start</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">end</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">attempts</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;api?airgap_filled - request argument - </span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>
        <span class="k">if</span> <span class="s1">&#39;metric&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">metric</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;metric&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">metric</span><span class="p">:</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="s1">&#39;Error: no metric parameter was passed to /api?airgap_filled&#39;</span><span class="p">})</span>
            <span class="k">return</span> <span class="n">resp</span><span class="p">,</span> <span class="mi">400</span>
        <span class="k">if</span> <span class="s1">&#39;resolution&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">resolution</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;resolution&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">resolution</span><span class="p">:</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="s1">&#39;Error: no resolution parameter was passed to /api?airgap_filled&#39;</span><span class="p">})</span>
            <span class="k">return</span> <span class="n">resp</span><span class="p">,</span> <span class="mi">400</span>
        <span class="k">if</span> <span class="s1">&#39;start&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">start</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;start&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">start</span><span class="p">:</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="s1">&#39;Error: no start parameter was passed to /api?airgap_filled&#39;</span><span class="p">})</span>
            <span class="k">return</span> <span class="n">resp</span><span class="p">,</span> <span class="mi">400</span>
        <span class="k">if</span> <span class="s1">&#39;end&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;end&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">end</span><span class="p">:</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="s1">&#39;Error: no end parameter was passed to /api?airgap_filled&#39;</span><span class="p">})</span>
            <span class="k">return</span> <span class="n">resp</span><span class="p">,</span> <span class="mi">400</span>
        <span class="k">if</span> <span class="s1">&#39;attempts&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">attempts</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;attempts&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">attempts</span><span class="p">:</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="s1">&#39;Error: no attempts parameter was passed to /api?airgap_filled&#39;</span><span class="p">})</span>
            <span class="k">return</span> <span class="n">resp</span><span class="p">,</span> <span class="mi">400</span>
        <span class="c1"># Check airgap is in the set</span>
        <span class="n">airgapped_metrics</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">airgapped_metrics</span> <span class="o">=</span> <span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="s1">&#39;analyzer.airgapped_metrics&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: Webapp could not get the analyzer.airgapped_metrics list from Redis&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;Internal Server Error&#39;</span><span class="p">,</span> <span class="mi">500</span>
        <span class="n">airgap_present</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">airgap_str</span> <span class="ow">in</span> <span class="n">airgapped_metrics</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">airgap</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">airgap_str</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span> <span class="o">!=</span> <span class="p">(</span><span class="n">airgap</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">resolution</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">int</span><span class="p">(</span><span class="n">airgap</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">start</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">int</span><span class="p">(</span><span class="n">airgap</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">end</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">int</span><span class="p">(</span><span class="n">airgap</span><span class="p">[</span><span class="mi">3</span><span class="p">]):</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">attempts</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">int</span><span class="p">(</span><span class="n">airgap</span><span class="p">[</span><span class="mi">4</span><span class="p">]):</span>
                    <span class="k">continue</span>
                <span class="n">airgap_present</span> <span class="o">=</span> <span class="n">airgap</span>
                <span class="k">break</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to iterate literal_eval of airgapped_metrics&#39;</span><span class="p">)</span>
                <span class="k">continue</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">airgap_present</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;api?airgap_filled responding with 404 no matching airgap found in analyzer.airgapped_metrics Redis set&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;Not found&#39;</span><span class="p">,</span> <span class="mi">404</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;removing airgapped metric item - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">airgap</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">REDIS_CONN_UNDECODE</span><span class="o">.</span><span class="n">srem</span><span class="p">(</span><span class="s1">&#39;analyzer.airgapped_metrics&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">airgap</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: could not remove item from analyzer.airgapped_metrics Redis set - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;Error: could not remove item from analyzer.airgapped_metrics Redis set&#39;</span><span class="p">})</span>
            <span class="k">return</span> <span class="n">resp</span><span class="p">,</span> <span class="mi">500</span>
        <span class="c1"># @added 20200501 - Feature #3400: Identify air gaps in the metric data</span>
        <span class="c1"># Handle airgaps filled so that once they have been submitted as filled</span>
        <span class="c1"># Analyzer will not identify them as airgapped again</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="s1">&#39;analyzer.airgapped_metrics.filled&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">airgap</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: could not add item from analyzer.airgapped_metrics.filled Redis set - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>

        <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;removed_airgap&quot;</span><span class="p">:</span> <span class="n">airgap</span><span class="p">}}</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">200</span>

    <span class="c1"># @added 20191231 - Feature #3368: webapp api - ionosphere_learn_work</span>
    <span class="k">if</span> <span class="s1">&#39;ionosphere_learn_work&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ionosphere_learn_work</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="s1">&#39;ionosphere.learn.work&#39;</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: Webapp could not get the ionosphere.learn.work list from Redis&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;Internal Server Error&#39;</span><span class="p">,</span> <span class="mi">500</span>

        <span class="c1"># @added 20200109 - Feature #3380: Create echo features profile when a Mirage features profile is created</span>
        <span class="c1"># Add pending echo features profiles to the to response</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ionosphere_echo_work</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="s1">&#39;ionosphere.echo.work&#39;</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: Webapp could not get the ionosphere.echo.work list from Redis&#39;</span><span class="p">)</span>
        <span class="n">echo_work_no_full_duration</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">ionosphere_echo_work</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">work</span> <span class="ow">in</span> <span class="n">ionosphere_echo_work</span><span class="p">:</span>
                <span class="n">work_list</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">work</span><span class="p">)</span>
                <span class="n">work_no_fd</span> <span class="o">=</span> <span class="p">[</span><span class="n">work_list</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">work_list</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">work_list</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">work_list</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">work_list</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">work_list</span><span class="p">[</span><span class="mi">5</span><span class="p">]]</span>
                <span class="n">echo_work_no_full_duration</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">work_no_fd</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">echo_work_no_full_duration</span><span class="p">:</span>
            <span class="n">new_ionosphere_learn_work</span> <span class="o">=</span> <span class="n">ionosphere_learn_work</span> <span class="o">+</span> <span class="n">echo_work_no_full_duration</span>
            <span class="n">ionosphere_learn_work</span> <span class="o">=</span> <span class="n">new_ionosphere_learn_work</span>

        <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;metrics&quot;</span><span class="p">:</span> <span class="n">ionosphere_learn_work</span><span class="p">}}</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">200</span>

    <span class="c1"># @added 20191203 - Feature #3350: webapp api - mirage_metrics and ionosphere_metrics</span>
    <span class="k">if</span> <span class="s1">&#39;mirage_metrics&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">mirage_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="s1">&#39;mirage.unique_metrics&#39;</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: Webapp could not get the mirage.unique_metrics list from Redis&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;Internal Server Error&#39;</span><span class="p">,</span> <span class="mi">500</span>
        <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;metrics&quot;</span><span class="p">:</span> <span class="n">mirage_metrics</span><span class="p">}}</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">200</span>

    <span class="c1"># @added 20191203 - Feature #3350: webapp api - mirage_metrics and ionosphere_metrics</span>
    <span class="k">if</span> <span class="s1">&#39;ionosphere_metrics&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ionosphere_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="s1">&#39;ionosphere.unique_metrics&#39;</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: Webapp could not get the ionosphere.unique_metrics list from Redis&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;Internal Server Error&#39;</span><span class="p">,</span> <span class="mi">500</span>
        <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{},</span>
            <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;metrics&quot;</span><span class="p">:</span> <span class="n">ionosphere_metrics</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">200</span>

    <span class="c1"># @added 20191126 - Feature #3336: webapp api - derivative_metrics</span>
    <span class="k">if</span> <span class="s1">&#39;derivative_metrics&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">derivative_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="s1">&#39;derivative_metrics&#39;</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: Webapp could not get the derivative_metrics list from Redis&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;Internal Server Error&#39;</span><span class="p">,</span> <span class="mi">500</span>
        <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{},</span>
            <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;metrics&quot;</span><span class="p">:</span> <span class="n">derivative_metrics</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">200</span>

    <span class="c1"># @added 20191008 - Feature #3252: webapp api - unique_metrics</span>
    <span class="k">if</span> <span class="s1">&#39;unique_metrics&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">unique_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span> <span class="o">+</span> <span class="s1">&#39;unique_metrics&#39;</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: Webapp could not get the unique_metrics list from Redis&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;Internal Server Error&#39;</span><span class="p">,</span> <span class="mi">500</span>
        <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{},</span>
            <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;metrics&quot;</span><span class="p">:</span> <span class="n">unique_metrics</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">200</span>

    <span class="c1"># @added 20180929</span>
    <span class="k">if</span> <span class="s1">&#39;get_json&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="n">source</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">metric</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">timestamp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">full_duration_data</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="s1">&#39;source&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">valid_source</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">source</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;source&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">source</span> <span class="o">==</span> <span class="s1">&#39;features_profile&#39;</span> <span class="ow">or</span> <span class="n">source</span> <span class="o">==</span> <span class="s1">&#39;training_data&#39;</span><span class="p">:</span>
                <span class="n">valid_source</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_source</span><span class="p">:</span>
                <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                    <span class="p">{</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="s1">&#39;Error: an invalid source parameter was passed to /api?get_json valid sources are features_profile or training_data&#39;</span><span class="p">})</span>
                <span class="k">return</span> <span class="n">resp</span><span class="p">,</span> <span class="mi">400</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="s1">&#39;Error: the required parameter source was not passed to /api?get_json - valid sources are features_profile or training_data&#39;</span><span class="p">})</span>
            <span class="k">return</span> <span class="n">resp</span><span class="p">,</span> <span class="mi">400</span>
        <span class="k">if</span> <span class="s1">&#39;metric&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">metric</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;metric&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">metric</span><span class="p">:</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="s1">&#39;Error: no metric parameter was passed to /api?get_json&#39;</span><span class="p">})</span>
            <span class="k">return</span> <span class="n">resp</span><span class="p">,</span> <span class="mi">400</span>
        <span class="k">if</span> <span class="s1">&#39;timestamp&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">timestamp</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;timestamp&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">timestamp</span><span class="p">:</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="s1">&#39;Error: no timestamp parameter was passed to /api?get_json&#39;</span><span class="p">})</span>
            <span class="k">return</span> <span class="n">resp</span><span class="p">,</span> <span class="mi">400</span>
        <span class="k">if</span> <span class="n">metric</span> <span class="ow">and</span> <span class="n">timestamp</span><span class="p">:</span>
            <span class="n">tuple_json_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.json&#39;</span> <span class="o">%</span> <span class="n">metric</span>
            <span class="k">if</span> <span class="s1">&#39;full_duration_data&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                <span class="n">full_duration_data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;full_duration_data&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">full_duration_data</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                    <span class="n">full_duration_in_hours</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FULL_DURATION</span> <span class="o">/</span> <span class="mi">60</span> <span class="o">/</span> <span class="mi">60</span><span class="p">)</span>
                    <span class="n">tuple_json_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.mirage.redis.</span><span class="si">%s</span><span class="s1">h.json&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">full_duration_in_hours</span><span class="p">))</span>
            <span class="n">metric_timeseries_dir</span> <span class="o">=</span> <span class="n">metric</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">source</span> <span class="o">==</span> <span class="s1">&#39;features_profile&#39;</span><span class="p">:</span>
                <span class="n">source_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_PROFILES_FOLDER</span><span class="p">,</span> <span class="n">metric_timeseries_dir</span><span class="p">,</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">timestamp</span><span class="p">),</span> <span class="n">tuple_json_file</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">source</span> <span class="o">==</span> <span class="s1">&#39;training_data&#39;</span><span class="p">:</span>
                <span class="n">source_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_DATA_FOLDER</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">timestamp</span><span class="p">),</span>
                    <span class="n">metric_timeseries_dir</span><span class="p">,</span> <span class="n">tuple_json_file</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;converting tuple data for </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1"> at </span><span class="si">%s</span><span class="s1"> to json&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">))</span>
            <span class="n">datapoints</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">source_file</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: file not found - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">source_file</span><span class="p">)</span>
                <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                    <span class="p">{</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="s1">&#39;404 data file not found&#39;</span><span class="p">})</span>
                <span class="k">return</span> <span class="n">resp</span><span class="p">,</span> <span class="mi">404</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">source_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">datapoints</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">line</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;(&#39;</span><span class="p">,</span> <span class="s1">&#39;[&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;)&#39;</span><span class="p">,</span> <span class="s1">&#39;]&#39;</span><span class="p">)</span>
            <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;metric&#39;</span><span class="p">:</span> <span class="n">metric</span><span class="p">}</span>
            <span class="n">datapoints</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">datapoints</span><span class="p">)</span>
            <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;datapoints&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datapoints</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">200</span>

    <span class="c1"># @added 20180720 - Feature #2464: luminosity_remote_data</span>
    <span class="c1"># Added luminosity_remote_data endpoint, requires two request parameter:</span>
    <span class="k">if</span> <span class="s1">&#39;luminosity_remote_data&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="n">anomaly_timestamp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s1">&#39;anomaly_timestamp&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">anomaly_timestamp_str</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;anomaly_timestamp&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">anomaly_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">anomaly_timestamp_str</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">anomaly_timestamp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="s1">&#39;Error: no anomaly_timestamp parameter was passed to /api?luminosity_remote_data&#39;</span><span class="p">})</span>
            <span class="k">return</span> <span class="n">resp</span><span class="p">,</span> <span class="mi">400</span>
        <span class="n">luminosity_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">anomaly_timestamp</span><span class="p">:</span>
            <span class="n">luminosity_data</span><span class="p">,</span> <span class="n">success</span><span class="p">,</span> <span class="n">message</span> <span class="o">=</span> <span class="n">luminosity_remote_data</span><span class="p">(</span><span class="n">anomaly_timestamp</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">luminosity_data</span><span class="p">:</span>
                <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                    <span class="p">{</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="n">luminosity_data</span><span class="p">})</span>
                <span class="k">return</span> <span class="n">resp</span><span class="p">,</span> <span class="mi">200</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                    <span class="p">{</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="s1">&#39;No data found&#39;</span><span class="p">})</span>
                <span class="k">return</span> <span class="n">resp</span><span class="p">,</span> <span class="mi">404</span>

    <span class="k">if</span> <span class="s1">&#39;metric&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="n">metric</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;metric&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># @modified 20200225 - Bug #3266: py3 Redis binary objects not strings</span>
            <span class="c1">#                      Branch #3262: py3</span>
            <span class="c1"># raw_series = REDIS_CONN.get(metric)</span>
            <span class="n">raw_series</span> <span class="o">=</span> <span class="n">REDIS_CONN_UNDECODE</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">metric</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">raw_series</span><span class="p">:</span>
                <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                    <span class="p">{</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="s1">&#39;Error: No metric by that name - try /api?metric=&#39;</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span> <span class="o">+</span> <span class="s1">&#39;metric_namespace&#39;</span><span class="p">})</span>
                <span class="k">return</span> <span class="n">resp</span><span class="p">,</span> <span class="mi">404</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">unpacker</span> <span class="o">=</span> <span class="n">Unpacker</span><span class="p">(</span><span class="n">use_list</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">unpacker</span><span class="o">.</span><span class="n">feed</span><span class="p">(</span><span class="n">raw_series</span><span class="p">)</span>
                <span class="n">timeseries</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">unpacker</span><span class="p">]</span>
                <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="n">timeseries</span><span class="p">})</span>
                <span class="k">return</span> <span class="n">resp</span><span class="p">,</span> <span class="mi">200</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">error</span> <span class="o">=</span> <span class="s2">&quot;Error: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="n">error</span><span class="p">})</span>
            <span class="k">return</span> <span class="n">resp</span><span class="p">,</span> <span class="mi">500</span>

    <span class="k">if</span> <span class="s1">&#39;graphite_metric&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;processing graphite_metric api request&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;request argument - </span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>

        <span class="n">valid_request</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">missing_arguments</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">metric</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;graphite_metric&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">from_timestamp</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;from_timestamp&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">until_timestamp</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;until_timestamp&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">metric</span><span class="p">:</span>
            <span class="n">valid_request</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">missing_arguments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;graphite_metric&#39;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;graphite_metric argument not found&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;graphite_metric - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">metric</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">from_timestamp</span><span class="p">:</span>
            <span class="n">valid_request</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">missing_arguments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;from_timestamp&#39;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;from_timestamp argument not found&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;from_timestamp - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">from_timestamp</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">until_timestamp</span><span class="p">:</span>
            <span class="n">valid_request</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">missing_arguments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;until_timestamp&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;until_timestamp - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">until_timestamp</span><span class="p">))</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_request</span><span class="p">:</span>
            <span class="n">error</span> <span class="o">=</span> <span class="s1">&#39;Error: not all arguments where passed, missing </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">missing_arguments</span><span class="p">)</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="n">error</span><span class="p">})</span>
            <span class="k">return</span> <span class="n">resp</span><span class="p">,</span> <span class="mi">404</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;requesting data from graphite for </span><span class="si">%s</span><span class="s1"> from </span><span class="si">%s</span><span class="s1"> to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">from_timestamp</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">until_timestamp</span><span class="p">)))</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">timeseries</span> <span class="o">=</span> <span class="n">get_graphite_metric</span><span class="p">(</span>
                <span class="n">skyline_app</span><span class="p">,</span> <span class="n">metric</span><span class="p">,</span> <span class="n">from_timestamp</span><span class="p">,</span> <span class="n">until_timestamp</span><span class="p">,</span> <span class="s1">&#39;json&#39;</span><span class="p">,</span>
                <span class="s1">&#39;object&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">error</span> <span class="o">=</span> <span class="s1">&#39;error :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">())</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="n">error</span><span class="p">})</span>
            <span class="k">return</span> <span class="n">resp</span><span class="p">,</span> <span class="mi">500</span>

        <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="n">timeseries</span><span class="p">})</span>
        <span class="n">cleaned_resp</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># @modified 20191014 - Task #3270: Deprecate string.replace for py3</span>
            <span class="c1"># format_resp_1 = string.replace(str(resp), &#39;&quot;[[&#39;, &#39;[[&#39;)</span>
            <span class="c1"># cleaned_resp = string.replace(str(format_resp_1), &#39;]]&quot;&#39;, &#39;]]&#39;)</span>
            <span class="n">resp_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span>
            <span class="n">format_resp_1</span> <span class="o">=</span> <span class="n">resp_str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&quot;[[&#39;</span><span class="p">,</span> <span class="s1">&#39;[[&#39;</span><span class="p">)</span>
            <span class="n">cleaned_resp</span> <span class="o">=</span> <span class="n">format_resp_1</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;]]&quot;&#39;</span><span class="p">,</span> <span class="s1">&#39;]]&#39;</span><span class="p">)</span>

        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed string replace resp: &#39;</span> <span class="o">+</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">cleaned_resp</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cleaned_resp</span><span class="p">,</span> <span class="mi">200</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="s1">&#39;Error: failed to generate timeseries&#39;</span><span class="p">})</span>
            <span class="k">return</span> <span class="n">resp</span><span class="p">,</span> <span class="mi">404</span>

    <span class="c1"># @modified 20200128 - Feature #3424: webapp - api documentation</span>
    <span class="c1"># resp = json.dumps(</span>
    <span class="c1">#     {&#39;results&#39;: &#39;Error: No argument passed - try /api?metric= or /api?graphite_metric=&#39;})</span>
    <span class="c1"># return resp, 404</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span>
            <span class="s1">&#39;api.html&#39;</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="n">skyline_version</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)),</span> <span class="mi">200</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;Uh oh ... a Skyline 500 :(&#39;</span><span class="p">,</span> <span class="mi">500</span></div>


<span class="c1"># @added 20200116: Feature #3396: http_alerter</span>
<div class="viewcode-block" id="mock_api"><a class="viewcode-back" href="../../skyline.webapp.html#webapp.webapp.mock_api">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/mock_api&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">mock_api</span><span class="p">():</span>
    <span class="k">if</span> <span class="s1">&#39;alert_reciever&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># post_data = request.form.to_dict()</span>
                <span class="n">post_data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mock_api :: /alert_reciever recieved </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">post_data</span><span class="p">))</span>
                <span class="n">metric</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">post_data</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;alert&#39;</span><span class="p">][</span><span class="s1">&#39;metric&#39;</span><span class="p">])</span>
                <span class="c1"># timestamp = int(request.form[&#39;timestamp&#39;])</span>
                <span class="c1"># value = float(request.form[&#39;value&#39;])</span>
                <span class="n">timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">post_data</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;alert&#39;</span><span class="p">][</span><span class="s1">&#39;timestamp&#39;</span><span class="p">])</span>
                <span class="n">value</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">post_data</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;alert&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">])</span>
                <span class="c1"># full_duration = int(request.form[&#39;full_duration&#39;])</span>
                <span class="c1"># expiry = int(request.form[&#39;expiry&#39;])</span>
                <span class="n">full_duration</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">post_data</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;alert&#39;</span><span class="p">][</span><span class="s1">&#39;full_duration&#39;</span><span class="p">])</span>
                <span class="n">expiry</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">post_data</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;alert&#39;</span><span class="p">][</span><span class="s1">&#39;expiry&#39;</span><span class="p">])</span>
                <span class="n">source</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">post_data</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;alert&#39;</span><span class="p">][</span><span class="s1">&#39;source&#39;</span><span class="p">])</span>
                <span class="n">token</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">post_data</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;alert&#39;</span><span class="p">][</span><span class="s1">&#39;token&#39;</span><span class="p">])</span>
                <span class="n">metric_alert_dict</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;metric&quot;</span><span class="p">:</span> <span class="n">metric</span><span class="p">,</span>
                    <span class="s2">&quot;timestamp&quot;</span><span class="p">:</span> <span class="n">timestamp</span><span class="p">,</span>
                    <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span>
                    <span class="s2">&quot;full_duration&quot;</span><span class="p">:</span> <span class="n">full_duration</span><span class="p">,</span>
                    <span class="s2">&quot;expiry&quot;</span><span class="p">:</span> <span class="n">expiry</span><span class="p">,</span>
                    <span class="s2">&quot;source&quot;</span><span class="p">:</span> <span class="n">source</span><span class="p">,</span>
                    <span class="s2">&quot;token&quot;</span><span class="p">:</span> <span class="n">token</span>
                <span class="p">}</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: Webapp could not get alert details from the alert_reciever POST request - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">))</span>
                <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                    <span class="p">{</span><span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="s1">&#39;malformed or missing data in the POST request&#39;</span><span class="p">})</span>
                <span class="k">return</span> <span class="n">resp</span><span class="p">,</span> <span class="mi">400</span>
            <span class="n">testing_http_alerter</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">testing_http_alerter</span><span class="p">:</span>
                <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                    <span class="p">{</span><span class="s1">&#39;status&#39;</span><span class="p">:</span> <span class="s1">&#39;testing with a 400&#39;</span><span class="p">})</span>
                <span class="k">return</span> <span class="n">resp</span><span class="p">,</span> <span class="mi">400</span>
            <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;alert&quot;</span><span class="p">:</span> <span class="n">metric_alert_dict</span><span class="p">}}</span>
            <span class="n">redis_set</span> <span class="o">=</span> <span class="s1">&#39;mock_api.alert_reciever.alerts&#39;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">REDIS_CONN_UNDECODE</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="n">redis_set</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">data_dict</span><span class="p">))</span>
                <span class="c1"># @added 20200528 - Feature #3560: External alert config</span>
                <span class="c1"># Expire this set</span>
                <span class="n">REDIS_CONN_UNDECODE</span><span class="o">.</span><span class="n">expire</span><span class="p">(</span><span class="n">redis_set</span><span class="p">,</span> <span class="mi">3600</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;added alert to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">redis_set</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mock_api :: could not add data_dict to Redis set - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">redis_set</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mock_api :: responding with 200 and </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">data_dict</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">200</span>

    <span class="c1"># @added 20200528 - Feature #3560: External alert config</span>
    <span class="k">if</span> <span class="s1">&#39;alert_config&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="n">token</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;GET&#39;</span><span class="p">:</span>
            <span class="c1"># return &#39;Method Not Allowed&#39;, 405</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">token</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: Webapp could not get token from the alert_config request, returning 400&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">post_data</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">get_json</span><span class="p">()</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;mock_api :: /alert_config recieved </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">post_data</span><span class="p">))</span>
                <span class="n">token</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">post_data</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;token&#39;</span><span class="p">])</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: Webapp could not get token from the alert_config POST request, returning 400 - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">token</span><span class="p">:</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="s1">&#39;no token found&#39;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: </span><span class="si">%s</span><span class="s1">, returning 400&#39;</span> <span class="o">%</span> <span class="n">error_msg</span><span class="p">)</span>
            <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">error_msg</span><span class="p">}}</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">400</span>
        <span class="k">if</span> <span class="n">token</span> <span class="o">!=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FLUX_SELF_API_KEY</span><span class="p">:</span>
            <span class="n">error_msg</span> <span class="o">=</span> <span class="s1">&#39;no token found&#39;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: the token </span><span class="si">%s</span><span class="s1"> does not match settings.FLUX_SELF_API_KEY, returning 401&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">token</span><span class="p">))</span>
            <span class="k">return</span> <span class="s1">&#39;Unauthorized&#39;</span><span class="p">,</span> <span class="mi">401</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">alerts_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">alert</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">ALERTS</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">namespace</span> <span class="o">=</span> <span class="n">alert</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mock_api :: alert_config :: could not determine namespace from alert_tuple - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">alert</span><span class="p">))</span>
                <span class="k">continue</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">alerter</span> <span class="o">=</span> <span class="n">alert</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mock_api :: alert_config :: could not determine alerter from alert_tuple - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">alert</span><span class="p">))</span>
                <span class="k">continue</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">expiration</span> <span class="o">=</span> <span class="n">alert</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: mock_api :: alert_config :: could not determine expiration from alert_tuple - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">alert</span><span class="p">))</span>
                <span class="k">continue</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">second_order_resolution_hours</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">alert</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
                <span class="n">second_order_resolution</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">second_order_resolution_hours</span> <span class="o">*</span> <span class="mi">3600</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">second_order_resolution</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FULL_DURATION</span>
            <span class="n">namespace_prefix_1</span> <span class="o">=</span> <span class="n">namespace</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;^&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">namespace_prefix_2</span> <span class="o">=</span> <span class="n">namespace_prefix_1</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
            <span class="n">namespace_prefix</span> <span class="o">=</span> <span class="n">namespace_prefix_2</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">learn_days</span> <span class="o">=</span> <span class="mi">30</span>
            <span class="n">count_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">count</span><span class="p">)</span>
            <span class="n">alerts_dict</span><span class="p">[</span><span class="n">count_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;alerter&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">alerter</span><span class="p">),</span>
                <span class="s1">&#39;expiration&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">expiration</span><span class="p">),</span>
                <span class="s1">&#39;namespace&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">namespace</span><span class="p">),</span>
                <span class="s1">&#39;namespace_prefix&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">namespace_prefix</span><span class="p">),</span>
                <span class="s1">&#39;second_order_resolution&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">second_order_resolution</span><span class="p">),</span>
                <span class="s1">&#39;learn_days&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">learn_days</span><span class="p">)</span>
            <span class="p">}</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">alerts_dict</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">200</span>

    <span class="c1"># @added 20200528 - Feature #3560: External alert config</span>
    <span class="k">if</span> <span class="s1">&#39;test_alert_config&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="n">alerts_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">alerts_dict</span><span class="p">[</span><span class="s1">&#39;test_external_alert_config&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;alerter&#39;</span><span class="p">:</span> <span class="s1">&#39;http_alerter-mock_api&#39;</span><span class="p">,</span>
            <span class="s1">&#39;expiration&#39;</span><span class="p">:</span> <span class="s1">&#39;60&#39;</span><span class="p">,</span>
            <span class="s1">&#39;namespace&#39;</span><span class="p">:</span> <span class="s1">&#39;analyzer.runtime&#39;</span><span class="p">,</span>
            <span class="s1">&#39;namespace_prefix&#39;</span><span class="p">:</span> <span class="s1">&#39;skyline&#39;</span><span class="p">,</span>
            <span class="s1">&#39;second_order_resolution&#39;</span><span class="p">:</span> <span class="s1">&#39;604800&#39;</span><span class="p">,</span>
            <span class="s1">&#39;learn_days&#39;</span><span class="p">:</span> <span class="s1">&#39;30&#39;</span>
        <span class="p">}</span>
        <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">alerts_dict</span><span class="p">}</span>
        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">200</span></div>


<span class="c1"># @added 20180721 - Feature #2464: luminosity_remote_data</span>
<span class="c1"># Add a specific route for the luminosity_remote_data endpoint so that the</span>
<span class="c1"># response can be gzipped as even the preprocessed data can run into megabyte</span>
<span class="c1"># reponses.</span>
<div class="viewcode-block" id="luminosity_remote_data_endpoint"><a class="viewcode-back" href="../../skyline.webapp.html#webapp.webapp.luminosity_remote_data_endpoint">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/luminosity_remote_data&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="nd">@gzipped</span>
<span class="k">def</span> <span class="nf">luminosity_remote_data_endpoint</span><span class="p">():</span>
    <span class="c1"># The luminosity_remote_data_endpoint, requires onerequest parameter:</span>
    <span class="k">if</span> <span class="s1">&#39;anomaly_timestamp&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="n">anomaly_timestamp_str</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;anomaly_timestamp&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">anomaly_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">anomaly_timestamp_str</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">anomaly_timestamp</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
            <span class="p">{</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="s1">&#39;Error: no anomaly_timestamp parameter was passed to /luminosity_remote_data&#39;</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">resp</span><span class="p">,</span> <span class="mi">400</span>
    <span class="n">luminosity_data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">anomaly_timestamp</span><span class="p">:</span>
        <span class="n">luminosity_data</span><span class="p">,</span> <span class="n">success</span><span class="p">,</span> <span class="n">message</span> <span class="o">=</span> <span class="n">luminosity_remote_data</span><span class="p">(</span><span class="n">anomaly_timestamp</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">luminosity_data</span><span class="p">:</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="n">luminosity_data</span><span class="p">})</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;returning gzipped response&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">resp</span><span class="p">,</span> <span class="mi">200</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                <span class="p">{</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="s1">&#39;No data found&#39;</span><span class="p">})</span>
            <span class="k">return</span> <span class="n">resp</span><span class="p">,</span> <span class="mi">404</span></div>


<div class="viewcode-block" id="docs"><a class="viewcode-back" href="../../skyline.webapp.html#webapp.webapp.docs">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/docs&quot;</span><span class="p">)</span>
<span class="nd">@requires_auth</span>
<span class="k">def</span> <span class="nf">docs</span><span class="p">():</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span>
            <span class="s1">&#39;docs.html&#39;</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="n">skyline_version</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)),</span> <span class="mi">200</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;Uh oh ... a Skyline 500 :(&#39;</span><span class="p">,</span> <span class="mi">500</span></div>


<div class="viewcode-block" id="panorama"><a class="viewcode-back" href="../../skyline.webapp.html#webapp.webapp.panorama">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/panorama&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="nd">@requires_auth</span>
<span class="k">def</span> <span class="nf">panorama</span><span class="p">():</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">settings</span><span class="o">.</span><span class="n">PANORAMA_ENABLED</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span>
                <span class="s1">&#39;uh_oh.html&#39;</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="n">skyline_version</span><span class="p">,</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Panorama is not enabled, please see the Panorama section in the docs and settings.py&quot;</span><span class="p">),</span> <span class="mi">200</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;Uh oh ... a Skyline 500 :(&#39;</span><span class="p">,</span> <span class="mi">500</span>

    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">apps</span> <span class="o">=</span> <span class="n">get_list</span><span class="p">(</span><span class="s1">&#39;app&#39;</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">())</span>
        <span class="n">apps</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;None&#39;</span><span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">sources</span> <span class="o">=</span> <span class="n">get_list</span><span class="p">(</span><span class="s1">&#39;source&#39;</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">())</span>
        <span class="n">sources</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;None&#39;</span><span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">algorithms</span> <span class="o">=</span> <span class="n">get_list</span><span class="p">(</span><span class="s1">&#39;algorithm&#39;</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">())</span>
        <span class="n">algorithms</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;None&#39;</span><span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">hosts</span> <span class="o">=</span> <span class="n">get_list</span><span class="p">(</span><span class="s1">&#39;host&#39;</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">())</span>
        <span class="n">hosts</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;None&#39;</span><span class="p">]</span>

    <span class="n">request_args_present</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">request_args_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
        <span class="n">request_args_present</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">request_args_len</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># @added 20200226: Ideas #2476: Label and relate anomalies</span>
    <span class="c1">#                  Feature #2516: Add label to features profile</span>
    <span class="n">label_anomalies_request</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="s1">&#39;label_anomalies&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="n">label_anomalies_request</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;label_anomalies&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">label_anomalies_request</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
            <span class="n">label_anomalies_request</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">label_anomalies_request</span><span class="p">:</span>
        <span class="n">start_timestamp</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">end_timestamp</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">metrics_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">namespaces_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">label</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s1">&#39;start_timestamp&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">start_timestamp</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;start_timestamp&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;end_timestamp&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">end_timestamp</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;end_timestamp&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;metrics&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">metrics</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;metrics&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;namespaces&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">namespaces</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;namespaces&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;label&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">label</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;label&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">do_label_anomalies</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">start_timestamp</span> <span class="ow">and</span> <span class="n">end_timestamp</span> <span class="ow">and</span> <span class="n">label</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">metrics</span><span class="p">:</span>
                <span class="n">do_label_anomalies</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">metrics_list</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;label_anomalies metrics_list - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metrics_list</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">namespaces</span><span class="p">:</span>
                <span class="n">do_label_anomalies</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">namespaces_list</span> <span class="o">=</span> <span class="n">namespaces</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;label_anomalies namespaces_list - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">namespaces_list</span><span class="p">))</span>
        <span class="n">labelled</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">anomalies_labelled</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">do_label_anomalies</span><span class="p">:</span>
            <span class="n">labelled</span><span class="p">,</span> <span class="n">anomalies_labelled</span> <span class="o">=</span> <span class="n">label_anomalies</span><span class="p">(</span><span class="n">start_timestamp</span><span class="p">,</span> <span class="n">end_timestamp</span><span class="p">,</span> <span class="n">metrics_list</span><span class="p">,</span> <span class="n">namespaces_list</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span>
            <span class="s1">&#39;panorama.html&#39;</span><span class="p">,</span> <span class="n">label_anomalies</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">anomalies_labelled</span><span class="o">=</span><span class="n">anomalies_labelled</span><span class="p">,</span>
            <span class="n">start_timestamp</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">start_timestamp</span><span class="p">),</span> <span class="n">end_timestamp</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">end_timestamp</span><span class="p">),</span>
            <span class="n">metrics</span><span class="o">=</span><span class="n">metrics_list</span><span class="p">,</span> <span class="n">namespaces</span><span class="o">=</span><span class="n">namespaces_list</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">,</span>
            <span class="n">version</span><span class="o">=</span><span class="n">skyline_version</span><span class="p">,</span>
            <span class="n">duration</span><span class="o">=</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">),</span> <span class="n">print_debug</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span> <span class="mi">200</span>

    <span class="c1"># @added 20160803 - Sanitize request.args</span>
    <span class="n">REQUEST_ARGS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;from_date&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;from_time&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;from_timestamp&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;until_date&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;until_time&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;until_timestamp&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;count_by_metric&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;metric&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;metric_like&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;app&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;source&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;host&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;algorithm&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;limit&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;order&#39;</span><span class="p">,</span>
                    <span class="c1"># @added 20161127 - Branch #922: ionosphere</span>
                    <span class="s1">&#39;panorama_anomaly_id&#39;</span><span class="p">,</span>
                    <span class="p">]</span>

    <span class="c1"># @added 20190919 - Feature #3230: users DB table</span>
    <span class="c1">#                   Ideas #2476: Label and relate anomalies</span>
    <span class="c1">#                   Feature #2516: Add label to features profile</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">WEBAPP_AUTH_ENABLED</span><span class="p">:</span>
        <span class="n">auth</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">authorization</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">auth</span><span class="o">.</span><span class="n">username</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">user</span> <span class="o">=</span> <span class="s1">&#39;Skyline&#39;</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">user_id</span><span class="p">:</span>
        <span class="n">success</span><span class="p">,</span> <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_user_details</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;username&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">user</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">success</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error : /panorama could not get_user_details(</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">user</span><span class="p">))</span>
            <span class="k">return</span> <span class="s1">&#39;Internal Server Error - ref: i - could not determine user_id&#39;</span><span class="p">,</span> <span class="mi">500</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">user_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: /panorama get_user_details(</span><span class="si">%s</span><span class="s1">) did not return an int&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">user</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">user_id</span><span class="p">)))</span>
                <span class="k">return</span> <span class="s1">&#39;Internal Server Error - ref: p - user_id not int&#39;</span><span class="p">,</span> <span class="mi">500</span>

    <span class="n">get_anomaly_id</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">request_args_present</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">REQUEST_ARGS</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: invalid request argument - </span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)))</span>
                <span class="c1"># @modified 20190524 - Branch #3002: docker</span>
                <span class="c1"># Return data</span>
                <span class="c1"># return &#39;Bad Request&#39;, 400</span>
                <span class="n">error_string</span> <span class="o">=</span> <span class="s1">&#39;error :: invalid request argument - </span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_string</span><span class="p">)</span>
                <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                    <span class="p">{</span><span class="s1">&#39;400 Bad Request&#39;</span><span class="p">:</span> <span class="n">error_string</span><span class="p">})</span>
                <span class="k">return</span> <span class="n">flask_escape</span><span class="p">(</span><span class="n">resp</span><span class="p">),</span> <span class="mi">400</span>

            <span class="n">value</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;request argument - </span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>

            <span class="c1"># @added 20161127 - Branch #922: ionosphere</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;panorama_anomaly_id&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                    <span class="n">get_anomaly_id</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;metric&#39;</span> <span class="ow">and</span> <span class="n">value</span> <span class="o">!=</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">value</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">unique_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span> <span class="o">+</span> <span class="s1">&#39;unique_metrics&#39;</span><span class="p">))</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: Webapp could not get the unique_metrics list from Redis&#39;</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="k">return</span> <span class="s1">&#39;Internal Server Error&#39;</span><span class="p">,</span> <span class="mi">500</span>
                    <span class="n">metric_name</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span> <span class="o">+</span> <span class="n">value</span>

                    <span class="c1"># @added 20180423 - Feature #2034: analyse_derivatives</span>
                    <span class="c1">#                   Branch #2270: luminosity</span>
                    <span class="n">other_unique_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="c1"># @added 20190105 - Bug #2792: webapp 500 error on no metric</span>
                    <span class="c1"># This needs to be set before the below conditional check</span>
                    <span class="c1"># otherwise webapp return a 500 server error instead of a</span>
                    <span class="c1"># 404 if the metric does not exist</span>
                    <span class="n">metric_found_in_other_redis</span> <span class="o">=</span> <span class="kc">False</span>

                    <span class="k">if</span> <span class="n">metric_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unique_metrics</span> <span class="ow">and</span> <span class="n">settings</span><span class="o">.</span><span class="n">OTHER_SKYLINE_REDIS_INSTANCES</span><span class="p">:</span>
                        <span class="n">metric_found_in_other_redis</span> <span class="o">=</span> <span class="kc">False</span>

                        <span class="c1"># @modified 20180519 - Feature #2378: Add redis auth to Skyline and rebrow</span>
                        <span class="c1"># for redis_ip, redis_port in settings.OTHER_SKYLINE_REDIS_INSTANCES:</span>
                        <span class="k">for</span> <span class="n">redis_ip</span><span class="p">,</span> <span class="n">redis_port</span><span class="p">,</span> <span class="n">redis_password</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">OTHER_SKYLINE_REDIS_INSTANCES</span><span class="p">:</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">metric_found_in_other_redis</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">redis_password</span><span class="p">:</span>
                                        <span class="n">other_redis_conn</span> <span class="o">=</span> <span class="n">redis</span><span class="o">.</span><span class="n">StrictRedis</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">redis_ip</span><span class="p">),</span> <span class="n">port</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">redis_port</span><span class="p">),</span> <span class="n">password</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">redis_password</span><span class="p">))</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="n">other_redis_conn</span> <span class="o">=</span> <span class="n">redis</span><span class="o">.</span><span class="n">StrictRedis</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">redis_ip</span><span class="p">),</span> <span class="n">port</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">redis_port</span><span class="p">))</span>
                                    <span class="n">other_unique_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">other_redis_conn</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span> <span class="o">+</span> <span class="s1">&#39;unique_metrics&#39;</span><span class="p">))</span>
                                <span class="k">except</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to connect to Redis at </span><span class="si">%s</span><span class="s1"> on port </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">redis_ip</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">redis_port</span><span class="p">)))</span>
                                <span class="k">if</span> <span class="n">metric_name</span> <span class="ow">in</span> <span class="n">other_unique_metrics</span><span class="p">:</span>
                                    <span class="n">metric_found_in_other_redis</span> <span class="o">=</span> <span class="kc">True</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> found in derivative_metrics in Redis at </span><span class="si">%s</span><span class="s1"> on port </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">redis_ip</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">redis_port</span><span class="p">)))</span>

                    <span class="k">if</span> <span class="n">metric_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unique_metrics</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">metric_found_in_other_redis</span><span class="p">:</span>
                        <span class="c1"># @added 20200715 - Task #3648: webapp - fp_search - do not use Redis metric check</span>
                        <span class="c1"># Do not use the Redis metric check result in a webapp</span>
                        <span class="c1"># fp_search request as this allows retried metric fps to</span>
                        <span class="c1"># accessed</span>
                        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;fp_search&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">):</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;check request.args -  </span><span class="si">%s</span><span class="s1"> not in Redis, but fp_search request so continuing&#39;</span> <span class="o">%</span> <span class="n">metric_name</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">error_string</span> <span class="o">=</span> <span class="s1">&#39;error :: no metric - </span><span class="si">%s</span><span class="s1"> - exists in Redis&#39;</span> <span class="o">%</span> <span class="n">metric_name</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_string</span><span class="p">)</span>
                            <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                                <span class="p">{</span><span class="s1">&#39;404 Not Found&#39;</span><span class="p">:</span> <span class="n">error_string</span><span class="p">})</span>
                            <span class="c1"># @modified 20190116 - Cross-Site Scripting Security Vulnerability #85</span>
                            <span class="c1">#                      Bug #2816: Cross-Site Scripting Security Vulnerability</span>
                            <span class="c1"># return resp, 404</span>
                            <span class="k">return</span> <span class="n">flask_escape</span><span class="p">(</span><span class="n">resp</span><span class="p">),</span> <span class="mi">404</span>

            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;count_by_metric&#39;</span><span class="p">:</span>
                <span class="n">count_by_metric_invalid</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="s1">&#39;false&#39;</span><span class="p">:</span>
                    <span class="n">count_by_metric_invalid</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                    <span class="n">count_by_metric_invalid</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">count_by_metric_invalid</span><span class="p">:</span>
                    <span class="n">error_string</span> <span class="o">=</span> <span class="s1">&#39;error :: invalid </span><span class="si">%s</span><span class="s1"> value passed </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_string</span><span class="p">)</span>
                    <span class="c1"># @modified 20190524 - Branch #3002: docker</span>
                    <span class="c1"># Return data</span>
                    <span class="c1"># return &#39;Bad Request&#39;, 400</span>
                    <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                        <span class="p">{</span><span class="s1">&#39;400 Bad Request&#39;</span><span class="p">:</span> <span class="n">error_string</span><span class="p">})</span>
                    <span class="k">return</span> <span class="n">flask_escape</span><span class="p">(</span><span class="n">resp</span><span class="p">),</span> <span class="mi">400</span>

            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;metric_like&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
                    <span class="n">metric_namespace_pattern</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

                <span class="n">metric_namespace_pattern</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;%&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">metric_namespace_pattern</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">value</span> <span class="o">!=</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">unique_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span> <span class="o">+</span> <span class="s1">&#39;unique_metrics&#39;</span><span class="p">))</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: Webapp could not get the unique_metrics list from Redis&#39;</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="k">return</span> <span class="s1">&#39;Internal Server Error&#39;</span><span class="p">,</span> <span class="mi">500</span>

                    <span class="n">matching</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">unique_metrics</span> <span class="k">if</span> <span class="n">metric_namespace_pattern</span> <span class="ow">in</span> <span class="n">s</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">matching</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">error_string</span> <span class="o">=</span> <span class="s1">&#39;error :: no metric like - </span><span class="si">%s</span><span class="s1"> - exists in Redis&#39;</span> <span class="o">%</span> <span class="n">metric_namespace_pattern</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_string</span><span class="p">)</span>
                        <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                            <span class="p">{</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="n">error_string</span><span class="p">})</span>
                        <span class="c1"># @modified 20190116 - Cross-Site Scripting Security Vulnerability #85</span>
                        <span class="c1">#                      Bug #2816: Cross-Site Scripting Security Vulnerability</span>
                        <span class="c1"># return resp, 404</span>
                        <span class="k">return</span> <span class="n">flask_escape</span><span class="p">(</span><span class="n">resp</span><span class="p">),</span> <span class="mi">404</span>

            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;from_timestamp&#39;</span> <span class="ow">or</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;until_timestamp&#39;</span><span class="p">:</span>
                <span class="n">timestamp_format_invalid</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
                    <span class="n">timestamp_format_invalid</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="c1"># unix timestamp</span>
                <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                    <span class="n">timestamp_format_invalid</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="c1"># %Y%m%d %H:%M timestamp</span>
                <span class="k">if</span> <span class="n">timestamp_format_invalid</span><span class="p">:</span>
                    <span class="n">value_strip_colon</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="n">new_value</span> <span class="o">=</span> <span class="n">value_strip_colon</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">new_value</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                        <span class="n">timestamp_format_invalid</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">timestamp_format_invalid</span><span class="p">:</span>
                    <span class="n">error_string</span> <span class="o">=</span> <span class="s1">&#39;error :: invalid </span><span class="si">%s</span><span class="s1"> value passed </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: invalid </span><span class="si">%s</span><span class="s1"> value passed </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
                    <span class="c1"># @modified 20190524 - Branch #3002: docker</span>
                    <span class="c1"># Return data</span>
                    <span class="c1"># return &#39;Bad Request&#39;, 400</span>
                    <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                        <span class="p">{</span><span class="s1">&#39;400 Bad Request&#39;</span><span class="p">:</span> <span class="n">error_string</span><span class="p">})</span>
                    <span class="k">return</span> <span class="n">flask_escape</span><span class="p">(</span><span class="n">resp</span><span class="p">),</span> <span class="mi">400</span>

            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;app&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">value</span> <span class="o">!=</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">apps</span><span class="p">:</span>
                        <span class="n">error_string</span> <span class="o">=</span> <span class="s1">&#39;error :: no </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_string</span><span class="p">)</span>
                        <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                            <span class="p">{</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="n">error_string</span><span class="p">})</span>
                        <span class="c1"># @modified 20190116 - Cross-Site Scripting Security Vulnerability #85</span>
                        <span class="c1">#                      Bug #2816: Cross-Site Scripting Security Vulnerability</span>
                        <span class="c1"># return resp, 404</span>
                        <span class="k">return</span> <span class="n">flask_escape</span><span class="p">(</span><span class="n">resp</span><span class="p">),</span> <span class="mi">404</span>

            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;source&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">value</span> <span class="o">!=</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sources</span><span class="p">:</span>
                        <span class="n">error_string</span> <span class="o">=</span> <span class="s1">&#39;error :: no </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_string</span><span class="p">)</span>
                        <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                            <span class="p">{</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="n">error_string</span><span class="p">})</span>
                        <span class="c1"># @modified 20190116 - Cross-Site Scripting Security Vulnerability #85</span>
                        <span class="c1">#                      Bug #2816: Cross-Site Scripting Security Vulnerability</span>
                        <span class="c1"># return resp, 404</span>
                        <span class="k">return</span> <span class="n">flask_escape</span><span class="p">(</span><span class="n">resp</span><span class="p">),</span> <span class="mi">404</span>

            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;algorithm&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">value</span> <span class="o">!=</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">algorithms</span><span class="p">:</span>
                        <span class="n">error_string</span> <span class="o">=</span> <span class="s1">&#39;error :: no </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_string</span><span class="p">)</span>
                        <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                            <span class="p">{</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="n">error_string</span><span class="p">})</span>
                        <span class="c1"># @modified 20190116 - Cross-Site Scripting Security Vulnerability #85</span>
                        <span class="c1">#                      Bug #2816: Cross-Site Scripting Security Vulnerability</span>
                        <span class="c1"># return resp, 404</span>
                        <span class="k">return</span> <span class="n">flask_escape</span><span class="p">(</span><span class="n">resp</span><span class="p">),</span> <span class="mi">404</span>

            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;host&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">value</span> <span class="o">!=</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">value</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">hosts</span><span class="p">:</span>
                        <span class="n">error_string</span> <span class="o">=</span> <span class="s1">&#39;error :: no </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_string</span><span class="p">)</span>
                        <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                            <span class="p">{</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="n">error_string</span><span class="p">})</span>
                        <span class="c1"># @modified 20190116 - Cross-Site Scripting Security Vulnerability #85</span>
                        <span class="c1">#                      Bug #2816: Cross-Site Scripting Security Vulnerability</span>
                        <span class="c1"># return resp, 404</span>
                        <span class="k">return</span> <span class="n">flask_escape</span><span class="p">(</span><span class="n">resp</span><span class="p">),</span> <span class="mi">404</span>

            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;limit&#39;</span><span class="p">:</span>
                <span class="n">limit_invalid</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">limit_is_not_numeric</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                    <span class="n">limit_is_not_numeric</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="k">if</span> <span class="n">limit_is_not_numeric</span><span class="p">:</span>
                    <span class="n">error_string</span> <span class="o">=</span> <span class="s1">&#39;error :: </span><span class="si">%s</span><span class="s1"> must be a numeric value - requested </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_string</span><span class="p">)</span>
                    <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                        <span class="p">{</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="n">error_string</span><span class="p">})</span>
                    <span class="c1"># @modified 20190116 - Cross-Site Scripting Security Vulnerability #85</span>
                    <span class="c1">#                      Bug #2816: Cross-Site Scripting Security Vulnerability</span>
                    <span class="c1"># return resp, 400</span>
                    <span class="k">return</span> <span class="n">flask_escape</span><span class="p">(</span><span class="n">resp</span><span class="p">),</span> <span class="mi">400</span>

                <span class="n">new_value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">valid_value</span> <span class="o">=</span> <span class="n">new_value</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">valid_value</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">valid_value</span> <span class="ow">and</span> <span class="n">new_value</span> <span class="o">&lt;</span> <span class="mi">101</span><span class="p">:</span>
                    <span class="n">limit_invalid</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">limit_invalid</span><span class="p">:</span>
                    <span class="n">error_string</span> <span class="o">=</span> <span class="s1">&#39;error :: </span><span class="si">%s</span><span class="s1"> must be &lt; 100 - requested </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_string</span><span class="p">)</span>
                    <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                        <span class="p">{</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="n">error_string</span><span class="p">})</span>
                    <span class="c1"># @modified 20190116 - Cross-Site Scripting Security Vulnerability #85</span>
                    <span class="c1">#                      Bug #2816: Cross-Site Scripting Security Vulnerability</span>
                    <span class="c1"># return resp, 400</span>
                    <span class="k">return</span> <span class="n">flask_escape</span><span class="p">(</span><span class="n">resp</span><span class="p">),</span> <span class="mi">400</span>

            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;order&#39;</span><span class="p">:</span>
                <span class="n">order_invalid</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="s1">&#39;DESC&#39;</span><span class="p">:</span>
                    <span class="n">order_invalid</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="s1">&#39;ASC&#39;</span><span class="p">:</span>
                    <span class="n">order_invalid</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">order_invalid</span><span class="p">:</span>
                    <span class="n">error_string</span> <span class="o">=</span> <span class="s1">&#39;error :: </span><span class="si">%s</span><span class="s1"> must be DESC or ASC&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_string</span><span class="p">)</span>
                    <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                        <span class="p">{</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="n">error_string</span><span class="p">})</span>
                    <span class="c1"># @modified 20190116 - Cross-Site Scripting Security Vulnerability #85</span>
                    <span class="c1">#                      Bug #2816: Cross-Site Scripting Security Vulnerability</span>
                    <span class="c1"># return resp, 400</span>
                    <span class="k">return</span> <span class="n">flask_escape</span><span class="p">(</span><span class="n">resp</span><span class="p">),</span> <span class="mi">400</span>

    <span class="c1"># @added 20161127 - Branch #922: ionosphere</span>
    <span class="k">if</span> <span class="n">get_anomaly_id</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">query</span><span class="p">,</span> <span class="n">panorama_data</span> <span class="o">=</span> <span class="n">panorama_request</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;debug :: panorama_data - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">panorama_data</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to get panorama: &#39;</span> <span class="o">+</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="k">return</span> <span class="s1">&#39;Uh oh ... a Skyline 500 :(&#39;</span><span class="p">,</span> <span class="mi">500</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">duration</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;debug :: duration - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">duration</span><span class="p">))</span>
            <span class="n">resp</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">panorama_data</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">resp</span><span class="p">,</span> <span class="mi">200</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to render panorama.html: &#39;</span> <span class="o">+</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="k">return</span> <span class="s1">&#39;Uh oh ... a Skyline 500 :(&#39;</span><span class="p">,</span> <span class="mi">500</span>

    <span class="k">if</span> <span class="n">request_args_len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">panorama_data</span> <span class="o">=</span> <span class="n">panorama_request</span><span class="p">()</span>
            <span class="c1"># logger.info(&#39;panorama_data - %s&#39; % str(panorama_data))</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span>
                <span class="s1">&#39;panorama.html&#39;</span><span class="p">,</span> <span class="n">anomalies</span><span class="o">=</span><span class="n">panorama_data</span><span class="p">,</span> <span class="n">app_list</span><span class="o">=</span><span class="n">apps</span><span class="p">,</span>
                <span class="n">source_list</span><span class="o">=</span><span class="n">sources</span><span class="p">,</span> <span class="n">algorithm_list</span><span class="o">=</span><span class="n">algorithms</span><span class="p">,</span>
                <span class="n">host_list</span><span class="o">=</span><span class="n">hosts</span><span class="p">,</span> <span class="n">results</span><span class="o">=</span><span class="s1">&#39;Latest anomalies&#39;</span><span class="p">,</span>
                <span class="n">version</span><span class="o">=</span><span class="n">skyline_version</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)),</span> <span class="mi">200</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to get panorama: &#39;</span> <span class="o">+</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="k">return</span> <span class="s1">&#39;Uh oh ... a Skyline 500 :(&#39;</span><span class="p">,</span> <span class="mi">500</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">count_request</span> <span class="o">=</span> <span class="s1">&#39;false&#39;</span>
        <span class="k">if</span> <span class="s1">&#39;count_by_metric&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">count_by_metric</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;count_by_metric&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">count_by_metric</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                <span class="n">count_request</span> <span class="o">=</span> <span class="s1">&#39;true&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">query</span><span class="p">,</span> <span class="n">panorama_data</span> <span class="o">=</span> <span class="n">panorama_request</span><span class="p">()</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">ENABLE_DEBUG</span> <span class="ow">or</span> <span class="n">settings</span><span class="o">.</span><span class="n">ENABLE_WEBAPP_DEBUG</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;panorama_data - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">panorama_data</span><span class="p">))</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;debug :: query - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">query</span><span class="p">))</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;debug :: panorama_data - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">panorama_data</span><span class="p">))</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;debug :: skyline_version - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">skyline_version</span><span class="p">))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: ENABLE_DEBUG or ENABLE_WEBAPP_DEBUG are not set in settings.py&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to get panorama_request: &#39;</span> <span class="o">+</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="k">return</span> <span class="s1">&#39;Uh oh ... a Skyline 500 :(&#39;</span><span class="p">,</span> <span class="mi">500</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">results_string</span> <span class="o">=</span> <span class="s1">&#39;Found anomalies for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

            <span class="n">duration</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;debug :: duration - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">duration</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span>
                <span class="s1">&#39;panorama.html&#39;</span><span class="p">,</span> <span class="n">anomalies</span><span class="o">=</span><span class="n">panorama_data</span><span class="p">,</span> <span class="n">app_list</span><span class="o">=</span><span class="n">apps</span><span class="p">,</span>
                <span class="n">source_list</span><span class="o">=</span><span class="n">sources</span><span class="p">,</span> <span class="n">algorithm_list</span><span class="o">=</span><span class="n">algorithms</span><span class="p">,</span>
                <span class="n">host_list</span><span class="o">=</span><span class="n">hosts</span><span class="p">,</span> <span class="n">results</span><span class="o">=</span><span class="n">results_string</span><span class="p">,</span> <span class="n">count_request</span><span class="o">=</span><span class="n">count_request</span><span class="p">,</span>
                <span class="n">version</span><span class="o">=</span><span class="n">skyline_version</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">)),</span> <span class="mi">200</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to render panorama.html: &#39;</span> <span class="o">+</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
            <span class="k">return</span> <span class="s1">&#39;Uh oh ... a Skyline 500 :(&#39;</span><span class="p">,</span> <span class="mi">500</span></div>


<span class="c1"># Feature #1448: Crucible web UI - @earthgecko</span>
<span class="c1"># Branch #868: crucible - @earthgecko</span>
<span class="c1"># This may actually need Django, perhaps this is starting to move outside the</span>
<span class="c1"># realms of Flask..</span>
<div class="viewcode-block" id="crucible"><a class="viewcode-back" href="../../skyline.webapp.html#webapp.webapp.crucible">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/crucible&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="nd">@requires_auth</span>
<span class="k">def</span> <span class="nf">crucible</span><span class="p">():</span>

    <span class="n">crucible_web_ui_implemented</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">crucible_web_ui_implemented</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span>
                <span class="s1">&#39;uh_oh.html&#39;</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="n">skyline_version</span><span class="p">,</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Sorry the Crucible web UI is not completed yet&quot;</span><span class="p">),</span> <span class="mi">200</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span>
                <span class="s1">&#39;uh_oh.html&#39;</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="n">skyline_version</span><span class="p">,</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Sorry the Crucible web UI is not completed yet&quot;</span><span class="p">),</span> <span class="mi">200</span>
    <span class="c1"># @added 20200420 - Feature #1448: Crucible web UI</span>
    <span class="c1">#                   Branch #868: crucible</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">request_args_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">request_args_len</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">from_timestamp</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">until_timestamp</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">metrics_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">namespaces_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">source</span> <span class="o">=</span> <span class="s1">&#39;graphite&#39;</span>
    <span class="n">alert_interval</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">PANORAMA_EXPIRY_TIME</span><span class="p">)</span>
    <span class="n">crucible_job_id</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">metrics_submitted_to_process</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">process_metrics</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">process_metrics_request</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">user</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">job_submitted</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">crucible_jobs_list</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">crucible_jobs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">crucible_job_request</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">crucible_job_dir</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">crucible_job_metric</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">crucible_job_details</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">completed_job</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">has_anomalies</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">skyline_anomalies</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">skyline_consensus_anomalies</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">image_files</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">image_file_names</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">graph_image_file</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">send_anomalies_panorama</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">send_to_panorama_request</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">sent_to_panorama</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">panorama_done</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">panorama_done_timestamp</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">panorama_done_user_id</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">skyline_consensus_anomalies_present</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1"># @added 20200421 - Feature #3500: webapp - crucible_process_metrics</span>
    <span class="c1">#                   Feature #1448: Crucible web UI</span>
    <span class="n">add_to_panorama</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">add_to_panorama_request</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="c1"># @added 20200422 - Feature #3500: webapp - crucible_process_metrics</span>
    <span class="c1">#                   Feature #1448: Crucible web UI</span>
    <span class="n">pad_timeseries</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># @added 20200428 - Feature #3500: webapp - crucible_process_metrics</span>
    <span class="c1">#                   Feature #1448: Crucible web UI</span>
    <span class="c1"># Paginate crucible_jobs page as when there are 1000s of jobs this page</span>
    <span class="c1"># fails to load</span>
    <span class="n">pagination_start</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">pagination_end</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="n">offset</span> <span class="o">=</span> <span class="mi">100</span>
    <span class="n">total_crucible_jobs</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">pagination_start_request</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">offset_request</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="c1"># @added 20200607 - Feature #3630: webapp - crucible_process_training_data</span>
    <span class="n">training_data_json</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">request_args_len</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;process_metrics&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">process_metrics_request</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;process_metrics&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">process_metrics_request</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                <span class="n">process_metrics_request</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">process_metrics</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="s1">&#39;crucible_job&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">crucible_job_request</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;crucible_job&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">crucible_job_request</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                <span class="n">crucible_job_request</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">process_metrics_request</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">process_metrics</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="s1">&#39;send_anomalies_panorama&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">send_to_panorama_request</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;send_anomalies_panorama&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">send_to_panorama_request</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                <span class="n">send_anomalies_panorama</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">send_to_panorama_request</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">process_metrics_request</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">process_metrics</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">crucible_job_request</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">process_metrics_request</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">process_metrics</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># @added 20200428 - Feature #3500: webapp - crucible_process_metrics</span>
        <span class="c1">#                   Feature #1448: Crucible web UI</span>
        <span class="c1"># Added paginate crucible_jobs page</span>
        <span class="k">if</span> <span class="s1">&#39;pagination_start&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">pagination_start_request</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;pagination_start&#39;</span><span class="p">),</span> <span class="s1">&#39;0&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pagination_start_request</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">pagination_start</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">pagination_start_request</span><span class="p">)</span>
                    <span class="n">pagination_start_request</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">pagination_start</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="s1">&#39;offset&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">offset_request</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;offset&#39;</span><span class="p">),</span> <span class="s1">&#39;100&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">offset_request</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">offset</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>
                    <span class="n">offset_request</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">offset</span> <span class="o">=</span> <span class="mi">100</span>

    <span class="k">if</span> <span class="n">crucible_job_request</span> <span class="ow">or</span> <span class="n">send_to_panorama_request</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;crucible_job_id&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">crucible_job_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;crucible_job_id&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;metric&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">crucible_job_metric</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;metric&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">crucible_job_id</span> <span class="ow">and</span> <span class="n">crucible_job_metric</span><span class="p">:</span>
            <span class="n">crucible_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">CRUCIBLE_DATA_FOLDER</span><span class="p">)</span>
            <span class="n">crucible_job_dir</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/jobs/</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">crucible_path</span><span class="p">,</span> <span class="n">crucible_job_id</span><span class="p">,</span> <span class="n">crucible_job_metric</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">crucible_job_request</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;crucible_job request for crucible_job_id </span><span class="si">%s</span><span class="s1"> and metric </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">crucible_job_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">crucible_job_metric</span><span class="p">)))</span>
        <span class="n">crucible_job_details</span><span class="p">,</span> <span class="n">completed_job</span><span class="p">,</span> <span class="n">has_anomalies</span><span class="p">,</span> <span class="n">skyline_anomalies</span><span class="p">,</span> <span class="n">skyline_consensus_anomalies</span><span class="p">,</span> <span class="n">panorama_done</span><span class="p">,</span> <span class="n">panorama_done_timestamp</span><span class="p">,</span> <span class="n">panorama_done_user_id</span><span class="p">,</span> <span class="n">image_files</span><span class="p">,</span> <span class="n">image_file_names</span><span class="p">,</span> <span class="n">graph_image_file</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">get_crucible_job</span><span class="p">(</span><span class="n">crucible_job_id</span><span class="p">,</span> <span class="n">crucible_job_metric</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">process_metrics</span> <span class="ow">or</span> <span class="n">send_anomalies_panorama</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">WEBAPP_AUTH_ENABLED</span><span class="p">:</span>
            <span class="n">auth</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">authorization</span>
            <span class="n">user</span> <span class="o">=</span> <span class="n">auth</span><span class="o">.</span><span class="n">username</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">user</span> <span class="o">=</span> <span class="s1">&#39;Skyline&#39;</span>
            <span class="n">user_id</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="c1"># Allow the user_id to be passed as a request argument</span>
        <span class="k">if</span> <span class="s1">&#39;user_id&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">user_id_str</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;user_id&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">user_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">user_id_str</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: the /crucible user_id argument is not an int - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">user_id_str</span><span class="p">))</span>
                <span class="k">return</span> <span class="s1">&#39;400 Bad Request - invalid user_id argument&#39;</span><span class="p">,</span> <span class="mi">400</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">user_id</span><span class="p">:</span>
            <span class="n">success</span><span class="p">,</span> <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_user_details</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;username&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">user</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">success</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: /crucible could not get_user_details(</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">user</span><span class="p">))</span>
                <span class="k">return</span> <span class="s1">&#39;Internal Server Error - ref: i - could not determine user_id&#39;</span><span class="p">,</span> <span class="mi">500</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">user_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/crucible get_user_details() with </span><span class="si">%s</span><span class="s1"> returned user id </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">user</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">user_id</span><span class="p">)))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: /crucible get_user_details() with </span><span class="si">%s</span><span class="s1"> did not return an int&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">user</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">user_id</span><span class="p">)))</span>
                    <span class="k">return</span> <span class="s1">&#39;Internal Server Error - ref: i - user_id not int&#39;</span><span class="p">,</span> <span class="mi">500</span>

    <span class="k">if</span> <span class="n">process_metrics_request</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;process_metrics request&#39;</span><span class="p">)</span>
        <span class="n">from_timestamp</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">until_timestamp</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">metrics_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">namespaces_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">source</span> <span class="o">=</span> <span class="s1">&#39;graphite&#39;</span>
        <span class="n">alert_interval</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">PANORAMA_EXPIRY_TIME</span><span class="p">))</span>
        <span class="k">if</span> <span class="s1">&#39;from_timestamp&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># If int is used it does not work</span>
                <span class="c1"># from_timestamp = request.args.get(int(&#39;from_timestamp&#39;), 0)</span>
                <span class="n">str_from_timestamp</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;from_timestamp&#39;</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">str_from_timestamp</span><span class="p">:</span>
                    <span class="n">from_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">str_from_timestamp</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: from_timestamp argument is not an int&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="s1">&#39;Bad Request - from_timestamp argument is not an int&#39;</span><span class="p">,</span> <span class="mi">400</span>
        <span class="k">if</span> <span class="s1">&#39;until_timestamp&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">str_until_timestamp</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;until_timestamp&#39;</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">str_until_timestamp</span><span class="p">:</span>
                    <span class="n">until_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">str_until_timestamp</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: until_timestamp argument is not an int&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="s1">&#39;Bad Request - until_timestamp argument is not an int&#39;</span><span class="p">,</span> <span class="mi">400</span>
        <span class="k">if</span> <span class="s1">&#39;metrics&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">metrics</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;metrics&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;namespaces&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">namespaces</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;namespaces&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;source&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">source</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;source&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;alert_interval&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">str_alert_interval</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;alert_interval&#39;</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">str_alert_interval</span><span class="p">:</span>
                    <span class="n">alert_interval</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">str_alert_interval</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: alert_interval argument is not an int&#39;</span><span class="p">)</span>
                <span class="k">return</span> <span class="s1">&#39;Bad Request - alert_interval argument is not an int&#39;</span><span class="p">,</span> <span class="mi">400</span>
        <span class="c1"># @added 20200421 - Feature #3500: webapp - crucible_process_metrics</span>
        <span class="c1">#                   Feature #1448: Crucible web UI</span>
        <span class="c1"># Added add_to_panorama</span>
        <span class="k">if</span> <span class="s1">&#39;add_to_panorama&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">add_to_panorama_request</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;add_to_panorama&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">add_to_panorama_request</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                <span class="n">add_to_panorama</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">add_to_panorama</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># @added 20200422 - Feature #3500: webapp - crucible_process_metrics</span>
        <span class="c1">#                   Feature #1448: Crucible web UI</span>
        <span class="k">if</span> <span class="s1">&#39;pad_timeseries&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">str_pad_timeseries</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;pad_timeseries&#39;</span><span class="p">),</span> <span class="s1">&#39;auto&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">str_pad_timeseries</span><span class="p">:</span>
                <span class="n">pad_timeseries</span> <span class="o">=</span> <span class="n">str_pad_timeseries</span>

        <span class="c1"># @added 20200607 - Feature #3630: webapp - crucible_process_training_data</span>
        <span class="k">if</span> <span class="s1">&#39;training_data_json&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">training_data_json</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;training_data_json&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">do_process_metrics</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">from_timestamp</span> <span class="ow">and</span> <span class="n">until_timestamp</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">metrics</span><span class="p">:</span>
                <span class="n">do_process_metrics</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">metrics_list</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;crucible_process_metrics - metrics_list - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metrics_list</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">namespaces</span><span class="p">:</span>
                <span class="n">do_process_metrics</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">namespaces_list</span> <span class="o">=</span> <span class="n">namespaces</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;crucible_process_metrics namespaces_list - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">namespaces_list</span><span class="p">))</span>

        <span class="c1"># @added 20200607 - Feature #3630: webapp - crucible_process_training_data</span>
        <span class="k">if</span> <span class="n">source</span> <span class="o">==</span> <span class="s1">&#39;training_data&#39;</span> <span class="ow">and</span> <span class="n">training_data_json</span><span class="p">:</span>
            <span class="n">do_process_metrics</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">crucible_job_id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">metrics_submitted_to_process</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">do_process_metrics</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># @modified 20200421 - Feature #3500: webapp - crucible_process_metrics</span>
                <span class="c1">#                      Feature #1448: Crucible web UI</span>
                <span class="c1"># Added add_to_panorama</span>
                <span class="c1"># crucible_job_id, metrics_submitted_to_process, message, trace = submit_crucible_job(from_timestamp, until_timestamp, metrics_list, namespaces_list, source, alert_interval, user_id, user)</span>
                <span class="c1"># @modified 20200422 - Feature #3500: webapp - crucible_process_metrics</span>
                <span class="c1">#                      Feature #1448: Crucible web UI</span>
                <span class="c1"># Added pad_timeseries</span>
                <span class="c1"># @added 20200607 - Feature #3630: webapp - crucible_process_training_data</span>
                <span class="c1"># Added training_data_json</span>
                <span class="n">crucible_job_id</span><span class="p">,</span> <span class="n">metrics_submitted_to_process</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">submit_crucible_job</span><span class="p">(</span><span class="n">from_timestamp</span><span class="p">,</span> <span class="n">until_timestamp</span><span class="p">,</span> <span class="n">metrics_list</span><span class="p">,</span> <span class="n">namespaces_list</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">alert_interval</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">add_to_panorama</span><span class="p">,</span> <span class="n">pad_timeseries</span><span class="p">,</span> <span class="n">training_data_json</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;crucible_process_metrics - submit_crucible_job returned (</span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">crucible_job_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">metrics_submitted_to_process</span><span class="p">),</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">message</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">trace</span><span class="p">)))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Uh oh ... a Skyline 500 using submit_crucible_job(</span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">from_timestamp</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">until_timestamp</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">metrics_list</span><span class="p">),</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">namespaces_list</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">source</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">alert_interval</span><span class="p">),</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">user_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">user</span><span class="p">))</span>
                <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">crucible_job_id</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">job_submitted</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="n">send_to_panorama_request</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;send_anomalies_panorama request&#39;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;send_anomalies_panorama request for crucible_job_id </span><span class="si">%s</span><span class="s1"> and metric </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">crucible_job_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">crucible_job_metric</span><span class="p">)))</span>
        <span class="n">crucible_job_details</span><span class="p">,</span> <span class="n">completed_job</span><span class="p">,</span> <span class="n">has_anomalies</span><span class="p">,</span> <span class="n">skyline_anomalies</span><span class="p">,</span> <span class="n">skyline_consensus_anomalies</span><span class="p">,</span> <span class="n">panorama_done</span><span class="p">,</span> <span class="n">panorama_done_timestamp</span><span class="p">,</span> <span class="n">panorama_done_user_id</span><span class="p">,</span> <span class="n">image_files</span><span class="p">,</span> <span class="n">image_file_names</span><span class="p">,</span> <span class="n">graph_image_file</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">get_crucible_job</span><span class="p">(</span><span class="n">crucible_job_id</span><span class="p">,</span> <span class="n">crucible_job_metric</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">sent_to_panorama</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">send_crucible_job_metric_to_panorama</span><span class="p">(</span><span class="n">crucible_job_id</span><span class="p">,</span> <span class="n">crucible_job_metric</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">skyline_consensus_anomalies</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;send_anomalies_panorama request sent </span><span class="si">%s</span><span class="s1"> anomalies to Panorama&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">sent_to_panorama</span><span class="p">))</span>
            <span class="n">crucible_job_request</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Uh oh ... a Skyline 500 using get_crucible_jobs&#39;</span>
            <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">process_metrics_request</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">crucible_job_request</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">send_to_panorama_request</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;crucible_jobs_list request&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">crucible_jobs_list</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">get_crucible_jobs</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;crucible_jobs_list determined&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Uh oh ... a Skyline 500 using get_crucible_jobs&#39;</span>
            <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">crucible_jobs_list</span><span class="p">:</span>

            <span class="c1"># @added 20200428 - Feature #3500: webapp - crucible_process_metrics</span>
            <span class="c1">#                   Feature #1448: Crucible web UI</span>
            <span class="c1"># Added pagination to crucible_jobs page</span>
            <span class="n">sorted_crucible_jobs_list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">crucible_jobs_list</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="c1"># sorted_crucible_jobs = sorted(crucible_jobs, key=lambda x: x[8])</span>
            <span class="n">sorted_crucible_jobs_list</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
            <span class="n">total_crucible_jobs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">crucible_jobs_list</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;crucible_jobs_list has a total of </span><span class="si">%s</span><span class="s1"> jobs&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">total_crucible_jobs</span><span class="p">)))</span>
            <span class="n">paginated_crucible_jobs_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">pagination_end</span> <span class="o">=</span> <span class="n">pagination_start</span> <span class="o">+</span> <span class="n">offset</span>
            <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">sorted_crucible_jobs_list</span><span class="p">[</span><span class="n">pagination_start</span><span class="p">:</span><span class="n">pagination_end</span><span class="p">]:</span>
                <span class="n">paginated_crucible_jobs_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;crucible_jobs_list paginated from </span><span class="si">%s</span><span class="s1"> to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="nb">str</span><span class="p">(</span><span class="n">pagination_start</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">pagination_end</span><span class="p">)))</span>
            <span class="k">del</span> <span class="n">sorted_crucible_jobs_list</span>

            <span class="c1"># @modified 20200428 - Feature #3500: webapp - crucible_process_metrics</span>
            <span class="c1">#                      Feature #1448: Crucible web UI</span>
            <span class="c1"># Added pagination to crucible_jobs page</span>
            <span class="c1"># for metric_name, root, crucible_job_id, human_date, completed_job, has_anomalies, panorama_done, skyline_consensus_anomalies_present in crucible_jobs_list:</span>
            <span class="n">job_list_item</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">for</span> <span class="n">metric_name</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">crucible_job_id</span><span class="p">,</span> <span class="n">human_date</span><span class="p">,</span> <span class="n">completed_job</span><span class="p">,</span> <span class="n">has_anomalies</span><span class="p">,</span> <span class="n">panorama_done</span><span class="p">,</span> <span class="n">skyline_consensus_anomalies_present</span> <span class="ow">in</span> <span class="n">paginated_crucible_jobs_list</span><span class="p">:</span>
                <span class="n">crucible_jobs</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">human_date</span><span class="p">,</span> <span class="n">crucible_job_id</span><span class="p">,</span> <span class="n">completed_job</span><span class="p">,</span> <span class="n">has_anomalies</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">metric_name</span><span class="p">,</span> <span class="n">panorama_done</span><span class="p">,</span> <span class="n">skyline_consensus_anomalies_present</span><span class="p">,</span> <span class="n">job_list_item</span><span class="p">])</span>
                <span class="n">job_list_item</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">del</span> <span class="n">paginated_crucible_jobs_list</span>

            <span class="k">if</span> <span class="n">crucible_jobs</span><span class="p">:</span>
                <span class="n">sorted_crucible_jobs</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">crucible_jobs</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="c1"># sorted_crucible_jobs = sorted(crucible_jobs, key=lambda x: x[8])</span>
                <span class="n">crucible_jobs</span> <span class="o">=</span> <span class="n">sorted_crucible_jobs</span>
                <span class="n">crucible_jobs</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
                <span class="k">del</span> <span class="n">sorted_crucible_jobs</span>
            <span class="k">del</span> <span class="n">crucible_jobs_list</span>

    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span>
        <span class="s1">&#39;crucible.html&#39;</span><span class="p">,</span> <span class="n">process_metrics</span><span class="o">=</span><span class="n">process_metrics</span><span class="p">,</span>
        <span class="n">crucible_job_id</span><span class="o">=</span><span class="n">crucible_job_id</span><span class="p">,</span>
        <span class="n">from_timestamp</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">from_timestamp</span><span class="p">),</span> <span class="n">until_timestamp</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">until_timestamp</span><span class="p">),</span>
        <span class="n">metrics</span><span class="o">=</span><span class="n">metrics_list</span><span class="p">,</span> <span class="n">namespaces</span><span class="o">=</span><span class="n">namespaces_list</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">,</span>
        <span class="n">alert_interval</span><span class="o">=</span><span class="n">alert_interval</span><span class="p">,</span> <span class="n">job_submitted</span><span class="o">=</span><span class="n">job_submitted</span><span class="p">,</span>
        <span class="n">metrics_submitted_to_process</span><span class="o">=</span><span class="n">metrics_submitted_to_process</span><span class="p">,</span>
        <span class="n">crucible_jobs</span><span class="o">=</span><span class="n">crucible_jobs</span><span class="p">,</span> <span class="n">crucible_job</span><span class="o">=</span><span class="n">crucible_job_request</span><span class="p">,</span>
        <span class="n">crucible_job_dir</span><span class="o">=</span><span class="n">crucible_job_dir</span><span class="p">,</span>
        <span class="n">crucible_job_metric</span><span class="o">=</span><span class="n">crucible_job_metric</span><span class="p">,</span>
        <span class="n">crucible_job_details</span><span class="o">=</span><span class="n">crucible_job_details</span><span class="p">,</span> <span class="n">completed_job</span><span class="o">=</span><span class="n">completed_job</span><span class="p">,</span>
        <span class="n">has_anomalies</span><span class="o">=</span><span class="n">has_anomalies</span><span class="p">,</span> <span class="n">skyline_anomalies</span><span class="o">=</span><span class="n">skyline_anomalies</span><span class="p">,</span>
        <span class="n">skyline_consensus_anomalies</span><span class="o">=</span><span class="n">skyline_consensus_anomalies</span><span class="p">,</span>
        <span class="n">skyline_consensus_anomalies_present</span><span class="o">=</span><span class="n">skyline_consensus_anomalies_present</span><span class="p">,</span>
        <span class="n">sent_to_panorama</span><span class="o">=</span><span class="n">sent_to_panorama</span><span class="p">,</span> <span class="n">panorama_done</span><span class="o">=</span><span class="n">panorama_done</span><span class="p">,</span>
        <span class="n">panorama_done_timestamp</span><span class="o">=</span><span class="n">panorama_done_timestamp</span><span class="p">,</span>
        <span class="n">panorama_done_user_id</span><span class="o">=</span><span class="n">panorama_done_user_id</span><span class="p">,</span>
        <span class="n">image_files</span><span class="o">=</span><span class="n">image_files</span><span class="p">,</span> <span class="n">image_file_names</span><span class="o">=</span><span class="n">image_file_names</span><span class="p">,</span>
        <span class="n">graph_image_file</span><span class="o">=</span><span class="n">graph_image_file</span><span class="p">,</span>
        <span class="n">crucible_enabled</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">ENABLE_CRUCIBLE</span><span class="p">,</span>
        <span class="c1"># @added 20200428 - Feature #3500: webapp - crucible_process_metrics</span>
        <span class="c1">#                   Feature #1448: Crucible web UI</span>
        <span class="c1"># Added pagination to crucible_jobs page</span>
        <span class="n">pagination_start</span><span class="o">=</span><span class="n">pagination_start</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">,</span>
        <span class="n">pagination_end</span><span class="o">=</span><span class="n">pagination_end</span><span class="p">,</span>
        <span class="n">total_crucible_jobs</span><span class="o">=</span><span class="n">total_crucible_jobs</span><span class="p">,</span>
        <span class="n">version</span><span class="o">=</span><span class="n">skyline_version</span><span class="p">,</span>
        <span class="n">duration</span><span class="o">=</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">),</span> <span class="n">print_debug</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span> <span class="mi">200</span></div>


<span class="c1"># @added 20161123 - Branch #922: ionosphere</span>
<div class="viewcode-block" id="ionosphere"><a class="viewcode-back" href="../../skyline.webapp.html#webapp.webapp.ionosphere">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/ionosphere&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="nd">@requires_auth</span>
<span class="k">def</span> <span class="nf">ionosphere</span><span class="p">():</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_ENABLED</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span>
                <span class="s1">&#39;uh_oh.html&#39;</span><span class="p">,</span> <span class="n">version</span><span class="o">=</span><span class="n">skyline_version</span><span class="p">,</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Ionosphere is not enabled, please see the Ionosphere section in the docs and settings.py&quot;</span><span class="p">),</span> <span class="mi">200</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;Uh oh ... a Skyline 500 :(&#39;</span><span class="p">,</span> <span class="mi">500</span>

    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="c1"># @added 20190919 - Feature #3230: users DB table</span>
    <span class="c1">#                   Ideas #2476: Label and relate anomalies</span>
    <span class="c1">#                   Feature #2516: Add label to features profile</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">WEBAPP_AUTH_ENABLED</span><span class="p">:</span>
        <span class="n">auth</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">authorization</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">auth</span><span class="o">.</span><span class="n">username</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">user</span> <span class="o">=</span> <span class="s1">&#39;Skyline&#39;</span>
        <span class="n">user_id</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="c1"># @added 20191211 - Feature #3230: users DB table</span>
    <span class="c1">#                   Ideas #2476: Label and relate anomalies</span>
    <span class="c1">#                   Feature #2516: Add label to features profile</span>
    <span class="c1"># Allow the user_id to be passed as a request argument</span>
    <span class="k">if</span> <span class="s1">&#39;user_id&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="n">user_id_str</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;user_id&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">user_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">user_id_str</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: the /ionosphere user_id argument is not an int - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">user_id_str</span><span class="p">))</span>
            <span class="k">return</span> <span class="s1">&#39;400 Bad Request - invalid user_id argument&#39;</span><span class="p">,</span> <span class="mi">400</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">user_id</span><span class="p">:</span>
        <span class="n">success</span><span class="p">,</span> <span class="n">user_id</span> <span class="o">=</span> <span class="n">get_user_details</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="s1">&#39;username&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">user</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">success</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: /ionosphere could not get_user_details(</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">user</span><span class="p">))</span>
            <span class="k">return</span> <span class="s1">&#39;Internal Server Error - ref: i - could not determine user_id&#39;</span><span class="p">,</span> <span class="mi">500</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">user_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/ionosphere get_user_details() with </span><span class="si">%s</span><span class="s1"> returned user id </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">user</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">user_id</span><span class="p">)))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: /ionosphere get_user_details() with </span><span class="si">%s</span><span class="s1"> did not return an int&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">user</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">user_id</span><span class="p">)))</span>
                <span class="k">return</span> <span class="s1">&#39;Internal Server Error - ref: i - user_id not int&#39;</span><span class="p">,</span> <span class="mi">500</span>

    <span class="n">request_args_present</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">request_args_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
        <span class="n">request_args_present</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">request_args_len</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">if</span> <span class="n">request_args_len</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;request argument - </span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>

    <span class="c1"># @added 20180419 - Feature #1996: Ionosphere - matches page</span>
    <span class="c1">#                   Branch #2270: luminosity</span>
    <span class="c1"># Change the default search parameters to return all matches for the</span>
    <span class="c1"># past 24 hours</span>
    <span class="n">matched_request_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
    <span class="n">default_matched_from_timestamp</span> <span class="o">=</span> <span class="n">matched_request_timestamp</span> <span class="o">-</span> <span class="mi">86400</span>
    <span class="n">matched_from_datetime</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1"> %H:%M&#39;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">(</span><span class="n">default_matched_from_timestamp</span><span class="p">))</span>

    <span class="c1"># @added 20190328 - Feature #2484: FULL_DURATION feature profiles</span>
    <span class="c1"># Added ionosphere_echo</span>
    <span class="n">echo_hdate</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">metric_id</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># @added 20180812 - Feature #2430: Ionosphere validate learnt features profiles page</span>
    <span class="n">features_profiles_to_validate</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">fp_validate_req</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="s1">&#39;fp_validate&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="n">fp_validate_req</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;fp_validate&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fp_validate_req</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
            <span class="n">fp_validate_req</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">fp_validate_req</span><span class="p">:</span>
        <span class="n">metric_found</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># @modified 20190503 - Branch #2646: slack - linting</span>
        <span class="c1"># timestamp = False</span>
        <span class="n">base_name</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># @added 20181013 - Feature #2430: Ionosphere validate learnt features profiles page</span>
        <span class="c1"># Added the validate_all context and function</span>
        <span class="n">validate_all</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">all_validated</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">metric_id</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">validated_count</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;request argument - </span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>

            <span class="c1"># @added 20181013 - Feature #2430: Ionosphere validate learnt features profiles page</span>
            <span class="c1"># Added the validate_all context and function</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;validate_all&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                    <span class="n">validate_all</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;all_validated&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                    <span class="n">all_validated</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="c1"># Ensure that validate_all is set to False so another call</span>
                    <span class="c1"># is not made to the validate_all function</span>
                    <span class="n">validate_all</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;metric_id&#39;</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="nb">int</span><span class="p">):</span>
                        <span class="n">metric_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: the metric_id request parameter was passed but is not an int - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;validated_count&#39;</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="nb">int</span><span class="p">):</span>
                        <span class="n">validated_count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: the validated_count request parameter was passed but is not an int - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;order&#39;</span><span class="p">:</span>
                <span class="n">order</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">order</span> <span class="o">==</span> <span class="s1">&#39;DESC&#39;</span><span class="p">:</span>
                    <span class="n">ordered_by</span> <span class="o">=</span> <span class="s1">&#39;DESC&#39;</span>
                <span class="k">if</span> <span class="n">order</span> <span class="o">==</span> <span class="s1">&#39;ASC&#39;</span><span class="p">:</span>
                    <span class="n">ordered_by</span> <span class="o">=</span> <span class="s1">&#39;ASC&#39;</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;limit&#39;</span><span class="p">:</span>
                <span class="n">limit</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">test_limit</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">limit</span><span class="p">)</span> <span class="o">+</span> <span class="mi">0</span>
                    <span class="n">limited_by</span> <span class="o">=</span> <span class="n">test_limit</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: limit is not an integer - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">limit</span><span class="p">))</span>
                    <span class="n">limited_by</span> <span class="o">=</span> <span class="s1">&#39;30&#39;</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;metric&#39;</span><span class="p">:</span>
                <span class="n">base_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">base_name</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
                    <span class="n">metric_found</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">metric_name</span> <span class="o">=</span> <span class="s1">&#39;all&#39;</span>
                    <span class="n">limited_by</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">ordered_by</span> <span class="o">=</span> <span class="s1">&#39;DESC&#39;</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">metric_found</span><span class="p">:</span>
                    <span class="n">metric_name</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span> <span class="o">+</span> <span class="n">base_name</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">unique_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span> <span class="o">+</span> <span class="s1">&#39;unique_metrics&#39;</span><span class="p">))</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: Webapp could not get the unique_metrics list from Redis&#39;</span><span class="p">)</span>
                        <span class="k">return</span> <span class="s1">&#39;Internal Server Error&#39;</span><span class="p">,</span> <span class="mi">500</span>
                    <span class="k">if</span> <span class="n">metric_name</span> <span class="ow">in</span> <span class="n">unique_metrics</span><span class="p">:</span>
                        <span class="n">metric_found</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="c1"># @added 20180423 - Feature #2034: analyse_derivatives</span>
                    <span class="c1">#                   Branch #2270: luminosity</span>
                    <span class="n">other_unique_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">if</span> <span class="n">metric_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unique_metrics</span> <span class="ow">and</span> <span class="n">settings</span><span class="o">.</span><span class="n">OTHER_SKYLINE_REDIS_INSTANCES</span><span class="p">:</span>
                        <span class="n">metric_found_in_other_redis</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="c1"># @modified 20180519 - Feature #2378: Add redis auth to Skyline and rebrow</span>
                        <span class="c1"># for redis_ip, redis_port in settings.OTHER_SKYLINE_REDIS_INSTANCES:</span>
                        <span class="k">for</span> <span class="n">redis_ip</span><span class="p">,</span> <span class="n">redis_port</span><span class="p">,</span> <span class="n">redis_password</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">OTHER_SKYLINE_REDIS_INSTANCES</span><span class="p">:</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">metric_found_in_other_redis</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">redis_password</span><span class="p">:</span>
                                        <span class="n">other_redis_conn</span> <span class="o">=</span> <span class="n">redis</span><span class="o">.</span><span class="n">StrictRedis</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">redis_ip</span><span class="p">),</span> <span class="n">port</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">redis_port</span><span class="p">),</span> <span class="n">password</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">redis_password</span><span class="p">))</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="n">other_redis_conn</span> <span class="o">=</span> <span class="n">redis</span><span class="o">.</span><span class="n">StrictRedis</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">redis_ip</span><span class="p">),</span> <span class="n">port</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">redis_port</span><span class="p">))</span>
                                    <span class="n">other_unique_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">other_redis_conn</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span> <span class="o">+</span> <span class="s1">&#39;unique_metrics&#39;</span><span class="p">))</span>
                                <span class="k">except</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to connect to Redis at </span><span class="si">%s</span><span class="s1"> on port </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">redis_ip</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">redis_port</span><span class="p">)))</span>
                                <span class="k">if</span> <span class="n">metric_name</span> <span class="ow">in</span> <span class="n">other_unique_metrics</span><span class="p">:</span>
                                    <span class="n">metric_found_in_other_redis</span> <span class="o">=</span> <span class="kc">True</span>
                                    <span class="n">metric_found</span> <span class="o">=</span> <span class="kc">True</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> found in derivative_metrics in Redis at </span><span class="si">%s</span><span class="s1"> on port </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">redis_ip</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">redis_port</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">metric_found</span><span class="p">:</span>

            <span class="c1"># @added 20181013 - Feature #2430: Ionosphere validate learnt features profiles page</span>
            <span class="c1"># Added the validate_all context and function, first do the</span>
            <span class="c1"># validate_all if it has been passed</span>
            <span class="k">if</span> <span class="n">validate_all</span> <span class="ow">and</span> <span class="n">metric_id</span><span class="p">:</span>
                <span class="n">features_profiles_to_validate_count</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">features_profiles_to_validate</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">get_features_profiles_to_validate</span><span class="p">(</span><span class="n">base_name</span><span class="p">)</span>
                    <span class="n">features_profiles_to_validate_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">features_profiles_to_validate</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> features profiles found that need validating for </span><span class="si">%s</span><span class="s1"> with metric_id </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">features_profiles_to_validate_count</span><span class="p">),</span> <span class="n">base_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">)))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Uh oh ... a Skyline 500 using get_features_profiles_to_validate(</span><span class="si">%s</span><span class="s1">) with metric_id </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">base_name</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">))</span>
                    <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">features_profiles_to_validate_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># @modified 20190919 - Feature #3230: users DB table</span>
                        <span class="c1">#                      Ideas #2476: Label and relate anomalies</span>
                        <span class="c1">#                      Feature #2516: Add label to features profile</span>
                        <span class="c1"># Added user_id</span>
                        <span class="c1"># all_validated, fail_msg, traceback_format_exc = validate_fp(int(metric_id), &#39;metric_id&#39;)</span>
                        <span class="n">all_validated</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">traceback_format_exc</span> <span class="o">=</span> <span class="n">validate_fp</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">metric_id</span><span class="p">),</span> <span class="s1">&#39;metric_id&#39;</span><span class="p">,</span> <span class="n">user_id</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;validated all the enabled, unvalidated features profiles for metric_id - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">all_validated</span><span class="p">:</span>
                            <span class="n">validated_count</span> <span class="o">=</span> <span class="n">features_profiles_to_validate_count</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                        <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Uh oh ... a Skyline 500 using get_features_profiles_to_validate(</span><span class="si">%s</span><span class="s1">) with metric_id </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">base_name</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">))</span>
                        <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

            <span class="n">features_profiles_to_validate</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">metric_name</span> <span class="o">!=</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">features_profiles_to_validate</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">get_features_profiles_to_validate</span><span class="p">(</span><span class="n">base_name</span><span class="p">)</span>
                    <span class="c1"># features_profiles_to_validate</span>
                    <span class="c1"># [ fp_id, metric_id, metric, full_duration, anomaly_timestamp,</span>
                    <span class="c1">#   fp_parent_id, parent_full_duration, parent_anomaly_timestamp,</span>
                    <span class="c1">#   fp_date, fp_graph_uri, parent_fp_date, parent_fp_graph_uri,</span>
                    <span class="c1">#   parent_prent_fp_id, fp_learn_graph_uri, parent_fp_learn_graph_uri,</span>
                    <span class="c1">#   minimum_full_duration, maximum_full_duration]</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> features profiles found that need validating for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">features_profiles_to_validate</span><span class="p">)),</span> <span class="n">base_name</span><span class="p">))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Uh oh ... a Skyline 500 using get_features_profiles_to_validate(</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">base_name</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">default_learn_full_duration</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_LEARN_DEFAULT_FULL_DURATION_DAYS</span><span class="p">)</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">default_learn_full_duration</span> <span class="o">=</span> <span class="mi">30</span> <span class="o">*</span> <span class="mi">24</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">*</span> <span class="mi">60</span>
            <span class="n">metrics_with_features_profiles_to_validate</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">features_profiles_to_validate</span><span class="p">:</span>
                <span class="c1"># metrics_with_features_profiles_to_validate</span>
                <span class="c1"># [[metric_id, metric, fps_to_validate_count]]</span>
                <span class="n">metrics_with_features_profiles_to_validate</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">get_metrics_with_features_profiles_to_validate</span><span class="p">()</span>

                <span class="c1"># @added 20190501 - Feature #2430: Ionosphere validate learnt features profiles page</span>
                <span class="c1"># Only add to features_profiles_to_validate if the metric is active</span>
                <span class="c1"># in Redis</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">settings</span><span class="o">.</span><span class="n">OTHER_SKYLINE_REDIS_INSTANCES</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">metrics_with_features_profiles_to_validate</span><span class="p">:</span>
                        <span class="n">active_metrics_with_features_profiles_to_validate</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">unique_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span> <span class="o">+</span> <span class="s1">&#39;unique_metrics&#39;</span><span class="p">))</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: Webapp could not get the unique_metrics list from Redis&#39;</span><span class="p">)</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                            <span class="k">return</span> <span class="s1">&#39;Internal Server Error&#39;</span><span class="p">,</span> <span class="mi">500</span>
                        <span class="k">for</span> <span class="n">i_metric_id</span><span class="p">,</span> <span class="n">i_metric</span><span class="p">,</span> <span class="n">fps_to_validate_count</span> <span class="ow">in</span> <span class="n">metrics_with_features_profiles_to_validate</span><span class="p">:</span>
                            <span class="n">i_metric_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">i_metric</span><span class="p">))</span>
                            <span class="k">if</span> <span class="n">i_metric_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unique_metrics</span><span class="p">:</span>
                                <span class="k">continue</span>
                            <span class="n">active_metrics_with_features_profiles_to_validate</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">i_metric_id</span><span class="p">,</span> <span class="n">i_metric</span><span class="p">,</span> <span class="n">fps_to_validate_count</span><span class="p">])</span>
                        <span class="n">metrics_with_features_profiles_to_validate</span> <span class="o">=</span> <span class="n">active_metrics_with_features_profiles_to_validate</span>

                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;no features_profiles_to_validate was passed so determined metrics_with_features_profiles_to_validate&#39;</span><span class="p">)</span>

            <span class="c1"># @added 20190503 - Branch #2646: slack</span>
            <span class="k">if</span> <span class="n">validated_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">slack_updated</span> <span class="o">=</span> <span class="n">webapp_update_slack_thread</span><span class="p">(</span><span class="n">base_name</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">validated_count</span><span class="p">,</span> <span class="s1">&#39;validated&#39;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;slack_updated for validated features profiles </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">slack_updated</span><span class="p">))</span>

            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span>
                <span class="s1">&#39;ionosphere.html&#39;</span><span class="p">,</span> <span class="n">fp_validate</span><span class="o">=</span><span class="n">fp_validate_req</span><span class="p">,</span>
                <span class="n">features_profiles_to_validate</span><span class="o">=</span><span class="n">features_profiles_to_validate</span><span class="p">,</span>
                <span class="n">metrics_with_features_profiles_to_validate</span><span class="o">=</span><span class="n">metrics_with_features_profiles_to_validate</span><span class="p">,</span>
                <span class="n">for_metric</span><span class="o">=</span><span class="n">base_name</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">ordered_by</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limited_by</span><span class="p">,</span>
                <span class="n">default_learn_full_duration</span><span class="o">=</span><span class="n">default_learn_full_duration</span><span class="p">,</span>
                <span class="n">matched_from_datetime</span><span class="o">=</span><span class="n">matched_from_datetime</span><span class="p">,</span>
                <span class="n">validate_all</span><span class="o">=</span><span class="n">validate_all</span><span class="p">,</span> <span class="n">all_validated</span><span class="o">=</span><span class="n">all_validated</span><span class="p">,</span>
                <span class="n">validated_count</span><span class="o">=</span><span class="n">validated_count</span><span class="p">,</span>
                <span class="n">version</span><span class="o">=</span><span class="n">skyline_version</span><span class="p">,</span>
                <span class="c1"># @added 20190919 - Feature #3230: users DB table</span>
                <span class="c1">#                   Feature #2516: Add label to features profile</span>
                <span class="n">user</span><span class="o">=</span><span class="n">user</span><span class="p">,</span>
                <span class="n">duration</span><span class="o">=</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">),</span> <span class="n">print_debug</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span> <span class="mi">200</span>

    <span class="c1"># @added 20170220 - Feature #1862: Ionosphere features profiles search page</span>
    <span class="c1"># Ionosphere features profiles by generations</span>
    <span class="n">fp_search_req</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># @added 20170916 - Feature #1996: Ionosphere - matches page</span>
    <span class="c1"># Handle both fp_search and fp_matches</span>
    <span class="n">fp_search_or_matches_req</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="s1">&#39;fp_search&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="n">fp_search_req</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;fp_search&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fp_search_req</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
            <span class="n">fp_search_req</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">fp_search_or_matches_req</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fp_search_req</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># @added 20170916 - Feature #1996: Ionosphere - matches page</span>
    <span class="n">fp_matches_req</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="s1">&#39;fp_matches&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
        <span class="n">fp_matches_req</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;fp_matches&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fp_matches_req</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
            <span class="n">fp_matches_req</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">fp_search_or_matches_req</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">from_timestamp</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">until_timestamp</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fp_matches_req</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="c1"># @modified 20170916 - Feature #1996: Ionosphere - matches page</span>
    <span class="c1"># Handle both fp_search and fp_matches</span>
    <span class="c1"># if fp_search_req and request_args_len &gt; 1:</span>
    <span class="k">if</span> <span class="n">fp_search_or_matches_req</span> <span class="ow">and</span> <span class="n">request_args_len</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">REQUEST_ARGS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;fp_search&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;metric&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;metric_like&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;from_timestamp&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;until_timestamp&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;generation_greater_than&#39;</span><span class="p">,</span>
                        <span class="c1"># @added 20170315 - Feature #1960: ionosphere_layers</span>
                        <span class="s1">&#39;layers_id_greater_than&#39;</span><span class="p">,</span>
                        <span class="c1"># @added 20170402 - Feature #2000: Ionosphere - validated</span>
                        <span class="s1">&#39;validated_equals&#39;</span><span class="p">,</span>
                        <span class="c1"># @added 20170518 - Feature #1996: Ionosphere - matches page - matched_greater_than</span>
                        <span class="s1">&#39;matched_greater_than&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;full_duration&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;enabled&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;tsfresh_version&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;generation&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;count_by_metric&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;count_by_matched&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;count_by_generation&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;count_by_checked&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;limit&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;order&#39;</span><span class="p">,</span>
                        <span class="c1"># @added 20170916 - Feature #1996: Ionosphere - matches page</span>
                        <span class="s1">&#39;fp_matches&#39;</span><span class="p">,</span>
                        <span class="c1"># @added 20170917 - Feature #1996: Ionosphere - matches page</span>
                        <span class="s1">&#39;fp_id&#39;</span><span class="p">,</span> <span class="s1">&#39;layer_id&#39;</span><span class="p">,</span>
                        <span class="c1"># @added 20180804 - Feature #2488: Allow user to specifically set metric as a derivative metric in training_data</span>
                        <span class="s1">&#39;load_derivative_graphs&#39;</span><span class="p">,</span>
                        <span class="c1"># @added 20180917 - Feature #2602: Graphs in search_features_profiles</span>
                        <span class="s1">&#39;show_graphs&#39;</span><span class="p">,</span>
                        <span class="c1"># @added 20191212 - Feature #3230: users DB table</span>
                        <span class="c1">#                   Feature #2516: Add label to features profile</span>
                        <span class="c1"># Allow the user_id to be passed as a request argument</span>
                        <span class="s1">&#39;user_id&#39;</span><span class="p">,</span>
                        <span class="p">]</span>

        <span class="n">count_by_metric</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">ordered_by</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">limited_by</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">get_metric_profiles</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">not_metric_wildcard</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># @added 20200710 - Feature #1996: Ionosphere - matches page</span>
        <span class="c1"># Moved from within the loop below</span>
        <span class="n">matching</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">metric_like</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">REQUEST_ARGS</span><span class="p">:</span>
                <span class="c1"># @modified 20190524 - Branch #3002: docker</span>
                <span class="c1"># Return data</span>
                <span class="c1"># logger.error(&#39;error :: invalid request argument - %s&#39; % (key))</span>
                <span class="c1"># return &#39;Bad Request&#39;, 400</span>
                <span class="n">error_string</span> <span class="o">=</span> <span class="s1">&#39;error :: invalid request argument - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_string</span><span class="p">)</span>
                <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                    <span class="p">{</span><span class="s1">&#39;400 Bad Request&#39;</span><span class="p">:</span> <span class="n">error_string</span><span class="p">})</span>
                <span class="k">return</span> <span class="n">flask_escape</span><span class="p">(</span><span class="n">resp</span><span class="p">),</span> <span class="mi">400</span>

            <span class="n">value</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;request argument - </span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>

            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;order&#39;</span><span class="p">:</span>
                <span class="n">order</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">order</span> <span class="o">==</span> <span class="s1">&#39;DESC&#39;</span><span class="p">:</span>
                    <span class="n">ordered_by</span> <span class="o">=</span> <span class="s1">&#39;DESC&#39;</span>
                <span class="k">if</span> <span class="n">order</span> <span class="o">==</span> <span class="s1">&#39;ASC&#39;</span><span class="p">:</span>
                    <span class="n">ordered_by</span> <span class="o">=</span> <span class="s1">&#39;ASC&#39;</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;limit&#39;</span><span class="p">:</span>
                <span class="n">limit</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">test_limit</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">limit</span><span class="p">)</span> <span class="o">+</span> <span class="mi">0</span>
                    <span class="n">limited_by</span> <span class="o">=</span> <span class="n">test_limit</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: limit is not an integer - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">limit</span><span class="p">))</span>
                    <span class="n">limited_by</span> <span class="o">=</span> <span class="s1">&#39;30&#39;</span>

            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;from_timestamp&#39;</span> <span class="ow">or</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;until_timestamp&#39;</span><span class="p">:</span>
                <span class="n">timestamp_format_invalid</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
                    <span class="n">timestamp_format_invalid</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="c1"># unix timestamp</span>
                <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                    <span class="n">timestamp_format_invalid</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="c1"># %Y%m%d %H:%M timestamp</span>
                <span class="k">if</span> <span class="n">timestamp_format_invalid</span><span class="p">:</span>
                    <span class="n">value_strip_colon</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="n">new_value</span> <span class="o">=</span> <span class="n">value_strip_colon</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">new_value</span><span class="o">.</span><span class="n">isdigit</span><span class="p">():</span>
                        <span class="n">timestamp_format_invalid</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">timestamp_format_invalid</span><span class="p">:</span>
                    <span class="n">error_string</span> <span class="o">=</span> <span class="s1">&#39;error :: invalid </span><span class="si">%s</span><span class="s1"> value passed </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: invalid </span><span class="si">%s</span><span class="s1"> value passed </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>
                    <span class="c1"># @modified 20190524 - Branch #3002: docker</span>
                    <span class="c1"># Return data</span>
                    <span class="c1"># return &#39;Bad Request&#39;, 400</span>
                    <span class="n">error_string</span> <span class="o">=</span> <span class="s1">&#39;error :: invalid request argument - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_string</span><span class="p">)</span>
                    <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                        <span class="p">{</span><span class="s1">&#39;400 Bad Request&#39;</span><span class="p">:</span> <span class="n">error_string</span><span class="p">})</span>
                    <span class="k">return</span> <span class="n">flask_escape</span><span class="p">(</span><span class="n">resp</span><span class="p">),</span> <span class="mi">400</span>

                <span class="c1"># @added 20190524 - Bug #3050: Ionosphere - Skyline and Graphite feedback</span>
                <span class="c1">#                   Branch #3002: docker</span>
                <span class="c1"># Added the missing definition of these 2 variables in the</span>
                <span class="c1"># fp_matches context</span>
                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;from_timestamp&#39;</span><span class="p">:</span>
                    <span class="n">from_timestamp</span> <span class="o">=</span> <span class="n">value</span>
                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;until_timestamp&#39;</span><span class="p">:</span>
                    <span class="n">until_timestamp</span> <span class="o">=</span> <span class="n">value</span>

            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;count_by_metric&#39;</span><span class="p">:</span>
                <span class="n">count_by_metric</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;count_by_metric&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">count_by_metric</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                    <span class="n">count_by_metric</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">count_by_metric</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;metric&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span> <span class="ow">or</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;*&#39;</span><span class="p">:</span>
                    <span class="n">not_metric_wildcard</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">get_metric_profiles</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">metric</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;metric&#39;</span> <span class="ow">and</span> <span class="n">not_metric_wildcard</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">unique_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span> <span class="o">+</span> <span class="s1">&#39;unique_metrics&#39;</span><span class="p">))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: Webapp could not get the unique_metrics list from Redis&#39;</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="k">return</span> <span class="s1">&#39;Internal Server Error&#39;</span><span class="p">,</span> <span class="mi">500</span>
                <span class="n">metric_name</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

                <span class="c1"># @added 20180423 - Feature #2034: analyse_derivatives</span>
                <span class="c1">#                   Branch #2270: luminosity</span>
                <span class="n">metric_found_in_other_redis</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">other_unique_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="n">metric_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unique_metrics</span> <span class="ow">and</span> <span class="n">settings</span><span class="o">.</span><span class="n">OTHER_SKYLINE_REDIS_INSTANCES</span><span class="p">:</span>
                    <span class="c1"># @modified 20180519 - Feature #2378: Add redis auth to Skyline and rebrow</span>
                    <span class="c1"># for redis_ip, redis_port in settings.OTHER_SKYLINE_REDIS_INSTANCES:</span>
                    <span class="k">for</span> <span class="n">redis_ip</span><span class="p">,</span> <span class="n">redis_port</span><span class="p">,</span> <span class="n">redis_password</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">OTHER_SKYLINE_REDIS_INSTANCES</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">metric_found_in_other_redis</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">redis_password</span><span class="p">:</span>
                                    <span class="n">other_redis_conn</span> <span class="o">=</span> <span class="n">redis</span><span class="o">.</span><span class="n">StrictRedis</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">redis_ip</span><span class="p">),</span> <span class="n">port</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">redis_port</span><span class="p">),</span> <span class="n">password</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">redis_password</span><span class="p">))</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">other_redis_conn</span> <span class="o">=</span> <span class="n">redis</span><span class="o">.</span><span class="n">StrictRedis</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">redis_ip</span><span class="p">),</span> <span class="n">port</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">redis_port</span><span class="p">))</span>
                                <span class="n">other_unique_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">other_redis_conn</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span> <span class="o">+</span> <span class="s1">&#39;unique_metrics&#39;</span><span class="p">))</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to connect to Redis at </span><span class="si">%s</span><span class="s1"> on port </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">redis_ip</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">redis_port</span><span class="p">)))</span>
                            <span class="k">if</span> <span class="n">metric_name</span> <span class="ow">in</span> <span class="n">other_unique_metrics</span><span class="p">:</span>
                                <span class="n">metric_found_in_other_redis</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> found in derivative_metrics in Redis at </span><span class="si">%s</span><span class="s1"> on port </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">metric_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">redis_ip</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">redis_port</span><span class="p">)))</span>

                <span class="k">if</span> <span class="n">metric_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unique_metrics</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">metric_found_in_other_redis</span><span class="p">:</span>
                    <span class="c1"># @added 20200715 - Task #3648: webapp - fp_search - do not use Redis metric check</span>
                    <span class="c1"># Do not use the Redis metric check result in a webapp</span>
                    <span class="c1"># fp_search request as this allows retried metric fps to</span>
                    <span class="c1"># accessed</span>
                    <span class="k">if</span> <span class="n">fp_search_req</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;fp_search_or_matches_req - </span><span class="si">%s</span><span class="s1"> not in Redis, but fp_search request so continuing&#39;</span> <span class="o">%</span> <span class="n">metric_name</span><span class="p">)</span>
                        <span class="n">get_metric_profiles</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="n">metric</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">error_string</span> <span class="o">=</span> <span class="s1">&#39;error :: no metric - </span><span class="si">%s</span><span class="s1"> - exists in Redis&#39;</span> <span class="o">%</span> <span class="n">metric_name</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_string</span><span class="p">)</span>
                        <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                            <span class="p">{</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="n">error_string</span><span class="p">})</span>
                        <span class="c1"># @modified 20190116 - Cross-Site Scripting Security Vulnerability #85</span>
                        <span class="c1">#                      Bug #2816: Cross-Site Scripting Security Vulnerability</span>
                        <span class="c1"># return resp, 404</span>
                        <span class="k">return</span> <span class="n">flask_escape</span><span class="p">(</span><span class="n">resp</span><span class="p">),</span> <span class="mi">404</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">get_metric_profiles</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">metric</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

            <span class="c1"># @added 20170917 - Feature #1996: Ionosphere - matches page</span>
            <span class="c1"># @modified 20170917 - Feature #1996: Ionosphere - matches page</span>
            <span class="c1"># Move outside the loop</span>
            <span class="c1"># matching = False</span>
            <span class="c1"># metric_like = False</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;metric_like&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
                    <span class="n">metric_namespace_pattern</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

                <span class="n">metric_namespace_pattern</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;%&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">metric_namespace_pattern</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span> <span class="ow">and</span> <span class="n">value</span> <span class="o">!=</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">unique_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span> <span class="o">+</span> <span class="s1">&#39;unique_metrics&#39;</span><span class="p">))</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                        <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: Webapp could not get the unique_metrics list from Redis&#39;</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

                    <span class="n">matching</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">unique_metrics</span> <span class="k">if</span> <span class="n">metric_namespace_pattern</span> <span class="ow">in</span> <span class="n">s</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">matching</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">error_string</span> <span class="o">=</span> <span class="s1">&#39;error :: no metric like - </span><span class="si">%s</span><span class="s1"> - exists in Redis&#39;</span> <span class="o">%</span> <span class="n">metric_namespace_pattern</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_string</span><span class="p">)</span>
                        <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                            <span class="p">{</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="n">error_string</span><span class="p">})</span>
                        <span class="c1"># @modified 20190116 - Cross-Site Scripting Security Vulnerability #85</span>
                        <span class="c1">#                      Bug #2816: Cross-Site Scripting Security Vulnerability</span>
                        <span class="c1"># return resp, 404</span>
                        <span class="k">return</span> <span class="n">flask_escape</span><span class="p">(</span><span class="n">resp</span><span class="p">),</span> <span class="mi">404</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># @added 20200710 - Feature #1996: Ionosphere - matches page</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metric_like </span><span class="si">%s</span><span class="s1"> was passed, </span><span class="si">%s</span><span class="s1"> metrics found matching&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">matching</span><span class="p">))))</span>
                        <span class="n">metric_like</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">matching</span><span class="p">:</span>
                    <span class="n">metric_like</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">fp_search_req</span> <span class="ow">and</span> <span class="n">request_args_len</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">count_by_metric</span><span class="p">:</span>
            <span class="c1"># @modified 20180717 - Task #2446: Optimize Ionosphere</span>
            <span class="c1"># Added missing search_success variable</span>
            <span class="n">features_profiles</span><span class="p">,</span> <span class="n">fps_count</span><span class="p">,</span> <span class="n">mc</span><span class="p">,</span> <span class="n">cc</span><span class="p">,</span> <span class="n">gc</span><span class="p">,</span> <span class="n">full_duration_list</span><span class="p">,</span> <span class="n">enabled_list</span><span class="p">,</span> <span class="n">tsfresh_version_list</span><span class="p">,</span> <span class="n">generation_list</span><span class="p">,</span> <span class="n">search_success</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">ionosphere_search</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;fp_search_req returning response&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span>
                <span class="s1">&#39;ionosphere.html&#39;</span><span class="p">,</span> <span class="n">fp_search</span><span class="o">=</span><span class="n">fp_search_req</span><span class="p">,</span>
                <span class="n">fp_search_results</span><span class="o">=</span><span class="n">fp_search_req</span><span class="p">,</span>
                <span class="n">features_profiles_count</span><span class="o">=</span><span class="n">fps_count</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">ordered_by</span><span class="p">,</span>
                <span class="n">limit</span><span class="o">=</span><span class="n">limited_by</span><span class="p">,</span> <span class="n">matched_count</span><span class="o">=</span><span class="n">mc</span><span class="p">,</span> <span class="n">checked_count</span><span class="o">=</span><span class="n">cc</span><span class="p">,</span>
                <span class="n">generation_count</span><span class="o">=</span><span class="n">gc</span><span class="p">,</span> <span class="n">matched_from_datetime</span><span class="o">=</span><span class="n">matched_from_datetime</span><span class="p">,</span>
                <span class="n">version</span><span class="o">=</span><span class="n">skyline_version</span><span class="p">,</span>
                <span class="n">duration</span><span class="o">=</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">),</span> <span class="n">print_debug</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span> <span class="mi">200</span>

        <span class="c1"># @added 20180917 - Feature #2602: Graphs in search_features_profiles</span>
        <span class="n">features_profiles_with_images</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">show_graphs</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">get_metric_profiles</span><span class="p">:</span>
            <span class="n">search_success</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">fps</span><span class="p">,</span> <span class="n">fps_count</span><span class="p">,</span> <span class="n">mc</span><span class="p">,</span> <span class="n">cc</span><span class="p">,</span> <span class="n">gc</span><span class="p">,</span> <span class="n">full_duration_list</span><span class="p">,</span> <span class="n">enabled_list</span><span class="p">,</span> <span class="n">tsfresh_version_list</span><span class="p">,</span> <span class="n">generation_list</span><span class="p">,</span> <span class="n">search_success</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">ionosphere_search</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: Webapp error with search_ionosphere&#39;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">search_success</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

            <span class="c1"># @added 20180917 - Feature #2602: Graphs in search_features_profiles</span>
            <span class="k">if</span> <span class="n">search_success</span> <span class="ow">and</span> <span class="n">fps</span><span class="p">:</span>
                <span class="n">show_graphs</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;show_graphs&#39;</span><span class="p">),</span> <span class="kc">False</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">show_graphs</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                    <span class="n">show_graphs</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">search_success</span> <span class="ow">and</span> <span class="n">fps</span> <span class="ow">and</span> <span class="n">show_graphs</span><span class="p">:</span>
                <span class="c1"># @modified 20190503 - Branch #2646: slack - linting</span>
                <span class="c1"># query_context = &#39;features_profiles&#39;</span>

                <span class="k">for</span> <span class="n">fp_elements</span> <span class="ow">in</span> <span class="n">fps</span><span class="p">:</span>
                    <span class="c1"># Get images</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">fp_id</span> <span class="o">=</span> <span class="n">fp_elements</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">base_name</span> <span class="o">=</span> <span class="n">fp_elements</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                        <span class="n">requested_timestamp</span> <span class="o">=</span> <span class="n">fp_elements</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>

                        <span class="c1"># @modified 20181205 - Bug #2746: webapp time out - Graphs in search_features_profiles</span>
                        <span class="c1">#                      Feature #2602: Graphs in search_features_profiles</span>
                        <span class="c1"># This function was causing the webapp to time out due</span>
                        <span class="c1"># to fetching all the matched Graphite graphs</span>
                        <span class="c1"># mpaths, images, hdate, m_vars, ts_json, data_to_process, p_id, gimages, gmimages, times_matched, glm_images, l_id_matched, ts_fd, i_ts_json, anomalous_timeseries, f_id_matched, fp_details_list = ionosphere_metric_data(requested_timestamp, base_name, query_context, fp_id)</span>
                        <span class="n">images</span><span class="p">,</span> <span class="n">gimages</span> <span class="o">=</span> <span class="n">ionosphere_show_graphs</span><span class="p">(</span><span class="n">requested_timestamp</span><span class="p">,</span> <span class="n">base_name</span><span class="p">,</span> <span class="n">fp_id</span><span class="p">)</span>

                        <span class="n">new_fp</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">for</span> <span class="n">fp_element</span> <span class="ow">in</span> <span class="n">fp_elements</span><span class="p">:</span>
                            <span class="n">new_fp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fp_element</span><span class="p">)</span>

                        <span class="c1"># @added 20180918 - Feature #2602: Graphs in search_features_profiles</span>
                        <span class="c1"># The images are required to be sorted here in terms of</span>
                        <span class="c1"># only passing the Redis image (if present) and the</span>
                        <span class="c1"># full duration graph, as it is a bit too much</span>
                        <span class="c1"># achieve in the Jinja template.</span>
                        <span class="n">full_duration_float</span> <span class="o">=</span> <span class="n">fp_elements</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
                        <span class="n">full_duration</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">full_duration_float</span><span class="p">)</span>
                        <span class="n">full_duration_in_hours</span> <span class="o">=</span> <span class="n">full_duration</span> <span class="o">/</span> <span class="mi">60</span> <span class="o">/</span> <span class="mi">60</span>
                        <span class="n">full_duration_in_hours_image_string</span> <span class="o">=</span> <span class="s1">&#39;.</span><span class="si">%s</span><span class="s1">h.png&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">full_duration_in_hours</span><span class="p">))</span>

                        <span class="c1"># @modified 20190503 - Branch #2646: slack - linting</span>
                        <span class="c1"># show_graph_images = []</span>

                        <span class="n">redis_image</span> <span class="o">=</span> <span class="s1">&#39;No Redis data graph&#39;</span>
                        <span class="n">full_duration_image</span> <span class="o">=</span> <span class="s1">&#39;No full duration graph&#39;</span>
                        <span class="c1"># @modified 20180918 - Feature #2602: Graphs in search_features_profiles</span>
                        <span class="c1"># Append individual redis_image and full_duration_image</span>
                        <span class="c1"># list elements instead of just added the images or</span>
                        <span class="c1">#  gimages list</span>
                        <span class="c1"># if images:</span>
                        <span class="c1">#     new_fp.append(images)</span>
                        <span class="c1"># else:</span>
                        <span class="c1">#     new_fp.append(gimages)</span>
                        <span class="k">if</span> <span class="n">images</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">image</span> <span class="ow">in</span> <span class="n">images</span><span class="p">:</span>
                                <span class="k">if</span> <span class="s1">&#39;.redis.plot&#39;</span> <span class="ow">in</span> <span class="n">image</span><span class="p">:</span>
                                    <span class="n">redis_image</span> <span class="o">=</span> <span class="n">image</span>
                                <span class="k">if</span> <span class="n">full_duration_in_hours_image_string</span> <span class="ow">in</span> <span class="n">image</span><span class="p">:</span>
                                    <span class="n">full_duration_image</span> <span class="o">=</span> <span class="n">image</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">image</span> <span class="ow">in</span> <span class="n">gimages</span><span class="p">:</span>
                                <span class="k">if</span> <span class="s1">&#39;.redis.plot&#39;</span> <span class="ow">in</span> <span class="n">image</span><span class="p">:</span>
                                    <span class="n">redis_image</span> <span class="o">=</span> <span class="n">image</span>
                                <span class="k">if</span> <span class="n">full_duration_in_hours_image_string</span> <span class="ow">in</span> <span class="n">image</span><span class="p">:</span>
                                    <span class="n">full_duration_image</span> <span class="o">=</span> <span class="n">image</span>
                        <span class="k">if</span> <span class="n">full_duration_image</span> <span class="o">==</span> <span class="s1">&#39;No full duration graph&#39;</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">image</span> <span class="ow">in</span> <span class="n">gimages</span><span class="p">:</span>
                                <span class="k">if</span> <span class="n">full_duration_in_hours_image_string</span> <span class="ow">in</span> <span class="n">image</span><span class="p">:</span>
                                    <span class="n">full_duration_image</span> <span class="o">=</span> <span class="n">image</span>
                        <span class="n">new_fp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">full_duration_image</span><span class="p">)</span>
                        <span class="n">new_fp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">redis_image</span><span class="p">)</span>

                        <span class="n">features_profiles_with_images</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_fp</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Uh oh ... a Skyline 500 :(&#39;</span>
                        <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                        <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">features_profiles_with_images</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">fps</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">fp_elements</span> <span class="ow">in</span> <span class="n">fps</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">new_fp</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="k">for</span> <span class="n">fp_element</span> <span class="ow">in</span> <span class="n">fp_elements</span><span class="p">:</span>
                                <span class="n">new_fp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fp_element</span><span class="p">)</span>
                            <span class="n">new_fp</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                            <span class="n">features_profiles_with_images</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_fp</span><span class="p">)</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Uh oh ... a Skyline 500 :(&#39;</span>
                            <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                            <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

            <span class="c1"># @modified 20170912 - Feature #2056: ionosphere - disabled_features_profiles</span>
            <span class="c1"># Added enabled_list to display DISABLED in search_features_profiles</span>
            <span class="c1"># page results.</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span>
                <span class="s1">&#39;ionosphere.html&#39;</span><span class="p">,</span> <span class="n">fp_search</span><span class="o">=</span><span class="n">fp_search_req</span><span class="p">,</span>
                <span class="n">fp_search_results</span><span class="o">=</span><span class="n">fp_search_req</span><span class="p">,</span> <span class="n">features_profiles</span><span class="o">=</span><span class="n">fps</span><span class="p">,</span>
                <span class="n">for_metric</span><span class="o">=</span><span class="n">metric</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">ordered_by</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limited_by</span><span class="p">,</span>
                <span class="n">matched_count</span><span class="o">=</span><span class="n">mc</span><span class="p">,</span> <span class="n">checked_count</span><span class="o">=</span><span class="n">cc</span><span class="p">,</span> <span class="n">generation_count</span><span class="o">=</span><span class="n">gc</span><span class="p">,</span>
                <span class="n">enabled_list</span><span class="o">=</span><span class="n">enabled_list</span><span class="p">,</span>
                <span class="n">matched_from_datetime</span><span class="o">=</span><span class="n">matched_from_datetime</span><span class="p">,</span>
                <span class="c1"># @added 20180917 - Feature #2602: Graphs in search_features_profiles</span>
                <span class="n">features_profiles_with_images</span><span class="o">=</span><span class="n">features_profiles_with_images</span><span class="p">,</span>
                <span class="n">show_graphs</span><span class="o">=</span><span class="n">show_graphs</span><span class="p">,</span>
                <span class="n">version</span><span class="o">=</span><span class="n">skyline_version</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">),</span>
                <span class="n">print_debug</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span> <span class="mi">200</span>

    <span class="c1"># @added 20170916 - Feature #1996: Ionosphere - matches page</span>
    <span class="k">if</span> <span class="n">fp_matches_req</span><span class="p">:</span>
        <span class="c1"># @added 20170917 - Feature #1996: Ionosphere - matches page</span>
        <span class="c1"># Added by fp_id or layer_id as well</span>
        <span class="n">fp_id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">layer_id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># @added 20190619 - Feature #3084: Ionosphere - validated matches</span>
        <span class="n">validated_equals</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;fp_id&#39;</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;request key </span><span class="si">%s</span><span class="s1"> set to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># @modified 20190524 - Branch #3002: docker</span>
                    <span class="c1"># test_fp_id = int(value) + 0</span>
                    <span class="c1"># if test_fp_id &gt; 0:</span>
                    <span class="c1">#     fp_id = str(test_fp_id)</span>
                    <span class="n">test_fp_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">test_fp_id</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                        <span class="n">fp_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># @modified 20190116 - Cross-Site Scripting Security Vulnerability #85</span>
                        <span class="c1">#                      Bug #2816: Cross-Site Scripting Security Vulnerability</span>
                        <span class="c1"># Test that the fp_id is an int first</span>
                        <span class="c1"># fp_id = None</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: invalid request argument - fp_id is not an int&#39;</span><span class="p">)</span>
                        <span class="c1"># @modified 20190524 - Branch #3002: docker</span>
                        <span class="c1"># Return data</span>
                        <span class="c1"># return &#39;Bad Request&#39;, 400</span>
                        <span class="n">error_string</span> <span class="o">=</span> <span class="s1">&#39;error :: invalid request argument - fp_id is not an int&#39;</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_string</span><span class="p">)</span>
                        <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                            <span class="p">{</span><span class="s1">&#39;400 Bad Request&#39;</span><span class="p">:</span> <span class="n">error_string</span><span class="p">})</span>
                        <span class="k">return</span> <span class="n">flask_escape</span><span class="p">(</span><span class="n">resp</span><span class="p">),</span> <span class="mi">200</span>

                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;fp_id now set to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">fp_id</span><span class="p">)))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">error_string</span> <span class="o">=</span> <span class="s1">&#39;error :: the fp_id argument was passed but not as an int - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_string</span><span class="p">)</span>
                    <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                        <span class="p">{</span><span class="s1">&#39;400 Bad Request&#39;</span><span class="p">:</span> <span class="n">error_string</span><span class="p">})</span>
                    <span class="c1"># @modified 20190116 - Cross-Site Scripting Security Vulnerability #85</span>
                    <span class="c1">#                      Bug #2816: Cross-Site Scripting Security Vulnerability</span>
                    <span class="c1"># return resp, 404</span>
                    <span class="k">return</span> <span class="n">flask_escape</span><span class="p">(</span><span class="n">resp</span><span class="p">),</span> <span class="mi">404</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;layer_id&#39;</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;request key </span><span class="si">%s</span><span class="s1"> set to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">test_layer_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">+</span> <span class="mi">0</span>
                    <span class="k">if</span> <span class="n">test_layer_id</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">layer_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">test_layer_id</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">layer_id</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;layer_id now set to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">layer_id</span><span class="p">)))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">error_string</span> <span class="o">=</span> <span class="s1">&#39;error :: the layer_id argument was passed but not as an int - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_string</span><span class="p">)</span>
                    <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                        <span class="p">{</span><span class="s1">&#39;400 Bad Request&#39;</span><span class="p">:</span> <span class="n">error_string</span><span class="p">})</span>
                    <span class="c1"># @modified 20190116 - Cross-Site Scripting Security Vulnerability #85</span>
                    <span class="c1">#                      Bug #2816: Cross-Site Scripting Security Vulnerability</span>
                    <span class="c1"># return resp, 404</span>
                    <span class="k">return</span> <span class="n">flask_escape</span><span class="p">(</span><span class="n">resp</span><span class="p">),</span> <span class="mi">404</span>

            <span class="c1"># @added 20190619 - Feature #3084: Ionosphere - validated matches</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;validated_equals&#39;</span><span class="p">:</span>
                <span class="n">validated_equals</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;get_fp_matches with arguments :: </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">, </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">metric</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_like</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">fp_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">layer_id</span><span class="p">),</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">from_timestamp</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">until_timestamp</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">limited_by</span><span class="p">),</span>
            <span class="nb">str</span><span class="p">(</span><span class="n">ordered_by</span><span class="p">)))</span>

        <span class="n">matches</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">get_fp_matches</span><span class="p">(</span><span class="n">metric</span><span class="p">,</span> <span class="n">metric_like</span><span class="p">,</span> <span class="n">fp_id</span><span class="p">,</span> <span class="n">layer_id</span><span class="p">,</span> <span class="n">from_timestamp</span><span class="p">,</span> <span class="n">until_timestamp</span><span class="p">,</span> <span class="n">limited_by</span><span class="p">,</span> <span class="n">ordered_by</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">matches</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

        <span class="c1"># @added 20190619 - Feature #3084: Ionosphere - validated matches</span>
        <span class="k">if</span> <span class="n">validated_equals</span><span class="p">:</span>
            <span class="n">filter_matches</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">validated_equals</span> <span class="o">==</span> <span class="s1">&#39;any&#39;</span><span class="p">:</span>
                <span class="n">filter_matches</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">validated_equals</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                <span class="n">filter_match_validation</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="n">validated_equals</span> <span class="o">==</span> <span class="s1">&#39;false&#39;</span><span class="p">:</span>
                <span class="n">filter_match_validation</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">validated_equals</span> <span class="o">==</span> <span class="s1">&#39;invalid&#39;</span><span class="p">:</span>
                <span class="n">filter_match_validation</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="k">if</span> <span class="n">filter_matches</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;matches filtered by validated = </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="nb">str</span><span class="p">(</span><span class="n">filter_match_validation</span><span class="p">)))</span>

        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span>
            <span class="s1">&#39;ionosphere.html&#39;</span><span class="p">,</span> <span class="n">fp_matches</span><span class="o">=</span><span class="n">fp_matches_req</span><span class="p">,</span> <span class="n">for_metric</span><span class="o">=</span><span class="n">metric</span><span class="p">,</span>
            <span class="n">fp_matches_results</span><span class="o">=</span><span class="n">matches</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">ordered_by</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="n">limited_by</span><span class="p">,</span>
            <span class="n">matched_from_datetime</span><span class="o">=</span><span class="n">matched_from_datetime</span><span class="p">,</span>
            <span class="n">version</span><span class="o">=</span><span class="n">skyline_version</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">),</span>
            <span class="n">print_debug</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span> <span class="mi">200</span>

    <span class="c1"># @modified 20170118 - Feature #1862: Ionosphere features profiles search page</span>
    <span class="c1"># Added fp_search parameter</span>
    <span class="c1"># @modified 20170122 - Feature #1872: Ionosphere - features profile page by id only</span>
    <span class="c1"># Added fp_id parameter</span>
    <span class="c1"># @modified 20170305 - Feature #1960: ionosphere_layers</span>
    <span class="c1"># Added layers arguments d_condition to fp_layer</span>
    <span class="c1"># @modified 20160315 - Feature #1972: ionosphere_layers - use D layer boundary for upper limit</span>
    <span class="c1"># Added d_boundary_times</span>
    <span class="c1"># @modified 20170327 - Feature #2004: Ionosphere layers - edit_layers</span>
    <span class="c1"># Added layers_id and edit_fp_layers</span>
    <span class="c1"># @added 20170402 - Feature #2000: Ionosphere - validated</span>
    <span class="n">IONOSPHERE_REQUEST_ARGS</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;timestamp&#39;</span><span class="p">,</span> <span class="s1">&#39;metric&#39;</span><span class="p">,</span> <span class="s1">&#39;metric_td&#39;</span><span class="p">,</span> <span class="s1">&#39;a_dated_list&#39;</span><span class="p">,</span> <span class="s1">&#39;timestamp_td&#39;</span><span class="p">,</span>
        <span class="s1">&#39;requested_timestamp&#39;</span><span class="p">,</span> <span class="s1">&#39;fp_view&#39;</span><span class="p">,</span> <span class="s1">&#39;calc_features&#39;</span><span class="p">,</span> <span class="s1">&#39;add_fp&#39;</span><span class="p">,</span>
        <span class="s1">&#39;features_profiles&#39;</span><span class="p">,</span> <span class="s1">&#39;fp_search&#39;</span><span class="p">,</span> <span class="s1">&#39;learn&#39;</span><span class="p">,</span> <span class="s1">&#39;fp_id&#39;</span><span class="p">,</span> <span class="s1">&#39;d_condition&#39;</span><span class="p">,</span>
        <span class="s1">&#39;d_boundary_limit&#39;</span><span class="p">,</span> <span class="s1">&#39;d_boundary_times&#39;</span><span class="p">,</span> <span class="s1">&#39;e_condition&#39;</span><span class="p">,</span> <span class="s1">&#39;e_boundary_limit&#39;</span><span class="p">,</span>
        <span class="s1">&#39;e_boundary_times&#39;</span><span class="p">,</span> <span class="s1">&#39;es_layer&#39;</span><span class="p">,</span> <span class="s1">&#39;es_day&#39;</span><span class="p">,</span> <span class="s1">&#39;f1_layer&#39;</span><span class="p">,</span> <span class="s1">&#39;f1_from_time&#39;</span><span class="p">,</span>
        <span class="s1">&#39;f1_layer&#39;</span><span class="p">,</span> <span class="s1">&#39;f2_until_time&#39;</span><span class="p">,</span> <span class="s1">&#39;fp_layer&#39;</span><span class="p">,</span> <span class="s1">&#39;fp_layer_label&#39;</span><span class="p">,</span>
        <span class="s1">&#39;add_fp_layer&#39;</span><span class="p">,</span> <span class="s1">&#39;layers_id&#39;</span><span class="p">,</span> <span class="s1">&#39;edit_fp_layers&#39;</span><span class="p">,</span> <span class="s1">&#39;validate_fp&#39;</span><span class="p">,</span>
        <span class="s1">&#39;validated_equals&#39;</span><span class="p">,</span>
        <span class="c1"># @added 20170616 - Feature #2048: D1 ionosphere layer</span>
        <span class="s1">&#39;d1_condition&#39;</span><span class="p">,</span> <span class="s1">&#39;d1_boundary_limit&#39;</span><span class="p">,</span> <span class="s1">&#39;d1_boundary_times&#39;</span><span class="p">,</span>
        <span class="c1"># @added 20170617 - Feature #2054: ionosphere.save.training_data</span>
        <span class="s1">&#39;save_training_data&#39;</span><span class="p">,</span> <span class="s1">&#39;saved_td_label&#39;</span><span class="p">,</span> <span class="s1">&#39;saved_training_data&#39;</span><span class="p">,</span>
        <span class="c1"># added 20170908 - Feature #2056: ionosphere - disabled_features_profiles</span>
        <span class="s1">&#39;disable_fp&#39;</span><span class="p">,</span>
        <span class="c1"># @added 20170917 - Feature #1996: Ionosphere - matches page</span>
        <span class="s1">&#39;matched_fp_id&#39;</span><span class="p">,</span> <span class="s1">&#39;matched_layer_id&#39;</span><span class="p">,</span>
        <span class="c1"># @added 20180804 - Feature #2488: Allow user to specifically set metric as a derivative metric in training_data</span>
        <span class="s1">&#39;load_derivative_graphs&#39;</span><span class="p">,</span>
        <span class="c1"># @added 20190601 - Feature #3084: Ionosphere - validated matches</span>
        <span class="s1">&#39;match_validation&#39;</span><span class="p">,</span>
        <span class="c1"># @added 20190922 - Feature #2516: Add label to features profile</span>
        <span class="s1">&#39;label&#39;</span><span class="p">,</span>
        <span class="c1"># @added 20191210 - Feature #3348: fp creation json response</span>
        <span class="s1">&#39;format&#39;</span><span class="p">,</span>
        <span class="c1"># @added 20191212 - Feature #3230: users DB table</span>
        <span class="c1">#                   Feature #2516: Add label to features profile</span>
        <span class="c1"># Allow the user_id to be passed as a request argument</span>
        <span class="s1">&#39;user_id&#39;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="c1"># @modified 20190503 - Branch #2646: slack - linting</span>
    <span class="c1"># determine_metric = False</span>

    <span class="n">dated_list</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">td_requested_timestamp</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># @modified 20190503 - Branch #2646: slack - linting</span>
    <span class="c1"># feature_profile_view = False</span>

    <span class="n">calculate_features</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">create_feature_profile</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">fp_view</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">fp_profiles</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="c1"># @added 20170118 - Feature #1862: Ionosphere features profiles search page</span>
    <span class="n">fp_search</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="c1"># @added 20170120 -  Feature #1854: Ionosphere learn - generations</span>
    <span class="c1"># Added fp_learn and fp_fd_days parameters to allow the user to not learn at</span>
    <span class="c1"># use_full_duration_days</span>
    <span class="n">fp_learn</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">fp_fd_days</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_LEARN_DEFAULT_FULL_DURATION_DAYS</span>

    <span class="c1"># @added 20170327 - Feature #2004: Ionosphere layers - edit_layers</span>
    <span class="c1">#                   Task #2002: Review and correct incorrectly defined layers</span>
    <span class="c1"># Added the argument edit_fp_layers</span>
    <span class="n">edit_fp_layers</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">layers_id</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># @added 20170617 - Feature #2054: ionosphere.save.training_data</span>
    <span class="n">save_training_data</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">saved_training_data</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">saved_td_label</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># added 20170908 - Feature #2056: ionosphere - disabled_features_profiles</span>
    <span class="n">disable_fp</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># @added 20170917 - Feature #1996: Ionosphere - matches page</span>
    <span class="n">matched_fp_id</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">matched_layer_id</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="c1"># @added 20190601 - Feature #3084: Ionosphere - validated matches</span>
    <span class="n">match_validated</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># @added 20190922 - Feature #2516: Add label to features profile</span>
    <span class="n">fp_label</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># @added 20191210 - Feature #3348: fp creation json response</span>
    <span class="n">response_format</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">request_args_present</span><span class="p">:</span>
            <span class="n">timestamp_arg</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">metric_arg</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">metric_td_arg</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">timestamp_td_arg</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="c1"># @added 20180804 - Feature #2488: Allow user to specifically set metric as a derivative metric in training_data</span>
            <span class="n">set_derivative_metric</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="s1">&#39;fp_view&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                <span class="n">fp_view</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;fp_view&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">base_name</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;metric&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>

                <span class="c1"># @added 20170917 - Feature #1996: Ionosphere - matches page</span>
                <span class="k">if</span> <span class="s1">&#39;matched_fp_id&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                    <span class="n">matched_fp_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;matched_fp_id&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="s1">&#39;matched_layer_id&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                    <span class="n">matched_layer_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;matched_layer_id&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
                <span class="c1"># @added 20190601 - Feature #3084: Ionosphere - validated matches</span>
                <span class="k">if</span> <span class="s1">&#39;match_validation&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                    <span class="n">match_validated_str</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;match_validation&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">match_validated_str</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">match_validated</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">match_validated_str</span><span class="p">)</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">error_string</span> <span class="o">=</span> <span class="s1">&#39;error :: invalid request argument - match_validation is not an int - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">match_validated_str</span><span class="p">)</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_string</span><span class="p">)</span>
                            <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                                <span class="p">{</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="n">error_string</span><span class="p">})</span>
                            <span class="k">return</span> <span class="n">flask_escape</span><span class="p">(</span><span class="n">resp</span><span class="p">),</span> <span class="mi">400</span>

                <span class="c1"># @added 20170122 - Feature #1872: Ionosphere - features profile page by id only</span>
                <span class="c1"># Determine the features profile dir path for a fp_id</span>
                <span class="k">if</span> <span class="s1">&#39;fp_id&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                    <span class="c1"># @added 20190116 - Cross-Site Scripting Security Vulnerability #85</span>
                    <span class="c1">#                      Bug #2816: Cross-Site Scripting Security Vulnerability</span>
                    <span class="c1"># Test that the fp_id is an int first</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">test_fp_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;fp_id&#39;</span><span class="p">))</span>
                        <span class="n">test_fp_id_valid</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">test_fp_id</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;test_fp_id_valid tests OK with </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">test_fp_id_valid</span><span class="p">))</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: invalid request argument - fp_id is not an int&#39;</span><span class="p">)</span>
                        <span class="c1"># @modified 20190524 - Branch #3002: docker</span>
                        <span class="c1"># Return data</span>
                        <span class="c1"># return &#39;Bad Request&#39;, 400</span>
                        <span class="n">error_string</span> <span class="o">=</span> <span class="s1">&#39;error :: the fp_id argument was passed but not as an int - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_string</span><span class="p">)</span>
                        <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                            <span class="p">{</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="n">error_string</span><span class="p">})</span>
                        <span class="k">return</span> <span class="n">flask_escape</span><span class="p">(</span><span class="n">resp</span><span class="p">),</span> <span class="mi">400</span>

                    <span class="n">fp_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;fp_id&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>

                    <span class="c1"># @modified 20190503 - Branch #2646: slack - linting</span>
                    <span class="c1"># metric_timestamp = 0</span>

                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">fp_details</span><span class="p">,</span> <span class="n">fp_details_successful</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">traceback_format_exc</span><span class="p">,</span> <span class="n">fp_details_object</span> <span class="o">=</span> <span class="n">features_profile_details</span><span class="p">(</span><span class="n">fp_id</span><span class="p">)</span>
                        <span class="n">anomaly_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">fp_details_object</span><span class="p">[</span><span class="s1">&#39;anomaly_timestamp&#39;</span><span class="p">])</span>
                        <span class="n">created_timestamp</span> <span class="o">=</span> <span class="n">fp_details_object</span><span class="p">[</span><span class="s1">&#39;created_timestamp&#39;</span><span class="p">]</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                        <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;failed to get features profile details for id </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">fp_id</span><span class="p">)</span>
                        <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">fp_details_successful</span><span class="p">:</span>
                        <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                        <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: features_profile_details failed&#39;</span>
                        <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

                    <span class="n">use_timestamp</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">metric_timeseries_dir</span> <span class="o">=</span> <span class="n">base_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
                    <span class="c1"># @modified 20170126 - Feature #1872: Ionosphere - features profile page by id only</span>
                    <span class="c1"># The the incorrect logic, first it should be checked if</span>
                    <span class="c1"># there is a use_full_duration parent timestamp</span>
                    <span class="n">dt</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">created_timestamp</span><span class="p">)</span>
                    <span class="n">naive</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span>
                    <span class="n">pytz_tz</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">SERVER_PYTZ_TIMEZONE</span>
                    <span class="n">local</span> <span class="o">=</span> <span class="n">pytz</span><span class="o">.</span><span class="n">timezone</span><span class="p">(</span><span class="n">pytz_tz</span><span class="p">)</span>
                    <span class="n">local_dt</span> <span class="o">=</span> <span class="n">local</span><span class="o">.</span><span class="n">localize</span><span class="p">(</span><span class="n">naive</span><span class="p">,</span> <span class="n">is_dst</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
                    <span class="n">utc_dt</span> <span class="o">=</span> <span class="n">local_dt</span><span class="o">.</span><span class="n">astimezone</span><span class="p">(</span><span class="n">pytz</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
                    <span class="n">unix_created_timestamp</span> <span class="o">=</span> <span class="n">utc_dt</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="n">features_profiles_data_dir</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_PROFILES_FOLDER</span><span class="p">,</span> <span class="n">metric_timeseries_dir</span><span class="p">,</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">unix_created_timestamp</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">features_profiles_data_dir</span><span class="p">):</span>
                        <span class="n">use_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">unix_created_timestamp</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;no timestamp feature profiles data dir found for feature profile id </span><span class="si">%s</span><span class="s1"> at </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">fp_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">features_profiles_data_dir</span><span class="p">)))</span>

                    <span class="c1"># @added 20170915 - Bug #2162: ionosphere - mismatching timestamp metadata</span>
                    <span class="c1">#                   Feature #1872: Ionosphere - features profile page by id only</span>
                    <span class="c1"># Iterate back a few seconds as the features profile dir and</span>
                    <span class="c1"># file resources may have a slight offset timestamp from the</span>
                    <span class="c1"># created_timestamp which is based on MySQL CURRENT_TIMESTAMP</span>
                    <span class="k">if</span> <span class="n">use_timestamp</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">check_back_to_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">unix_created_timestamp</span><span class="p">)</span> <span class="o">-</span> <span class="mi">10</span>
                        <span class="n">check_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">unix_created_timestamp</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
                        <span class="k">while</span> <span class="n">check_timestamp</span> <span class="o">&gt;</span> <span class="n">check_back_to_timestamp</span><span class="p">:</span>
                            <span class="n">features_profiles_data_dir</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_PROFILES_FOLDER</span><span class="p">,</span> <span class="n">metric_timeseries_dir</span><span class="p">,</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">check_timestamp</span><span class="p">))</span>
                            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">features_profiles_data_dir</span><span class="p">):</span>
                                <span class="n">use_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">check_timestamp</span><span class="p">)</span>
                                <span class="n">check_timestamp</span> <span class="o">=</span> <span class="n">check_back_to_timestamp</span> <span class="o">-</span> <span class="mi">1</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">check_timestamp</span> <span class="o">-=</span> <span class="mi">1</span>

                    <span class="n">features_profiles_data_dir</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_PROFILES_FOLDER</span><span class="p">,</span> <span class="n">metric_timeseries_dir</span><span class="p">,</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">anomaly_timestamp</span><span class="p">))</span>
                    <span class="c1"># @modified 20170126 - Feature #1872: Ionosphere - features profile page by id only</span>
                    <span class="c1"># This was the incorrect logic, first it should be checked if</span>
                    <span class="c1"># there is a use_full_duration parent timestamp</span>
                    <span class="k">if</span> <span class="n">use_timestamp</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">features_profiles_data_dir</span><span class="p">):</span>
                            <span class="n">use_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">anomaly_timestamp</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;no timestamp feature profiles data dir found for feature profile id </span><span class="si">%s</span><span class="s1"> at </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">fp_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">features_profiles_data_dir</span><span class="p">)))</span>

                    <span class="k">if</span> <span class="n">use_timestamp</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;no timestamp feature profiles data dir found for feature profile id - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">fp_id</span><span class="p">))</span>

                        <span class="c1"># @added 20180420 - Branch #2270: luminosity</span>
                        <span class="c1"># Use settings.ALTERNATIVE_SKYLINE_URLS if they are</span>
                        <span class="c1"># declared</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">use_alternative_urls</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">ALTERNATIVE_SKYLINE_URLS</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">use_alternative_urls</span> <span class="o">=</span> <span class="kc">False</span>

                        <span class="k">if</span> <span class="n">use_alternative_urls</span><span class="p">:</span>
                            <span class="n">alternative_urls</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="k">for</span> <span class="n">alt_url</span> <span class="ow">in</span> <span class="n">use_alternative_urls</span><span class="p">:</span>
                                <span class="n">alt_redirect_url</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/ionosphere?fp_view=true&amp;fp_id=</span><span class="si">%s</span><span class="s1">&amp;metric=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">alt_url</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">fp_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">base_name</span><span class="p">))</span>
                                <span class="n">alternative_urls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">alt_redirect_url</span><span class="p">)</span>
                            <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;no timestamp feature profiles data dir found on this Skyline instance try at the alternative URLS listed below:&#39;</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;passing alternative_urls - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">alternative_urls</span><span class="p">))</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span>
                                    <span class="s1">&#39;ionosphere.html&#39;</span><span class="p">,</span> <span class="n">display_message</span><span class="o">=</span><span class="n">message</span><span class="p">,</span>
                                    <span class="n">alternative_urls</span><span class="o">=</span><span class="n">alternative_urls</span><span class="p">,</span>
                                    <span class="n">fp_view</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                    <span class="n">version</span><span class="o">=</span><span class="n">skyline_version</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">),</span>
                                    <span class="n">print_debug</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="mi">200</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Uh oh ... a Skyline 500 :(&#39;</span>
                                <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                                <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

                        <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                            <span class="p">{</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="s1">&#39;Error: no timestamp feature profiles data dir found for feature profile id - &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">fp_id</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; - go on... nothing here.&#39;</span><span class="p">})</span>
                        <span class="c1"># @modified 20190116 - Cross-Site Scripting Security Vulnerability #85</span>
                        <span class="c1">#                      Bug #2816: Cross-Site Scripting Security Vulnerability</span>
                        <span class="c1"># return resp, 400</span>
                        <span class="k">return</span> <span class="n">flask_escape</span><span class="p">(</span><span class="n">resp</span><span class="p">),</span> <span class="mi">400</span>

                    <span class="n">redirect_url</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/ionosphere?fp_view=true&amp;timestamp=</span><span class="si">%s</span><span class="s1">&amp;metric=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">SKYLINE_URL</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">use_timestamp</span><span class="p">),</span> <span class="n">base_name</span><span class="p">)</span>

                    <span class="c1"># @added 20180815 - Feature #2430: Ionosphere validate learnt features profiles page</span>
                    <span class="n">validate_fp_req</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">if</span> <span class="s1">&#39;validate_fp&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                        <span class="n">validate_fp_req</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;validate_fp&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">validate_fp_req</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                            <span class="n">validate_fp_req</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">if</span> <span class="n">validate_fp_req</span><span class="p">:</span>
                        <span class="n">redirect_url</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/ionosphere?fp_view=true&amp;timestamp=</span><span class="si">%s</span><span class="s1">&amp;metric=</span><span class="si">%s</span><span class="s1">&amp;validate_fp=true&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">settings</span><span class="o">.</span><span class="n">SKYLINE_URL</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">use_timestamp</span><span class="p">),</span> <span class="n">base_name</span><span class="p">)</span>

                    <span class="c1"># @added 20180816 - Feature #2430: Ionosphere validate learnt features profiles page</span>
                    <span class="n">disable_fp_req</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">if</span> <span class="s1">&#39;disable_fp&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                        <span class="n">disable_fp_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;disable_fp&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">disable_fp_id</span><span class="p">),</span> <span class="nb">int</span><span class="p">):</span>
                            <span class="n">disable_fp_req</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">if</span> <span class="n">disable_fp_req</span><span class="p">:</span>
                        <span class="n">redirect_url</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/ionosphere?fp_view=true&amp;timestamp=</span><span class="si">%s</span><span class="s1">&amp;metric=</span><span class="si">%s</span><span class="s1">&amp;disable_fp=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">settings</span><span class="o">.</span><span class="n">SKYLINE_URL</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">use_timestamp</span><span class="p">),</span> <span class="n">base_name</span><span class="p">,</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">disable_fp_id</span><span class="p">))</span>

                    <span class="c1"># @added 20170917 - Feature #1996: Ionosphere - matches page</span>
                    <span class="k">if</span> <span class="n">matched_fp_id</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">matched_fp_id</span> <span class="o">!=</span> <span class="s1">&#39;False&#39;</span><span class="p">:</span>
                            <span class="n">redirect_url</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/ionosphere?fp_view=true&amp;timestamp=</span><span class="si">%s</span><span class="s1">&amp;metric=</span><span class="si">%s</span><span class="s1">&amp;matched_fp_id=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">settings</span><span class="o">.</span><span class="n">SKYLINE_URL</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">use_timestamp</span><span class="p">),</span> <span class="n">base_name</span><span class="p">,</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">matched_fp_id</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">matched_layer_id</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">matched_layer_id</span> <span class="o">!=</span> <span class="s1">&#39;False&#39;</span><span class="p">:</span>
                            <span class="n">redirect_url</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/ionosphere?fp_view=true&amp;timestamp=</span><span class="si">%s</span><span class="s1">&amp;metric=</span><span class="si">%s</span><span class="s1">&amp;matched_layer_id=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">settings</span><span class="o">.</span><span class="n">SKYLINE_URL</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">use_timestamp</span><span class="p">),</span> <span class="n">base_name</span><span class="p">,</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">matched_layer_id</span><span class="p">))</span>

                    <span class="c1"># @added 20190601 - Feature #3084: Ionosphere - validated matches</span>
                    <span class="k">if</span> <span class="n">matched_fp_id</span> <span class="ow">or</span> <span class="n">matched_layer_id</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s1">&#39;match_validation&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">match_validated</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">validate_matched_redirect_url</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&amp;match_validation=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="n">redirect_url</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">match_validated</span><span class="p">))</span>
                                <span class="n">redirect_url</span> <span class="o">=</span> <span class="n">validate_matched_redirect_url</span>

                    <span class="c1"># @modified 20170327 - Feature #2004: Ionosphere layers - edit_layers</span>
                    <span class="c1">#                      Task #2002: Review and correct incorrectly defined layers</span>
                    <span class="c1"># Build the query string from the previous parameters</span>
                    <span class="k">if</span> <span class="s1">&#39;edit_fp_layers&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                        <span class="n">redirect_url</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/ionosphere?timestamp=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">SKYLINE_URL</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">use_timestamp</span><span class="p">))</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                            <span class="n">key</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span>
                                <span class="k">continue</span>
                            <span class="n">value</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                            <span class="n">new_redirect_url</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&amp;</span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">redirect_url</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
                            <span class="n">redirect_url</span> <span class="o">=</span> <span class="n">new_redirect_url</span>
                    <span class="k">if</span> <span class="s1">&#39;edit_fp_layers&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;not returning redirect as edit_fp_layers request&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;returned redirect on original request - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">redirect_url</span><span class="p">))</span>
                        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">redirect_url</span><span class="p">,</span> <span class="n">code</span><span class="o">=</span><span class="mi">302</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">IONOSPHERE_REQUEST_ARGS</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: invalid request argument - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">))</span>
                    <span class="c1"># @modified 20190524 - Branch #3002: docker</span>
                    <span class="c1"># Return data</span>
                    <span class="c1"># return &#39;Bad Request&#39;, 400</span>
                    <span class="n">error_string</span> <span class="o">=</span> <span class="s1">&#39;error :: invalid request argument - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_string</span><span class="p">)</span>
                    <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                        <span class="p">{</span><span class="s1">&#39;400 Bad Request&#39;</span><span class="p">:</span> <span class="n">error_string</span><span class="p">})</span>
                    <span class="k">return</span> <span class="n">flask_escape</span><span class="p">(</span><span class="n">resp</span><span class="p">),</span> <span class="mi">400</span>

                <span class="n">value</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;request argument - </span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>

                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;calc_features&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                        <span class="n">calculate_features</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;add_fp&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                        <span class="n">create_feature_profile</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="c1"># @added 20191210 - Feature #3348: fp creation json response</span>
                        <span class="k">if</span> <span class="s1">&#39;format&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                            <span class="n">response_format</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;format&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">response_format</span> <span class="o">!=</span> <span class="s1">&#39;json&#39;</span><span class="p">:</span>
                                <span class="n">response_format</span> <span class="o">=</span> <span class="kc">None</span>

                <span class="c1"># @added 20170317 - Feature #1960: ionosphere_layers - allow for floats</span>
                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;d_boundary_limit&#39;</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">d_boundary_limit</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: invalid request argument - </span><span class="si">%s</span><span class="s1"> is not numeric - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>
                        <span class="k">return</span> <span class="s1">&#39;Bad Request</span><span class="se">\n\n</span><span class="s1">invalid request argument - </span><span class="si">%s</span><span class="s1"> is not numeric - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)),</span> <span class="mi">400</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;request argument OK - </span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">d_boundary_limit</span><span class="p">)))</span>
                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;e_boundary_limit&#39;</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">e_boundary_limit</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: invalid request argument - </span><span class="si">%s</span><span class="s1"> is not numeric - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>
                        <span class="k">return</span> <span class="s1">&#39;Bad Request</span><span class="se">\n\n</span><span class="s1">invalid request argument - </span><span class="si">%s</span><span class="s1"> is not numeric - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)),</span> <span class="mi">400</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;request argument OK - </span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">e_boundary_limit</span><span class="p">)))</span>

                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;fp_view&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                        <span class="n">fp_view</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="c1"># @added 20170118 - Feature #1862: Ionosphere features profiles search page</span>
                <span class="c1"># Added fp_search parameter</span>
                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;fp_search&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                        <span class="n">fp_search</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="c1"># @added 20170120 -  Feature #1854: Ionosphere learn - generations</span>
                <span class="c1"># Added fp_learn parameter</span>
                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;learn&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                        <span class="n">fp_learn</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="c1"># @added 20170305 - Feature #1960: ionosphere_layers</span>
                    <span class="c1"># Being passed through as a boolean from the Create features</span>
                    <span class="c1"># profile arguments and I cannot be arsed to track it down</span>
                    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;True&#39;</span><span class="p">:</span>
                        <span class="n">fp_learn</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;features_profiles&#39;</span><span class="p">:</span>
                    <span class="n">fp_profiles</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="c1"># @added 20190503 - Branch #2646: slack - linting</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;fp_profiles is </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fp_profiles</span><span class="p">)</span>

                <span class="c1"># @added 20170327 - Feature #2004: Ionosphere layers - edit_layers</span>
                <span class="c1">#                   Task #2002: Review and correct incorrectly defined layers</span>
                <span class="c1"># Added layers and edit_fp_layers</span>
                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;layers_id&#39;</span><span class="p">:</span>
                    <span class="n">test_layer_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">layers_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">test_layer_id</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;bad request argument - </span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="s1"> not numeric&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>
                        <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                            <span class="p">{</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="s1">&#39;Error: not a numeric id for the layers_id argument - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; - please pass a proper id&#39;</span><span class="p">})</span>
                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;edit_fp_layers&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                        <span class="n">edit_fp_layers</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;True&#39;</span><span class="p">:</span>
                        <span class="n">edit_fp_layers</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">if</span> <span class="n">edit_fp_layers</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;edit_fp_layers is set to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">edit_fp_layers</span><span class="p">)))</span>

                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;a_dated_list&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                        <span class="n">dated_list</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;requested_timestamp&#39;</span><span class="p">:</span>
                    <span class="n">valid_rt_timestamp</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;False&#39;</span><span class="p">:</span>
                        <span class="n">valid_rt_timestamp</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_rt_timestamp</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">))</span> <span class="o">==</span> <span class="mi">10</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;bad request argument - </span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="s1"> not an epoch timestamp&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>
                            <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                                <span class="p">{</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="s1">&#39;Error: not an epoch timestamp for &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; - &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; - please pass a proper epoch timestamp&#39;</span><span class="p">})</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">timestamp_numeric</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                                <span class="n">valid_rt_timestamp</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="n">valid_timestamp</span> <span class="o">=</span> <span class="kc">False</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;bad request argument - </span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="s1"> not numeric&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>
                                <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                                    <span class="p">{</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="s1">&#39;Error: not a numeric epoch timestamp for &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; - &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; - please pass a proper epoch timestamp&#39;</span><span class="p">})</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_rt_timestamp</span><span class="p">:</span>
                        <span class="c1"># @modified 20190116 - Cross-Site Scripting Security Vulnerability #85</span>
                        <span class="c1">#                      Bug #2816: Cross-Site Scripting Security Vulnerability</span>
                        <span class="c1"># return resp, 400</span>
                        <span class="k">return</span> <span class="n">flask_escape</span><span class="p">(</span><span class="n">resp</span><span class="p">),</span> <span class="mi">400</span>

                <span class="c1"># @added 20170617 - Feature #2054: ionosphere.save.training_data</span>
                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;save_training_data&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                        <span class="n">save_training_data</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;saved_td_label&#39;</span><span class="p">:</span>
                    <span class="n">saved_td_label</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;saved_training_data&#39;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                        <span class="n">saved_training_data</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">check_for_purged</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">saved_training_data</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">fp_view</span><span class="p">:</span>
                        <span class="n">check_for_purged</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;label&#39;</span><span class="p">:</span>
                    <span class="n">label_arg</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;label&#39;</span><span class="p">)</span>
                    <span class="n">label</span> <span class="o">=</span> <span class="n">label_arg</span><span class="p">[:</span><span class="mi">255</span><span class="p">]</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;label - </span><span class="si">%s</span><span class="s1"> &#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>

                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;timestamp&#39;</span> <span class="ow">or</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;timestamp_td&#39;</span><span class="p">:</span>
                    <span class="n">valid_timestamp</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">))</span> <span class="o">==</span> <span class="mi">10</span><span class="p">:</span>
                        <span class="n">valid_timestamp</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;bad request argument - </span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="s1"> not an epoch timestamp&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>
                        <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                            <span class="p">{</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="s1">&#39;Error: not an epoch timestamp for &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; - &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; - please pass a proper epoch timestamp&#39;</span><span class="p">})</span>
                    <span class="k">if</span> <span class="n">valid_timestamp</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">timestamp_numeric</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                            <span class="c1"># @added 20190503 - Branch #2646: slack - linting</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;timestamp_numeric tests OK with </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">timestamp_numeric</span><span class="p">))</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="n">valid_timestamp</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;bad request argument - </span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="s1"> not numeric&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>
                            <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                                <span class="p">{</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="s1">&#39;Error: not a numeric epoch timestamp for &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; - &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; - please pass a proper epoch timestamp&#39;</span><span class="p">})</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_timestamp</span><span class="p">:</span>
                        <span class="c1"># @modified 20190116 - Cross-Site Scripting Security Vulnerability #85</span>
                        <span class="c1">#                      Bug #2816: Cross-Site Scripting Security Vulnerability</span>
                        <span class="c1"># return resp, 400</span>
                        <span class="k">return</span> <span class="n">flask_escape</span><span class="p">(</span><span class="n">resp</span><span class="p">),</span> <span class="mi">400</span>

                    <span class="c1"># if not fp_view:</span>
                    <span class="k">if</span> <span class="n">check_for_purged</span><span class="p">:</span>
                        <span class="n">ionosphere_data_dir</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_DATA_FOLDER</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">isdir</span><span class="p">(</span><span class="n">ionosphere_data_dir</span><span class="p">):</span>
                            <span class="n">valid_timestamp</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
                            <span class="n">purged_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">now</span><span class="p">)</span> <span class="o">-</span> <span class="nb">int</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_KEEP_TRAINING_TIMESERIES_FOR</span><span class="p">)</span>
                            <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">purged_timestamp</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="s1"> timestamp it to old to have training data&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>
                                <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                                    <span class="p">{</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="s1">&#39;Error: timestamp too old no training data exists, training data has been purged&#39;</span><span class="p">})</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="s1"> no timestamp training data dir found - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="n">ionosphere_data_dir</span><span class="p">))</span>
                                <span class="c1"># @added 20180713 - Branch #2270: luminosity</span>
                                <span class="c1"># Use settings.ALTERNATIVE_SKYLINE_URLS if they are</span>
                                <span class="c1"># declared</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="n">use_alternative_urls</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">ALTERNATIVE_SKYLINE_URLS</span>
                                <span class="k">except</span><span class="p">:</span>
                                    <span class="n">use_alternative_urls</span> <span class="o">=</span> <span class="kc">False</span>
                                <span class="k">if</span> <span class="n">use_alternative_urls</span><span class="p">:</span>
                                    <span class="n">base_name</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;metric&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
                                    <span class="n">alternative_urls</span> <span class="o">=</span> <span class="p">[]</span>
                                    <span class="k">for</span> <span class="n">alt_url</span> <span class="ow">in</span> <span class="n">use_alternative_urls</span><span class="p">:</span>
                                        <span class="n">alt_redirect_url</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/ionosphere?timestamp=</span><span class="si">%s</span><span class="s1">&amp;metric=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">alt_url</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">base_name</span><span class="p">))</span>
                                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">use_alternative_urls</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">alt_redirect_url</span><span class="p">)</span>
                                        <span class="n">alternative_urls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">alt_redirect_url</span><span class="p">)</span>
                                    <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;no training data dir exists on this Skyline instance try at the alternative URLS listed below:&#39;</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;passing alternative_urls - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">alternative_urls</span><span class="p">))</span>
                                    <span class="k">try</span><span class="p">:</span>
                                        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span>
                                            <span class="s1">&#39;ionosphere.html&#39;</span><span class="p">,</span> <span class="n">display_message</span><span class="o">=</span><span class="n">message</span><span class="p">,</span>
                                            <span class="n">alternative_urls</span><span class="o">=</span><span class="n">alternative_urls</span><span class="p">,</span>
                                            <span class="n">fp_view</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                            <span class="n">version</span><span class="o">=</span><span class="n">skyline_version</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">),</span>
                                            <span class="n">print_debug</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="mi">200</span>
                                    <span class="k">except</span><span class="p">:</span>
                                        <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Uh oh ... a Skyline 500 :(&#39;</span>
                                        <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                                        <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                                        <span class="p">{</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="s1">&#39;Error: no training data dir exists - &#39;</span> <span class="o">+</span> <span class="n">ionosphere_data_dir</span> <span class="o">+</span> <span class="s1">&#39; - go on... nothing here.&#39;</span><span class="p">})</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_timestamp</span><span class="p">:</span>
                        <span class="c1"># @modified 20190116 - Cross-Site Scripting Security Vulnerability #85</span>
                        <span class="c1">#                      Bug #2816: Cross-Site Scripting Security Vulnerability</span>
                        <span class="c1"># return resp, 404</span>
                        <span class="k">return</span> <span class="n">flask_escape</span><span class="p">(</span><span class="n">resp</span><span class="p">),</span> <span class="mi">404</span>

                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span>
                    <span class="n">requested_timestamp</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="n">timestamp_arg</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;timestamp_td&#39;</span><span class="p">:</span>
                    <span class="n">timestamp_td_arg</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">requested_timestamp_td</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="c1"># determine_metric = True</span>

                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;requested_timestamp&#39;</span><span class="p">:</span>
                    <span class="n">td_requested_timestamp</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;metric&#39;</span> <span class="ow">or</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;metric_td&#39;</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">unique_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span> <span class="o">+</span> <span class="s1">&#39;unique_metrics&#39;</span><span class="p">))</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: Webapp could not get the unique_metrics list from Redis&#39;</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                        <span class="k">return</span> <span class="s1">&#39;Internal Server Error&#39;</span><span class="p">,</span> <span class="mi">500</span>
                    <span class="n">metric_name</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

                    <span class="n">metric_found</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">if</span> <span class="n">metric_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unique_metrics</span> <span class="ow">and</span> <span class="n">settings</span><span class="o">.</span><span class="n">OTHER_SKYLINE_REDIS_INSTANCES</span><span class="p">:</span>
                        <span class="c1"># @modified 20180519 - Feature #2378: Add redis auth to Skyline and rebrow</span>
                        <span class="c1"># for redis_ip, redis_port in settings.OTHER_SKYLINE_REDIS_INSTANCES:</span>
                        <span class="k">for</span> <span class="n">redis_ip</span><span class="p">,</span> <span class="n">redis_port</span><span class="p">,</span> <span class="n">redis_password</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">OTHER_SKYLINE_REDIS_INSTANCES</span><span class="p">:</span>
                            <span class="n">other_unique_metrics</span> <span class="o">=</span> <span class="p">[]</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">metric_found</span><span class="p">:</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">redis_password</span><span class="p">:</span>
                                        <span class="n">OTHER_REDIS_CONN</span> <span class="o">=</span> <span class="n">redis</span><span class="o">.</span><span class="n">StrictRedis</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">redis_ip</span><span class="p">),</span> <span class="n">port</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">redis_port</span><span class="p">),</span> <span class="n">password</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">redis_password</span><span class="p">))</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="n">OTHER_REDIS_CONN</span> <span class="o">=</span> <span class="n">redis</span><span class="o">.</span><span class="n">StrictRedis</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">redis_ip</span><span class="p">),</span> <span class="n">port</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">redis_port</span><span class="p">))</span>
                                    <span class="n">other_unique_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">OTHER_REDIS_CONN</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span> <span class="o">+</span> <span class="s1">&#39;unique_metrics&#39;</span><span class="p">))</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metric found in Redis at </span><span class="si">%s</span><span class="s1"> on port </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">redis_ip</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">redis_port</span><span class="p">)))</span>
                                <span class="k">except</span><span class="p">:</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to connect to Redis at </span><span class="si">%s</span><span class="s1"> on port </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">redis_ip</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">redis_port</span><span class="p">)))</span>
                            <span class="k">if</span> <span class="n">metric_name</span> <span class="ow">in</span> <span class="n">other_unique_metrics</span><span class="p">:</span>
                                <span class="n">metric_found</span> <span class="o">=</span> <span class="kc">True</span>

                    <span class="c1"># if metric_name not in unique_metrics:</span>
                    <span class="k">if</span> <span class="n">metric_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">unique_metrics</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">metric_found</span><span class="p">:</span>
                        <span class="c1"># @added 20170917 - Bug #2158: webapp - redis metric check - existing but sparsely represented metrics</span>
                        <span class="c1"># If this is an fp_view=true, it means that either the</span>
                        <span class="c1"># metric is sparsely represented or no longer exists,</span>
                        <span class="c1"># but an fp exists so continue and do not 404</span>
                        <span class="k">if</span> <span class="n">fp_view</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> not in Redis, but fp passed so continuing&#39;</span> <span class="o">%</span> <span class="n">metric_name</span><span class="p">)</span>
                        <span class="c1"># @added 20200715 - Task #3648: webapp - fp_search - do not use Redis metric check</span>
                        <span class="c1"># Do not use the Redis metric check result in a webapp</span>
                        <span class="c1"># fp_search request as this allows retried metric fps to</span>
                        <span class="c1"># accessed</span>
                        <span class="k">elif</span> <span class="n">fp_search_req</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;IONOSPHERE_REQUEST_ARGS check - </span><span class="si">%s</span><span class="s1"> not in Redis, but fp_search request so continuing&#39;</span> <span class="o">%</span> <span class="n">metric_name</span><span class="p">)</span>
                        <span class="c1"># @added 20200808</span>
                        <span class="k">elif</span> <span class="n">saved_training_data</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;IONOSPHERE_REQUEST_ARGS check - </span><span class="si">%s</span><span class="s1"> not in Redis, but saved_training_data request so continuing&#39;</span> <span class="o">%</span> <span class="n">metric_name</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">error_string</span> <span class="o">=</span> <span class="s1">&#39;error :: no metric - </span><span class="si">%s</span><span class="s1"> - exists in Redis&#39;</span> <span class="o">%</span> <span class="n">metric_name</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_string</span><span class="p">)</span>
                            <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                                <span class="p">{</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="n">error_string</span><span class="p">})</span>
                            <span class="c1"># @modified 20190116 - Cross-Site Scripting Security Vulnerability #85</span>
                            <span class="c1">#                      Bug #2816: Cross-Site Scripting Security Vulnerability</span>
                            <span class="c1"># return resp, 404</span>
                            <span class="k">return</span> <span class="n">flask_escape</span><span class="p">(</span><span class="n">resp</span><span class="p">),</span> <span class="mi">404</span>

                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;metric&#39;</span><span class="p">:</span>
                    <span class="n">metric_arg</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;metric_td&#39;</span><span class="p">:</span>
                    <span class="n">metric_td_arg</span> <span class="o">=</span> <span class="kc">True</span>

                <span class="k">if</span> <span class="n">metric_arg</span> <span class="ow">or</span> <span class="n">metric_td_arg</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;metric&#39;</span> <span class="ow">or</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;metric_td&#39;</span><span class="p">:</span>
                        <span class="n">base_name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

                <span class="c1"># @added 20180804 - Feature #2488: Allow user to specifically set metric as a derivative metric in training_data</span>
                <span class="k">if</span> <span class="n">timestamp_arg</span> <span class="ow">and</span> <span class="n">metric_arg</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;load_derivative_graphs&#39;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                            <span class="n">set_derivative_metric</span> <span class="o">=</span> <span class="n">set_metric_as_derivative</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">base_name</span><span class="p">)</span>
                            <span class="c1"># @added 20180918 - Feature #2488: Allow user to specifically set metric as a derivative metric in training_data</span>
                            <span class="c1"># Remove any graphite_now png files that are present</span>
                            <span class="c1"># so that the webapp recreates the pngs as</span>
                            <span class="c1"># nonNegativeDerivative graphs.</span>
                            <span class="c1"># TODO - handle caching</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">timeseries_dir</span> <span class="o">=</span> <span class="n">base_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
                                <span class="n">ionosphere_data_dir</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                    <span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_DATA_FOLDER</span><span class="p">,</span>
                                    <span class="n">requested_timestamp</span><span class="p">,</span> <span class="n">timeseries_dir</span><span class="p">)</span>
                                <span class="n">pattern</span> <span class="o">=</span> <span class="s1">&#39;graphite_now&#39;</span>
                                <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">ionosphere_data_dir</span><span class="p">):</span>
                                    <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
                                        <span class="n">remove_graphite_now_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ionosphere_data_dir</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
                                        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">remove_graphite_now_file</span><span class="p">)</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;removed graphite_now image at user request - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">remove_graphite_now_file</span><span class="p">)</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;failed to remove graphite_now images&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">set_derivative_metric</span><span class="p">:</span>
                    <span class="n">return_url</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/ionosphere?timestamp=</span><span class="si">%s</span><span class="s1">&amp;metric=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">SKYLINE_URL</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">requested_timestamp</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">base_name</span><span class="p">))</span>
                    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">return_url</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">timestamp_arg</span> <span class="ow">and</span> <span class="n">metric_arg</span><span class="p">:</span>
                    <span class="n">timeseries_dir</span> <span class="o">=</span> <span class="n">base_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">fp_view</span><span class="p">:</span>
                        <span class="n">ionosphere_data_dir</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_DATA_FOLDER</span><span class="p">,</span>
                            <span class="n">requested_timestamp</span><span class="p">,</span> <span class="n">timeseries_dir</span><span class="p">)</span>

                        <span class="c1"># @added 20170617 - Feature #2054: ionosphere.save.training_data</span>
                        <span class="k">if</span> <span class="n">saved_training_data</span><span class="p">:</span>
                            <span class="n">ionosphere_data_dir</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_saved/</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_DATA_FOLDER</span><span class="p">,</span>
                                <span class="n">requested_timestamp</span><span class="p">,</span> <span class="n">timeseries_dir</span><span class="p">)</span>

                        <span class="k">if</span> <span class="ow">not</span> <span class="n">isdir</span><span class="p">(</span><span class="n">ionosphere_data_dir</span><span class="p">):</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                                <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="s1"> no timestamp metric training data dir found - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
                                <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="n">ionosphere_data_dir</span><span class="p">))</span>
                            <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                                <span class="p">{</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="s1">&#39;Error: no training data dir exists - &#39;</span> <span class="o">+</span> <span class="n">ionosphere_data_dir</span> <span class="o">+</span> <span class="s1">&#39; - go on... nothing here.&#39;</span><span class="p">})</span>
                            <span class="c1"># @modified 20190116 - Cross-Site Scripting Security Vulnerability #85</span>
                            <span class="c1">#                      Bug #2816: Cross-Site Scripting Security Vulnerability</span>
                            <span class="c1"># return resp, 404</span>
                            <span class="k">return</span> <span class="n">flask_escape</span><span class="p">(</span><span class="n">resp</span><span class="p">),</span> <span class="mi">404</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">ionosphere_profiles_dir</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">settings</span><span class="o">.</span><span class="n">IONOSPHERE_PROFILES_FOLDER</span><span class="p">,</span> <span class="n">timeseries_dir</span><span class="p">,</span>
                            <span class="n">requested_timestamp</span><span class="p">)</span>

                        <span class="k">if</span> <span class="ow">not</span> <span class="n">isdir</span><span class="p">(</span><span class="n">ionosphere_profiles_dir</span><span class="p">):</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
                                <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="s1"> no timestamp metric features profile dir found - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
                                <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="n">ionosphere_profiles_dir</span><span class="p">))</span>

                            <span class="c1"># @added 20180715 - Branch #2270: luminosity</span>
                            <span class="c1"># Use settings.ALTERNATIVE_SKYLINE_URLS if they are</span>
                            <span class="c1"># declared and redirect to alternative URL/s if no</span>
                            <span class="c1"># features profile directory exists on the Skyline</span>
                            <span class="c1"># instance.</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">use_alternative_urls</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">ALTERNATIVE_SKYLINE_URLS</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="n">use_alternative_urls</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="k">if</span> <span class="n">use_alternative_urls</span><span class="p">:</span>
                                <span class="n">base_name</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;metric&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
                                <span class="n">alternative_urls</span> <span class="o">=</span> <span class="p">[]</span>
                                <span class="k">for</span> <span class="n">alt_url</span> <span class="ow">in</span> <span class="n">use_alternative_urls</span><span class="p">:</span>
                                    <span class="n">alt_redirect_url_base</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/ionosphere&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">alt_url</span><span class="p">)</span>
                                    <span class="n">request_url</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
                                    <span class="n">request_endpoint</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/ionosphere&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">SKYLINE_URL</span><span class="p">)</span>
                                    <span class="n">alt_redirect_url</span> <span class="o">=</span> <span class="n">request_url</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">request_endpoint</span><span class="p">,</span> <span class="n">alt_redirect_url_base</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">use_alternative_urls</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;redirecting to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">alt_redirect_url</span><span class="p">))</span>
                                        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">alt_redirect_url</span><span class="p">)</span>
                                    <span class="n">alternative_urls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">alt_redirect_url</span><span class="p">)</span>
                                <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;no features profile dir exists on this Skyline instance try at the alternative URLS listed below:&#39;</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;passing alternative_urls - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">alternative_urls</span><span class="p">))</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span>
                                        <span class="s1">&#39;ionosphere.html&#39;</span><span class="p">,</span> <span class="n">display_message</span><span class="o">=</span><span class="n">message</span><span class="p">,</span>
                                        <span class="n">alternative_urls</span><span class="o">=</span><span class="n">alternative_urls</span><span class="p">,</span>
                                        <span class="n">fp_view</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                        <span class="n">version</span><span class="o">=</span><span class="n">skyline_version</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">),</span>
                                        <span class="n">print_debug</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="mi">200</span>
                                <span class="k">except</span><span class="p">:</span>
                                    <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Uh oh ... a Skyline 500 :(&#39;</span>
                                    <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                                    <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                                    <span class="p">{</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="s1">&#39;Error: no features profile dir exists - &#39;</span> <span class="o">+</span> <span class="n">ionosphere_profiles_dir</span> <span class="o">+</span> <span class="s1">&#39; - go on... nothing here.&#39;</span><span class="p">})</span>
                                <span class="c1"># @modified 20190116 - Cross-Site Scripting Security Vulnerability #85</span>
                                <span class="c1">#                      Bug #2816: Cross-Site Scripting Security Vulnerability</span>
                                <span class="c1"># return resp, 404</span>
                                <span class="k">return</span> <span class="n">flask_escape</span><span class="p">(</span><span class="n">resp</span><span class="p">),</span> <span class="mi">404</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;arguments validated - OK&#39;</span><span class="p">)</span>

    <span class="k">except</span><span class="p">:</span>
        <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Uh oh ... a Skyline 500 :(&#39;</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

    <span class="n">debug_on</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="n">fp_view</span><span class="p">:</span>
        <span class="n">context</span> <span class="o">=</span> <span class="s1">&#39;features_profiles&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">context</span> <span class="o">=</span> <span class="s1">&#39;training_data&#39;</span>

    <span class="c1"># @added 20170617 - Feature #2054: ionosphere.save.training_data</span>
    <span class="k">if</span> <span class="n">saved_training_data</span><span class="p">:</span>
        <span class="n">context</span> <span class="o">=</span> <span class="s1">&#39;saved_training_data&#39;</span>

    <span class="n">fp_view_on</span> <span class="o">=</span> <span class="n">fp_view</span>

    <span class="n">do_first</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">fp_view</span><span class="p">:</span>
        <span class="n">do_first</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">,</span> <span class="s1">&#39;metric&#39;</span><span class="p">,</span> <span class="s1">&#39;metric_td&#39;</span><span class="p">,</span> <span class="s1">&#39;timestamp_td&#39;</span><span class="p">,</span>
            <span class="s1">&#39;requested_timestamp&#39;</span><span class="p">,</span> <span class="s1">&#39;features_profiles&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i_arg</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">i_arg</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                <span class="n">do_first</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="n">request_args_len</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">dated_list</span><span class="p">:</span>
        <span class="n">do_first</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="n">do_first</span><span class="p">:</span>
        <span class="n">listed_by</span> <span class="o">=</span> <span class="s1">&#39;metric&#39;</span>
        <span class="k">if</span> <span class="n">dated_list</span><span class="p">:</span>
            <span class="n">listed_by</span> <span class="o">=</span> <span class="s1">&#39;date&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">mpaths</span><span class="p">,</span> <span class="n">unique_m</span><span class="p">,</span> <span class="n">unique_ts</span><span class="p">,</span> <span class="n">hdates</span> <span class="o">=</span> <span class="n">ionosphere_data</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span>
                <span class="s1">&#39;ionosphere.html&#39;</span><span class="p">,</span> <span class="n">unique_metrics</span><span class="o">=</span><span class="n">unique_m</span><span class="p">,</span> <span class="n">list_by</span><span class="o">=</span><span class="n">listed_by</span><span class="p">,</span>
                <span class="n">unique_timestamps</span><span class="o">=</span><span class="n">unique_ts</span><span class="p">,</span> <span class="n">human_dates</span><span class="o">=</span><span class="n">hdates</span><span class="p">,</span>
                <span class="n">metric_td_dirs</span><span class="o">=</span><span class="nb">zip</span><span class="p">(</span><span class="n">unique_ts</span><span class="p">,</span> <span class="n">hdates</span><span class="p">),</span> <span class="n">td_files</span><span class="o">=</span><span class="n">mpaths</span><span class="p">,</span>
                <span class="n">requested_timestamp</span><span class="o">=</span><span class="n">td_requested_timestamp</span><span class="p">,</span> <span class="n">fp_view</span><span class="o">=</span><span class="n">fp_view_on</span><span class="p">,</span>
                <span class="n">matched_from_datetime</span><span class="o">=</span><span class="n">matched_from_datetime</span><span class="p">,</span>
                <span class="n">version</span><span class="o">=</span><span class="n">skyline_version</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">),</span>
                <span class="n">print_debug</span><span class="o">=</span><span class="n">debug_on</span><span class="p">),</span> <span class="mi">200</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Uh oh ... a Skyline 500 :(&#39;</span>
            <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

    <span class="c1"># @added 20170118 - Feature #1862: Ionosphere features profiles search page</span>
    <span class="c1"># Added fp_search parameter</span>
    <span class="n">fp_search_param</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">fp_search</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: fp_search was True&#39;</span><span class="p">)</span>
        <span class="n">fp_search_param</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">listed_by</span> <span class="o">=</span> <span class="s1">&#39;search&#39;</span>
        <span class="c1"># get_options = [</span>
        <span class="c1">#     &#39;full_duration&#39;, &#39;enabled&#39;, &#39;tsfresh_version&#39;, &#39;generation&#39;]</span>
        <span class="n">fd_list</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># @modified 20170221 - Feature #1862: Ionosphere features profiles search page</span>
            <span class="c1"># fd_list, en_list, tsfresh_list, gen_list, fail_msg, trace = ionosphere_search_defaults(get_options)</span>
            <span class="c1"># @modified 20200715 - Task #3648: webapp - fp_search - do not use Redis metric check</span>
            <span class="c1">#                      Task #2446: Optimize Ionosphere</span>
            <span class="c1"># Added missing search_success variable</span>
            <span class="c1"># features_profiles, fp_count, mc, cc, gc, fd_list, en_list, tsfresh_list, gen_list, fail_msg, trace = ionosphere_search(True, False)</span>
            <span class="n">features_profiles</span><span class="p">,</span> <span class="n">fp_count</span><span class="p">,</span> <span class="n">mc</span><span class="p">,</span> <span class="n">cc</span><span class="p">,</span> <span class="n">gc</span><span class="p">,</span> <span class="n">fd_list</span><span class="p">,</span> <span class="n">en_list</span><span class="p">,</span> <span class="n">tsfresh_list</span><span class="p">,</span> <span class="n">gen_list</span><span class="p">,</span> <span class="n">search_success</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">ionosphere_search</span><span class="p">(</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;debug :: fd_list - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">fd_list</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Uh oh ... a Skyline 500 :(&#39;</span>
            <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">fd_list</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span>
                    <span class="s1">&#39;ionosphere.html&#39;</span><span class="p">,</span> <span class="n">list_by</span><span class="o">=</span><span class="n">listed_by</span><span class="p">,</span> <span class="n">fp_search</span><span class="o">=</span><span class="n">fp_search_param</span><span class="p">,</span>
                    <span class="n">full_duration_list</span><span class="o">=</span><span class="n">fd_list</span><span class="p">,</span> <span class="n">enabled_list</span><span class="o">=</span><span class="n">en_list</span><span class="p">,</span>
                    <span class="n">tsfresh_version_list</span><span class="o">=</span><span class="n">tsfresh_list</span><span class="p">,</span> <span class="n">generation_list</span><span class="o">=</span><span class="n">gen_list</span><span class="p">,</span>
                    <span class="n">matched_from_datetime</span><span class="o">=</span><span class="n">matched_from_datetime</span><span class="p">,</span>
                    <span class="n">version</span><span class="o">=</span><span class="n">skyline_version</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">),</span>
                    <span class="n">print_debug</span><span class="o">=</span><span class="n">debug_on</span><span class="p">),</span> <span class="mi">200</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Uh oh ... a Skyline 500 :(&#39;</span>
                <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">metric_td_arg</span><span class="p">:</span>
        <span class="n">listed_by</span> <span class="o">=</span> <span class="s1">&#39;metric_td_dirs&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">mpaths</span><span class="p">,</span> <span class="n">unique_m</span><span class="p">,</span> <span class="n">unique_ts</span><span class="p">,</span> <span class="n">hdates</span> <span class="o">=</span> <span class="n">ionosphere_data</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">base_name</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span>
                <span class="s1">&#39;ionosphere.html&#39;</span><span class="p">,</span> <span class="n">metric_td_dirs</span><span class="o">=</span><span class="nb">zip</span><span class="p">(</span><span class="n">unique_ts</span><span class="p">,</span> <span class="n">hdates</span><span class="p">),</span>
                <span class="n">list_by</span><span class="o">=</span><span class="n">listed_by</span><span class="p">,</span> <span class="n">for_metric</span><span class="o">=</span><span class="n">base_name</span><span class="p">,</span> <span class="n">td_files</span><span class="o">=</span><span class="n">mpaths</span><span class="p">,</span>
                <span class="n">requested_timestamp</span><span class="o">=</span><span class="n">td_requested_timestamp</span><span class="p">,</span> <span class="n">fp_view</span><span class="o">=</span><span class="n">fp_view_on</span><span class="p">,</span>
                <span class="n">matched_from_datetime</span><span class="o">=</span><span class="n">matched_from_datetime</span><span class="p">,</span>
                <span class="n">version</span><span class="o">=</span><span class="n">skyline_version</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">),</span>
                <span class="n">print_debug</span><span class="o">=</span><span class="n">debug_on</span><span class="p">),</span> <span class="mi">200</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Uh oh ... a Skyline 500 :(&#39;</span>
            <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">timestamp_td_arg</span><span class="p">:</span>
        <span class="c1"># Note to self.  Can we carry the referring timestamp through and when</span>
        <span class="c1"># a metric is selected the time is the only one wrapped in &lt;code&gt; .e.g red?</span>
        <span class="n">listed_by</span> <span class="o">=</span> <span class="s1">&#39;timestamp_td_dirs&#39;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">mpaths</span><span class="p">,</span> <span class="n">unique_m</span><span class="p">,</span> <span class="n">unique_ts</span><span class="p">,</span> <span class="n">hdates</span> <span class="o">=</span> <span class="n">ionosphere_get_metrics_dir</span><span class="p">(</span><span class="n">requested_timestamp_td</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span>
                <span class="s1">&#39;ionosphere.html&#39;</span><span class="p">,</span> <span class="n">unique_metrics</span><span class="o">=</span><span class="n">unique_m</span><span class="p">,</span> <span class="n">list_by</span><span class="o">=</span><span class="n">listed_by</span><span class="p">,</span>
                <span class="n">unique_timestamps</span><span class="o">=</span><span class="n">unique_ts</span><span class="p">,</span> <span class="n">human_dates</span><span class="o">=</span><span class="n">hdates</span><span class="p">,</span> <span class="n">td_files</span><span class="o">=</span><span class="n">mpaths</span><span class="p">,</span>
                <span class="n">metric_td_dirs</span><span class="o">=</span><span class="nb">zip</span><span class="p">(</span><span class="n">unique_ts</span><span class="p">,</span> <span class="n">hdates</span><span class="p">),</span>
                <span class="n">requested_timestamp</span><span class="o">=</span><span class="n">td_requested_timestamp</span><span class="p">,</span> <span class="n">fp_view</span><span class="o">=</span><span class="n">fp_view_on</span><span class="p">,</span>
                <span class="n">matched_from_datetime</span><span class="o">=</span><span class="n">matched_from_datetime</span><span class="p">,</span>
                <span class="n">version</span><span class="o">=</span><span class="n">skyline_version</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">),</span>
                <span class="n">print_debug</span><span class="o">=</span><span class="n">debug_on</span><span class="p">),</span> <span class="mi">200</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Uh oh ... a Skyline 500 :(&#39;</span>
            <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">timestamp_arg</span> <span class="ow">and</span> <span class="n">metric_arg</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># @modified 20170104 - Feature #1842: Ionosphere - Graphite now graphs</span>
            <span class="c1"># Added the full_duration_in_hours and changed graph color from blue to orange</span>
            <span class="c1"># full_duration_in_hours</span>
            <span class="c1"># GRAPH_URL = GRAPHITE_PROTOCOL + &#39;://&#39; + GRAPHITE_HOST + &#39;:&#39; + GRAPHITE_PORT + &#39;/render/?width=1400&amp;from=-&#39; + TARGET_HOURS + &#39;hour&amp;target=&#39;</span>
            <span class="c1"># A regex is required to change the TARGET_HOURS, no? extend do not modify?</span>
            <span class="c1"># Not certain will review after Dude morning excersion</span>

            <span class="c1"># @modified 20200417 - Task #3294: py3 - handle system parameter in Graphite cactiStyle</span>
            <span class="c1"># graph_url = &#39;%scactiStyle(%s)%s&amp;colorList=blue&#39; % (</span>
            <span class="n">graph_url</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">cactiStyle(</span><span class="si">%s</span><span class="s1">,</span><span class="si">%%</span><span class="s1">27si</span><span class="si">%%</span><span class="s1">27)</span><span class="si">%s</span><span class="s1">&amp;colorList=blue&#39;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">settings</span><span class="o">.</span><span class="n">GRAPH_URL</span><span class="p">,</span> <span class="n">base_name</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">GRAPHITE_GRAPH_SETTINGS</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">graph_url</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># @added 20170604 - Feature #2034: analyse_derivatives</span>
        <span class="c1"># Added nonNegativeDerivative to strictly</span>
        <span class="c1"># increasing monotonically metrics in graph_url</span>
        <span class="n">known_derivative_metric</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">derivative_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="s1">&#39;derivative_metrics&#39;</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">derivative_metrics</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">redis_metric_name</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">base_name</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">redis_metric_name</span> <span class="ow">in</span> <span class="n">derivative_metrics</span><span class="p">:</span>
            <span class="n">known_derivative_metric</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">known_derivative_metric</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">non_derivative_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="s1">&#39;non_derivative_metrics&#39;</span><span class="p">))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">non_derivative_metrics</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">skip_derivative</span> <span class="o">=</span> <span class="n">in_list</span><span class="p">(</span><span class="n">redis_metric_name</span><span class="p">,</span> <span class="n">non_derivative_metrics</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">skip_derivative</span><span class="p">:</span>
                <span class="n">known_derivative_metric</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">known_derivative_metric</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># @modified 20200417 - Task #3294: py3 - handle system parameter in Graphite cactiStyle</span>
                <span class="c1"># graph_url = &#39;%scactiStyle(nonNegativeDerivative(%s))%s&amp;colorList=blue&#39; % (</span>
                <span class="n">graph_url</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">cactiStyle(nonNegativeDerivative(</span><span class="si">%s</span><span class="s1">),</span><span class="si">%%</span><span class="s1">27si</span><span class="si">%%</span><span class="s1">27)</span><span class="si">%s</span><span class="s1">&amp;colorList=blue&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">settings</span><span class="o">.</span><span class="n">GRAPH_URL</span><span class="p">,</span> <span class="n">base_name</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">GRAPHITE_GRAPH_SETTINGS</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">graph_url</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># @added 20170327 - Feature #2004: Ionosphere layers - edit_layers</span>
        <span class="c1">#                   Task #2002: Review and correct incorrectly defined layers</span>
        <span class="n">layers_updated</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="s1">&#39;edit_fp_layers&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">edit_fp_layers_arg</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;edit_fp_layers&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">edit_fp_layers_arg</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                <span class="n">edit_fp_layers</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;editing layers id - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">layers_id</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;not editing layers id - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">layers_id</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">edit_fp_layers</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;editing layers id - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">layers_id</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">layers_updated</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">traceback_format_exc</span> <span class="o">=</span> <span class="n">edit_ionosphere_layers</span><span class="p">(</span><span class="n">layers_id</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;updated layers id - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">layers_id</span><span class="p">))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;failed to update layer calling edit_ionosphere_layers&#39;</span>
                <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">layers_updated</span><span class="p">:</span>
                <span class="n">trace</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;failed to update layer&#39;</span>
                <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;not editing layers&#39;</span><span class="p">)</span>

        <span class="n">features</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">f_calc</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span>
        <span class="n">fp_exists</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">fp_id</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">calculate_features</span> <span class="ow">or</span> <span class="n">create_feature_profile</span> <span class="ow">or</span> <span class="n">fp_view</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">fp_csv</span><span class="p">,</span> <span class="n">successful</span><span class="p">,</span> <span class="n">fp_exists</span><span class="p">,</span> <span class="n">fp_id</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">traceback_format_exc</span><span class="p">,</span> <span class="n">f_calc</span> <span class="o">=</span> <span class="n">calculate_features_profile</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">requested_timestamp</span><span class="p">,</span> <span class="n">base_name</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;failed to calculate features&#39;</span>
                <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">successful</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">,</span> <span class="n">traceback_format_exc</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">fp_csv</span><span class="p">)):</span>
                <span class="c1"># @added 20191029 - Task #3302: Handle csv.reader in py3</span>
                <span class="c1">#                      Branch #3262: py3</span>
                <span class="k">if</span> <span class="n">python_version</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">codecs</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="kn">import</span> <span class="nn">codecs</span>

                <span class="n">features</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fp_csv</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fr</span><span class="p">:</span>
                        <span class="c1"># @modified 20191029 - Task #3302: Handle csv.reader in py3</span>
                        <span class="c1">#                      Branch #3262: py3</span>
                        <span class="c1"># reader = csv.reader(fr, delimiter=&#39;,&#39;)</span>
                        <span class="k">if</span> <span class="n">python_version</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                            <span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">fr</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">codecs</span><span class="o">.</span><span class="n">iterdecode</span><span class="p">(</span><span class="n">fr</span><span class="p">,</span> <span class="s1">&#39;utf-8&#39;</span><span class="p">),</span> <span class="n">delimiter</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">reader</span><span class="p">):</span>
                            <span class="n">features</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="nb">str</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="nb">str</span><span class="p">(</span><span class="n">line</span><span class="p">[</span><span class="mi">1</span><span class="p">])])</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;failed to read csv features from fp_csv - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">fp_csv</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

        <span class="n">generation_zero</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">create_feature_profile</span> <span class="ow">or</span> <span class="n">fp_view</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">create_feature_profile</span><span class="p">:</span>
                <span class="c1"># Submit to Ionosphere to run tsfresh on</span>
                <span class="n">create_feature_profile</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">fp_id</span><span class="p">:</span>
                <span class="c1"># @modified 20170114 -  Feature #1854: Ionosphere learn - generations</span>
                <span class="c1"># Added parent_id and generation as all features profiles that</span>
                <span class="c1"># are created via the UI will be generation 0</span>
                <span class="n">parent_id</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">generation</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">ionosphere_job</span> <span class="o">=</span> <span class="s1">&#39;learn_fp_human&#39;</span>
                <span class="c1"># @added 20190503 - Branch #2646: slack</span>
                <span class="c1"># Added slack_ionosphere_job</span>
                <span class="n">slack_ionosphere_job</span> <span class="o">=</span> <span class="n">ionosphere_job</span>

                <span class="c1"># @added 20200216 - Feature #3450: Handle multiple requests to create a features profile</span>
                <span class="c1"># Ensure that one features profile can only be created if</span>
                <span class="c1"># multiple requests are received to create a features profile</span>
                <span class="n">fp_pending</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">cache_key</span> <span class="o">=</span> <span class="s1">&#39;fp_pending.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">requested_timestamp</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">base_name</span><span class="p">))</span>
                    <span class="n">fp_pending</span> <span class="o">=</span> <span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;failed to determine if a features profile is pending&#39;</span>
                    <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">create_feature_profile</span> <span class="ow">and</span> <span class="n">fp_pending</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;fp pending for - </span><span class="si">%s</span><span class="s1"> on </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                        <span class="nb">str</span><span class="p">(</span><span class="n">requested_timestamp</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">base_name</span><span class="p">)))</span>
                    <span class="k">if</span> <span class="n">response_format</span> <span class="o">==</span> <span class="s1">&#39;json&#39;</span><span class="p">:</span>
                        <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;created&quot;</span><span class="p">:</span> <span class="s2">&quot;pending&quot;</span><span class="p">},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;fp_id&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}}</span>
                        <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">200</span>
                    <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                        <span class="p">{</span><span class="s1">&#39;results&#39;</span><span class="p">:</span> <span class="s1">&#39;Notice: a features profile is already being created for &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">requested_timestamp</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; - &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">base_name</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; - please click the back button and refresh the page&#39;</span><span class="p">})</span>
                    <span class="k">return</span> <span class="n">flask_escape</span><span class="p">(</span><span class="n">resp</span><span class="p">),</span> <span class="mi">200</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># @modified 20170120 -  Feature #1854: Ionosphere learn - generations</span>
                    <span class="c1"># Added fp_learn parameter to allow the user to not learn the</span>
                    <span class="c1"># use_full_duration_days</span>
                    <span class="c1"># fp_id, fp_in_successful, fp_exists, fail_msg, traceback_format_exc = create_features_profile(skyline_app, requested_timestamp, base_name, context, ionosphere_job, parent_id, generation, fp_learn)</span>
                    <span class="c1"># @modified 20190503 - Branch #2646: slack</span>
                    <span class="c1"># Added slack_ionosphere_job</span>
                    <span class="c1"># fp_id, fp_in_successful, fp_exists, fail_msg, traceback_format_exc = create_features_profile(skyline_app, requested_timestamp, base_name, context, ionosphere_job, parent_id, generation, fp_learn)</span>
                    <span class="c1"># @modified 20190919 - Feature #3230: users DB table</span>
                    <span class="c1">#                      Ideas #2476: Label and relate anomalies</span>
                    <span class="c1">#                      Feature #2516: Add label to features profile</span>
                    <span class="c1"># Added user_id and label</span>
                    <span class="c1"># fp_id, fp_in_successful, fp_exists, fail_msg, traceback_format_exc = create_features_profile(skyline_app, requested_timestamp, base_name, context, ionosphere_job, parent_id, generation, fp_learn, slack_ionosphere_job)</span>
                    <span class="n">fp_id</span><span class="p">,</span> <span class="n">fp_in_successful</span><span class="p">,</span> <span class="n">fp_exists</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">traceback_format_exc</span> <span class="o">=</span> <span class="n">create_features_profile</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">requested_timestamp</span><span class="p">,</span> <span class="n">base_name</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">ionosphere_job</span><span class="p">,</span> <span class="n">parent_id</span><span class="p">,</span> <span class="n">generation</span><span class="p">,</span> <span class="n">fp_learn</span><span class="p">,</span> <span class="n">slack_ionosphere_job</span><span class="p">,</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">label</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">create_feature_profile</span><span class="p">:</span>
                        <span class="n">generation_zero</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="c1"># @modified 20161209 -  - Branch #922: ionosphere</span>
                    <span class="c1">#                        Task #1658: Patterning Skyline Ionosphere</span>
                    <span class="c1"># Use raise and traceback.format_exc() to carry</span>
                    <span class="c1"># ionosphere_backend.py through to the rendered page for the user, e.g</span>
                    <span class="c1"># me.</span>
                    <span class="c1"># trace = traceback_format_exc</span>
                    <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;failed to create features profile&#39;</span>
                    <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">fp_in_successful</span><span class="p">:</span>
                    <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                    <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: create_features_profile failed&#39;</span>
                    <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">,</span> <span class="s1">&#39;no traceback available&#39;</span><span class="p">)</span>

        <span class="n">fp_details</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># @added 20170305  - Feature #1960: ionosphere_layers</span>
        <span class="n">l_id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">l_details</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">l_details_object</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">la_details</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># @added 20170402 - Feature #2000: Ionosphere - validated</span>
        <span class="n">validated_fp_success</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># added 20170908 - Feature #2056: ionosphere - disabled_features_profiles</span>
        <span class="n">family_tree_fp_ids</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">disabled_fp_success</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">fp_view</span><span class="p">:</span>
            <span class="c1"># @added 20170402 - Feature #2000: Ionosphere - validated</span>
            <span class="n">validate</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="s1">&#39;validate_fp&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                <span class="n">validate_arg</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;validate_fp&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">validate_arg</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                    <span class="n">validate</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;validate - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">validate</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">validate</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;validating - fp_ip </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">fp_id</span><span class="p">))</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># @modified 20181013 - Feature #2430: Ionosphere validate learnt features profiles page</span>
                    <span class="c1"># Added the extended validate_fp parameter of id_column_name</span>
                    <span class="c1"># validated_fp_success, fail_msg, traceback_format_exc = validate_fp(fp_id)</span>
                    <span class="c1"># @modified 20190919 - Feature #3230: users DB table</span>
                    <span class="c1">#                      Ideas #2476: Label and relate anomalies</span>
                    <span class="c1">#                      Feature #2516: Add label to features profile</span>
                    <span class="c1"># Added user_id</span>
                    <span class="c1"># validated_fp_success, fail_msg, traceback_format_exc = validate_fp(fp_id, &#39;id&#39;)</span>
                    <span class="n">validated_fp_success</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">traceback_format_exc</span> <span class="o">=</span> <span class="n">validate_fp</span><span class="p">(</span><span class="n">fp_id</span><span class="p">,</span> <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">user_id</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;validated fp_id - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">fp_id</span><span class="p">))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;failed to validate features profile&#39;</span>
                    <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

            <span class="c1"># added 20170908 - Feature #2056: ionosphere - disabled_features_profiles</span>
            <span class="n">family_tree_fp_ids</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">traceback_format_exc</span> <span class="o">=</span> <span class="n">features_profile_family_tree</span><span class="p">(</span><span class="n">fp_id</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;disable_fp&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;disable_fp&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">disable_fp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;disable_fp is set to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">disable_fp</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">disable_fp</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;disabling fp ids - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">family_tree_fp_ids</span><span class="p">))</span>
                <span class="n">disabled_fp_success</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">traceback_format_exc</span> <span class="o">=</span> <span class="n">disable_features_profile_family_tree</span><span class="p">(</span><span class="n">family_tree_fp_ids</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># @modified 20170114 -  Feature #1854: Ionosphere learn - generations</span>
                <span class="c1"># Return the fp_details_object so that webapp can pass the parent_id and</span>
                <span class="c1"># generation to the templates</span>
                <span class="c1"># fp_details, fp_details_successful, fail_msg, traceback_format_exc = features_profile_details(fp_id)</span>
                <span class="n">fp_details</span><span class="p">,</span> <span class="n">fp_details_successful</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">traceback_format_exc</span><span class="p">,</span> <span class="n">fp_details_object</span> <span class="o">=</span> <span class="n">features_profile_details</span><span class="p">(</span><span class="n">fp_id</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="c1"># trace = traceback_format_exc</span>
                <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;failed to get features profile details&#39;</span>
                <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">fp_details_successful</span><span class="p">:</span>
                <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: features_profile_details failed&#39;</span>
                <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

            <span class="c1"># @added 20170305  - Feature #1960: ionosphere_layers</span>
            <span class="n">fp_layers_id</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">fp_layers_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">fp_details_object</span><span class="p">[</span><span class="s1">&#39;layers_id&#39;</span><span class="p">])</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">fp_layers_id</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1"># @added 20190922 - Feature #2516: Add label to features profile</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">fp_label</span> <span class="o">=</span> <span class="n">fp_details_object</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">fp_label</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># @modified 20190503 - Branch #2646: slack - linting</span>
            <span class="c1"># layer_details = None</span>

            <span class="n">layer_details_success</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">fp_layers_id</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">l_details</span><span class="p">,</span> <span class="n">layer_details_success</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">traceback_format_exc</span><span class="p">,</span> <span class="n">l_details_object</span> <span class="o">=</span> <span class="n">feature_profile_layers_detail</span><span class="p">(</span><span class="n">fp_layers_id</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;failed to get features profile layers details for id </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">fp_layers_id</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">la_details</span><span class="p">,</span> <span class="n">layer_algorithms_success</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">traceback_format_exc</span><span class="p">,</span> <span class="n">la_details_object</span> <span class="o">=</span> <span class="n">feature_profile_layer_alogrithms</span><span class="p">(</span><span class="n">fp_layers_id</span><span class="p">)</span>
                    <span class="n">l_id</span> <span class="o">=</span> <span class="n">fp_layers_id</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;failed to get features profile layer algorithm details for id </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">fp_layers_id</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

        <span class="n">valid_learning_duration</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># @added 20170308  - Feature #1960: ionosphere_layers - glm_images to m_app_context</span>
        <span class="n">glm_images</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">l_id_matched</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">m_app_context</span> <span class="o">=</span> <span class="s1">&#39;Analyzer&#39;</span>
        <span class="c1"># @added 20170309  - Feature #1960: ionosphere_layers - i_ts_json</span>
        <span class="n">i_ts_json</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">sample_ts_json</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">sample_i_ts_json</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># @added 20170331 - Task #1988: Review - Ionosphere layers - always show layers</span>
        <span class="c1">#                   Feature #1960: ionosphere_layers</span>
        <span class="n">anomalous_timeseries</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">f_id_matched</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">fp_details_list</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">f_id_created</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">fp_generation_created</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># @modified 20170106 - Feature #1842: Ionosphere - Graphite now graphs</span>
            <span class="c1"># Added graphite_now_images gimages</span>
            <span class="c1"># @modified 20170107 - Feature #1852: Ionosphere - features_profile matched graphite graphs</span>
            <span class="c1"># Added graphite_matched_images gmimages</span>
            <span class="c1"># @modified 20170308 - Feature #1960: ionosphere_layers</span>
            <span class="c1"># Show the latest matched layers graphs as well added glm_images - graphite_layers_matched_images</span>
            <span class="c1"># @modified 20170309 - Feature #1960: ionosphere_layers</span>
            <span class="c1"># Also return the Analyzer FULL_DURATION timeseries if available in a Mirage</span>
            <span class="c1"># based features profile added i_ts_json</span>
            <span class="c1"># @added 20170331 - Task #1988: Review - Ionosphere layers - always show layers</span>
            <span class="c1">#                   Feature #1960: ionosphere_layers</span>
            <span class="c1"># Return the anomalous_timeseries as an array to sample and fp_id_matched</span>
            <span class="c1"># @added 20170401 - Task #1988: Review - Ionosphere layers - added fp_id_created</span>
            <span class="c1"># @added 20190328 - Feature #2484: FULL_DURATION feature profiles</span>
            <span class="c1"># Added fp_anomaly_timestamp ionosphere_echo features profiles</span>
            <span class="n">mpaths</span><span class="p">,</span> <span class="n">images</span><span class="p">,</span> <span class="n">hdate</span><span class="p">,</span> <span class="n">m_vars</span><span class="p">,</span> <span class="n">ts_json</span><span class="p">,</span> <span class="n">data_to_process</span><span class="p">,</span> <span class="n">p_id</span><span class="p">,</span> <span class="n">gimages</span><span class="p">,</span> <span class="n">gmimages</span><span class="p">,</span> <span class="n">times_matched</span><span class="p">,</span> <span class="n">glm_images</span><span class="p">,</span> <span class="n">l_id_matched</span><span class="p">,</span> <span class="n">ts_fd</span><span class="p">,</span> <span class="n">i_ts_json</span><span class="p">,</span> <span class="n">anomalous_timeseries</span><span class="p">,</span> <span class="n">f_id_matched</span><span class="p">,</span> <span class="n">fp_details_list</span><span class="p">,</span> <span class="n">fp_anomaly_timestamp</span> <span class="o">=</span> <span class="n">ionosphere_metric_data</span><span class="p">(</span><span class="n">requested_timestamp</span><span class="p">,</span> <span class="n">base_name</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">fp_id</span><span class="p">)</span>

            <span class="c1"># @added 20200711 - Feature #3634: webapp - ionosphere - report number of data points</span>
            <span class="n">ts_json_length</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">anomalous_timeseries_length</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1"># @added 20170309  - Feature #1960: ionosphere_layers - i_ts_json</span>
            <span class="c1"># Show the last 30</span>
            <span class="k">if</span> <span class="n">ts_json</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">sample_ts_json</span> <span class="o">=</span> <span class="n">ts_json</span><span class="p">[</span><span class="o">-</span><span class="mi">30</span><span class="p">:]</span>
                    <span class="c1"># @added 20200711 - Feature #3634: webapp - ionosphere - report number of data points</span>
                    <span class="n">ts_json_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ts_json</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Failed to sample ts_json&#39;</span>
                    <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

            <span class="c1"># @modified 20170331 - Task #1988: Review - Ionosphere layers - always show layers</span>
            <span class="c1">#                      Feature #1960: ionosphere_layers</span>
            <span class="c1"># Return the anomalous_timeseries as an array to sample</span>
            <span class="c1"># if i_ts_json:</span>
            <span class="c1">#     sample_i_ts_json = i_ts_json[-30:]</span>
            <span class="k">if</span> <span class="n">anomalous_timeseries</span><span class="p">:</span>
                <span class="n">sample_i_ts_json</span> <span class="o">=</span> <span class="n">anomalous_timeseries</span><span class="p">[</span><span class="o">-</span><span class="mi">30</span><span class="p">:]</span>
                <span class="c1"># @added 20200711 - Feature #3634: webapp - ionosphere - report number of data points</span>
                <span class="n">anomalous_timeseries_length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">anomalous_timeseries</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">fp_details_list</span><span class="p">:</span>
                <span class="n">f_id_created</span> <span class="o">=</span> <span class="n">fp_details_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="c1"># @modified 20170729 - Feature #1854: Ionosphere learn - generations</span>
                <span class="c1"># Make backwards compatible with older features profiles</span>
                <span class="c1"># fp_generation_created = fp_details_list[8]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">fp_generation_created</span> <span class="o">=</span> <span class="n">fp_details_list</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">fp_generation_created</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1"># @added 20170120 -  Feature #1854: Ionosphere learn - generations</span>
            <span class="c1"># Added fp_learn parameter to allow the user to not learn the</span>
            <span class="c1"># use_full_duration_days so added fp_fd_days</span>
            <span class="n">use_full_duration</span><span class="p">,</span> <span class="n">valid_learning_duration</span><span class="p">,</span> <span class="n">fp_fd_days</span><span class="p">,</span> <span class="n">max_generations</span><span class="p">,</span> <span class="n">max_percent_diff_from_origin</span> <span class="o">=</span> <span class="n">get_ionosphere_learn_details</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">base_name</span><span class="p">)</span>

            <span class="c1"># @added 20170104 - Feature #1842: Ionosphere - Graphite now graphs</span>
            <span class="c1"># Added the full_duration parameter so that the appropriate graphs can be</span>
            <span class="c1"># embedded for the user in the training data page</span>
            <span class="n">full_duration</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FULL_DURATION</span>
            <span class="n">full_duration_in_hours</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">full_duration</span> <span class="o">/</span> <span class="mi">3600</span><span class="p">)</span>
            <span class="n">second_order_resolution_hours</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;full_duration&#39;</span>
                <span class="n">value_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">var_array</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">var_array</span> <span class="ow">in</span> <span class="n">m_vars</span> <span class="k">if</span> <span class="n">var_array</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">key</span><span class="p">]</span>
                <span class="n">m_full_duration</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="n">m_full_duration_in_hours</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">m_full_duration</span> <span class="o">/</span> <span class="mi">3600</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">m_full_duration</span> <span class="o">!=</span> <span class="n">full_duration</span><span class="p">:</span>
                    <span class="n">second_order_resolution_hours</span> <span class="o">=</span> <span class="n">m_full_duration_in_hours</span>
                    <span class="c1"># @added 20170305  - Feature #1960: ionosphere_layers - m_app_context</span>
                    <span class="n">m_app_context</span> <span class="o">=</span> <span class="s1">&#39;Mirage&#39;</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">m_full_duration</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">m_full_duration_in_hours</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Uh oh ... a Skyline 500 :( :: m_vars - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">m_vars</span><span class="p">)</span>
                <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

            <span class="c1"># @added 20190330 - Feature #2484: FULL_DURATION feature profiles</span>
            <span class="c1"># For Ionosphere echo and adding red borders on the matched graphs</span>
            <span class="k">if</span> <span class="n">m_full_duration_in_hours</span><span class="p">:</span>
                <span class="n">m_fd_in_hours_img_str</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">h.png&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">m_full_duration_in_hours</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">m_fd_in_hours_img_str</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># @added 20170105 - Feature #1842: Ionosphere - Graphite now graphs</span>
            <span class="c1"># We want to sort the images so that the Graphite image is always</span>
            <span class="c1"># displayed first in he training_data.html page AND we want Graphite</span>
            <span class="c1"># now graphs at TARGET_HOURS, 24h, 7d, 30d to inform the operator</span>
            <span class="c1"># about the metric</span>
            <span class="n">sorted_images</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">images</span><span class="p">)</span>

            <span class="c1"># @modified 20170105 - Feature #1842: Ionosphere - Graphite now graphs</span>
            <span class="c1"># Added matched_count and only displaying one graph for each 10</span>
            <span class="c1"># minute period if there are mulitple matches in a 10 minute period</span>
            <span class="c1"># @modified 20170114 -  Feature #1854: Ionosphere learn - generations</span>
            <span class="c1"># Added parent_id and generation</span>
            <span class="n">par_id</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">gen</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="c1"># @added 20170402 - Feature #2000: Ionosphere - validated</span>
            <span class="n">fp_validated</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1"># added 20170908 - Feature #2056: ionosphere - disabled_features_profiles</span>
            <span class="n">fp_enabled</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># @added 20190328 - Feature #2484: FULL_DURATION feature profiles</span>
            <span class="c1"># Added ionosphere_echo</span>
            <span class="n">echo_fp_value</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1"># @added 20190619 - Feature #2990: Add metrics id to relevant web pages</span>
            <span class="n">metric_id</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="c1"># Determine the parent_id and generation as they were added to the</span>
            <span class="c1"># fp_details_object</span>
            <span class="k">if</span> <span class="n">fp_details</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">par_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">fp_details_object</span><span class="p">[</span><span class="s1">&#39;parent_id&#39;</span><span class="p">])</span>
                    <span class="n">gen</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">fp_details_object</span><span class="p">[</span><span class="s1">&#39;generation&#39;</span><span class="p">])</span>
                    <span class="c1"># @added 20170402 - Feature #2000: Ionosphere - validated</span>
                    <span class="n">fp_validated</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">fp_details_object</span><span class="p">[</span><span class="s1">&#39;validated&#39;</span><span class="p">])</span>
                    <span class="c1"># added 20170908 - Feature #2056: ionosphere - disabled_features_profiles</span>
                    <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">fp_details_object</span><span class="p">[</span><span class="s1">&#39;enabled&#39;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">fp_enabled</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="c1"># @added 20190328 - Feature #2484: FULL_DURATION feature profiles</span>
                    <span class="c1"># Added ionosphere_echo</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">echo_fp_value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">fp_details_object</span><span class="p">[</span><span class="s1">&#39;echo_fp&#39;</span><span class="p">])</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">pass</span>

                    <span class="c1"># @added 20190619 - Feature #2990: Add metrics id to relevant web pages</span>
                    <span class="c1"># Determine the metric_id from the fp_details_object</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">metric_id</span><span class="p">:</span>
                        <span class="n">metric_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">fp_details_object</span><span class="p">[</span><span class="s1">&#39;metric_id&#39;</span><span class="p">])</span>

                <span class="k">except</span><span class="p">:</span>
                    <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Uh oh ... a Skyline 500 :( :: failed to determine parent or generation values from the fp_details_object&#39;</span>
                    <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

                <span class="c1"># @added 20190328 - Feature #2484: FULL_DURATION feature profiles</span>
                <span class="c1"># Added ionosphere_echo</span>
                <span class="n">echo_hdate</span> <span class="o">=</span> <span class="n">hdate</span>
                <span class="k">if</span> <span class="n">echo_fp_value</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># echo_hdate = datetime.datetime.utcfromtimestamp(fp_anomaly_timestamp).strftime(&#39;%Y-%m-%d %H:%M:%S&#39;)</span>
                        <span class="n">echo_hdate</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S %Z (%A)&#39;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">fp_anomaly_timestamp</span><span class="p">)))</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                        <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: Webapp failed to determine the echo_hdate from the fp_anomaly_timestamp&#39;</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">)</span>
                        <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

            <span class="c1"># @added 20170114 -  Feature #1854: Ionosphere learn - generations</span>
            <span class="c1"># The fp_id will be in the fp_details_object, but if this is a</span>
            <span class="c1"># generation zero features profile we what set</span>
            <span class="k">if</span> <span class="n">generation_zero</span><span class="p">:</span>
                <span class="n">par_id</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">gen</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1"># @added 20170122 - Feature #1876: Ionosphere - training_data learn countdown</span>
            <span class="c1"># Add a countdown until Ionosphere will learn</span>
            <span class="n">countdown_to</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">requested_timestamp</span> <span class="ow">and</span> <span class="n">valid_learning_duration</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">request_time</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
                    <span class="n">vaild_learning_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">requested_timestamp</span><span class="p">)</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">valid_learning_duration</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">request_time</span> <span class="o">&lt;</span> <span class="n">vaild_learning_timestamp</span><span class="p">:</span>
                        <span class="n">countdown_to</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span>
                            <span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">(</span><span class="n">vaild_learning_timestamp</span><span class="p">))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Uh oh ... a Skyline 500 :( :: failed to determine parent or generation values from the fp_details_object&#39;</span>
                    <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

            <span class="n">iono_metric</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">base_name</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">ionosphere_metrics</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="s1">&#39;ionosphere.unique_metrics&#39;</span><span class="p">))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;warning :: Webapp could not get the ionosphere.unique_metrics list from Redis, this could be because there are none&#39;</span><span class="p">)</span>
                <span class="n">metric_name</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">FULL_NAMESPACE</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">base_name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">metric_name</span> <span class="ow">in</span> <span class="n">ionosphere_metrics</span><span class="p">:</span>
                    <span class="n">iono_metric</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="c1"># @added 20170303 - Feature #1960: ionosphere_layers</span>
            <span class="n">vconds</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;&lt;&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;&#39;</span><span class="p">,</span> <span class="s1">&#39;==&#39;</span><span class="p">,</span> <span class="s1">&#39;!=&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;=&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;=&#39;</span><span class="p">]</span>

            <span class="c1"># @modified 20190503 - Branch #2646: slack - linting</span>
            <span class="c1"># condition_list = [&#39;&lt;&#39;, &#39;&gt;&#39;, &#39;==&#39;, &#39;!=&#39;, &#39;&lt;=&#39;, &#39;&gt;=&#39;, &#39;in&#39;, &#39;not in&#39;]</span>

            <span class="n">crit_types</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;day&#39;</span><span class="p">,</span> <span class="s1">&#39;from_time&#39;</span><span class="p">,</span> <span class="s1">&#39;until_time&#39;</span><span class="p">]</span>

            <span class="n">fp_layers</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="s1">&#39;fp_layer&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                <span class="n">fp_layer_arg</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;fp_layer&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">fp_layer_arg</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                    <span class="n">fp_layers</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">add_fp_layers</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="s1">&#39;add_fp_layer&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                <span class="n">add_fp_layer_arg</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;add_fp_layer&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">add_fp_layer_arg</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                    <span class="n">add_fp_layers</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">new_l_algos</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">new_l_algos_ids</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">add_fp_layers</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;learn&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;learn&#39;</span><span class="p">))</span>
                    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                        <span class="n">fp_learn</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;True&#39;</span><span class="p">:</span>
                        <span class="n">fp_learn</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="s1">&#39;fp_id&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                    <span class="n">fp_id</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;fp_id&#39;</span><span class="p">))</span>
                <span class="n">l_id</span><span class="p">,</span> <span class="n">layer_successful</span><span class="p">,</span> <span class="n">new_l_algos</span><span class="p">,</span> <span class="n">new_l_algos_ids</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">create_ionosphere_layers</span><span class="p">(</span><span class="n">base_name</span><span class="p">,</span> <span class="n">fp_id</span><span class="p">,</span> <span class="n">requested_timestamp</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">layer_successful</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">webapp_update_slack_thread</span><span class="p">(</span><span class="n">base_name</span><span class="p">,</span> <span class="n">requested_timestamp</span><span class="p">,</span> <span class="n">fp_id</span><span class="p">,</span> <span class="s1">&#39;layers_created&#39;</span><span class="p">)</span>

            <span class="c1"># @added 20170308 - Feature #1960: ionosphere_layers</span>
            <span class="c1"># To present the operator with the existing layers and algorithms for the metric</span>
            <span class="c1"># The metric layers algoritms are required to present the user with</span>
            <span class="c1"># if the add_fp=true argument is passed, which if so results in the</span>
            <span class="c1"># local variable of create_feature_profile being set and in the</span>
            <span class="c1"># fp_view</span>
            <span class="n">metric_layers_details</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">metric_layers_algorithm_details</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="c1"># @modified 20170331 - Task #1988: Review - Ionosphere layers - always show layers</span>
            <span class="c1"># Set to True so they are always displayed</span>
            <span class="c1"># get_metric_existing_layers = False</span>
            <span class="n">get_metric_existing_layers</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">metric_lc</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">metric_lmc</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">create_feature_profile</span><span class="p">:</span>
                <span class="n">get_metric_existing_layers</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">fp_view</span> <span class="ow">and</span> <span class="n">fp_details</span><span class="p">:</span>
                <span class="n">get_metric_existing_layers</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="s1">&#39;add_fp&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                <span class="n">get_layers_add_fp</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="s1">&#39;add_fp&#39;</span><span class="p">),</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">get_layers_add_fp</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                    <span class="n">get_metric_existing_layers</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">get_metric_existing_layers</span><span class="p">:</span>
                <span class="n">metric_layers_details</span><span class="p">,</span> <span class="n">metric_layers_algorithm_details</span><span class="p">,</span> <span class="n">metric_lc</span><span class="p">,</span> <span class="n">metric_lmc</span><span class="p">,</span> <span class="n">mlad_successful</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">metric_layers_alogrithms</span><span class="p">(</span><span class="n">base_name</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">mlad_successful</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

            <span class="c1"># @added 20170616 - Feature #2048: D1 ionosphere layer</span>
            <span class="n">fp_layer_algorithms</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">metric_layers_algorithm_details</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i_layer_algorithm</span> <span class="ow">in</span> <span class="n">metric_layers_algorithm_details</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">i_layer_algorithm</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">l_id</span><span class="p">):</span>
                            <span class="n">fp_layer_algorithms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i_layer_algorithm</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;warning :: Webapp could not determine layer_algorithm in metric_layers_algorithm_details&#39;</span><span class="p">)</span>
            <span class="n">fp_current_layer</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">metric_layers_details</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i_layer</span> <span class="ow">in</span> <span class="n">metric_layers_details</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">i_layer</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">l_id</span><span class="p">):</span>
                            <span class="n">fp_current_layer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">i_layer</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;warning :: Webapp could not determine layer in metric_layers_details&#39;</span><span class="p">)</span>

            <span class="c1"># @added 20170617 - Feature #2054: ionosphere.save.training_data</span>
            <span class="n">training_data_saved</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">saved_td_details</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">save_training_data</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;saving training data&#39;</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">request_time</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
                    <span class="n">saved_hdate</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S %Z (%A)&#39;</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">(</span><span class="n">request_time</span><span class="p">))</span>
                    <span class="n">training_data_saved</span><span class="p">,</span> <span class="n">saved_td_details</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">save_training_data_dir</span><span class="p">(</span><span class="n">requested_timestamp</span><span class="p">,</span> <span class="n">base_name</span><span class="p">,</span> <span class="n">saved_td_label</span><span class="p">,</span> <span class="n">saved_hdate</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;saved training data&#39;</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: Webapp could not save_training_data_dir&#39;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>
            <span class="n">saved_td_requested</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">saved_training_data</span><span class="p">:</span>
                <span class="n">saved_td_requested</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">training_data_saved</span><span class="p">,</span> <span class="n">saved_td_details</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">save_training_data_dir</span><span class="p">(</span><span class="n">requested_timestamp</span><span class="p">,</span> <span class="n">base_name</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;got saved training data details&#39;</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: Webapp could not get saved training_data details&#39;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

            <span class="c1"># @added 20170917 - Feature #1996: Ionosphere - matches page</span>
            <span class="n">matched_id_resources</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">matched_graph_image_file</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">matched_fp_id</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">matched_fp_id</span> <span class="o">!=</span> <span class="s1">&#39;False&#39;</span><span class="p">:</span>
                    <span class="n">matched_id_resources</span><span class="p">,</span> <span class="n">successful</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="n">matched_details_object</span><span class="p">,</span> <span class="n">matched_graph_image_file</span> <span class="o">=</span> <span class="n">get_matched_id_resources</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">matched_fp_id</span><span class="p">),</span> <span class="s1">&#39;features_profile&#39;</span><span class="p">,</span> <span class="n">base_name</span><span class="p">,</span> <span class="n">requested_timestamp</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">matched_layer_id</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">matched_layer_id</span> <span class="o">!=</span> <span class="s1">&#39;False&#39;</span><span class="p">:</span>
                    <span class="n">matched_id_resources</span><span class="p">,</span> <span class="n">successful</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span><span class="p">,</span> <span class="n">matched_details_object</span><span class="p">,</span> <span class="n">matched_graph_image_file</span> <span class="o">=</span> <span class="n">get_matched_id_resources</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">matched_layer_id</span><span class="p">),</span> <span class="s1">&#39;layers&#39;</span><span class="p">,</span> <span class="n">base_name</span><span class="p">,</span> <span class="n">requested_timestamp</span><span class="p">)</span>

            <span class="c1"># @added 20180620 - Feature #2404: Ionosphere - fluid approximation</span>
            <span class="c1"># Added minmax scaling</span>
            <span class="n">minmax</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">matched_fp_id</span><span class="p">:</span>
                <span class="n">minmax</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">matched_details_object</span><span class="p">[</span><span class="s1">&#39;minmax&#39;</span><span class="p">])</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;the fp match has minmax set to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">minmax</span><span class="p">))</span>

            <span class="c1"># @added 20190601 - Feature #3084: Ionosphere - validated matches</span>
            <span class="c1"># Update the DB that the match has been validated or invalidated</span>
            <span class="n">validated_match_successful</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">match_validated_db_value</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="n">matched_fp_id</span> <span class="ow">or</span> <span class="n">matched_layer_id</span><span class="p">:</span>
                <span class="n">match_validated_db_value</span> <span class="o">=</span> <span class="n">matched_details_object</span><span class="p">[</span><span class="s1">&#39;validated&#39;</span><span class="p">]</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;the match_validated_db_value is set to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">match_validated_db_value</span><span class="p">))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;the match_validated is set to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">match_validated</span><span class="p">))</span>
                <span class="c1"># Only update if the value in the DB is different from the value</span>
                <span class="c1"># in the argument, due to there being a difficulty in the</span>
                <span class="c1"># removal of the match_validation argument due to the</span>
                <span class="c1"># redirect_url function being applied earlier ^^ in the process.</span>
                <span class="c1"># Unfortunately without the redirect_url function being applied</span>
                <span class="c1"># this match_validation and match_validated would not work as</span>
                <span class="c1"># the matched context the redirect_url function is used.  Hence</span>
                <span class="c1"># more F.</span>
                <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">match_validated_db_value</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">int</span><span class="p">(</span><span class="n">match_validated</span><span class="p">):</span>
                    <span class="k">if</span> <span class="s1">&#39;match_validation&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">match_validated</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;validating match&#39;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">matched_fp_id</span><span class="p">:</span>
                                <span class="n">match_id</span> <span class="o">=</span> <span class="n">matched_fp_id</span>
                                <span class="n">validate_context</span> <span class="o">=</span> <span class="s1">&#39;ionosphere_matched&#39;</span>
                            <span class="k">if</span> <span class="n">matched_layer_id</span><span class="p">:</span>
                                <span class="n">match_id</span> <span class="o">=</span> <span class="n">matched_layer_id</span>
                                <span class="n">validate_context</span> <span class="o">=</span> <span class="s1">&#39;ionosphere_layers_matched&#39;</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="c1"># @modified 20190920 -</span>
                                <span class="c1"># Added user_id</span>
                                <span class="c1"># validated_match_successful = validate_ionosphere_match(match_id, validate_context, match_validated)</span>
                                <span class="n">validated_match_successful</span> <span class="o">=</span> <span class="n">validate_ionosphere_match</span><span class="p">(</span><span class="n">match_id</span><span class="p">,</span> <span class="n">validate_context</span><span class="p">,</span> <span class="n">match_validated</span><span class="p">,</span> <span class="n">user_id</span><span class="p">)</span>
                                <span class="c1"># @added 20190921 - Feature #3234: Ionosphere - related matches vaildation</span>
                                <span class="c1"># TODO - here related matches will also be validated</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;validated match&#39;</span><span class="p">)</span>
                                <span class="n">match_validated_db_value</span> <span class="o">=</span> <span class="n">match_validated</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                                <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: Webapp error with search_ionosphere&#39;</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">)</span>
                                <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

            <span class="c1"># @added 20180921 - Feature #2558: Ionosphere - fluid approximation - approximately_close on layers</span>
            <span class="n">approx_close</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">matched_layer_id</span><span class="p">:</span>
                <span class="n">approx_close</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">matched_details_object</span><span class="p">[</span><span class="s1">&#39;approx_close&#39;</span><span class="p">])</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;the layers match has approx_close set to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">approx_close</span><span class="p">))</span>

            <span class="c1"># @added 20180414 - Branch #2270: luminosity</span>
            <span class="c1"># Add correlations to features_profile and training_data pages if a</span>
            <span class="c1"># panorama_anomaly_id is present</span>
            <span class="n">correlations</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">correlations_with_graph_links</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">p_id</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">correlations</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">get_correlations</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">p_id</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                    <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: Webapp error with get_correlations&#39;</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">correlations</span><span class="p">:</span>
                    <span class="c1"># @added 20180723 - Feature #2470: Correlations Graphite graph links</span>
                    <span class="c1">#                   Branch #2270: luminosity</span>
                    <span class="c1"># Added Graphite graph links to Correlations block</span>
                    <span class="k">for</span> <span class="n">metric_name</span><span class="p">,</span> <span class="n">coefficient</span><span class="p">,</span> <span class="n">shifted</span><span class="p">,</span> <span class="n">shifted_coefficient</span> <span class="ow">in</span> <span class="n">correlations</span><span class="p">:</span>
                        <span class="n">from_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">requested_timestamp</span><span class="p">)</span> <span class="o">-</span> <span class="n">m_full_duration</span>
                        <span class="n">graphite_from</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">from_timestamp</span><span class="p">))</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%H:%M_%Y%m</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="n">graphite_until</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">requested_timestamp</span><span class="p">))</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%H:%M_%Y%m</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="n">unencoded_graph_title</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="s1">correlated with anomaly id </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">metric_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">p_id</span><span class="p">))</span>
                        <span class="n">graph_title_string</span> <span class="o">=</span> <span class="n">quote</span><span class="p">(</span><span class="n">unencoded_graph_title</span><span class="p">,</span> <span class="n">safe</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                        <span class="n">graph_title</span> <span class="o">=</span> <span class="s1">&#39;&amp;title=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">graph_title_string</span>
                        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">GRAPHITE_PORT</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                            <span class="c1"># @modified 20190520 - Branch #3002: docker</span>
                            <span class="c1"># correlation_graphite_link = &#39;%s://%s:%s/render/?from=%s&amp;until=%s&amp;target=cactiStyle(%s)%s%s&amp;colorList=blue&#39; % (settings.GRAPHITE_PROTOCOL, settings.GRAPHITE_HOST, settings.GRAPHITE_PORT, str(graphite_from), str(graphite_until), metric_name, settings.GRAPHITE_GRAPH_SETTINGS, graph_title)</span>
                            <span class="c1"># @modified 20200417 - Task #3294: py3 - handle system parameter in Graphite cactiStyle</span>
                            <span class="c1"># correlation_graphite_link = &#39;%s://%s:%s/%s/?from=%s&amp;until=%s&amp;target=cactiStyle(%s)%s%s&amp;colorList=blue&#39; % (</span>
                            <span class="n">correlation_graphite_link</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">://</span><span class="si">%s</span><span class="s1">:</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">/?from=</span><span class="si">%s</span><span class="s1">&amp;until=</span><span class="si">%s</span><span class="s1">&amp;target=cactiStyle(</span><span class="si">%s</span><span class="s1">,</span><span class="si">%%</span><span class="s1">27si</span><span class="si">%%</span><span class="s1">27)</span><span class="si">%s%s</span><span class="s1">&amp;colorList=blue&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">settings</span><span class="o">.</span><span class="n">GRAPHITE_PROTOCOL</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">GRAPHITE_HOST</span><span class="p">,</span>
                                <span class="n">settings</span><span class="o">.</span><span class="n">GRAPHITE_PORT</span><span class="p">,</span> <span class="n">GRAPHITE_RENDER_URI</span><span class="p">,</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">graphite_from</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">graphite_until</span><span class="p">),</span> <span class="n">metric_name</span><span class="p">,</span>
                                <span class="n">settings</span><span class="o">.</span><span class="n">GRAPHITE_GRAPH_SETTINGS</span><span class="p">,</span> <span class="n">graph_title</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># @modified 20190520 - Branch #3002: docker</span>
                            <span class="c1"># correlation_graphite_link = &#39;%s://%s/render/?from=%s&amp;until=%starget=cactiStyle(%s)%s%s&amp;colorList=blue&#39; % (settings.GRAPHITE_PROTOCOL, settings.GRAPHITE_HOST, str(graphite_from), str(graphite_until), metric_name, settings.GRAPHITE_GRAPH_SETTINGS, graph_title)</span>
                            <span class="c1"># @modified 20200417 - Task #3294: py3 - handle system parameter in Graphite cactiStyle</span>
                            <span class="c1"># correlation_graphite_link = &#39;%s://%s/%s/?from=%s&amp;until=%starget=cactiStyle(%s)%s%s&amp;colorList=blue&#39; % (</span>
                            <span class="n">correlation_graphite_link</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">://</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">/?from=</span><span class="si">%s</span><span class="s1">&amp;until=</span><span class="si">%s</span><span class="s1">target=cactiStyle(</span><span class="si">%s</span><span class="s1">,</span><span class="si">%%</span><span class="s1">27si</span><span class="si">%%</span><span class="s1">27)</span><span class="si">%s%s</span><span class="s1">&amp;colorList=blue&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">settings</span><span class="o">.</span><span class="n">GRAPHITE_PROTOCOL</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">GRAPHITE_HOST</span><span class="p">,</span>
                                <span class="n">GRAPHITE_RENDER_URI</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">graphite_from</span><span class="p">),</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">graphite_until</span><span class="p">),</span> <span class="n">metric_name</span><span class="p">,</span>
                                <span class="n">settings</span><span class="o">.</span><span class="n">GRAPHITE_GRAPH_SETTINGS</span><span class="p">,</span> <span class="n">graph_title</span><span class="p">)</span>
                        <span class="n">correlations_with_graph_links</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">metric_name</span><span class="p">,</span> <span class="n">coefficient</span><span class="p">,</span> <span class="n">shifted</span><span class="p">,</span> <span class="n">shifted_coefficient</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">correlation_graphite_link</span><span class="p">)])</span>

            <span class="c1"># @added 20200808 - Feature #3568: Ionosphere - report anomalies in training period</span>
            <span class="n">labelled_anomalies</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="c1"># @added 20200113 - Feature #3390: luminosity related anomalies</span>
            <span class="c1">#                   Branch #2270: luminosity</span>
            <span class="n">related</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">related_with_graph_links</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">related_matches</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="n">p_id</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># @modified 20200808 - Feature #3568: Ionosphere - report anomalies in training period</span>
                    <span class="c1"># related, fail_msg, trace = get_related(skyline_app, p_id, requested_timestamp)</span>
                    <span class="n">related</span><span class="p">,</span> <span class="n">labelled_anomalies</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">get_related</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">p_id</span><span class="p">,</span> <span class="n">requested_timestamp</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                    <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: Webapp error with get_related&#39;</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">related</span><span class="p">:</span>
                    <span class="c1"># Added Graphite graph links to Related block</span>
                    <span class="k">for</span> <span class="n">related_anomaly_id</span><span class="p">,</span> <span class="n">related_metric_id</span><span class="p">,</span> <span class="n">related_metric_name</span><span class="p">,</span> <span class="n">related_anomaly_timestamp</span><span class="p">,</span> <span class="n">related_full_duration</span> <span class="ow">in</span> <span class="n">related</span><span class="p">:</span>
                        <span class="n">related_from_timestamp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">related_anomaly_timestamp</span><span class="p">)</span> <span class="o">-</span> <span class="n">related_full_duration</span>
                        <span class="n">related_graphite_from</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">related_from_timestamp</span><span class="p">))</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%H:%M_%Y%m</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="n">related_graphite_until</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">related_anomaly_timestamp</span><span class="p">))</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%H:%M_%Y%m</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
                        <span class="n">related_unencoded_graph_title</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="se">\n</span><span class="s1">related with anomaly id </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                            <span class="n">related_metric_name</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">p_id</span><span class="p">))</span>
                        <span class="n">related_graph_title_string</span> <span class="o">=</span> <span class="n">quote</span><span class="p">(</span><span class="n">related_unencoded_graph_title</span><span class="p">,</span> <span class="n">safe</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                        <span class="n">related_graph_title</span> <span class="o">=</span> <span class="s1">&#39;&amp;title=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">related_graph_title_string</span>
                        <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">GRAPHITE_PORT</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                            <span class="c1"># @modified 20200417 - Task #3294: py3 - handle system parameter in Graphite cactiStyle</span>
                            <span class="c1"># related_graphite_link = &#39;%s://%s:%s/%s/?from=%s&amp;until=%s&amp;target=cactiStyle(%s)%s%s&amp;colorList=blue&#39; % (</span>
                            <span class="n">related_graphite_link</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">://</span><span class="si">%s</span><span class="s1">:</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">/?from=</span><span class="si">%s</span><span class="s1">&amp;until=</span><span class="si">%s</span><span class="s1">&amp;target=cactiStyle(</span><span class="si">%s</span><span class="s1">,</span><span class="si">%%</span><span class="s1">27si</span><span class="si">%%</span><span class="s1">27)</span><span class="si">%s%s</span><span class="s1">&amp;colorList=blue&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">settings</span><span class="o">.</span><span class="n">GRAPHITE_PROTOCOL</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">GRAPHITE_HOST</span><span class="p">,</span>
                                <span class="n">settings</span><span class="o">.</span><span class="n">GRAPHITE_PORT</span><span class="p">,</span> <span class="n">GRAPHITE_RENDER_URI</span><span class="p">,</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">related_graphite_from</span><span class="p">),</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">related_graphite_until</span><span class="p">),</span> <span class="n">related_metric_name</span><span class="p">,</span>
                                <span class="n">settings</span><span class="o">.</span><span class="n">GRAPHITE_GRAPH_SETTINGS</span><span class="p">,</span> <span class="n">related_graph_title</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># @modified 20200417 - Task #3294: py3 - handle system parameter in Graphite cactiStyle</span>
                            <span class="c1"># related_graphite_link = &#39;%s://%s/%s/?from=%s&amp;until=%starget=cactiStyle(%s)%s%s&amp;colorList=blue&#39; % (</span>
                            <span class="n">related_graphite_link</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">://</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">/?from=</span><span class="si">%s</span><span class="s1">&amp;until=</span><span class="si">%s</span><span class="s1">target=cactiStyle(</span><span class="si">%s</span><span class="s1">,</span><span class="si">%%</span><span class="s1">27si</span><span class="si">%%</span><span class="s1">27)</span><span class="si">%s%s</span><span class="s1">&amp;colorList=blue&#39;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="n">settings</span><span class="o">.</span><span class="n">GRAPHITE_PROTOCOL</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">GRAPHITE_HOST</span><span class="p">,</span>
                                <span class="n">GRAPHITE_RENDER_URI</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">related_graphite_from</span><span class="p">),</span>
                                <span class="nb">str</span><span class="p">(</span><span class="n">related_graphite_until</span><span class="p">),</span> <span class="n">related_metric_name</span><span class="p">,</span>
                                <span class="n">settings</span><span class="o">.</span><span class="n">GRAPHITE_GRAPH_SETTINGS</span><span class="p">,</span> <span class="n">related_graph_title</span><span class="p">)</span>
                        <span class="n">related_human_timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">related_anomaly_timestamp</span><span class="p">))</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M:%S&#39;</span><span class="p">)</span>
                        <span class="n">related_with_graph_links</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">related_anomaly_id</span><span class="p">,</span> <span class="n">related_metric_name</span><span class="p">,</span> <span class="n">related_anomaly_timestamp</span><span class="p">,</span> <span class="n">related_full_duration</span><span class="p">,</span> <span class="n">related_human_timestamp</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">related_graphite_link</span><span class="p">)])</span>
                <span class="n">related_metric</span> <span class="o">=</span> <span class="s1">&#39;get_related_matches&#39;</span>
                <span class="n">related_metric_like</span> <span class="o">=</span> <span class="s1">&#39;all&#39;</span>
                <span class="n">related_fp_id</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">related_layer_id</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">minus_two_minutes</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">requested_timestamp</span><span class="p">)</span> <span class="o">-</span> <span class="mi">120</span>
                <span class="n">plus_two_minutes</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">requested_timestamp</span><span class="p">)</span> <span class="o">+</span> <span class="mi">120</span>
                <span class="n">related_limited_by</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">related_ordered_by</span> <span class="o">=</span> <span class="s1">&#39;DESC&#39;</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">related_matches</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">get_fp_matches</span><span class="p">(</span><span class="n">related_metric</span><span class="p">,</span> <span class="n">related_metric_like</span><span class="p">,</span> <span class="n">related_fp_id</span><span class="p">,</span> <span class="n">related_layer_id</span><span class="p">,</span> <span class="n">minus_two_minutes</span><span class="p">,</span> <span class="n">plus_two_minutes</span><span class="p">,</span> <span class="n">related_limited_by</span><span class="p">,</span> <span class="n">related_ordered_by</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                    <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: Webapp error with get_fp_matches for related_matches&#39;</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">related_matches</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">related_human_date</span><span class="p">,</span> <span class="n">related_match_id</span><span class="p">,</span> <span class="n">related_matched_by</span><span class="p">,</span> <span class="n">related_fp_id</span><span class="p">,</span> <span class="n">related_layer_id</span><span class="p">,</span> <span class="n">related_metric</span><span class="p">,</span> <span class="n">related_uri_to_matched_page</span><span class="p">,</span> <span class="n">related_validated</span> <span class="ow">in</span> <span class="n">related_matches</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">related_matched_by</span> <span class="o">==</span> <span class="s1">&#39;no matches were found&#39;</span><span class="p">:</span>
                            <span class="n">related_matches</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="n">related_matches</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> possible related matches found&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">related_matches</span><span class="p">))))</span>
                <span class="c1"># @added 20200808 - Feature #3568: Ionosphere - report anomalies in training period</span>
                <span class="k">if</span> <span class="n">labelled_anomalies</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> labelled anomalies found in the trying period&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">labelled_anomalies</span><span class="p">))))</span>

            <span class="c1"># @added 20190510 - Feature #2990: Add metrics id to relevant web pages</span>
            <span class="c1"># By this point in the request the previous function calls will have</span>
            <span class="c1"># populated memcache with the metric details</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">metric_id</span><span class="p">:</span>
                <span class="n">metric_id</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">cache_key</span> <span class="o">=</span> <span class="s1">&#39;panorama.mysql_ids.metrics.metric.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">base_name</span>
                    <span class="n">metric_id_msg_pack</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="c1"># @modified 20191015 - Bug #3266: py3 Redis binary objects not strings</span>
                    <span class="c1">#                      Branch #3262: py3</span>
                    <span class="c1"># metric_id_msg_pack = REDIS_CONN.get(cache_key)</span>
                    <span class="n">metric_id_msg_pack</span> <span class="o">=</span> <span class="n">REDIS_CONN_UNDECODE</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">cache_key</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">metric_id_msg_pack</span><span class="p">:</span>
                        <span class="n">unpacker</span> <span class="o">=</span> <span class="n">Unpacker</span><span class="p">(</span><span class="n">use_list</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                        <span class="n">unpacker</span><span class="o">.</span><span class="n">feed</span><span class="p">(</span><span class="n">metric_id_msg_pack</span><span class="p">)</span>
                        <span class="n">metric_id</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">unpacker</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics id is </span><span class="si">%s</span><span class="s1"> from Redis key -</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">),</span> <span class="n">cache_key</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Webapp could not get metric id from Redis key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">cache_key</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: Webapp could not get metric id from Redis key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">cache_key</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;metrics id is </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">metric_id</span><span class="p">))</span>

            <span class="c1"># @added 20190502 - Branch #2646: slack</span>
            <span class="k">if</span> <span class="n">context</span> <span class="o">==</span> <span class="s1">&#39;training_data&#39;</span><span class="p">:</span>
                <span class="n">update_slack</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="c1"># Do not update if a fp_id is present</span>
                <span class="k">if</span> <span class="n">fp_id</span><span class="p">:</span>
                    <span class="n">update_slack</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="c1"># Do not update slack when extract features is run</span>
                <span class="k">if</span> <span class="n">calculate_features</span><span class="p">:</span>
                    <span class="n">update_slack</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">update_slack</span><span class="p">:</span>
                    <span class="n">slack_updated</span> <span class="o">=</span> <span class="n">webapp_update_slack_thread</span><span class="p">(</span><span class="n">base_name</span><span class="p">,</span> <span class="n">requested_timestamp</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;training_data_viewed&#39;</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;slack_updated for training_data_viewed </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">slack_updated</span><span class="p">))</span>

            <span class="c1"># @added 20191210 - Feature #3348: fp creation json response</span>
            <span class="k">if</span> <span class="n">create_feature_profile</span> <span class="ow">and</span> <span class="n">fp_id</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">response_format</span> <span class="o">==</span> <span class="s1">&#39;json&#39;</span><span class="p">:</span>
                    <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s2">&quot;error&quot;</span><span class="p">}</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">fp_created_successful</span> <span class="o">=</span> <span class="n">fp_in_successful</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">fp_created_successful</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="n">fp_created_successful</span><span class="p">:</span>
                        <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;created&quot;</span><span class="p">:</span> <span class="s2">&quot;true&quot;</span><span class="p">},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;fp_id&quot;</span><span class="p">:</span> <span class="n">fp_id</span><span class="p">}}</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">fp_exists</span><span class="p">:</span>
                            <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;created&quot;</span><span class="p">:</span> <span class="s2">&quot;already exists&quot;</span><span class="p">},</span> <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;fp_id&quot;</span><span class="p">:</span> <span class="n">fp_id</span><span class="p">}}</span>
                    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">200</span>

            <span class="c1"># @added 20200731 - Feature #3654: IONOSPHERE_GRAPHITE_NOW_GRAPHS_OVERRIDE</span>
            <span class="n">graphite_now_graphs_title</span> <span class="o">=</span> <span class="s1">&#39;NOW&#39;</span>
            <span class="k">if</span> <span class="n">IONOSPHERE_GRAPHITE_NOW_GRAPHS_OVERRIDE</span><span class="p">:</span>
                <span class="n">graphite_now_graphs_title</span> <span class="o">=</span> <span class="s1">&#39;THEN&#39;</span>

            <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span>
                <span class="s1">&#39;ionosphere.html&#39;</span><span class="p">,</span> <span class="n">timestamp</span><span class="o">=</span><span class="n">requested_timestamp</span><span class="p">,</span>
                <span class="n">for_metric</span><span class="o">=</span><span class="n">base_name</span><span class="p">,</span> <span class="n">metric_vars</span><span class="o">=</span><span class="n">m_vars</span><span class="p">,</span> <span class="n">metric_files</span><span class="o">=</span><span class="n">mpaths</span><span class="p">,</span>
                <span class="n">metric_images</span><span class="o">=</span><span class="n">sorted_images</span><span class="p">,</span> <span class="n">human_date</span><span class="o">=</span><span class="n">hdate</span><span class="p">,</span> <span class="n">timeseries</span><span class="o">=</span><span class="n">ts_json</span><span class="p">,</span>
                <span class="n">data_ok</span><span class="o">=</span><span class="n">data_to_process</span><span class="p">,</span> <span class="n">td_files</span><span class="o">=</span><span class="n">mpaths</span><span class="p">,</span>
                <span class="n">panorama_anomaly_id</span><span class="o">=</span><span class="n">p_id</span><span class="p">,</span> <span class="n">graphite_url</span><span class="o">=</span><span class="n">graph_url</span><span class="p">,</span>
                <span class="n">extracted_features</span><span class="o">=</span><span class="n">features</span><span class="p">,</span> <span class="n">calc_time</span><span class="o">=</span><span class="n">f_calc</span><span class="p">,</span>
                <span class="n">features_profile_id</span><span class="o">=</span><span class="n">fp_id</span><span class="p">,</span> <span class="n">features_profile_exists</span><span class="o">=</span><span class="n">fp_exists</span><span class="p">,</span>
                <span class="n">fp_view</span><span class="o">=</span><span class="n">fp_view_on</span><span class="p">,</span> <span class="n">features_profile_details</span><span class="o">=</span><span class="n">fp_details</span><span class="p">,</span>
                <span class="n">redis_full_duration</span><span class="o">=</span><span class="n">full_duration</span><span class="p">,</span>
                <span class="n">redis_full_duration_in_hours</span><span class="o">=</span><span class="n">full_duration_in_hours</span><span class="p">,</span>
                <span class="n">metric_full_duration</span><span class="o">=</span><span class="n">m_full_duration</span><span class="p">,</span>
                <span class="n">metric_full_duration_in_hours</span><span class="o">=</span><span class="n">m_full_duration_in_hours</span><span class="p">,</span>
                <span class="n">metric_second_order_resolution_hours</span><span class="o">=</span><span class="n">second_order_resolution_hours</span><span class="p">,</span>
                <span class="n">tsfresh_version</span><span class="o">=</span><span class="n">TSFRESH_VERSION</span><span class="p">,</span> <span class="n">graphite_now_images</span><span class="o">=</span><span class="n">gimages</span><span class="p">,</span>
                <span class="n">graphite_matched_images</span><span class="o">=</span><span class="n">gmimages</span><span class="p">,</span> <span class="n">matched_count</span><span class="o">=</span><span class="n">times_matched</span><span class="p">,</span>
                <span class="n">parent_id</span><span class="o">=</span><span class="n">par_id</span><span class="p">,</span> <span class="n">generation</span><span class="o">=</span><span class="n">gen</span><span class="p">,</span> <span class="n">learn</span><span class="o">=</span><span class="n">fp_learn</span><span class="p">,</span>
                <span class="n">use_full_duration_days</span><span class="o">=</span><span class="n">fp_fd_days</span><span class="p">,</span> <span class="n">countdown</span><span class="o">=</span><span class="n">countdown_to</span><span class="p">,</span>
                <span class="n">ionosphere_metric</span><span class="o">=</span><span class="n">iono_metric</span><span class="p">,</span> <span class="n">value_condition_list</span><span class="o">=</span><span class="n">vconds</span><span class="p">,</span>
                <span class="n">criteria_types</span><span class="o">=</span><span class="n">crit_types</span><span class="p">,</span> <span class="n">fp_layer</span><span class="o">=</span><span class="n">fp_layers</span><span class="p">,</span>
                <span class="n">layer_id</span><span class="o">=</span><span class="n">l_id</span><span class="p">,</span> <span class="n">layers_algorithms</span><span class="o">=</span><span class="n">new_l_algos</span><span class="p">,</span>
                <span class="n">layers_algorithms_ids</span><span class="o">=</span><span class="n">new_l_algos_ids</span><span class="p">,</span>
                <span class="n">layer_details</span><span class="o">=</span><span class="n">l_details</span><span class="p">,</span>
                <span class="n">layer_details_object</span><span class="o">=</span><span class="n">l_details_object</span><span class="p">,</span>
                <span class="n">layer_algorithms_details</span><span class="o">=</span><span class="n">la_details</span><span class="p">,</span>
                <span class="n">existing_layers</span><span class="o">=</span><span class="n">metric_layers_details</span><span class="p">,</span>
                <span class="n">existing_algorithms</span><span class="o">=</span><span class="n">metric_layers_algorithm_details</span><span class="p">,</span>
                <span class="n">metric_layers_count</span><span class="o">=</span><span class="n">metric_lc</span><span class="p">,</span>
                <span class="n">metric_layers_matched_count</span><span class="o">=</span><span class="n">metric_lmc</span><span class="p">,</span>
                <span class="n">graphite_layers_matched_images</span><span class="o">=</span><span class="n">glm_images</span><span class="p">,</span>
                <span class="n">layers_id_matched</span><span class="o">=</span><span class="n">l_id_matched</span><span class="p">,</span> <span class="n">ts_full_duration</span><span class="o">=</span><span class="n">ts_fd</span><span class="p">,</span>
                <span class="n">app_context</span><span class="o">=</span><span class="n">m_app_context</span><span class="p">,</span> <span class="n">ionosphere_json</span><span class="o">=</span><span class="n">i_ts_json</span><span class="p">,</span>
                <span class="n">baseline_fd</span><span class="o">=</span><span class="n">full_duration</span><span class="p">,</span> <span class="n">last_ts_json</span><span class="o">=</span><span class="n">sample_ts_json</span><span class="p">,</span>
                <span class="n">last_i_ts_json</span><span class="o">=</span><span class="n">sample_i_ts_json</span><span class="p">,</span> <span class="n">layers_updated</span><span class="o">=</span><span class="n">layers_updated</span><span class="p">,</span>
                <span class="n">fp_id_matched</span><span class="o">=</span><span class="n">f_id_matched</span><span class="p">,</span> <span class="n">fp_id_created</span><span class="o">=</span><span class="n">f_id_created</span><span class="p">,</span>
                <span class="n">fp_generation</span><span class="o">=</span><span class="n">fp_generation_created</span><span class="p">,</span> <span class="n">validated</span><span class="o">=</span><span class="n">fp_validated</span><span class="p">,</span>
                <span class="n">validated_fp_successful</span><span class="o">=</span><span class="n">validated_fp_success</span><span class="p">,</span>
                <span class="n">profile_layer_algorithms</span><span class="o">=</span><span class="n">fp_layer_algorithms</span><span class="p">,</span>
                <span class="n">current_layer</span><span class="o">=</span><span class="n">fp_current_layer</span><span class="p">,</span>
                <span class="n">save_metric_td</span><span class="o">=</span><span class="n">save_training_data</span><span class="p">,</span>
                <span class="n">saved_metric_td_label</span><span class="o">=</span><span class="n">saved_td_label</span><span class="p">,</span>
                <span class="n">saved_metric_td</span><span class="o">=</span><span class="n">saved_training_data</span><span class="p">,</span>
                <span class="n">metric_training_data_saved</span><span class="o">=</span><span class="n">training_data_saved</span><span class="p">,</span>
                <span class="n">saved_metric_td_requested</span><span class="o">=</span><span class="n">saved_td_requested</span><span class="p">,</span>
                <span class="n">saved_metric_td_details</span><span class="o">=</span><span class="n">saved_td_details</span><span class="p">,</span>
                <span class="n">profile_enabled</span><span class="o">=</span><span class="n">fp_enabled</span><span class="p">,</span> <span class="n">disable_feature_profile</span><span class="o">=</span><span class="n">disable_fp</span><span class="p">,</span>
                <span class="n">disabled_fp_successful</span><span class="o">=</span><span class="n">disabled_fp_success</span><span class="p">,</span>
                <span class="n">family_tree_ids</span><span class="o">=</span><span class="n">family_tree_fp_ids</span><span class="p">,</span>
                <span class="n">matched_fp_id</span><span class="o">=</span><span class="n">matched_fp_id</span><span class="p">,</span> <span class="n">matched_layer_id</span><span class="o">=</span><span class="n">matched_layer_id</span><span class="p">,</span>
                <span class="n">matched_id_resources</span><span class="o">=</span><span class="n">matched_id_resources</span><span class="p">,</span>
                <span class="n">matched_graph_image_file</span><span class="o">=</span><span class="n">matched_graph_image_file</span><span class="p">,</span>
                <span class="c1"># @added 20180620 - Feature #2404: Ionosphere - fluid approximation</span>
                <span class="c1"># Added minmax scaling</span>
                <span class="n">minmax</span><span class="o">=</span><span class="n">minmax</span><span class="p">,</span>
                <span class="n">correlations</span><span class="o">=</span><span class="n">correlations</span><span class="p">,</span>
                <span class="c1"># @added 20180723 - Feature #2470: Correlations Graphite graph links</span>
                <span class="c1">#                   Branch #2270: luminosity</span>
                <span class="c1"># Added Graphite graph links to the Correlations block in</span>
                <span class="c1"># the correlations.html and training_data.html templates</span>
                <span class="n">correlations_with_graph_links</span><span class="o">=</span><span class="n">correlations_with_graph_links</span><span class="p">,</span>
                <span class="n">matched_from_datetime</span><span class="o">=</span><span class="n">matched_from_datetime</span><span class="p">,</span>
                <span class="c1"># @added 20180921 - Feature #2558: Ionosphere - fluid approximation - approximately_close on layers</span>
                <span class="n">approx_close</span><span class="o">=</span><span class="n">approx_close</span><span class="p">,</span>
                <span class="c1"># @added 20190328 - Feature #2484: FULL_DURATION feature profiles</span>
                <span class="c1"># Added ionosphere_echo</span>
                <span class="n">echo_fp</span><span class="o">=</span><span class="n">echo_fp_value</span><span class="p">,</span> <span class="n">echo_human_date</span><span class="o">=</span><span class="n">echo_hdate</span><span class="p">,</span>
                <span class="n">metric_full_duration_in_hours_image_str</span><span class="o">=</span><span class="n">m_fd_in_hours_img_str</span><span class="p">,</span>
                <span class="c1"># @added 20190510 - Feature #2990: Add metrics id to relevant web pages</span>
                <span class="n">metric_id</span><span class="o">=</span><span class="n">metric_id</span><span class="p">,</span>
                <span class="c1"># @added 20190601 - Feature #3084: Ionosphere - validated matches</span>
                <span class="n">match_validated</span><span class="o">=</span><span class="n">match_validated</span><span class="p">,</span>
                <span class="n">match_validated_db_value</span><span class="o">=</span><span class="n">match_validated_db_value</span><span class="p">,</span>
                <span class="n">validated_match_successful</span><span class="o">=</span><span class="n">validated_match_successful</span><span class="p">,</span>
                <span class="c1"># @added 20190922 - Feature #2516: Add label to features profile</span>
                <span class="n">fp_label</span><span class="o">=</span><span class="n">fp_label</span><span class="p">,</span>
                <span class="c1"># @added 20200113 - Feature #3390: luminosity related anomalies</span>
                <span class="c1">#                   Branch #2270: luminosity</span>
                <span class="n">related</span><span class="o">=</span><span class="n">related</span><span class="p">,</span> <span class="n">related_with_graph_links</span><span class="o">=</span><span class="n">related_with_graph_links</span><span class="p">,</span>
                <span class="n">related_matches</span><span class="o">=</span><span class="n">related_matches</span><span class="p">,</span>
                <span class="c1"># @added 20200711 - Feature #3634: webapp - ionosphere - report number of data points</span>
                <span class="n">ts_json_length</span><span class="o">=</span><span class="n">ts_json_length</span><span class="p">,</span>
                <span class="n">anomalous_timeseries_length</span><span class="o">=</span><span class="n">anomalous_timeseries_length</span><span class="p">,</span>
                <span class="c1"># @added 20200731 - Feature #3654: IONOSPHERE_GRAPHITE_NOW_GRAPHS_OVERRIDE</span>
                <span class="n">graphite_now_graphs_title</span><span class="o">=</span><span class="n">graphite_now_graphs_title</span><span class="p">,</span>
                <span class="c1"># @added 20200808 - Feature #3568: Ionosphere - report anomalies in training period</span>
                <span class="n">labelled_anomalies</span><span class="o">=</span><span class="n">labelled_anomalies</span><span class="p">,</span>
                <span class="n">version</span><span class="o">=</span><span class="n">skyline_version</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">),</span>
                <span class="n">print_debug</span><span class="o">=</span><span class="n">debug_on</span><span class="p">),</span> <span class="mi">200</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Uh oh ... a Skyline 500 :(&#39;</span>
            <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Unknown request&#39;</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span>
            <span class="s1">&#39;ionosphere.html&#39;</span><span class="p">,</span> <span class="n">display_message</span><span class="o">=</span><span class="n">message</span><span class="p">,</span>
            <span class="n">version</span><span class="o">=</span><span class="n">skyline_version</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">),</span>
            <span class="n">print_debug</span><span class="o">=</span><span class="n">debug_on</span><span class="p">),</span> <span class="mi">200</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Uh oh ... a Skyline 500 :(&#39;</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span></div>


<div class="viewcode-block" id="ionosphere_images"><a class="viewcode-back" href="../../skyline.webapp.html#webapp.webapp.ionosphere_images">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/ionosphere_images&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">ionosphere_images</span><span class="p">():</span>

    <span class="n">request_args_present</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">request_args_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
        <span class="n">request_args_present</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">request_args_len</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: request arguments have no length - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">request_args_len</span><span class="p">))</span>

    <span class="n">IONOSPHERE_REQUEST_ARGS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">request_args_present</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">IONOSPHERE_REQUEST_ARGS</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: invalid request argument - </span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)))</span>
                <span class="c1"># @modified 20190524 - Branch #3002: docker</span>
                <span class="c1"># Return data</span>
                <span class="c1"># return &#39;Bad Request&#39;, 400</span>
                <span class="n">error_string</span> <span class="o">=</span> <span class="s1">&#39;error :: invalid request argument - </span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_string</span><span class="p">)</span>
                <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                    <span class="p">{</span><span class="s1">&#39;400 Bad Request&#39;</span><span class="p">:</span> <span class="n">error_string</span><span class="p">})</span>
                <span class="k">return</span> <span class="n">flask_escape</span><span class="p">(</span><span class="n">resp</span><span class="p">),</span> <span class="mi">400</span>

            <span class="n">value</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;request argument - </span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>

            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;image&#39;</span><span class="p">:</span>
                <span class="n">filename</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">send_file</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">mimetype</span><span class="o">=</span><span class="s1">&#39;image/png&#39;</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Uh oh ... a Skyline 500 :( - could not return </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">filename</span>
                        <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                        <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">image_404_path</span> <span class="o">=</span> <span class="s1">&#39;webapp/static/images/skyline.ionosphere.image.404.png&#39;</span>
                    <span class="n">filename</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span>
                        <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">),</span> <span class="s1">&#39;..&#39;</span><span class="p">,</span> <span class="n">image_404_path</span><span class="p">))</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">send_file</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">mimetype</span><span class="o">=</span><span class="s1">&#39;image/png&#39;</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Uh oh ... a Skyline 500 :( - could not return </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">filename</span>
                        <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                        <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

    <span class="k">return</span> <span class="s1">&#39;Bad Request&#39;</span><span class="p">,</span> <span class="mi">400</span></div>


<span class="c1"># @added 20170102 - Feature #1838: utilites - ALERTS matcher</span>
<span class="c1">#                   Branch #922: ionosphere</span>
<span class="c1">#                   Task #1658: Patterning Skyline Ionosphere</span>
<span class="c1"># Added utilities TODO</span>
<div class="viewcode-block" id="utilities"><a class="viewcode-back" href="../../skyline.webapp.html#webapp.webapp.utilities">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/utilities&quot;</span><span class="p">)</span>
<span class="nd">@requires_auth</span>
<span class="k">def</span> <span class="nf">utilities</span><span class="p">():</span>
    <span class="c1"># start = time.time()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;utilities.html&#39;</span><span class="p">),</span> <span class="mi">200</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">error_string</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to render utilities.html: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">error_string</span><span class="p">))</span>
        <span class="k">return</span> <span class="s1">&#39;Uh oh ... a Skyline 500 :(&#39;</span><span class="p">,</span> <span class="mi">500</span></div>


<span class="c1"># @added 20200516 - Feature #3538: webapp - upload_data endpoint</span>
<span class="c1">#                   Feature #3550: flux.uploaded_data_worker</span>
<div class="viewcode-block" id="flux_frontend"><a class="viewcode-back" href="../../skyline.webapp.html#webapp.webapp.flux_frontend">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/flux_frontend&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="nd">@requires_auth</span>
<span class="k">def</span> <span class="nf">flux_frontend</span><span class="p">():</span>
    <span class="n">debug_on</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># file_uploads_enabled = True</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/flux_frontend request&#39;</span><span class="p">)</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">request_args_len</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">request_args_len</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">FLUX_UPLOAD_DATA_REQUEST_ARGS</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;parent_metric_namespace&#39;</span><span class="p">,</span> <span class="s1">&#39;data_file_uploaded&#39;</span><span class="p">,</span> <span class="s1">&#39;info_file_uploaded&#39;</span><span class="p">,</span>
        <span class="s1">&#39;upload_id&#39;</span><span class="p">,</span> <span class="s1">&#39;upload_id_key&#39;</span>
    <span class="p">]</span>

    <span class="n">parent_metric_namespace</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">data_file_uploaded</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">info_file_uploaded</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">upload_id</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">upload_id_key</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">request_arguments</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="n">request_args_len</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">key</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">FLUX_UPLOAD_DATA_REQUEST_ARGS</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: invalid request argument - </span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)))</span>
                <span class="n">error_string</span> <span class="o">=</span> <span class="s1">&#39;error :: invalid request argument - </span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_string</span><span class="p">)</span>
                <span class="n">resp</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span>
                    <span class="p">{</span><span class="s1">&#39;400 Bad Request&#39;</span><span class="p">:</span> <span class="n">error_string</span><span class="p">})</span>
                <span class="k">return</span> <span class="n">flask_escape</span><span class="p">(</span><span class="n">resp</span><span class="p">),</span> <span class="mi">400</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">request_arguments</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">])</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;request argument - </span><span class="si">%s</span><span class="s1">=</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)))</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;parent_metric_namespace&#39;</span><span class="p">:</span>
                <span class="n">parent_metric_namespace</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;data_file_uploaded&#39;</span><span class="p">:</span>
                <span class="n">data_file_uploaded</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;info_file_uploaded&#39;</span><span class="p">:</span>
                <span class="n">info_file_uploaded</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;upload_id&#39;</span><span class="p">:</span>
                <span class="n">upload_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s1">&#39;upload_id_key&#39;</span><span class="p">:</span>
                <span class="n">upload_id_key</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">upload_id_key</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">upload_id</span><span class="p">:</span>
            <span class="n">upload_id_key</span> <span class="o">=</span> <span class="n">upload_id</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">)</span>

    <span class="c1"># To enable uplaods via the webapp Flux endpoint using the</span>
    <span class="c1"># settings.FLUX_SELF_API_KEY a shortlived FLUX_UPLOADS_KEYS is created in</span>
    <span class="c1"># in Redis and passed the the upload_data template to submit as the key</span>
    <span class="n">temporary_key</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
    <span class="n">redis_temporary_upload_key</span> <span class="o">=</span> <span class="s1">&#39;flux.tmp.temporary_upload_key.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">temporary_key</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span><span class="n">redis_temporary_upload_key</span><span class="p">,</span> <span class="mi">600</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">temporary_key</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;added Redis key </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">redis_temporary_upload_key</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
        <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;could not add Redis key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">redis_temporary_upload_key</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">message</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span>
            <span class="s1">&#39;flux_frontend.html&#39;</span><span class="p">,</span> <span class="n">upload_data_enabled</span><span class="o">=</span><span class="n">file_uploads_enabled</span><span class="p">,</span>
            <span class="n">parent_metric_namespace</span><span class="o">=</span><span class="n">parent_metric_namespace</span><span class="p">,</span>
            <span class="n">data_file_uploaded</span><span class="o">=</span><span class="n">data_file_uploaded</span><span class="p">,</span>
            <span class="n">info_file_uploaded</span><span class="o">=</span><span class="n">info_file_uploaded</span><span class="p">,</span>
            <span class="n">upload_id</span><span class="o">=</span><span class="n">upload_id</span><span class="p">,</span> <span class="n">upload_id_key</span><span class="o">=</span><span class="n">upload_id_key</span><span class="p">,</span>
            <span class="n">temporary_upload_key</span><span class="o">=</span><span class="n">temporary_key</span><span class="p">,</span>
            <span class="n">flux_identifier</span><span class="o">=</span><span class="n">temporary_key</span><span class="p">,</span>
            <span class="n">version</span><span class="o">=</span><span class="n">skyline_version</span><span class="p">,</span> <span class="n">duration</span><span class="o">=</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">),</span>
            <span class="n">print_debug</span><span class="o">=</span><span class="n">debug_on</span><span class="p">),</span> <span class="mi">200</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Uh oh ... a Skyline 500 :(&#39;</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span></div>


<span class="c1"># @added 20200514 - Feature #3538: webapp - upload_data endpoint</span>
<span class="c1">#                   Feature #3550: flux.uploaded_data_worker</span>
<div class="viewcode-block" id="upload_data"><a class="viewcode-back" href="../../skyline.webapp.html#webapp.webapp.upload_data">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/upload_data&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">upload_data</span><span class="p">():</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;/upload_data request&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">file_uploads_enabled</span><span class="p">:</span>
        <span class="k">return</span> <span class="s1">&#39;Not Found&#39;</span><span class="p">,</span> <span class="mi">404</span>

    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="n">api_key</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">parent_metric_namespace</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">timezone</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="nb">format</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">archive</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">data_file</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">info_file</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">info_file_in_archive</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">date_orientation</span> <span class="o">=</span> <span class="s1">&#39;rows&#39;</span>
    <span class="n">skip_rows</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">header_row</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">columns_to_ignore</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">columns_to_process</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">resample_method</span> <span class="o">=</span> <span class="s1">&#39;mean&#39;</span>
    <span class="n">json_response</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">flux_identifier</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1"># @added 20200521 - Feature #3538: webapp - upload_data endpoint</span>
    <span class="c1">#                   Feature #3550: flux.uploaded_data_worker</span>
    <span class="c1"># Added the ability to ignore_submitted_timestamps and not</span>
    <span class="c1"># check flux.last metric timestamp</span>
    <span class="n">ignore_submitted_timestamps</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">upload_id</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">!=</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: not a POST requests, returning 400&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="s1">&#39;Method Not Allowed&#39;</span><span class="p">,</span> <span class="mi">405</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;handling upload_data POST request&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;json_response&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">:</span>
            <span class="n">json_response</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;json_response&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">json_response</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                <span class="n">json_response</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;handling upload_data POST with variable json_response - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">json_response</span><span class="p">))</span>

        <span class="c1"># If there is no key a 401 is returned with no info</span>
        <span class="k">if</span> <span class="s1">&#39;key&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">:</span>
            <span class="n">error_string</span> <span class="o">=</span> <span class="s1">&#39;no key in the POST variables&#39;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: &#39;</span> <span class="o">+</span> <span class="n">error_string</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;Unauthorized&#39;</span><span class="p">,</span> <span class="mi">401</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">api_key</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">])</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;handling upload_data POST request with key - </span><span class="si">%s</span><span class="s1">, using as api_key&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">api_key</span><span class="p">))</span>

        <span class="c1"># Do not process requests that do not come from the Flux frontend if</span>
        <span class="c1"># they do not have json_response set.</span>
        <span class="k">if</span> <span class="s1">&#39;flux_identifier&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">json_response</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;Bad Request&#39;</span><span class="p">,</span> <span class="mi">400</span>
        <span class="n">flux_frontend_request</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="s1">&#39;flux_identifier&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">:</span>
            <span class="n">flux_identifier</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;flux_identifier&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">flux_identifier</span><span class="p">:</span>
                <span class="n">flux_identifier_key</span> <span class="o">=</span> <span class="s1">&#39;flux.tmp.temporary_upload_key.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">flux_identifier</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">flux_frontend_request</span> <span class="o">=</span> <span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">flux_identifier_key</span><span class="p">)</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;could query Redis for flux_identifier_key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">flux_identifier_key</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">message</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">flux_frontend_request</span><span class="p">:</span>
                <span class="n">error_string</span> <span class="o">=</span> <span class="s1">&#39;flux_identifier has expired or is not valid, please reload the Flux page&#39;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;flux_identifier - </span><span class="si">%s</span><span class="s1"> - has expired or is not valid, returning 400&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">flux_identifier</span><span class="p">))</span>
                <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">error_string</span><span class="p">},</span>
                             <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span>
                                 <span class="s2">&quot;upload&quot;</span><span class="p">:</span> <span class="s2">&quot;failed&quot;</span><span class="p">}}</span>
                <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">400</span>

        <span class="n">required_post_variables</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;parent_metric_namespace&#39;</span><span class="p">,</span> <span class="s1">&#39;timezone&#39;</span><span class="p">,</span> <span class="s1">&#39;format&#39;</span><span class="p">,</span> <span class="s1">&#39;archive&#39;</span><span class="p">,</span>
            <span class="s1">&#39;date_orientation&#39;</span><span class="p">,</span> <span class="s1">&#39;header_row&#39;</span><span class="p">,</span> <span class="s1">&#39;columns_to_metrics&#39;</span><span class="p">,</span>
            <span class="s1">&#39;info_file_in_archive&#39;</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">r_var</span> <span class="ow">in</span> <span class="n">required_post_variables</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">r_var</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">:</span>
                <span class="n">error_string</span> <span class="o">=</span> <span class="s1">&#39;no </span><span class="si">%s</span><span class="s1"> in the POST variables&#39;</span> <span class="o">%</span> <span class="n">r_var</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: &#39;</span> <span class="o">+</span> <span class="n">error_string</span><span class="p">)</span>
                <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">error_string</span><span class="p">},</span>
                             <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span>
                                 <span class="s2">&quot;upload&quot;</span><span class="p">:</span> <span class="s2">&quot;failed&quot;</span><span class="p">}}</span>
                <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">400</span>
        <span class="n">return_400</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">parent_metric_namespace</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;parent_metric_namespace&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">parent_metric_namespace</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">error_string</span> <span class="o">=</span> <span class="s1">&#39;blank parent_metric_namespace variable passed&#39;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: &#39;</span> <span class="o">+</span> <span class="n">error_string</span><span class="p">)</span>
            <span class="n">return_400</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="n">known_key</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">flux_upload_keys</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">parent_metric_namespace_key</span> <span class="o">=</span> <span class="n">flux_upload_keys</span><span class="p">[</span><span class="n">parent_metric_namespace</span><span class="p">]</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;a key found for </span><span class="si">%s</span><span class="s1"> in flux_upload_keys&#39;</span> <span class="o">%</span> <span class="n">parent_metric_namespace</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">parent_metric_namespace_key</span> <span class="o">==</span> <span class="n">api_key</span><span class="p">:</span>
                    <span class="n">known_key</span> <span class="o">=</span> <span class="n">api_key</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;the key matches the key found for </span><span class="si">%s</span><span class="s1"> in flux_upload_keys&#39;</span> <span class="o">%</span> <span class="n">parent_metric_namespace</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;the key variable passed does not match the key found for </span><span class="si">%s</span><span class="s1"> in flux_upload_keys&#39;</span> <span class="o">%</span> <span class="n">parent_metric_namespace</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;no known key found for </span><span class="si">%s</span><span class="s1"> in flux_upload_keys&#39;</span> <span class="o">%</span> <span class="n">parent_metric_namespace</span><span class="p">)</span>
                <span class="n">known_key</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">known_key</span><span class="p">:</span>
            <span class="n">redis_temporary_upload_key</span> <span class="o">=</span> <span class="s1">&#39;flux.tmp.temporary_upload_key.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">api_key</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">known_key</span> <span class="o">=</span> <span class="n">REDIS_CONN_UNDECODE</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">redis_temporary_upload_key</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;attempt to check </span><span class="si">%s</span><span class="s1"> key in Redis got - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span>
                    <span class="n">redis_temporary_upload_key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">known_key</span><span class="p">)))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: could query Redis for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">redis_temporary_upload_key</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">known_key</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: unknown key passed </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">api_key</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;Unauthorized&#39;</span><span class="p">,</span> <span class="mi">401</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">return_400</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;handling upload_data POST with variable parent_metric_namespace - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">parent_metric_namespace</span><span class="p">))</span>
            <span class="n">timezone</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;timezone&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">timezone</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">error_string</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> is not an accepted timezone&#39;</span> <span class="o">%</span> <span class="n">timezone</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: &#39;</span> <span class="o">+</span> <span class="n">error_string</span><span class="p">)</span>
                <span class="n">return_400</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">return_400</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;handling upload_data POST with variable timezone - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">timezone</span><span class="p">))</span>
            <span class="nb">format</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;format&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="nb">format</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ALLOWED_FORMATS</span><span class="p">:</span>
                <span class="n">error_string</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> is not an accepted format&#39;</span> <span class="o">%</span> <span class="nb">format</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: &#39;</span> <span class="o">+</span> <span class="n">error_string</span><span class="p">)</span>
                <span class="n">return_400</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">return_400</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;handling upload_data POST with variable format - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="nb">format</span><span class="p">))</span>
            <span class="n">archive</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;archive&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">archive</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ALLOWED_ARCHIVES</span><span class="p">:</span>
                <span class="n">error_string</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> is not an accepted archive type&#39;</span> <span class="o">%</span> <span class="n">archive</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: &#39;</span> <span class="o">+</span> <span class="n">error_string</span><span class="p">)</span>
                <span class="n">return_400</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">return_400</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;handling upload_data POST with variable archive - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">archive</span><span class="p">))</span>
            <span class="n">date_orientation</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;date_orientation&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">date_orientation</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;rows&#39;</span><span class="p">,</span> <span class="s1">&#39;columns&#39;</span><span class="p">]:</span>
                <span class="n">error_string</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> is not a valid date_orientation&#39;</span> <span class="o">%</span> <span class="n">date_orientation</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: &#39;</span> <span class="o">+</span> <span class="n">error_string</span><span class="p">)</span>
                <span class="n">return_400</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">return_400</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;handling upload_data POST with variable date_orientation - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">date_orientation</span><span class="p">))</span>
            <span class="n">header_row_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;header_row&#39;</span><span class="p">])</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">header_row</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">header_row_str</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">error_string</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> is not a valid header_row&#39;</span> <span class="o">%</span> <span class="n">header_row_str</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: &#39;</span> <span class="o">+</span> <span class="n">error_string</span><span class="p">)</span>
                <span class="n">return_400</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">return_400</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;handling upload_data POST with variable header_row - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">header_row</span><span class="p">))</span>
            <span class="n">columns_to_metrics</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;columns_to_metrics&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">return_400</span><span class="p">:</span>
            <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">error_string</span><span class="p">},</span>
                         <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span>
                             <span class="s2">&quot;upload&quot;</span><span class="p">:</span> <span class="s2">&quot;failed&quot;</span><span class="p">}}</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">400</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;handling upload_data POST with variable columns_to_metrics - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">columns_to_metrics</span><span class="p">))</span>
        <span class="n">info_file_in_archive_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;info_file_in_archive&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">info_file_in_archive_str</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
            <span class="n">info_file_in_archive</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;handling upload_data POST with variable info_file_in_archive - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">info_file_in_archive</span><span class="p">))</span>

        <span class="n">info_filename</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">data_filename</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># Check if the POST request has the data_file part</span>
        <span class="n">no_data_file</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="s1">&#39;data_file&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">files</span><span class="p">:</span>
            <span class="n">no_data_file</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">error_string</span> <span class="o">=</span> <span class="s1">&#39;error :: no data_file in the POST&#39;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_string</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;data_file&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">files</span><span class="p">:</span>
            <span class="n">data_file</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;data_file&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">data_file</span><span class="o">.</span><span class="n">filename</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">error_string</span> <span class="o">=</span> <span class="s1">&#39;error :: blank data_file variable&#39;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">error_string</span><span class="p">)</span>
                <span class="n">no_data_file</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">no_data_file</span><span class="p">:</span>
            <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">error_string</span><span class="p">},</span>
                         <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span>
                             <span class="s2">&quot;upload&quot;</span><span class="p">:</span> <span class="s2">&quot;failed&quot;</span><span class="p">}}</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">400</span>

        <span class="n">create_info_file</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">info_file_dict</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="s1">&#39;skip_rows&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;skip_rows&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;none&#39;</span><span class="p">:</span>
                <span class="n">skip_rows</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">skip_rows</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;skip_rows&#39;</span><span class="p">])</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">error_string</span> <span class="o">=</span> <span class="s1">&#39;skip_row must be none or int&#39;</span>
                    <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">error_string</span><span class="p">},</span>
                                 <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span>
                                     <span class="s2">&quot;upload&quot;</span><span class="p">:</span> <span class="s2">&quot;failed&quot;</span><span class="p">}}</span>
                    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">400</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;handling upload_data POST with variable skip_rows - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">skip_rows</span><span class="p">))</span>
        <span class="k">if</span> <span class="s1">&#39;columns_to_ignore&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">:</span>
            <span class="n">columns_to_ignore</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;columns_to_ignore&#39;</span><span class="p">])</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;handling upload_data POST with variable columns_to_ignore - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">columns_to_ignore</span><span class="p">))</span>
        <span class="k">if</span> <span class="s1">&#39;columns_to_process&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">:</span>
            <span class="n">columns_to_process</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;columns_to_process&#39;</span><span class="p">])</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;handling upload_data POST with variable columns_to_process - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">columns_to_process</span><span class="p">))</span>
        <span class="n">resample_method</span> <span class="o">=</span> <span class="s1">&#39;mean&#39;</span>
        <span class="k">if</span> <span class="s1">&#39;resample_method&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">:</span>
            <span class="n">resample_method_str</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;resample_method&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">resample_method_str</span> <span class="o">==</span> <span class="s1">&#39;sum&#39;</span><span class="p">:</span>
                <span class="n">resample_method</span> <span class="o">=</span> <span class="s1">&#39;sum&#39;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;handling upload_data POST with variable columns_to_process - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">columns_to_process</span><span class="p">))</span>
        <span class="c1"># @added 20200521 - Feature #3538: webapp - upload_data endpoint</span>
        <span class="c1">#                   Feature #3550: flux.uploaded_data_worker</span>
        <span class="c1"># Added the ability to ignore_submitted_timestamps and not</span>
        <span class="c1"># check flux.last metric timestamp</span>
        <span class="k">if</span> <span class="s1">&#39;ignore_submitted_timestamps&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">:</span>
            <span class="n">ignore_submitted_timestamps_str</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;ignore_submitted_timestamps&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">ignore_submitted_timestamps_str</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
                <span class="n">ignore_submitted_timestamps</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;handling upload_data POST with variable json_response - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">json_response</span><span class="p">))</span>

        <span class="k">if</span> <span class="s1">&#39;info_file&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">files</span><span class="p">:</span>
            <span class="n">create_info_file</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="s1">&#39;info_file&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">files</span><span class="p">:</span>
            <span class="n">info_file</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;info_file&#39;</span><span class="p">]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;handling upload_data POST with variable info_file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">info_file</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">info_file</span><span class="o">.</span><span class="n">filename</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">create_info_file</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">create_info_file</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">create_info_file</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;handling upload_data POST request with no info_file uploaded, attempting to create from variables&#39;</span><span class="p">)</span>
            <span class="n">return_400</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">info_file_dict</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;parent_metric_namespace&quot;</span><span class="p">:</span> <span class="n">parent_metric_namespace</span><span class="p">,</span>
                <span class="s2">&quot;timezone&quot;</span><span class="p">:</span> <span class="n">timezone</span><span class="p">,</span>
                <span class="s2">&quot;archive&quot;</span><span class="p">:</span> <span class="n">archive</span><span class="p">,</span>
                <span class="s2">&quot;skip_rows&quot;</span><span class="p">:</span> <span class="n">skip_rows</span><span class="p">,</span>
                <span class="s2">&quot;header_row&quot;</span><span class="p">:</span> <span class="n">header_row</span><span class="p">,</span>
                <span class="s2">&quot;date_orientation&quot;</span><span class="p">:</span> <span class="n">date_orientation</span><span class="p">,</span>
                <span class="s2">&quot;columns_to_metrics&quot;</span><span class="p">:</span> <span class="n">columns_to_metrics</span><span class="p">,</span>
                <span class="s2">&quot;columns_to_ignore&quot;</span><span class="p">:</span> <span class="n">columns_to_ignore</span><span class="p">,</span>
                <span class="s2">&quot;columns_to_process&quot;</span><span class="p">:</span> <span class="n">columns_to_process</span><span class="p">,</span>
                <span class="s2">&quot;info_file_in_archive&quot;</span><span class="p">:</span> <span class="n">info_file_in_archive</span><span class="p">,</span>
                <span class="s2">&quot;resample_method&quot;</span><span class="p">:</span> <span class="n">resample_method</span><span class="p">,</span>
                <span class="s2">&quot;ignore_submitted_timestamps&quot;</span><span class="p">:</span> <span class="n">ignore_submitted_timestamps</span><span class="p">,</span>
            <span class="p">}</span>

        <span class="n">info_file_saved</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">parent_metric_namespace_dirname</span> <span class="o">=</span> <span class="n">secure_filename</span><span class="p">(</span><span class="n">parent_metric_namespace</span><span class="p">)</span>
        <span class="n">upload_data_dir</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">DATA_UPLOADS_PATH</span><span class="p">,</span> <span class="n">parent_metric_namespace_dirname</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">start</span><span class="p">))</span>
        <span class="n">upload_id</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">parent_metric_namespace_dirname</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">start</span><span class="p">))</span>
        <span class="n">upload_id_key</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">parent_metric_namespace_dirname</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">start</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">create_info_file</span><span class="p">:</span>
            <span class="n">info_file</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s1">&#39;info_file&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">info_file</span> <span class="ow">and</span> <span class="n">allowed_file</span><span class="p">(</span><span class="n">info_file</span><span class="o">.</span><span class="n">filename</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">info_filename</span> <span class="o">=</span> <span class="n">secure_filename</span><span class="p">(</span><span class="n">info_file</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;handling upload_data POST request with info file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">info_filename</span><span class="p">))</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">upload_data_dir</span><span class="p">):</span>
                        <span class="n">mkdir_p</span><span class="p">(</span><span class="n">upload_data_dir</span><span class="p">)</span>
                    <span class="n">info_file</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">upload_data_dir</span><span class="p">,</span> <span class="n">info_filename</span><span class="p">))</span>
                    <span class="n">info_file_saved</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;handling upload_data POST request saved info file - </span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">upload_data_dir</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">info_filename</span><span class="p">)))</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;failed to save info file&#39;</span>
                    <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">json_response</span><span class="p">:</span>
                        <span class="k">return</span> <span class="s1">&#39;Internal Server Error&#39;</span><span class="p">,</span> <span class="mi">500</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

        <span class="n">data_filename</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">data_file</span> <span class="ow">and</span> <span class="n">allowed_file</span><span class="p">(</span><span class="n">data_file</span><span class="o">.</span><span class="n">filename</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">data_filename</span> <span class="o">=</span> <span class="n">secure_filename</span><span class="p">(</span><span class="n">data_file</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;handling upload_data POST request with data file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">data_filename</span><span class="p">))</span>
                <span class="c1"># @modified 20200520 - Bug #3552: flux.uploaded_data_worker - tar.gz</span>
                <span class="c1"># tar.gz needs more work</span>
                <span class="k">if</span> <span class="n">data_filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;tar.gz&#39;</span><span class="p">):</span>
                    <span class="n">error_string</span> <span class="o">=</span> <span class="s1">&#39;error - tar.gz archives are not accepted&#39;</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;tar.gz archives are not accepted - </span><span class="si">%s</span><span class="s1">, returning 400&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">data_file</span><span class="p">))</span>
                    <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="n">error_string</span><span class="p">},</span>
                                 <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span>
                                     <span class="s2">&quot;upload&quot;</span><span class="p">:</span> <span class="s2">&quot;failed&quot;</span><span class="p">}}</span>
                    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">400</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">upload_data_dir</span><span class="p">):</span>
                    <span class="n">mkdir_p</span><span class="p">(</span><span class="n">upload_data_dir</span><span class="p">)</span>
                <span class="n">data_file</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">upload_data_dir</span><span class="p">,</span> <span class="n">data_filename</span><span class="p">))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;handling upload_data POST request saved data file - </span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">upload_data_dir</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">data_filename</span><span class="p">)))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;failed to save data file&#39;</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">message</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">json_response</span><span class="p">:</span>
                    <span class="k">return</span> <span class="s1">&#39;Internal Server Error&#39;</span><span class="p">,</span> <span class="mi">500</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">info_file_dict</span> <span class="ow">and</span> <span class="n">data_filename</span><span class="p">:</span>
            <span class="n">info_filename</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.info.json&#39;</span> <span class="o">%</span> <span class="n">data_filename</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;handling upload_data POST creating info file from POST variables - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">info_filename</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">info_file_in_archive</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;handling upload_data POST request with info_file_in_archive True, but still creating a parent info file from variables&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">upload_data_dir</span><span class="p">):</span>
                <span class="n">mkdir_p</span><span class="p">(</span><span class="n">upload_data_dir</span><span class="p">)</span>
            <span class="n">info_file</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">upload_data_dir</span><span class="p">,</span> <span class="n">info_filename</span><span class="p">)</span>
            <span class="c1"># info_file_data = jsonify(info_file_dict)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">write_data_to_file</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">info_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">info_file_dict</span><span class="p">))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;handling upload_data POST - saved inferred info file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">info_file</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to save inferred info file - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">info_file</span><span class="p">)</span>

        <span class="n">upload_data_dict</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;parent_metric_namespace&quot;</span><span class="p">:</span> <span class="n">parent_metric_namespace</span><span class="p">,</span>
            <span class="s2">&quot;timezone&quot;</span><span class="p">:</span> <span class="n">timezone</span><span class="p">,</span>
            <span class="s2">&quot;upload_id&quot;</span><span class="p">:</span> <span class="n">upload_id</span><span class="p">,</span>
            <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="s1">&#39;pending&#39;</span><span class="p">,</span>
            <span class="s2">&quot;format&quot;</span><span class="p">:</span> <span class="nb">format</span><span class="p">,</span>
            <span class="s2">&quot;archive&quot;</span><span class="p">:</span> <span class="n">archive</span><span class="p">,</span>
            <span class="s2">&quot;data_filename&quot;</span><span class="p">:</span> <span class="n">data_filename</span><span class="p">,</span>
            <span class="s2">&quot;info_filename&quot;</span><span class="p">:</span> <span class="n">info_filename</span><span class="p">,</span>
            <span class="s2">&quot;info_file_in_archive&quot;</span><span class="p">:</span> <span class="n">info_file_in_archive</span><span class="p">,</span>
            <span class="s2">&quot;skip_rows&quot;</span><span class="p">:</span> <span class="n">skip_rows</span><span class="p">,</span>
            <span class="s2">&quot;header_row&quot;</span><span class="p">:</span> <span class="n">header_row</span><span class="p">,</span>
            <span class="s2">&quot;resample_method&quot;</span><span class="p">:</span> <span class="n">resample_method</span><span class="p">,</span>
            <span class="s2">&quot;ignore_submitted_timestamps&quot;</span><span class="p">:</span> <span class="n">ignore_submitted_timestamps</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">sadd</span><span class="p">(</span><span class="s1">&#39;flux.uploaded_data&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">upload_data_dict</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;could not add item to flux.uploaded_data Redis set - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">message</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">json_response</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;Internal Server Error&#39;</span><span class="p">,</span> <span class="mi">500</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

        <span class="n">upload_status_redis_key</span> <span class="o">=</span> <span class="s1">&#39;flux.upload_status.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">upload_id_key</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">REDIS_CONN</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span><span class="n">upload_status_redis_key</span><span class="p">,</span> <span class="mi">2592000</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">upload_data_dict</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;added Redis key </span><span class="si">%s</span><span class="s1"> with new status&#39;</span> <span class="o">%</span> <span class="n">upload_status_redis_key</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;could not add item to flux.uploaded_data Redis set - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">trace</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">message</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">json_response</span><span class="p">:</span>
            <span class="n">data_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">{},</span>
                         <span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span>
                             <span class="s2">&quot;feature maturity&quot;</span><span class="p">:</span> <span class="s2">&quot;EXPERIMENTAL&quot;</span><span class="p">,</span>
                             <span class="s2">&quot;upload&quot;</span><span class="p">:</span> <span class="s2">&quot;successful&quot;</span><span class="p">,</span>
                             <span class="s2">&quot;upload_id&quot;</span><span class="p">:</span> <span class="n">upload_id</span><span class="p">,</span>
                             <span class="s2">&quot;upload_id_key&quot;</span><span class="p">:</span> <span class="n">upload_id_key</span><span class="p">,</span>
                             <span class="s2">&quot;key&quot;</span><span class="p">:</span> <span class="n">api_key</span><span class="p">,</span>
                             <span class="s2">&quot;parent_metric_namespace&quot;</span><span class="p">:</span> <span class="n">parent_metric_namespace</span><span class="p">,</span>
                             <span class="s2">&quot;data file&quot;</span><span class="p">:</span> <span class="n">data_filename</span><span class="p">}}</span>
            <span class="k">if</span> <span class="n">info_file_saved</span><span class="p">:</span>
                <span class="n">data_dict</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">][</span><span class="s1">&#39;info file&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">info_filename</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;responding to upload_data POST request with json response - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">data_dict</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">data_dict</span><span class="p">),</span> <span class="mi">200</span>
        <span class="k">if</span> <span class="n">flux_frontend_request</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;flux_frontend&#39;</span><span class="p">,</span>
                                    <span class="n">parent_metric_namespace</span><span class="o">=</span><span class="n">parent_metric_namespace</span><span class="p">,</span>
                                    <span class="n">data_file_uploaded</span><span class="o">=</span><span class="n">data_filename</span><span class="p">,</span>
                                    <span class="n">info_file_uploaded</span><span class="o">=</span><span class="n">info_filename</span><span class="p">,</span>
                                    <span class="n">upload_id</span><span class="o">=</span><span class="n">upload_id</span><span class="p">,</span>
                                    <span class="n">upload_id_key</span><span class="o">=</span><span class="n">upload_id_key</span><span class="p">))</span>
    <span class="k">return</span> <span class="s1">&#39;Bad Request&#39;</span><span class="p">,</span> <span class="mi">400</span></div>


<span class="c1"># @added 20160703 - Feature #1464: Webapp Redis browser</span>
<span class="c1"># A port of Marian Steinbach&#39;s rebrow - https://github.com/marians/rebrow</span>
<span class="c1"># Description of info keys</span>
<span class="c1"># TODO: to be continued.</span>
<span class="n">serverinfo_meta</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;aof_current_rewrite_time_sec&#39;</span><span class="p">:</span> <span class="s2">&quot;Duration of the on-going &lt;abbr title=&#39;Append-Only File&#39;&gt;AOF&lt;/abbr&gt; rewrite operation if any&quot;</span><span class="p">,</span>
    <span class="s1">&#39;aof_enabled&#39;</span><span class="p">:</span> <span class="s2">&quot;Flag indicating &lt;abbr title=&#39;Append-Only File&#39;&gt;AOF&lt;/abbr&gt; logging is activated&quot;</span><span class="p">,</span>
    <span class="s1">&#39;aof_last_bgrewrite_status&#39;</span><span class="p">:</span> <span class="s2">&quot;Status of the last &lt;abbr title=&#39;Append-Only File&#39;&gt;AOF&lt;/abbr&gt; rewrite operation&quot;</span><span class="p">,</span>
    <span class="s1">&#39;aof_last_rewrite_time_sec&#39;</span><span class="p">:</span> <span class="s2">&quot;Duration of the last &lt;abbr title=&#39;Append-Only File&#39;&gt;AOF&lt;/abbr&gt; rewrite operation in seconds&quot;</span><span class="p">,</span>
    <span class="s1">&#39;aof_last_write_status&#39;</span><span class="p">:</span> <span class="s2">&quot;Status of last &lt;abbr title=&#39;Append-Only File&#39;&gt;AOF&lt;/abbr&gt; write operation&quot;</span><span class="p">,</span>
    <span class="s1">&#39;aof_rewrite_in_progress&#39;</span><span class="p">:</span> <span class="s2">&quot;Flag indicating a &lt;abbr title=&#39;Append-Only File&#39;&gt;AOF&lt;/abbr&gt; rewrite operation is on-going&quot;</span><span class="p">,</span>
    <span class="s1">&#39;aof_rewrite_scheduled&#39;</span><span class="p">:</span> <span class="s2">&quot;Flag indicating an &lt;abbr title=&#39;Append-Only File&#39;&gt;AOF&lt;/abbr&gt; rewrite operation will be scheduled once the on-going RDB save is complete&quot;</span><span class="p">,</span>
    <span class="s1">&#39;arch_bits&#39;</span><span class="p">:</span> <span class="s1">&#39;Architecture (32 or 64 bits)&#39;</span><span class="p">,</span>
    <span class="s1">&#39;blocked_clients&#39;</span><span class="p">:</span> <span class="s1">&#39;Number of clients pending on a blocking call (BLPOP, BRPOP, BRPOPLPUSH)&#39;</span><span class="p">,</span>
    <span class="s1">&#39;client_biggest_input_buf&#39;</span><span class="p">:</span> <span class="s1">&#39;biggest input buffer among current client connections&#39;</span><span class="p">,</span>
    <span class="s1">&#39;client_longest_output_list&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;cmdstat_client&#39;</span><span class="p">:</span> <span class="s1">&#39;Statistics for the client command&#39;</span><span class="p">,</span>
    <span class="s1">&#39;cmdstat_config&#39;</span><span class="p">:</span> <span class="s1">&#39;Statistics for the config command&#39;</span><span class="p">,</span>
    <span class="s1">&#39;cmdstat_dbsize&#39;</span><span class="p">:</span> <span class="s1">&#39;Statistics for the dbsize command&#39;</span><span class="p">,</span>
    <span class="s1">&#39;cmdstat_del&#39;</span><span class="p">:</span> <span class="s1">&#39;Statistics for the del command&#39;</span><span class="p">,</span>
    <span class="s1">&#39;cmdstat_dump&#39;</span><span class="p">:</span> <span class="s1">&#39;Statistics for the dump command&#39;</span><span class="p">,</span>
    <span class="s1">&#39;cmdstat_expire&#39;</span><span class="p">:</span> <span class="s1">&#39;Statistics for the expire command&#39;</span><span class="p">,</span>
    <span class="s1">&#39;cmdstat_flushall&#39;</span><span class="p">:</span> <span class="s1">&#39;Statistics for the flushall command&#39;</span><span class="p">,</span>
    <span class="s1">&#39;cmdstat_get&#39;</span><span class="p">:</span> <span class="s1">&#39;Statistics for the get command&#39;</span><span class="p">,</span>
    <span class="s1">&#39;cmdstat_hgetall&#39;</span><span class="p">:</span> <span class="s1">&#39;Statistics for the hgetall command&#39;</span><span class="p">,</span>
    <span class="s1">&#39;cmdstat_hkeys&#39;</span><span class="p">:</span> <span class="s1">&#39;Statistics for the hkeys command&#39;</span><span class="p">,</span>
    <span class="s1">&#39;cmdstat_hmset&#39;</span><span class="p">:</span> <span class="s1">&#39;Statistics for the hmset command&#39;</span><span class="p">,</span>
    <span class="s1">&#39;cmdstat_info&#39;</span><span class="p">:</span> <span class="s1">&#39;Statistics for the info command&#39;</span><span class="p">,</span>
    <span class="s1">&#39;cmdstat_keys&#39;</span><span class="p">:</span> <span class="s1">&#39;Statistics for the keys command&#39;</span><span class="p">,</span>
    <span class="s1">&#39;cmdstat_llen&#39;</span><span class="p">:</span> <span class="s1">&#39;Statistics for the llen command&#39;</span><span class="p">,</span>
    <span class="s1">&#39;cmdstat_ping&#39;</span><span class="p">:</span> <span class="s1">&#39;Statistics for the ping command&#39;</span><span class="p">,</span>
    <span class="s1">&#39;cmdstat_psubscribe&#39;</span><span class="p">:</span> <span class="s1">&#39;Statistics for the psubscribe command&#39;</span><span class="p">,</span>
    <span class="s1">&#39;cmdstat_pttl&#39;</span><span class="p">:</span> <span class="s1">&#39;Statistics for the pttl command&#39;</span><span class="p">,</span>
    <span class="s1">&#39;cmdstat_sadd&#39;</span><span class="p">:</span> <span class="s1">&#39;Statistics for the sadd command&#39;</span><span class="p">,</span>
    <span class="s1">&#39;cmdstat_scan&#39;</span><span class="p">:</span> <span class="s1">&#39;Statistics for the scan command&#39;</span><span class="p">,</span>
    <span class="s1">&#39;cmdstat_select&#39;</span><span class="p">:</span> <span class="s1">&#39;Statistics for the select command&#39;</span><span class="p">,</span>
    <span class="s1">&#39;cmdstat_set&#39;</span><span class="p">:</span> <span class="s1">&#39;Statistics for the set command&#39;</span><span class="p">,</span>
    <span class="s1">&#39;cmdstat_smembers&#39;</span><span class="p">:</span> <span class="s1">&#39;Statistics for the smembers command&#39;</span><span class="p">,</span>
    <span class="s1">&#39;cmdstat_sscan&#39;</span><span class="p">:</span> <span class="s1">&#39;Statistics for the sscan command&#39;</span><span class="p">,</span>
    <span class="s1">&#39;cmdstat_ttl&#39;</span><span class="p">:</span> <span class="s1">&#39;Statistics for the ttl command&#39;</span><span class="p">,</span>
    <span class="s1">&#39;cmdstat_type&#39;</span><span class="p">:</span> <span class="s1">&#39;Statistics for the type command&#39;</span><span class="p">,</span>
    <span class="s1">&#39;cmdstat_zadd&#39;</span><span class="p">:</span> <span class="s1">&#39;Statistics for the zadd command&#39;</span><span class="p">,</span>
    <span class="s1">&#39;cmdstat_zcard&#39;</span><span class="p">:</span> <span class="s1">&#39;Statistics for the zcard command&#39;</span><span class="p">,</span>
    <span class="s1">&#39;cmdstat_zrange&#39;</span><span class="p">:</span> <span class="s1">&#39;Statistics for the zrange command&#39;</span><span class="p">,</span>
    <span class="s1">&#39;cmdstat_zremrangebyrank&#39;</span><span class="p">:</span> <span class="s1">&#39;Statistics for the zremrangebyrank command&#39;</span><span class="p">,</span>
    <span class="s1">&#39;cmdstat_zrevrange&#39;</span><span class="p">:</span> <span class="s1">&#39;Statistics for the zrevrange command&#39;</span><span class="p">,</span>
    <span class="s1">&#39;cmdstat_zscan&#39;</span><span class="p">:</span> <span class="s1">&#39;Statistics for the zscan command&#39;</span><span class="p">,</span>
    <span class="s1">&#39;config_file&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;connected_clients&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;connected_slaves&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;db0&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;evicted_keys&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;expired_keys&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;gcc_version&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;hz&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;instantaneous_ops_per_sec&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;keyspace_hits&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;keyspace_misses&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;latest_fork_usec&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;loading&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;lru_clock&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;master_repl_offset&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;mem_allocator&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;mem_fragmentation_ratio&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;multiplexing_api&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;os&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;process_id&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;pubsub_channels&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;pubsub_patterns&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;rdb_bgsave_in_progress&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;rdb_changes_since_last_save&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;rdb_current_bgsave_time_sec&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;rdb_last_bgsave_status&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;rdb_last_bgsave_time_sec&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;rdb_last_save_time&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;redis_build_id&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;redis_git_dirty&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;redis_git_sha1&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;redis_mode&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;redis_version&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;rejected_connections&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;repl_backlog_active&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;repl_backlog_first_byte_offset&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;repl_backlog_histlen&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;repl_backlog_size&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;role&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;run_id&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;sync_full&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;sync_partial_err&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;sync_partial_ok&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;tcp_port&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;total_commands_processed&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;total_connections_received&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;uptime_in_days&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;uptime_in_seconds&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;used_cpu_sys&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;used_cpu_sys_children&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;used_cpu_user&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;used_cpu_user_children&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;used_memory&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;used_memory_human&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;used_memory_lua&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;used_memory_peak&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;used_memory_peak_human&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="s1">&#39;used_memory_rss&#39;</span><span class="p">:</span> <span class="kc">None</span>
<span class="p">}</span>


<span class="c1"># @added 20180520 - Feature #2378: Add redis auth to Skyline and rebrow</span>
<span class="c1"># Added auth to rebrow as per https://github.com/marians/rebrow/pull/20 by</span>
<span class="c1"># elky84</span>
<span class="c1"># @modified 20191014 - Bug #3266: py3 Redis binary objects not strings</span>
<span class="c1">#                      Branch #3262: py3</span>
<span class="c1"># def get_redis(host, port, db, password):</span>
<div class="viewcode-block" id="get_redis"><a class="viewcode-back" href="../../skyline.webapp.html#webapp.webapp.get_redis">[docs]</a><span class="k">def</span> <span class="nf">get_redis</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">password</span><span class="p">,</span> <span class="n">decode</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">password</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
        <span class="c1"># @modified 20190517 - Branch #3002: docker</span>
        <span class="c1"># Allow rebrow to connect to Redis on the socket too</span>
        <span class="k">if</span> <span class="n">host</span> <span class="o">==</span> <span class="s1">&#39;unix_socket&#39;</span><span class="p">:</span>
            <span class="c1"># @modified 20191014 - Bug #3266: py3 Redis binary objects not strings</span>
            <span class="c1">#                      Branch #3262: py3</span>
            <span class="c1"># return redis.StrictRedis(unix_socket_path=settings.REDIS_SOCKET_PATH, db=db)</span>
            <span class="k">if</span> <span class="n">decode</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">redis</span><span class="o">.</span><span class="n">StrictRedis</span><span class="p">(</span><span class="n">unix_socket_path</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">REDIS_SOCKET_PATH</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="n">db</span><span class="p">,</span> <span class="n">charset</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">decode_responses</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">redis</span><span class="o">.</span><span class="n">StrictRedis</span><span class="p">(</span><span class="n">unix_socket_path</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">REDIS_SOCKET_PATH</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="n">db</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># @modified 20191014 - Bug #3266: py3 Redis binary objects not strings</span>
            <span class="c1">#                      Branch #3262: py3</span>
            <span class="c1"># return redis.StrictRedis(host=host, port=port, db=db)</span>
            <span class="k">if</span> <span class="n">decode</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">redis</span><span class="o">.</span><span class="n">StrictRedis</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">port</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="n">db</span><span class="p">,</span> <span class="n">charset</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">decode_responses</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">redis</span><span class="o">.</span><span class="n">StrictRedis</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">port</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="n">db</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">host</span> <span class="o">==</span> <span class="s1">&#39;unix_socket&#39;</span><span class="p">:</span>
            <span class="c1"># @modified 20191014 - Bug #3266: py3 Redis binary objects not strings</span>
            <span class="c1">#                      Branch #3262: py3</span>
            <span class="c1"># return redis.StrictRedis(password=settings.REDIS_PASSWORD, unix_socket_path=settings.REDIS_SOCKET_PATH, db=db)</span>
            <span class="k">if</span> <span class="n">decode</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">redis</span><span class="o">.</span><span class="n">StrictRedis</span><span class="p">(</span><span class="n">password</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">REDIS_PASSWORD</span><span class="p">,</span> <span class="n">unix_socket_path</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">REDIS_SOCKET_PATH</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="n">db</span><span class="p">,</span> <span class="n">charset</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">decode_responses</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">redis</span><span class="o">.</span><span class="n">StrictRedis</span><span class="p">(</span><span class="n">password</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">REDIS_PASSWORD</span><span class="p">,</span> <span class="n">unix_socket_path</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">REDIS_SOCKET_PATH</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="n">db</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># @modified 20191014 - Bug #3266: py3 Redis binary objects not strings</span>
            <span class="c1">#                      Branch #3262: py3</span>
            <span class="c1"># return redis.StrictRedis(host=host, port=port, db=db, password=password)</span>
            <span class="k">if</span> <span class="n">decode</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">redis</span><span class="o">.</span><span class="n">StrictRedis</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">port</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="n">db</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">,</span> <span class="n">charset</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">decode_responses</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">redis</span><span class="o">.</span><span class="n">StrictRedis</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">port</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="n">db</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">password</span><span class="p">)</span></div>


<span class="c1"># @added 20180527 - Feature #2378: Add redis auth to Skyline and rebrow</span>
<span class="c1"># Added token, client_id and salt to replace password parameter and determining</span>
<span class="c1"># client protocol</span>
<div class="viewcode-block" id="get_client_details"><a class="viewcode-back" href="../../skyline.webapp.html#webapp.webapp.get_client_details">[docs]</a><span class="k">def</span> <span class="nf">get_client_details</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Gets the first X-Forwarded-For address and sets as the IP address.</span>
<span class="sd">    Gets the client_id by simply using a md5 hash of the client IP address</span>
<span class="sd">    and user agent.</span>
<span class="sd">    Determines whether the request was proxied.</span>
<span class="sd">    Determines the client protocol.</span>

<span class="sd">    :return: client_id, protocol, proxied, salt</span>
<span class="sd">    :rtype: str, str, boolean, str</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">proxied</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="s1">&#39;X-Forwarded-For&#39;</span><span class="p">):</span>
        <span class="n">client_ip</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="s1">&#39;X-Forwarded-For&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;rebrow access :: client ip set from X-Forwarded-For[0] to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">client_ip</span><span class="p">)))</span>
        <span class="n">proxied</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">client_ip</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">remote_addr</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;rebrow access :: client ip set from remote_addr to </span><span class="si">%s</span><span class="s1">, no X-Forwarded-For header was found&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">client_ip</span><span class="p">)))</span>
    <span class="n">client_user_agent</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;User-Agent&#39;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;rebrow access :: </span><span class="si">%s</span><span class="s1"> client_user_agent set to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">client_ip</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">client_user_agent</span><span class="p">)))</span>
    <span class="n">client_id</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">client_ip</span><span class="p">,</span> <span class="n">client_user_agent</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">python_version</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="c1"># @modified 20200808 - Task #3608: Update Skyline to Python 3.8.3 and deps</span>
        <span class="c1"># Added nosec for bandit [B303:blacklist] Use of insecure MD2, MD4, MD5,</span>
        <span class="c1"># or SHA1 hash function.  For internal use only.</span>
        <span class="n">client_id</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">client_id</span><span class="p">)</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>  <span class="c1"># nosec</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># @modified 20200808 - Task #3608: Update Skyline to Python 3.8.3 and deps</span>
        <span class="c1"># Added nosec for bandit [B303:blacklist] Use of insecure MD2, MD4, MD5,</span>
        <span class="c1"># or SHA1 hash function.  For internal use only.</span>
        <span class="n">client_id</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">client_id</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>  <span class="c1"># nosec</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;rebrow access :: </span><span class="si">%s</span><span class="s1"> has client_id </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">client_ip</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">client_id</span><span class="p">)))</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="s1">&#39;X-Forwarded-Proto&#39;</span><span class="p">):</span>
        <span class="n">protocol_list</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="s1">&#39;X-Forwarded-Proto&#39;</span><span class="p">)</span>
        <span class="n">protocol</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">protocol_list</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;rebrow access :: protocol for </span><span class="si">%s</span><span class="s1"> was set from X-Forwarded-Proto to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">client_ip</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">protocol</span><span class="p">)))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">protocol</span> <span class="o">=</span> <span class="s1">&#39;unknown&#39;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;rebrow access :: protocol for </span><span class="si">%s</span><span class="s1"> was not set from X-Forwarded-Proto to </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">client_ip</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">protocol</span><span class="p">)))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">proxied</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;rebrow access :: Skyline is not set up correctly, the expected X-Forwarded-For header was not found&#39;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">client_id</span><span class="p">,</span> <span class="n">protocol</span><span class="p">,</span> <span class="n">proxied</span></div>


<div class="viewcode-block" id="decode_token"><a class="viewcode-back" href="../../skyline.webapp.html#webapp.webapp.decode_token">[docs]</a><span class="k">def</span> <span class="nf">decode_token</span><span class="p">(</span><span class="n">client_id</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Use the app.secret, client_id and salt to decode the token JWT encoded</span>
<span class="sd">    payload and determine the Redis password.</span>

<span class="sd">    :param client_id: the client_id string</span>
<span class="sd">    :type client_id: str</span>
<span class="sd">    :return: token, decoded_redis_password, fail_msg, trace</span>
<span class="sd">    :rtype: str, str, str, str</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fail_msg</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">trace</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">token</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;decode_token for client_id - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">client_id</span><span class="p">))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">):</span>
        <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;No token url parameter was passed, please log into Redis again through rebrow&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;token&#39;</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;token found in request.args - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">token</span><span class="p">))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">token</span><span class="p">:</span>
        <span class="n">client_id</span><span class="p">,</span> <span class="n">protocol</span><span class="p">,</span> <span class="n">proxied</span> <span class="o">=</span> <span class="n">get_client_details</span><span class="p">()</span>
        <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;No token url parameter was passed, please log into Redis again through rebrow&#39;</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="s1">&#39;False&#39;</span>

    <span class="n">client_token_data</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">token</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">REDIS_PASSWORD</span><span class="p">:</span>
                <span class="c1"># @modified 20191014 - Bug #3266: py3 Redis binary objects not strings</span>
                <span class="c1">#                      Branch #3262: py3</span>
                <span class="c1"># redis_conn = redis.StrictRedis(password=settings.REDIS_PASSWORD, unix_socket_path=settings.REDIS_SOCKET_PATH)</span>
                <span class="n">redis_conn</span> <span class="o">=</span> <span class="n">redis</span><span class="o">.</span><span class="n">StrictRedis</span><span class="p">(</span><span class="n">password</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">REDIS_PASSWORD</span><span class="p">,</span> <span class="n">unix_socket_path</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">REDIS_SOCKET_PATH</span><span class="p">,</span> <span class="n">charset</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">decode_responses</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># redis_conn = redis.StrictRedis(unix_socket_path=settings.REDIS_SOCKET_PATH)</span>
                <span class="n">redis_conn</span> <span class="o">=</span> <span class="n">redis</span><span class="o">.</span><span class="n">StrictRedis</span><span class="p">(</span><span class="n">unix_socket_path</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">REDIS_SOCKET_PATH</span><span class="p">,</span> <span class="n">charset</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">decode_responses</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;rebrow.token.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">token</span>
            <span class="n">client_token_data</span> <span class="o">=</span> <span class="n">redis_conn</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;Failed to get client_token_data from Redis key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">key</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">trace</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">fail_msg</span><span class="p">)</span>
            <span class="n">client_token_data</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">token</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">client_id_match</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="c1"># @modified 20191014 - Bug #3266: py3 Redis binary objects not strings</span>
    <span class="c1">#                      Branch #3262: py3</span>
    <span class="c1"># if client_token_data is not None:</span>
    <span class="k">if</span> <span class="n">client_token_data</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;client_token_data retrieved from Redis - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">client_token_data</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">client_data</span> <span class="o">=</span> <span class="n">literal_eval</span><span class="p">(</span><span class="n">client_token_data</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;client_token_data - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">client_token_data</span><span class="p">))</span>
            <span class="n">client_data_client_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">client_data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;client_data_client_id - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">client_data_client_id</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">trace</span><span class="p">)</span>
            <span class="n">err_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: failed to get client data from Redis key&#39;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err_msg</span><span class="p">)</span>
            <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;Invalid token. Please log into Redis through rebrow again.&#39;</span>
            <span class="n">client_data_client_id</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">client_data_client_id</span> <span class="o">!=</span> <span class="n">client_id</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                <span class="s1">&#39;rebrow access :: error :: the client_id does not match the client_id of the token - </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
                <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">client_data_client_id</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">client_id</span><span class="p">)))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">REDIS_PASSWORD</span><span class="p">:</span>
                    <span class="c1"># @modified 20191014 - Bug #3266: py3 Redis binary objects not strings</span>
                    <span class="c1">#                      Branch #3262: py3</span>
                    <span class="c1"># redis_conn = redis.StrictRedis(password=settings.REDIS_PASSWORD, unix_socket_path=settings.REDIS_SOCKET_PATH)</span>
                    <span class="n">redis_conn</span> <span class="o">=</span> <span class="n">redis</span><span class="o">.</span><span class="n">StrictRedis</span><span class="p">(</span><span class="n">password</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">REDIS_PASSWORD</span><span class="p">,</span> <span class="n">unix_socket_path</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">REDIS_SOCKET_PATH</span><span class="p">,</span> <span class="n">charset</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">decode_responses</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># redis_conn = redis.StrictRedis(unix_socket_path=settings.REDIS_SOCKET_PATH)</span>
                    <span class="n">redis_conn</span> <span class="o">=</span> <span class="n">redis</span><span class="o">.</span><span class="n">StrictRedis</span><span class="p">(</span><span class="n">unix_socket_path</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">REDIS_SOCKET_PATH</span><span class="p">,</span> <span class="n">charset</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">decode_responses</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;rebrow.token.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">token</span>
                <span class="n">redis_conn</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;due to possible attempt at unauthorised use of the token, deleted the Redis key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;The request data did not match the token data, due to possible attempt at unauthorised use of the token it has been deleted.&#39;</span>
            <span class="n">trace</span> <span class="o">=</span> <span class="s1">&#39;this was a dodgy request&#39;</span>
            <span class="n">token</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">client_id_match</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;Invalid token, there was no data found associated with the token, it has probably expired.  Please log into Redis again through rebrow&#39;</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="n">client_token_data</span>
        <span class="n">token</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="n">client_data_salt</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">client_data_jwt_payload</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">client_id_match</span><span class="p">:</span>
        <span class="n">client_data_salt</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">client_data</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">client_data_jwt_payload</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">client_data</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

    <span class="n">decoded_redis_password</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">client_data_salt</span> <span class="ow">and</span> <span class="n">client_data_jwt_payload</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">jwt_secret</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">secret_key</span><span class="p">,</span> <span class="n">client_id</span><span class="p">,</span> <span class="n">client_data_salt</span><span class="p">)</span>
            <span class="n">jwt_decoded_dict</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">client_data_jwt_payload</span><span class="p">,</span> <span class="n">jwt_secret</span><span class="p">,</span> <span class="n">algorithms</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;HS256&#39;</span><span class="p">])</span>
            <span class="n">jwt_decoded_redis_password</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">jwt_decoded_dict</span><span class="p">[</span><span class="s1">&#39;auth&#39;</span><span class="p">])</span>
            <span class="n">decoded_redis_password</span> <span class="o">=</span> <span class="n">jwt_decoded_redis_password</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">trace</span><span class="p">)</span>
            <span class="n">err_msg</span> <span class="o">=</span> <span class="s1">&#39;error :: failed to decode the JWT token with the salt and client_id&#39;</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err_msg</span><span class="p">)</span>
            <span class="n">fail_msg</span> <span class="o">=</span> <span class="s1">&#39;failed to decode the JWT token with the salt and client_id. Please log into rebrow again.&#39;</span>
            <span class="n">token</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">return</span> <span class="n">token</span><span class="p">,</span> <span class="n">decoded_redis_password</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span></div>


<div class="viewcode-block" id="rebrow"><a class="viewcode-back" href="../../skyline.webapp.html#webapp.webapp.rebrow">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/rebrow&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@requires_auth</span>
<span class="c1"># def login():</span>
<span class="k">def</span> <span class="nf">rebrow</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Start page</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="c1"># TODO: test connection, handle failures</span>
        <span class="n">host</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;host&#39;</span><span class="p">])</span>
        <span class="n">port</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;port&#39;</span><span class="p">])</span>
        <span class="n">db</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;db&#39;</span><span class="p">])</span>
        <span class="c1"># @modified 20180520 - Feature #2378: Add redis auth to Skyline and rebrow</span>
        <span class="c1"># Added auth to rebrow as per https://github.com/marians/rebrow/pull/20 by</span>
        <span class="c1"># elky84</span>
        <span class="c1"># url = url_for(&#39;rebrow_server_db&#39;, host=host, port=port, db=db)</span>
        <span class="n">password</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">])</span>

        <span class="c1"># @added 20180529 - Feature #2378: Add redis auth to Skyline and rebrow</span>
        <span class="n">token_valid_for</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;token_valid_for&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">token_valid_for</span> <span class="o">&gt;</span> <span class="mi">3600</span><span class="p">:</span>
            <span class="n">token_valid_for</span> <span class="o">=</span> <span class="mi">3600</span>
        <span class="k">if</span> <span class="n">token_valid_for</span> <span class="o">&lt;</span> <span class="mi">30</span><span class="p">:</span>
            <span class="n">token_valid_for</span> <span class="o">=</span> <span class="mi">30</span>

        <span class="c1"># @added 20180520 - Feature #2378: Add redis auth to Skyline and rebrow</span>
        <span class="c1"># Added auth to rebrow as per https://github.com/marians/rebrow/pull/20 by</span>
        <span class="c1"># elky84 and add encryption to the password URL parameter trying to use</span>
        <span class="c1"># pycrypto/pycryptodome to encode it, but no, used PyJWT instead</span>
        <span class="c1"># padded_password = password.rjust(32)</span>
        <span class="c1"># secret_key = &#39;1234567890123456&#39; # create new &amp; store somewhere safe</span>
        <span class="c1"># cipher = AES.new(app.secret_key,AES.MODE_ECB) # never use ECB in strong systems obviously</span>
        <span class="c1"># encoded = base64.b64encode(cipher.encrypt(padded_password))</span>

        <span class="c1"># @added 20180527 - Feature #2378: Add redis auth to Skyline and rebrow</span>
        <span class="c1"># Added client_id, token and salt</span>
        <span class="n">salt</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
        <span class="n">client_id</span><span class="p">,</span> <span class="n">protocol</span><span class="p">,</span> <span class="n">proxied</span> <span class="o">=</span> <span class="n">get_client_details</span><span class="p">()</span>

        <span class="c1"># @added 20180526 - Feature #2378: Add redis auth to Skyline and rebrow</span>
        <span class="c1"># Use pyjwt - JSON Web Token implementation to encode the password and</span>
        <span class="c1"># pass a token in the URL password parameter, the password in the POST</span>
        <span class="c1"># data should be encrypted via the reverse proxy SSL endpoint</span>
        <span class="c1"># encoded = jwt.encode({&#39;some&#39;: &#39;payload&#39;}, &#39;secret&#39;, algorithm=&#39;HS256&#39;)</span>
        <span class="c1"># jwt.decode(encoded, &#39;secret&#39;, algorithms=[&#39;HS256&#39;])</span>
        <span class="c1"># {&#39;some&#39;: &#39;payload&#39;}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">jwt_secret</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">secret_key</span><span class="p">,</span> <span class="n">client_id</span><span class="p">,</span> <span class="n">salt</span><span class="p">)</span>
            <span class="n">jwt_encoded_payload</span> <span class="o">=</span> <span class="n">jwt</span><span class="o">.</span><span class="n">encode</span><span class="p">({</span><span class="s1">&#39;auth&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">password</span><span class="p">)},</span> <span class="n">jwt_secret</span><span class="p">,</span> <span class="n">algorithm</span><span class="o">=</span><span class="s1">&#39;HS256&#39;</span><span class="p">)</span>
            <span class="c1"># @added 20191014 - Bug #3268: webapp - rebrow - jwt.encode generating bytes instead of a string in py3</span>
            <span class="c1">#                   Branch #3262: py3</span>
            <span class="c1"># As per https://github.com/jpadilla/pyjwt/issues/391 - jwt.encode generating bytes instead of a string</span>
            <span class="k">if</span> <span class="n">python_version</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">jwt_encoded_payload</span> <span class="o">=</span> <span class="n">jwt_encoded_payload</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;UTF-8&#39;</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Failed to create set jwt_encoded_payload for </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">client_id</span>
            <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

        <span class="c1"># HERE WE WANT TO PUT THIS INTO REDIS with a TTL key and give the key</span>
        <span class="c1"># a salt and have the client use that as their token</span>
        <span class="n">client_token</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;rebrow access :: generated client_token </span><span class="si">%s</span><span class="s1"> for client_id </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">client_token</span><span class="p">,</span> <span class="n">client_id</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">settings</span><span class="o">.</span><span class="n">REDIS_PASSWORD</span><span class="p">:</span>
                <span class="c1"># @modified 20191014 - Bug #3266: py3 Redis binary objects not strings</span>
                <span class="c1">#                      Branch #3262: py3</span>
                <span class="c1"># redis_conn = redis.StrictRedis(password=settings.REDIS_PASSWORD, unix_socket_path=settings.REDIS_SOCKET_PATH)</span>
                <span class="n">redis_conn</span> <span class="o">=</span> <span class="n">redis</span><span class="o">.</span><span class="n">StrictRedis</span><span class="p">(</span><span class="n">password</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">REDIS_PASSWORD</span><span class="p">,</span> <span class="n">unix_socket_path</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">REDIS_SOCKET_PATH</span><span class="p">,</span> <span class="n">charset</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">decode_responses</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># @modified 20191014 - Bug #3266: py3 Redis binary objects not strings</span>
                <span class="c1">#                      Branch #3262: py3</span>
                <span class="c1"># redis_conn = redis.StrictRedis(unix_socket_path=settings.REDIS_SOCKET_PATH)</span>
                <span class="n">redis_conn</span> <span class="o">=</span> <span class="n">redis</span><span class="o">.</span><span class="n">StrictRedis</span><span class="p">(</span><span class="n">unix_socket_path</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">REDIS_SOCKET_PATH</span><span class="p">,</span> <span class="n">charset</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">decode_responses</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">key</span> <span class="o">=</span> <span class="s1">&#39;rebrow.token.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">client_token</span>
            <span class="c1"># @modified 20191014 - Bug #3266: py3 Redis binary objects not strings</span>
            <span class="c1">#                      Branch #3262: py3</span>
            <span class="n">value</span> <span class="o">=</span> <span class="s1">&#39;[</span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s1">,</span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s1">,</span><span class="se">\&#39;</span><span class="si">%s</span><span class="se">\&#39;</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">client_id</span><span class="p">,</span> <span class="n">salt</span><span class="p">,</span> <span class="n">jwt_encoded_payload</span><span class="p">)</span>
            <span class="n">redis_conn</span><span class="o">.</span><span class="n">setex</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">token_valid_for</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;rebrow access :: set Redis key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Failed to set Redis key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">key</span>
            <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

        <span class="c1"># @modified 20180526 - Feature #2378: Add redis auth to Skyline and rebrow</span>
        <span class="c1"># Change password parameter to token parameter</span>
        <span class="c1"># url = url_for(&quot;rebrow_server_db&quot;, host=host, port=port, db=db, password=password)</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">url_for</span><span class="p">(</span>
            <span class="s2">&quot;rebrow_server_db&quot;</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">port</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="n">db</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="n">client_token</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="c1"># @added 20180527 - Feature #2378: Add redis auth to Skyline and rebrow</span>
        <span class="c1"># Added client_id</span>
        <span class="n">client_id</span><span class="p">,</span> <span class="n">protocol</span><span class="p">,</span> <span class="n">proxied</span> <span class="o">=</span> <span class="n">get_client_details</span><span class="p">()</span>

        <span class="c1"># @added 20180527 - Feature #2378: Add redis auth to Skyline and rebrow</span>
        <span class="c1"># Added client message to give relevant messages on the login page</span>
        <span class="n">client_message</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># @added 20190519 - Branch #3002: docker</span>
        <span class="n">display_redis_password</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">host_input_value</span> <span class="o">=</span> <span class="s1">&#39;localhost&#39;</span>
        <span class="n">rebrow_redis_password</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">running_on_docker</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">DOCKER</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">running_on_docker</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">running_on_docker</span><span class="p">:</span>
            <span class="n">host_input_value</span> <span class="o">=</span> <span class="s1">&#39;unix_socket&#39;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">display_redis_password</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">DOCKER_DISPLAY_REDIS_PASSWORD_IN_REBROW</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">display_redis_password</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">display_redis_password</span><span class="p">:</span>
                <span class="n">rebrow_redis_password</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">REDIS_PASSWORD</span>

        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span>
            <span class="s1">&#39;rebrow_login.html&#39;</span><span class="p">,</span>
            <span class="c1"># @modified 20180527 - Feature #2378: Add redis auth to Skyline and rebrow</span>
            <span class="c1"># Change password parameter to token parameter and added protocol,</span>
            <span class="c1"># proxied</span>
            <span class="c1"># redis_password=redis_password,</span>
            <span class="n">protocol</span><span class="o">=</span><span class="n">protocol</span><span class="p">,</span> <span class="n">proxied</span><span class="o">=</span><span class="n">proxied</span><span class="p">,</span> <span class="n">client_message</span><span class="o">=</span><span class="n">client_message</span><span class="p">,</span>
            <span class="n">version</span><span class="o">=</span><span class="n">skyline_version</span><span class="p">,</span>
            <span class="c1"># @added 20190519 - Branch #3002: docker</span>
            <span class="n">running_on_docker</span><span class="o">=</span><span class="n">running_on_docker</span><span class="p">,</span>
            <span class="n">rebrow_redis_password</span><span class="o">=</span><span class="n">rebrow_redis_password</span><span class="p">,</span>
            <span class="n">display_redis_password</span><span class="o">=</span><span class="n">display_redis_password</span><span class="p">,</span>
            <span class="n">host_input_value</span><span class="o">=</span><span class="n">host_input_value</span><span class="p">,</span>
            <span class="n">duration</span><span class="o">=</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">))</span></div>


<div class="viewcode-block" id="rebrow_server_db"><a class="viewcode-back" href="../../skyline.webapp.html#webapp.webapp.rebrow_server_db">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/rebrow_server_db/&lt;host&gt;:&lt;int:port&gt;/&lt;int:db&gt;/&quot;</span><span class="p">)</span>
<span class="nd">@requires_auth</span>
<span class="k">def</span> <span class="nf">rebrow_server_db</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">db</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    List all databases and show info on server</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="c1"># @modified 20180520 - Feature #2378: Add redis auth to Skyline and rebrow</span>
    <span class="c1"># r = redis.StrictRedis(host=host, port=port, db=0)</span>
    <span class="c1"># @modified 20180527 - Feature #2378: Add redis auth to Skyline and rebrow</span>
    <span class="c1"># Use client_id and JWT token</span>
    <span class="c1"># password = False</span>
    <span class="c1"># url_password = False</span>
    <span class="c1"># if request.args.getlist(&#39;password&#39;):</span>
    <span class="c1">#     password = request.args.get(&#39;password&#39;, default=&#39;&#39;, type=str)</span>
    <span class="c1">#     url_password = quote(password, safe=&#39;&#39;)</span>
    <span class="c1"># @added 20180527 - Feature #2378: Add redis auth to Skyline and rebrow</span>
    <span class="c1"># Added client_id and token</span>
    <span class="n">client_id</span><span class="p">,</span> <span class="n">protocol</span><span class="p">,</span> <span class="n">proxied</span> <span class="o">=</span> <span class="n">get_client_details</span><span class="p">()</span>
    <span class="n">token</span><span class="p">,</span> <span class="n">redis_password</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">decode_token</span><span class="p">(</span><span class="n">client_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">token</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">fail_msg</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># @modified 20191014 - Bug #3266: py3 Redis binary objects not strings</span>
        <span class="c1">#                      Branch #3262: py3</span>
        <span class="c1"># r = get_redis(host, port, db, redis_password)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">get_redis</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">redis_password</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: rebrow access :: failed to login to Redis with token&#39;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">info</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Failed to get INFO all from Redis, this could be an issue with the Redis password you entered.&#39;</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

    <span class="n">dbsize</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">dbsize</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span>
        <span class="s1">&#39;rebrow_server_db.html&#39;</span><span class="p">,</span>
        <span class="n">host</span><span class="o">=</span><span class="n">host</span><span class="p">,</span>
        <span class="n">port</span><span class="o">=</span><span class="n">port</span><span class="p">,</span>
        <span class="n">db</span><span class="o">=</span><span class="n">db</span><span class="p">,</span>
        <span class="c1"># @added 20180520 - Feature #2378: Add redis auth to Skyline and rebrow</span>
        <span class="c1"># password=password,</span>
        <span class="c1"># url_password=url_password,</span>
        <span class="c1"># @added 20180527 - Feature #2378: Add redis auth to Skyline and rebrow</span>
        <span class="n">token</span><span class="o">=</span><span class="n">token</span><span class="p">,</span>
        <span class="n">info</span><span class="o">=</span><span class="n">info</span><span class="p">,</span>
        <span class="n">dbsize</span><span class="o">=</span><span class="n">dbsize</span><span class="p">,</span>
        <span class="n">serverinfo_meta</span><span class="o">=</span><span class="n">serverinfo_meta</span><span class="p">,</span>
        <span class="n">version</span><span class="o">=</span><span class="n">skyline_version</span><span class="p">,</span>
        <span class="n">duration</span><span class="o">=</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">))</span></div>


<div class="viewcode-block" id="rebrow_keys"><a class="viewcode-back" href="../../skyline.webapp.html#webapp.webapp.rebrow_keys">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/rebrow_keys/&lt;host&gt;:&lt;int:port&gt;/&lt;int:db&gt;/keys/&quot;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="nd">@requires_auth</span>
<span class="k">def</span> <span class="nf">rebrow_keys</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">db</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    List keys for one database</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="c1"># @modified 20180520 - Feature #2378: Add redis auth to Skyline and rebrow</span>
    <span class="c1"># r = redis.StrictRedis(host=host, port=port, db=db)</span>
    <span class="c1"># @modified 20180527 - Feature #2378: Add redis auth to Skyline and rebrow</span>
    <span class="c1"># password = request.args.get(&#39;password&#39;, default=&#39;&#39;, type=str)</span>
    <span class="c1"># url_password = quote(password, safe=&#39;&#39;)</span>
    <span class="c1"># r = get_redis(host, port, db, password)</span>
    <span class="c1"># @added 20180527 - Feature #2378: Add redis auth to Skyline and rebrow</span>
    <span class="c1"># Added client_id and token</span>
    <span class="n">client_id</span><span class="p">,</span> <span class="n">protocol</span><span class="p">,</span> <span class="n">proxied</span> <span class="o">=</span> <span class="n">get_client_details</span><span class="p">()</span>
    <span class="n">token</span><span class="p">,</span> <span class="n">redis_password</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">decode_token</span><span class="p">(</span><span class="n">client_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">token</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">fail_msg</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># @modified 20191014 - Bug #3266: py3 Redis binary objects not strings</span>
        <span class="c1">#                      Branch #3262: py3</span>
        <span class="c1"># r = get_redis(host, port, db, redis_password)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">get_redis</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">redis_password</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: rebrow access :: failed to login to Redis with token&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
        <span class="n">action</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;action&#39;</span><span class="p">]</span>
        <span class="n">app</span><span class="o">.</span><span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">action</span> <span class="o">==</span> <span class="s1">&#39;delkey&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">result</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">])</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Failed to delete Redis key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">])</span>
                    <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
                    <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">result</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">flash</span><span class="p">(</span><span class="s1">&#39;Key </span><span class="si">%s</span><span class="s1"> has been deleted.&#39;</span> <span class="o">%</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">],</span> <span class="n">category</span><span class="o">=</span><span class="s1">&#39;info&#39;</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;rebrow :: deleted Redis key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">]))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">flash</span><span class="p">(</span><span class="s1">&#39;Key </span><span class="si">%s</span><span class="s1"> could not be deleted.&#39;</span> <span class="o">%</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">],</span> <span class="n">category</span><span class="o">=</span><span class="s1">&#39;error&#39;</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;rebrow :: could not deleted Redis key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;key&#39;</span><span class="p">]))</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;offset&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">))</span>
        <span class="c1"># @modified 20180527 - Feature #2378: Add redis auth to Skyline and rebrow</span>
        <span class="c1"># List more keys per page</span>
        <span class="c1"># perpage = int(request.args.get(&#39;perpage&#39;, &#39;10&#39;))</span>
        <span class="n">perpage</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;perpage&#39;</span><span class="p">,</span> <span class="s1">&#39;50&#39;</span><span class="p">))</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pattern&#39;</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">dbsize</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">dbsize</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Failed to determine Redis dbsize&#39;</span>
            <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
            <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

        <span class="n">keys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">keys</span><span class="p">(</span><span class="n">pattern</span><span class="p">))</span>
        <span class="n">limited_keys</span> <span class="o">=</span> <span class="n">keys</span><span class="p">[</span><span class="n">offset</span><span class="p">:(</span><span class="n">perpage</span> <span class="o">+</span> <span class="n">offset</span><span class="p">)]</span>
        <span class="n">types</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">limited_keys</span><span class="p">:</span>
            <span class="n">types</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">type</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;rebrow :: returned keys list&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span>
            <span class="s1">&#39;rebrow_keys.html&#39;</span><span class="p">,</span>
            <span class="n">host</span><span class="o">=</span><span class="n">host</span><span class="p">,</span>
            <span class="n">port</span><span class="o">=</span><span class="n">port</span><span class="p">,</span>
            <span class="n">db</span><span class="o">=</span><span class="n">db</span><span class="p">,</span>
            <span class="c1"># @added 20180520 - Feature #2378: Add redis auth to Skyline and rebrow</span>
            <span class="c1"># password=password,</span>
            <span class="c1"># url_password=url_password,</span>
            <span class="c1"># @added 20180527 - Feature #2378: Add redis auth to Skyline and rebrow</span>
            <span class="n">token</span><span class="o">=</span><span class="n">token</span><span class="p">,</span>
            <span class="n">dbsize</span><span class="o">=</span><span class="n">dbsize</span><span class="p">,</span>
            <span class="n">keys</span><span class="o">=</span><span class="n">limited_keys</span><span class="p">,</span>
            <span class="n">types</span><span class="o">=</span><span class="n">types</span><span class="p">,</span>
            <span class="n">offset</span><span class="o">=</span><span class="n">offset</span><span class="p">,</span>
            <span class="n">perpage</span><span class="o">=</span><span class="n">perpage</span><span class="p">,</span>
            <span class="n">pattern</span><span class="o">=</span><span class="n">pattern</span><span class="p">,</span>
            <span class="n">num_keys</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">),</span>
            <span class="n">version</span><span class="o">=</span><span class="n">skyline_version</span><span class="p">,</span>
            <span class="n">duration</span><span class="o">=</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">))</span></div>


<div class="viewcode-block" id="rebrow_key"><a class="viewcode-back" href="../../skyline.webapp.html#webapp.webapp.rebrow_key">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s2">&quot;/rebrow_key/&lt;host&gt;:&lt;int:port&gt;/&lt;int:db&gt;/keys/&lt;key&gt;/&quot;</span><span class="p">)</span>
<span class="nd">@requires_auth</span>
<span class="k">def</span> <span class="nf">rebrow_key</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Show a specific key.</span>
<span class="sd">    key is expected to be URL-safe base64 encoded</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># @added 20160703 - Feature #1464: Webapp Redis browser</span>
    <span class="c1"># metrics encoded with msgpack</span>
    <span class="c1"># @modified 20190503 - Branch #2646: slack - linting</span>
    <span class="c1"># original_key not used</span>
    <span class="c1"># original_key = key</span>

    <span class="n">msg_pack_key</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="c1"># if key.startswith(&#39;metrics.&#39;):</span>
    <span class="c1">#     msg_packed_key = True</span>
    <span class="n">key</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">urlsafe_b64decode</span><span class="p">(</span><span class="n">key</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf8&#39;</span><span class="p">))</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="c1"># @modified 20180520 - Feature #2378: Add redis auth to Skyline and rebrow</span>
    <span class="c1"># r = redis.StrictRedis(host=host, port=port, db=db)</span>
    <span class="c1"># @modified 20180527 - Feature #2378: Add redis auth to Skyline and rebrow</span>
    <span class="c1"># Use client_id and token</span>
    <span class="c1"># password = request.args.get(&#39;password&#39;, default=&#39;&#39;, type=str)</span>
    <span class="c1"># url_password = quote(password, safe=&#39;&#39;)</span>
    <span class="c1"># r = get_redis(host, port, db, password)</span>
    <span class="c1"># @added 20180527 - Feature #2378: Add redis auth to Skyline and rebrow</span>
    <span class="c1"># Added client_id and token</span>
    <span class="n">client_id</span><span class="p">,</span> <span class="n">protocol</span><span class="p">,</span> <span class="n">proxied</span> <span class="o">=</span> <span class="n">get_client_details</span><span class="p">()</span>
    <span class="n">token</span><span class="p">,</span> <span class="n">redis_password</span><span class="p">,</span> <span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span> <span class="o">=</span> <span class="n">decode_token</span><span class="p">(</span><span class="n">client_id</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">token</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">fail_msg</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">fail_msg</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">get_redis</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">redis_password</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: rebrow access :: failed to login to Redis with token&#39;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">r_d</span> <span class="o">=</span> <span class="n">get_redis</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">db</span><span class="p">,</span> <span class="n">redis_password</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: rebrow access :: failed to login to Redis with token&#39;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># @modified 20191014 - Bug #3266: py3 Redis binary objects not strings</span>
        <span class="c1">#                      Branch #3262: py3</span>
        <span class="c1"># dump = r.dump(key)</span>
        <span class="k">if</span> <span class="n">python_version</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">dump</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="n">dump_key</span> <span class="o">=</span> <span class="n">key</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">python_version</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">dump</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">dump_key</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;rebrow :: got key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">dump_key</span><span class="p">))</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Failed to dump Redis key - </span><span class="si">%s</span><span class="s1">, decoded key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">dump_key</span><span class="p">))</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">dump</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">abort</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>
    <span class="c1"># if t is None:</span>
    <span class="c1">#    abort(404)</span>
    <span class="n">size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dump</span><span class="p">)</span>
    <span class="c1"># @modified 20170809 - Bug #2136: Analyzer stalling on no metrics</span>
    <span class="c1"># Added except to all del methods to prevent stalling if any object does</span>
    <span class="c1"># not exist</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">del</span> <span class="n">dump</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to del dump&#39;</span><span class="p">)</span>

    <span class="c1"># @modified 20191014 - Bug #3266: py3 Redis binary objects not strings</span>
    <span class="c1">#                      Branch #3262: py3</span>
    <span class="c1"># t = r.type(key)</span>
    <span class="k">if</span> <span class="n">python_version</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">type</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">python_version</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">dump_key</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">type</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;rebrow :: got key - </span><span class="si">%s</span><span class="s1">, of type </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">dump_key</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="p">)))</span>

    <span class="n">ttl</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">pttl</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="s1">&#39;string&#39;</span><span class="p">:</span>
        <span class="c1"># @modified 20160703 - Feature #1464: Webapp Redis browser</span>
        <span class="c1"># metrics encoded with msgpack</span>
        <span class="c1"># val = r.get(key)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">abort</span><span class="p">(</span><span class="mi">404</span><span class="p">)</span>

        <span class="c1"># @modified 20200610 - Bug #3266: py3 Redis binary objects not strings</span>
        <span class="c1">#                      Branch #3262: py3</span>
        <span class="c1"># Try decode val so that bytes-like objects are decoded, this will fail</span>
        <span class="c1"># sliently and if it is a msg_packed_key</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">UnicodeDecodeError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">):</span>
            <span class="k">pass</span>

        <span class="c1"># @modified 20191014 - Bug #3266: py3 Redis binary objects not strings</span>
        <span class="c1">#                      Branch #3262: py3</span>
        <span class="c1"># test_string = all(c in string.printable for c in val)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">test_string</span> <span class="o">=</span> <span class="nb">all</span><span class="p">(</span><span class="n">c</span> <span class="ow">in</span> <span class="n">string</span><span class="o">.</span><span class="n">printable</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">val</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">test_string</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># @added 20170920 - Bug #2166: panorama incorrect mysql_id cache keys</span>
        <span class="c1"># There are SOME cache key msgpack values that DO == string.printable</span>
        <span class="c1"># for example [73] msgpacks to I</span>
        <span class="c1"># panorama.mysql_ids will always be msgpack</span>
        <span class="k">if</span> <span class="s1">&#39;panorama.mysql_ids&#39;</span> <span class="ow">in</span> <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">):</span>
            <span class="n">test_string</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">test_string</span><span class="p">:</span>
            <span class="n">raw_result</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
            <span class="n">unpacker</span> <span class="o">=</span> <span class="n">Unpacker</span><span class="p">(</span><span class="n">use_list</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">unpacker</span><span class="o">.</span><span class="n">feed</span><span class="p">(</span><span class="n">raw_result</span><span class="p">)</span>
            <span class="n">val</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">unpacker</span><span class="p">)</span>
            <span class="n">msg_pack_key</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;rebrow :: msgpack key unpacked - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">dump_key</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">t</span> <span class="o">==</span> <span class="s1">&#39;list&#39;</span><span class="p">:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">lrange</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">t</span> <span class="o">==</span> <span class="s1">&#39;hash&#39;</span><span class="p">:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">hgetall</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">t</span> <span class="o">==</span> <span class="s1">&#39;set&#39;</span><span class="p">:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">smembers</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="c1"># @modified 20200610 - Bug #3266: py3 Redis binary objects not strings</span>
        <span class="c1">#                      Branch #3262: py3</span>
        <span class="c1"># Try decode val so that bytes-like objects are decoded</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">UnicodeDecodeError</span><span class="p">,</span> <span class="ne">AttributeError</span><span class="p">):</span>
            <span class="k">pass</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;rebrow :: set key - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">t</span> <span class="o">==</span> <span class="s1">&#39;zset&#39;</span><span class="p">:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">zrange</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">withscores</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span>
        <span class="s1">&#39;rebrow_key.html&#39;</span><span class="p">,</span>
        <span class="n">host</span><span class="o">=</span><span class="n">host</span><span class="p">,</span>
        <span class="n">port</span><span class="o">=</span><span class="n">port</span><span class="p">,</span>
        <span class="n">db</span><span class="o">=</span><span class="n">db</span><span class="p">,</span>
        <span class="c1"># @added 20180520 - Feature #2378: Add redis auth to Skyline and rebrow</span>
        <span class="c1"># password=password,</span>
        <span class="c1"># url_password=url_password,</span>
        <span class="c1"># @added 20180527 - Feature #2378: Add redis auth to Skyline and rebrow</span>
        <span class="n">token</span><span class="o">=</span><span class="n">token</span><span class="p">,</span>
        <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">,</span>
        <span class="n">value</span><span class="o">=</span><span class="n">val</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="n">t</span><span class="p">,</span>
        <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">,</span>
        <span class="n">ttl</span><span class="o">=</span><span class="n">ttl</span> <span class="o">/</span> <span class="mf">1000.0</span><span class="p">,</span>
        <span class="n">now</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">(),</span>
        <span class="n">expiration</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="n">ttl</span> <span class="o">/</span> <span class="mf">1000.0</span><span class="p">),</span>
        <span class="n">version</span><span class="o">=</span><span class="n">skyline_version</span><span class="p">,</span>
        <span class="n">duration</span><span class="o">=</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span><span class="p">),</span>
        <span class="n">msg_packed_key</span><span class="o">=</span><span class="n">msg_pack_key</span><span class="p">)</span></div>


<div class="viewcode-block" id="urlsafe_base64_encode"><a class="viewcode-back" href="../../skyline.webapp.html#webapp.webapp.urlsafe_base64_encode">[docs]</a><span class="nd">@app</span><span class="o">.</span><span class="n">template_filter</span><span class="p">(</span><span class="s1">&#39;urlsafe_base64&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">urlsafe_base64_encode</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
    <span class="c1"># @modified 20180520 - Feature #2378: Add redis auth to Skyline and rebrow</span>
    <span class="c1"># if type(s) == &#39;Markup&#39;:</span>
    <span class="c1">#     s = s.unescape()</span>

    <span class="c1"># @modified 20191014 - Bug #3266: py3 Redis binary objects not strings</span>
    <span class="c1">#                      Branch #3262: py3</span>
    <span class="c1"># if isinstance(s, Markup):</span>
    <span class="c1">#     s = s.unescape()</span>
    <span class="c1"># elif isinstance(s, bytes):</span>
    <span class="c1">#     s = s.decode(&#39;utf-8&#39;)</span>
    <span class="c1"># s = s.encode(&#39;utf8&#39;)</span>
    <span class="c1"># s = base64.urlsafe_b64encode(s)</span>
    <span class="n">s_original</span> <span class="o">=</span> <span class="n">s</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">Markup</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">unescape</span><span class="p">()</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf8&#39;</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">base64</span><span class="o">.</span><span class="n">urlsafe_b64encode</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="c1"># logger.info(&#39;debug :: rebrow :: %s urlsafe_b64encode as %s&#39; % (str(s_original), str(s)))</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">message</span> <span class="o">=</span> <span class="s1">&#39;Failed to urlsafe_b64encode - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
        <span class="n">trace</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">internal_error</span><span class="p">(</span><span class="n">message</span><span class="p">,</span> <span class="n">trace</span><span class="p">)</span>

    <span class="c1"># @added 20191014 - Bug #3266: py3 Redis binary objects not strings</span>
    <span class="c1">#                   Branch #3262: py3</span>
    <span class="k">if</span> <span class="n">python_version</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
        <span class="n">decoded_s</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">decoded_s</span>
        <span class="c1"># logger.info(&#39;debug more :: rebrow :: %s urlsafe_b64encode decoded as %s&#39; % (str(s_original), str(decoded_s)))</span>

    <span class="k">return</span> <span class="n">Markup</span><span class="p">(</span><span class="n">s</span><span class="p">)</span></div>
<span class="c1"># END rebrow</span>


<div class="viewcode-block" id="App"><a class="viewcode-back" href="../../skyline.webapp.html#webapp.webapp.App">[docs]</a><span class="k">class</span> <span class="nc">App</span><span class="p">():</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stdin_path</span> <span class="o">=</span> <span class="s1">&#39;/dev/null&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stdout_path</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">.log&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">LOG_PATH</span><span class="p">,</span> <span class="n">skyline_app</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stderr_path</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">.log&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">LOG_PATH</span><span class="p">,</span> <span class="n">skyline_app</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pidfile_path</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">/</span><span class="si">%s</span><span class="s1">.pid&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">PID_PATH</span><span class="p">,</span> <span class="n">skyline_app</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pidfile_timeout</span> <span class="o">=</span> <span class="mi">5</span>

<div class="viewcode-block" id="App.run"><a class="viewcode-back" href="../../skyline.webapp.html#webapp.webapp.App.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c1"># Log management to prevent overwriting</span>
        <span class="c1"># Allow the bin/&lt;skyline_app&gt;.d to manage the log</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">skyline_app_logwait</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os_remove</span><span class="p">(</span><span class="n">skyline_app_logwait</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error - failed to remove </span><span class="si">%s</span><span class="s1">, continuing&#39;</span> <span class="o">%</span> <span class="n">skyline_app_logwait</span><span class="p">)</span>
                <span class="k">pass</span>

        <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<span class="c1">#        log_wait_for = now + 5</span>
        <span class="n">log_wait_for</span> <span class="o">=</span> <span class="n">now</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">while</span> <span class="n">now</span> <span class="o">&lt;</span> <span class="n">log_wait_for</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">skyline_app_loglock</span><span class="p">):</span>
                <span class="n">sleep</span><span class="p">(</span><span class="o">.</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">now</span> <span class="o">=</span> <span class="n">log_wait_for</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;starting </span><span class="si">%s</span><span class="s1"> run&#39;</span> <span class="o">%</span> <span class="n">skyline_app</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">skyline_app_loglock</span><span class="p">):</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error - bin/</span><span class="si">%s</span><span class="s1">.d log management seems to have failed, continuing&#39;</span> <span class="o">%</span> <span class="n">skyline_app</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">os_remove</span><span class="p">(</span><span class="n">skyline_app_loglock</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;log lock file removed&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error - failed to remove </span><span class="si">%s</span><span class="s1">, continuing&#39;</span> <span class="o">%</span> <span class="n">skyline_app_loglock</span><span class="p">)</span>
                <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;bin/</span><span class="si">%s</span><span class="s1">.d log management done&#39;</span> <span class="o">%</span> <span class="n">skyline_app</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;starting </span><span class="si">%s</span><span class="s1"> - </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">skyline_app</span><span class="p">,</span> <span class="n">skyline_version</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;starting </span><span class="si">%s</span><span class="s1"> - version UNKNOWN&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">skyline_app</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;hosted at </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">settings</span><span class="o">.</span><span class="n">WEBAPP_IP</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;running on port </span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">settings</span><span class="o">.</span><span class="n">WEBAPP_PORT</span><span class="p">)</span>

        <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">WEBAPP_IP</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">WEBAPP_PORT</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="run"><a class="viewcode-back" href="../../skyline.webapp.html#webapp.webapp.run">[docs]</a><span class="k">def</span> <span class="nf">run</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Start the Webapp server</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">isdir</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">PID_PATH</span><span class="p">):</span>
        <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;pid directory does not exist at </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">settings</span><span class="o">.</span><span class="n">PID_PATH</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">isdir</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">LOG_PATH</span><span class="p">):</span>
        <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;log directory does not exist at </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">settings</span><span class="o">.</span><span class="n">LOG_PATH</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>

    <span class="n">formatter</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">Formatter</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%(asctime)s</span><span class="s2"> :: </span><span class="si">%(process)s</span><span class="s2"> :: </span><span class="si">%(message)s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">datefmt</span><span class="o">=</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span>
    <span class="n">handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">handlers</span><span class="o">.</span><span class="n">TimedRotatingFileHandler</span><span class="p">(</span>
        <span class="n">logfile</span><span class="p">,</span>
        <span class="n">when</span><span class="o">=</span><span class="s2">&quot;midnight&quot;</span><span class="p">,</span>
        <span class="n">interval</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="n">backupCount</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>

    <span class="n">memory_handler</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">handlers</span><span class="o">.</span><span class="n">MemoryHandler</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span>
                                                    <span class="n">flushLevel</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">,</span>
                                                    <span class="n">target</span><span class="o">=</span><span class="n">handler</span><span class="p">)</span>
    <span class="n">handler</span><span class="o">.</span><span class="n">setFormatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">addHandler</span><span class="p">(</span><span class="n">memory_handler</span><span class="p">)</span>

    <span class="c1"># Validate settings variables</span>
    <span class="n">valid_settings</span> <span class="o">=</span> <span class="n">validate_settings_variables</span><span class="p">(</span><span class="n">skyline_app</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">valid_settings</span><span class="p">:</span>
        <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;error :: invalid variables in settings.py - cannot start&#39;</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">WEBAPP_SERVER</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to determine </span><span class="si">%s</span><span class="s1"> from settings.py&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="s1">&#39;WEBAPP_SERVER&#39;</span><span class="p">))</span>
        <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Failed to determine </span><span class="si">%s</span><span class="s1"> from settings.py&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="s1">&#39;WEBAPP_SERVER&#39;</span><span class="p">))</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">WEBAPP_IP</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to determine </span><span class="si">%s</span><span class="s1"> from settings.py&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="s1">&#39;WEBAPP_IP&#39;</span><span class="p">))</span>
        <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Failed to determine </span><span class="si">%s</span><span class="s1"> from settings.py&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="s1">&#39;WEBAPP_IP&#39;</span><span class="p">))</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">WEBAPP_PORT</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to determine </span><span class="si">%s</span><span class="s1"> from settings.py&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="s1">&#39;WEBAPP_PORT&#39;</span><span class="p">))</span>
        <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Failed to determine </span><span class="si">%s</span><span class="s1"> from settings.py&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="s1">&#39;WEBAPP_PORT&#39;</span><span class="p">))</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">WEBAPP_AUTH_ENABLED</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to determine </span><span class="si">%s</span><span class="s1"> from settings.py&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="s1">&#39;WEBAPP_AUTH_ENABLED&#39;</span><span class="p">))</span>
        <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Failed to determine </span><span class="si">%s</span><span class="s1"> from settings.py&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="s1">&#39;WEBAPP_AUTH_ENABLED&#39;</span><span class="p">))</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">WEBAPP_IP_RESTRICTED</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to determine </span><span class="si">%s</span><span class="s1"> from settings.py&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="s1">&#39;WEBAPP_IP_RESTRICTED&#39;</span><span class="p">))</span>
        <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Failed to determine </span><span class="si">%s</span><span class="s1"> from settings.py&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="s1">&#39;WEBAPP_IP_RESTRICTED&#39;</span><span class="p">))</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">WEBAPP_AUTH_USER</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to determine </span><span class="si">%s</span><span class="s1"> from settings.py&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="s1">&#39;WEBAPP_AUTH_USER&#39;</span><span class="p">))</span>
        <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Failed to determine </span><span class="si">%s</span><span class="s1"> from settings.py&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="s1">&#39;WEBAPP_AUTH_USER&#39;</span><span class="p">))</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">WEBAPP_AUTH_USER_PASSWORD</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to determine </span><span class="si">%s</span><span class="s1"> from settings.py&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="s1">&#39;WEBAPP_AUTH_USER_PASSWORD&#39;</span><span class="p">))</span>
        <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Failed to determine </span><span class="si">%s</span><span class="s1"> from settings.py&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="s1">&#39;WEBAPP_AUTH_USER_PASSWORD&#39;</span><span class="p">))</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">settings</span><span class="o">.</span><span class="n">WEBAPP_ALLOWED_IPS</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;error :: failed to determine </span><span class="si">%s</span><span class="s1"> from settings.py&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="s1">&#39;WEBAPP_ALLOWED_IPS&#39;</span><span class="p">))</span>
        <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Failed to determine </span><span class="si">%s</span><span class="s1"> from settings.py&#39;</span> <span class="o">%</span> <span class="nb">str</span><span class="p">(</span><span class="s1">&#39;WEBAPP_ALLOWED_IPS&#39;</span><span class="p">))</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="n">webapp</span> <span class="o">=</span> <span class="n">App</span><span class="p">()</span>

<span class="c1"># Does this make it log?</span>
<span class="c1">#    if len(sys.argv) &gt; 1 and sys.argv[1] == &#39;run&#39;:</span>
<span class="c1">#        webapp.run()</span>
<span class="c1">#    else:</span>
<span class="c1">#        daemon_runner = runner.DaemonRunner(webapp)</span>
<span class="c1">#        daemon_runner.daemon_context.files_preserve = [handler.stream]</span>
<span class="c1">#        daemon_runner.do_action()</span>

    <span class="n">daemon_runner</span> <span class="o">=</span> <span class="n">runner</span><span class="o">.</span><span class="n">DaemonRunner</span><span class="p">(</span><span class="n">webapp</span><span class="p">)</span>
    <span class="n">daemon_runner</span><span class="o">.</span><span class="n">daemon_context</span><span class="o">.</span><span class="n">files_preserve</span> <span class="o">=</span> <span class="p">[</span><span class="n">handler</span><span class="o">.</span><span class="n">stream</span><span class="p">]</span>
    <span class="n">daemon_runner</span><span class="o">.</span><span class="n">do_action</span><span class="p">()</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">run</span><span class="p">()</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2013-2014, Etsy Inc; 2015, Abe Stanway; 2015-2020, Gary Wilson

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>