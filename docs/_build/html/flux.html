

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Flux &mdash; Skyline 2.0.0 documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/skyline.styles.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/language_data.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="upload_data to Flux - EXPERIMENTAL" href="upload-data-to-flux.html" />
    <link rel="prev" title="Luminosity" href="luminosity.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home" alt="Documentation Home"> Skyline
          

          
          </a>

          
            
            
              <div class="version">
                2.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="requirements.html">Requirements</a></li>
<li class="toctree-l1"><a class="reference internal" href="getting-started.html">Getting started</a></li>
<li class="toctree-l1"><a class="reference internal" href="running-in-python-virtualenv.html">Running Skyline in a Python virtualenv</a></li>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="upgrading/index.html">Upgrading</a></li>
<li class="toctree-l1"><a class="reference internal" href="getting-data-into-skyline.html">Getting data into Skyline</a></li>
<li class="toctree-l1"><a class="reference internal" href="alert-testing.html">Alert testing</a></li>
<li class="toctree-l1"><a class="reference internal" href="alerts.html">Alerts</a></li>
<li class="toctree-l1"><a class="reference internal" href="slack.html">slack</a></li>
<li class="toctree-l1"><a class="reference internal" href="monotonic-metrics.html">Strictly increasing monotonicity</a></li>
<li class="toctree-l1"><a class="reference internal" href="horizon.html">Horizon</a></li>
<li class="toctree-l1"><a class="reference internal" href="analyzer.html">Analyzer</a></li>
<li class="toctree-l1"><a class="reference internal" href="analyzer-optimizations.html">Analyzer Optimizations</a></li>
<li class="toctree-l1"><a class="reference internal" href="algorithms/index.html">Algorithms</a></li>
<li class="toctree-l1"><a class="reference internal" href="mirage.html">Mirage</a></li>
<li class="toctree-l1"><a class="reference internal" href="boundary.html">Boundary</a></li>
<li class="toctree-l1"><a class="reference internal" href="crucible.html">Crucible</a></li>
<li class="toctree-l1"><a class="reference internal" href="panorama.html">Panorama</a></li>
<li class="toctree-l1"><a class="reference internal" href="webapp.html">Webapp</a></li>
<li class="toctree-l1"><a class="reference internal" href="ionosphere.html">Ionosphere</a></li>
<li class="toctree-l1"><a class="reference internal" href="ionosphere_echo.html">Ionosphere echo</a></li>
<li class="toctree-l1"><a class="reference internal" href="tsfresh.html">tsfresh</a></li>
<li class="toctree-l1"><a class="reference internal" href="luminosity.html">Luminosity</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Flux</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#de-duplication">De-duplication</a></li>
<li class="toctree-l2"><a class="reference internal" href="#post-request">POST request</a></li>
<li class="toctree-l2"><a class="reference internal" href="#get-request">GET request</a></li>
<li class="toctree-l2"><a class="reference internal" href="#populate-metric-endpoint">populate_metric endpoint</a></li>
<li class="toctree-l2"><a class="reference internal" href="#process-uploaded-data">Process uploaded data</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="upload-data-to-flux.html">upload_data to Flux - EXPERIMENTAL</a></li>
<li class="toctree-l1"><a class="reference internal" href="vista.html">Vista</a></li>
<li class="toctree-l1"><a class="reference internal" href="redis-integration.html">Redis integration</a></li>
<li class="toctree-l1"><a class="reference internal" href="rebrow.html"><span class="red">re</span><span class="brow">brow</span></a></li>
<li class="toctree-l1"><a class="reference internal" href="running-multiple-skylines.html">Running multiple Skyline instances</a></li>
<li class="toctree-l1"><a class="reference internal" href="skyline-and-friends.html">Skyline and friends</a></li>
<li class="toctree-l1"><a class="reference internal" href="logging.html">Logging</a></li>
<li class="toctree-l1"><a class="reference internal" href="tuning-tips.html">Tuning tips</a></li>
<li class="toctree-l1"><a class="reference internal" href="monitoring-skyline.html">Monitoring Skyline</a></li>
<li class="toctree-l1"><a class="reference internal" href="deprecated-docs/index.html">Deprecated docs</a></li>
<li class="toctree-l1"><a class="reference internal" href="releases.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="whats-new.html">What’s new</a></li>
<li class="toctree-l1"><a class="reference internal" href="development/index.html">Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="roadmap.html">Roadmap</a></li>
<li class="toctree-l1"><a class="reference internal" href="skyline.html">skyline package</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Skyline</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Flux</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/flux.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="flux">
<h1>Flux<a class="headerlink" href="#flux" title="Permalink to this headline">¶</a></h1>
<p>Flux enables Skyline to receive metrics via HTTP GET and POST requests and
submits them to Graphite, so they can be pickled to Skyline for analysis in near
real time via the normal Skyline pipeline.</p>
<p>Flux uses falcon the bare-metal web API framework for Python to serve the API
via gunicorn.  The normal Apache/nginx reverse proxy Skyline vhost is used to
serve the /flux endpoint and proxy requests to flux.</p>
<p>It is preferable to use the POST Flux endpoint to submit metrics so that the
Skyline flux API key can be encrypted via SSL in the POST data.</p>
<div class="section" id="de-duplication">
<h2>De-duplication<a class="headerlink" href="#de-duplication" title="Permalink to this headline">¶</a></h2>
<p>Flux de-duplicates metric data that it receives by maintaining a Redis key for
each metric that is submitted.  When the flux worker successfully submits a data
point and timestamp for a metric to Graphite, flux updates the
<cite>flux.last.&lt;metric&gt;</cite> Redis key with the data point timestamp.  If a data point
is submitted to flux with a timestamp &lt;= to the timestamp value in the metric
Redis key, flux discards the data.</p>
</div>
<div class="section" id="post-request">
<h2>POST request<a class="headerlink" href="#post-request" title="Permalink to this headline">¶</a></h2>
<p>The POST endpoint is <cite>/flux/metric_data_post</cite> and this accepts JSON data.
Here is an example of the data it requires and an example POST request.</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
      <span class="nt">&quot;metric&quot;</span><span class="p">:</span> <span class="s2">&quot;vista.nodes.skyline-1.cpu.user&quot;</span><span class="p">,</span>
      <span class="nt">&quot;timestamp&quot;</span><span class="p">:</span> <span class="s2">&quot;1478021700&quot;</span><span class="p">,</span>
      <span class="nt">&quot;value&quot;</span><span class="p">:</span> <span class="s2">&quot;1.0&quot;</span><span class="p">,</span>
      <span class="nt">&quot;key&quot;</span><span class="p">:</span> <span class="s2">&quot;YOURown32charSkylineAPIkeySecret&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>curl -vvv -u username:password -d <span class="s1">&#39;{&quot;metric&quot;:&quot;vista.nodes.skyline-1.cpu.user&quot;,&quot;timestamp&quot;:&quot;1478021700&quot;,&quot;value&quot;:&quot;1.0&quot;,&quot;key&quot;:&quot;YOURown32charSkylineAPIkeySecret&quot;}&#39;</span> -H <span class="s2">&quot;Content-Type: application/json&quot;</span> -X POST https://skyline.example.org/flux/metric_data_post
</pre></div>
</div>
</div>
<div class="section" id="get-request">
<h2>GET request<a class="headerlink" href="#get-request" title="Permalink to this headline">¶</a></h2>
<p>However if the flux instance in question is only receiving metrics on a local
network or protected network and you do not mind sending the API key in
plaintext, the GET method can be used.</p>
<p>The <cite>/flux/metric_data</cite> endpoint is called via a GET request with the URI
parameters as defined below:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># /flux/metric_data?metric=&lt;metric|str&gt;&amp;timestamp=&lt;timestamp|int&gt;&amp;value=&lt;value|float&gt;&amp;key=&lt;key|str&gt;</span>
<span class="c1"># For example:</span>
curl -vvv -u username:password <span class="s2">&quot;https://skyline.example.org/flux/metric_data?metric=vista.nodes.skyline-1.cpu.user&amp;timestamp=1478021700&amp;value=1.0&amp;key=YOURown32charSkylineAPIkeySecret&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="populate-metric-endpoint">
<h2>populate_metric endpoint<a class="headerlink" href="#populate-metric-endpoint" title="Permalink to this headline">¶</a></h2>
<p>Skyline Vista is tightly integrated with Flux. Vista uses flux to submit metric
data to Graphite for the metrics that Vista fetches.  Vista does not connect
to flux via the reverse proxy, it connects directly to flux and uses the
<a class="reference internal" href="skyline.html#settings.FLUX_SELF_API_KEY" title="settings.FLUX_SELF_API_KEY"><code class="xref py py-mod docutils literal notranslate"><span class="pre">settings.FLUX_SELF_API_KEY</span></code></a> to authenticate itself.  Flux has a specific
<cite>/flux/populate_metric</cite> endpoint and worker so that Vista can submit historical
metric data to in order to pre-populate Graphite with data when new
metrics are added to Vista at multiple resolutions.  However, this endpoint is
also used by Vista to catchup/backfill metrics if for any reason data has not
been retrieved for a metric for in <cite>(frequency + 300)</cite> seconds and has fallen
behind.</p>
<p>The populate_metric worker uses the <cite>last_flux_timestamp</cite> from the
<cite>flux.last.&lt;metric&gt;</cite> Redis keys to ensure that only missing data is retrieved
and submitted to Graphite.  If no <cite>flux.last.&lt;metric&gt;</cite> Redis key exists, the
worker checks Graphite to see if Graphite has any data for the metric and if so,
flux uses the last data point timestamp from Graphite as the
<cite>last_flux_timestamp</cite> and retrieves data &gt; <cite>last_flux_timestamp</cite>.</p>
<p>The flux populate_metric_worker submits pickled data to Graphite via the Carbon
PICKLE_RECEIVER_PORT, therefore ensure that there is a firewall rule allowing
the Skyline node to connect to the Graphite node on this port.</p>
<p>The populate_metric_worker applies resampling at 1Min, but see Vista
populate_at_resolutions for more detailed information.</p>
</div>
<div class="section" id="process-uploaded-data">
<h2>Process uploaded data<a class="headerlink" href="#process-uploaded-data" title="Permalink to this headline">¶</a></h2>
<p>Skyline Flux can be enabled to process data uploaded via the webapp and submit
data to Graphite.  This allows for the automated uploading and processing of
batched measurements data and reports to time series data which is analysed in
the normal Skyline workflow.  An example use case would be if you had an hourly
report of wind related metrics that had a reading every 5 minutes for an hour
period, for x number of stations.  As long as the data is in uploaded in an
acceptable format, it can be preprocessed by flux and submitted to Graphite.
The metric namespace/s need be declared as batch processing metrics in
<a class="reference internal" href="skyline.html#settings.BATCH_PROCESSING_NAMESPACES" title="settings.BATCH_PROCESSING_NAMESPACES"><code class="xref py py-mod docutils literal notranslate"><span class="pre">settings.BATCH_PROCESSING_NAMESPACES</span></code></a> and <a class="reference internal" href="skyline.html#settings.BATCH_PROCESSING" title="settings.BATCH_PROCESSING"><code class="xref py py-mod docutils literal notranslate"><span class="pre">settings.BATCH_PROCESSING</span></code></a>
has to be enabled.</p>
<p>By default flux is not enabled to process uploaded data and the webapp is not
configured to accept uploaded data.</p>
<p>To enable Flux to process uploaded data the following settings need to be set
and services running:</p>
<ul class="simple">
<li><p>analyzer_batch needs to be enabled and running, see <a class="reference external" href="analyzer.html#analyzer_batch">Analyzer - analyzer_batch</a>.</p></li>
<li><p><a class="reference internal" href="skyline.html#settings.BATCH_PROCESSING" title="settings.BATCH_PROCESSING"><code class="xref py py-mod docutils literal notranslate"><span class="pre">settings.BATCH_PROCESSING</span></code></a> need to be set to <cite>True</cite></p></li>
<li><p>The <cite>parent_metric_namespace</cite> or all the metric namespace in question relating
to the specific data being uploaded need to be declared in
<a class="reference internal" href="skyline.html#settings.BATCH_PROCESSING_NAMESPACES" title="settings.BATCH_PROCESSING_NAMESPACES"><code class="xref py py-mod docutils literal notranslate"><span class="pre">settings.BATCH_PROCESSING_NAMESPACES</span></code></a></p></li>
<li><p><a class="reference internal" href="skyline.html#settings.DATA_UPLOADS_PATH" title="settings.DATA_UPLOADS_PATH"><code class="xref py py-mod docutils literal notranslate"><span class="pre">settings.DATA_UPLOADS_PATH</span></code></a> is required</p></li>
<li><p><a class="reference internal" href="skyline.html#settings.WEBAPP_ACCEPT_DATA_UPLOADS" title="settings.WEBAPP_ACCEPT_DATA_UPLOADS"><code class="xref py py-mod docutils literal notranslate"><span class="pre">settings.WEBAPP_ACCEPT_DATA_UPLOADS</span></code></a> must be enabled</p></li>
<li><p><a class="reference internal" href="skyline.html#settings.FLUX_PROCESS_UPLOADS" title="settings.FLUX_PROCESS_UPLOADS"><code class="xref py py-mod docutils literal notranslate"><span class="pre">settings.FLUX_PROCESS_UPLOADS</span></code></a> must be enabled</p></li>
<li><p>If the data is being uploaded ia an automated process, curl, etc the
<cite>parent_metric_namespace</cite> needs a key set in the
<a class="reference internal" href="skyline.html#settings.FLUX_UPLOADS_KEYS" title="settings.FLUX_UPLOADS_KEYS"><code class="xref py py-mod docutils literal notranslate"><span class="pre">settings.FLUX_UPLOADS_KEYS</span></code></a> dictionary e.g.</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">FLUX_UPLOADS_KEYS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;temp_monitoring.warehouse.2.012383&#39;</span><span class="p">:</span> <span class="s1">&#39;484166bf-df66-4f7d-ad4a-9336da9ef620&#39;</span><span class="p">,</span>
<span class="p">}</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Optionally <a class="reference internal" href="skyline.html#settings.FLUX_SAVE_UPLOADS" title="settings.FLUX_SAVE_UPLOADS"><code class="xref py py-mod docutils literal notranslate"><span class="pre">settings.FLUX_SAVE_UPLOADS</span></code></a> and
<a class="reference internal" href="skyline.html#settings.FLUX_SAVE_UPLOADS_PATH" title="settings.FLUX_SAVE_UPLOADS_PATH"><code class="xref py py-mod docutils literal notranslate"><span class="pre">settings.FLUX_SAVE_UPLOADS_PATH</span></code></a> can be used if you wish to save the
uploaded data.</p></li>
</ul>
<p>For specific details about the data formats and methods for uploading and
processing data files see the <a class="reference external" href="upload-data-to-flux.html">upload_data to Flux</a>
page.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="upload-data-to-flux.html" class="btn btn-neutral float-right" title="upload_data to Flux - EXPERIMENTAL" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="luminosity.html" class="btn btn-neutral float-left" title="Luminosity" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2013-2014, Etsy Inc; 2015, Abe Stanway; 2015-2020, Gary Wilson

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>